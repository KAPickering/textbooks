/* (c) Mathigon, generated by Mathigon Studio */
(()=>{var Cl=Object.defineProperty;var bf=Object.prototype.hasOwnProperty;var $f=Object.getOwnPropertyDescriptor,Ml=Object.getOwnPropertySymbols,xf=Object.prototype.propertyIsEnumerable;var El=(n,t,e)=>t in n?Cl(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,me=(n,t)=>{for(var e in t||(t={}))bf.call(t,e)&&El(n,e,t[e]);if(Ml)for(var e of Ml(t))xf.call(t,e)&&El(n,e,t[e]);return n};var V=(n,t,e,s)=>{for(var i=s>1?void 0:s?$f(t,e):t,o=n.length-1,r;o>=0;o--)(r=n[o])&&(i=(s?r(t,e,i):r(i))||i);return s&&i&&Cl(t,e,i),i};var P=(n,t,e)=>new Promise((s,i)=>{var o=h=>{try{a(e.next(h))}catch(l){i(l)}},r=h=>{try{a(e.throw(h))}catch(l){i(l)}},a=h=>h.done?s(h.value):Promise.resolve(h.value).then(o,r);a((e=e.apply(n,t)).next())});function Fe(n=10){return Math.random().toString(36).substr(2,n)}function F(n,...t){return t.includes(n)}function Sn(n={},t){for(let e of Object.keys(t))Object.prototype.hasOwnProperty.call(n,e)||(n[e]=t[e]);return n}var Pf=(n,t)=>n.concat(t);function Jo(n,t,e=Pf){for(let s of Object.keys(t))s in n&&Array.isArray(n[s])&&Array.isArray(t[s])?n[s]=e(n[s],t[s]):s in n&&n[s]instanceof Object&&t[s]instanceof Object?Jo(n[s],t[s]):n[s]=t[s]}function ge(n,t=0){return t?+setTimeout(n,t):(n(),0)}function Ve(n){return new Promise(t=>setTimeout(t,n))}function hs(){let n=()=>{},t=()=>{},e=new Promise((s,i)=>{n=s,t=i});return e.catch(s=>s),{promise:e,resolve:n,reject:t}}var Qo=class extends Error{constructor(t){super("[Cache Error]");this.data=t}};function Jt(n){let t=new Map;return function(...e){let s=e.join("--");if(!t.has(s))try{t.set(s,n(...e))}catch(o){t.set(s,new Qo(o))}let i=t.get(s);if(i instanceof Qo)throw i.data;return i}}function ls(n,t=0,e=!1){let s=!1,i=!1;return(...o)=>{s?i=!0:(e?i=!0:n(...o),s=!0,setTimeout(()=>{i&&n(...o),s=i=!1},t))}}function tr(n,t={}){if(!n)return t;try{return JSON.parse(n)||t}catch(e){return t}}function Nt(n,t){return new Array(t).fill(n)}function er(n,t,e){let s=[];for(let i=0;i<t;++i)s.push(Nt(n,e));return s}function _(n,t){let e=[];for(let s=0;s<t;++s)e.push(n(s));return e}function Vl(n,t,e){let s=[];for(let i=0;i<t;++i){let o=[];for(let r=0;r<e;++r)o.push(n(i,r));s.push(o)}return s}function Us(n,t,e=1){let s=[];if(t===void 0&&n>=0)for(let i=0;i<n;i+=e)s.push(i);else if(t===void 0)for(let i=0;i>n;i-=e)s.push(i);else if(n<=t)for(let i=n;i<=t;i+=e)s.push(i);else for(let i=n;i>=t;i-=e)s.push(i);return s}function I(n,t=0){return n[n.length-1-t]}function H(n){return n.reduce((t,e)=>t+e,0)}function cs(n,t,e=!1){return n.slice(0).sort((s,i)=>{let o=t(s),r=t(i);return o<r?e?1:-1:o>r?e?-1:1:0})}function ds(n){let t=0;return()=>n[t++%n.length]}function Wt(n){return n.filter((t,e)=>n.indexOf(t)===e)}function Ut(n){return n.reduce((t,e)=>t.concat(Array.isArray(e)?Ut(e):e),[])}function Tn(n){let t=0;return n.map(e=>t+=e)}function js(n,t){let e=[];for(let s=0;s<n.length;s+=t)e.push(n.slice(s,s+t));return e}function sr(n,t=1){let e=n.length;t=(t%e+e)%e;let s=n.slice(0,t);return n.slice(t).concat(s)}function Cn(...n){return n.reduce((t,e)=>t.concat(e),[])}var ir=class{constructor(t){let e=t.length,s=t.map(i=>({val:i}));for(let[i,o]of s.entries())o.next=s[(i+1)%e],o.prev=s[(i-1+e)%e];this.root=s[0]}*traverse(){let t=this.root;for(;t;)if(yield t,t=t.next,t===this.root)return}get array(){return Array.from(this.traverse())}delete(t){if(t===this.root){if(t.next===t)return this.root=void 0;this.root=t.next}t.prev.next=t.next,t.next.prev=t.prev}};function tt(n,t=/\s+/){return n?n.trim().split(t):[]}function Mn(n){return n.toLowerCase().replace(/^-/,"").replace(/-(.)/g,(t,e)=>e.toUpperCase())}function Sf(n,t,e=!1){let s=er(0,n.length+1,t.length+1);for(let i=0;i<=n.length;i++)s[i][0]=i;for(let i=0;i<=t.length;i++)s[0][i]=i;for(let i=1;i<=n.length;i++)for(let o=1;o<=t.length;o++)s[i][o]=Math.min(s[i-1][o-1]+(n.charAt(i-1)===t.charAt(o-1)?0:1),s[i-1][o]+1,s[i][o-1]+1);return e?Math.min(...s[n.length]):s[n.length][t.length]}function Al(n,t){let e=n.length/2,s=t.map(o=>({w:o,d:Sf(n,o)})).filter(({d:o})=>o<e),i=cs(s,o=>o.d)[0];return i?i.w:void 0}var we=class{constructor(){this.events=new Map}on(t,e){for(let s of tt(t))this.events.has(s)||this.events.set(s,[]),this.events.get(s).push(e)}one(t,e){let s=i=>{this.off(t,s),e(i)};this.on(t,s)}off(t,e){for(let s of tt(t))this.events.has(s)&&this.events.set(s,this.events.get(s).filter(i=>i!==e))}trigger(t,e){for(let s of tt(t))if(this.events.has(s))for(let i of this.events.get(s))i(e)}},Tf=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,Cf=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})?$/i,Mf=/rgba?\(([0-9,]+), ?([0-9,]+), ?([0-9,]+)(, ?([0-9,]+))?\)/,Ef=["#22ab24","#009ea6","#0f82f2","#6d3bbf","#cd0e66","#eb4726","#fd8c00"];function kl(n){return n.length===1?"0"+n:n}function Ol(n,t){if(t<=0)return G.from(n[0]);if(t>=1)return G.from(I(n));let e=Math.floor(t*(n.length-1)),s=t*(n.length-1)-e;return G.mix(n[e+1],n[e],s)}function nr(n,t,e){return e<0&&(e+=1),e>1&&(e-=1),e<1/6?n+(t-n)*6*e:e<1/2?t:e<2/3?n+(t-n)*(2/3-e)*6:n}var G=class{constructor(t,e,s,i=1){this.r=t,this.g=e,this.b=s,this.a=i}get hex(){let t=[this.r,this.g,this.b].map(s=>kl(Math.round(s).toString(16))),e=this.a>=1?"":kl(Math.round(this.a*255).toString(16));return"#"+t.join("")+e}get rgb(){let t=[this.r,this.g,this.b].map(e=>Math.round(e)).join(",");return"rgba("+t+","+this.a+")"}get brightness(){return(this.r*299+this.g*587+this.g*114)/1e3}get hsl(){let t=this.r/255,e=this.g/255,s=this.b/255,i=Math.max(t,e,s),o=Math.min(t,e,s),r=(o+i)/2,a=i-o;if(i===o)return[0,0,Math.round(r*100)];let h=t===i?(e-s)/a:e===i?2+(s-t)/a:4+(t-e)/a;h=Math.min(h*60,360),h<0&&(h+=360);let l=r<=.5?a/(i+o):a/(2-i-o);return[Math.round(h),Math.round(l*100),Math.round(r*100)]}get chroma(){return Math.max(this.r,this.g,this.b)-Math.min(this.r,this.g,this.b)}toString(){return this.rgb}copy(){return new G(this.r,this.g,this.b,this.a)}static from(t){return typeof t!="string"?t:t.startsWith("#")?G.fromHex(t):G.fromRgb(t)}static fromRgb(t){let e=t.match(Mf);if(!e)return new G(0,0,0);let s=e[4]?+e[5]||0:1;return new G(+e[1],+e[2],+e[3],s)}static fromHex(t){t=t.replace(Tf,(s,i,o,r)=>i+i+o+o+r+r);let e=Cf.exec(t);return e?new G(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),e[4]?parseInt(e[4],16)/255:1):new G(0,0,0)}static fromHsl(t,e,s){if(t/=360,e/=100,s/=100,e===0){let l=Math.round(s*255);return new G(l,l,l)}let i=s<.5?s*(1+e):s+e-s*e,o=2*s-i,r=nr(o,i,t+1/3),a=nr(o,i,t),h=nr(o,i,t-1/3);return new G(Math.round(r*255),Math.round(a*255),Math.round(h*255))}static rainbow(t){return _(e=>Ol(Ef,e/(t-1)),t)}static gradient(t,e){return _(s=>Ol(t,s/(e-1)),e)}static shades(t,e,s=.5){let i=G.mix("#fff",t,s),o=G.mix("#000",t,s);return G.gradient([i,t,o],e)}static mix(t,e,s=.5){return t=G.from(t),e=G.from(e),new G(s*t.r+(1-s)*e.r,s*t.g+(1-s)*e.g,s*t.b+(1-s)*e.b,s*t.a+(1-s)*e.a)}static mixMany(t,e){e||(e=t.map(()=>1));let s=H(e),i=t.map(y=>y.hsl),o=i.map(y=>y[0]),r=o.map(y=>y<180?y+360:y),a=e.map((y,$)=>y*Math.sqrt(t[$].chroma)),h=H(a),l=H(o.map((y,$)=>y*a[$]))/h,p=H(r.map((y,$)=>y*a[$]))/h,u=H(o.map((y,$)=>Math.abs(y-l)*a[$])),m=H(r.map((y,$)=>Math.abs(y-p)*a[$])),g=u<=m?l:p%360,b=H(i.map((y,$)=>e[$]*y[1]))/s,w=H(i.map((y,$)=>e[$]*y[2]))/s;return G.fromHsl(g,b,w)}};function Ll(n,t){for(let e of n)if(!t(e))return!1;return!0}function Ue(n,t){for(let e of n)if(t(e))return!0;return!1}function*Rl(n,t){for(let e of n)for(let s of t(e))yield s}function*Il(n,t){for(let e of n)for(let s of t)yield[e,s]}function ps(n,t,e=Infinity,s){let i,o=e;for(let r of n){let a=t(r);if(a<o&&(i=r,o=a,s!==void 0&&o<s))return i}return i}var Zs=class{constructor(...t){this.values=t}map(t){let e=this.values;return new Zs(function*(){let s=0;for(let i of e)for(let o of i)yield t(o,s),s+=1}())}every(t){let e=0;for(let s of this.values)for(let i of s){if(!t(i,e))return!1;e+=1}return!0}some(t){let e=0;for(let s of this.values)for(let i of s){if(t(i,e))return!0;e+=1}return!1}slice(t,e){let s=this.values;return new Zs(function*(){let i=0;for(let o of s)for(let r of o)i<t||e!==void 0&&i>t+e||(yield r,i+=1)}())}filter(t){let e=this.values;return new Zs(function*(){let s=0;for(let i of e)for(let o of i)t(o,s)&&(yield o),s+=1}())}concat(t){this.values.push(t)}[Symbol.iterator](){let t=this.values;return function*(){for(let e of t)for(let s of e)yield s}()}static make(t,e){return new Zs(function*(){let s=0;for(;e===void 0||s<e;)yield t(s),s+=1}())}};var Nl=1e-6;function C(n,t,e=Nl){return isNaN(n)||isNaN(t)?!1:Math.abs(n-t)<e}function lt(n,t,e,s=Nl){return t>e&&([t,e]=[e,t]),n>t+s&&n<e-s}var Dl=/(\d+)(\d{3})/,Vf=["","k","m","b","t","q"];function Af(n){let[t,e]=n.split(".");for(;Dl.test(t);)t=t.replace(Dl,"$1,$2");return t+(e?"."+e:"")}function kf(n,t=6){if(!t)return""+n;let e=(""+Math.abs(Math.floor(n))).length,s=n<0?1:0;if(e<=t-s)return""+kt(n,t-e-s-1);let i=Math.floor(Math.log10(Math.abs(n))/3);return kt(n/Math.pow(10,3*i),t-(e%3||3)-s-1)+Vf[i]}function ot(n,t=0,e=!0){let s=kf(n,t).replace("-","\u2013");return e?Af(s):s}var Of=/^-?0,[0-9]+$/,Lf=/^-?([0-9]+(,[0-9]{3})*)?\.?[0-9]*$/,Rf=/^-?[0-9]+(\.[0-9]{3})*,?[0-9]*$/;function Mi(n){return n=n.replace(/^â€“/,"-").trim(),!n||n.match(/[^0-9.,-]/)?NaN:Of.test(n)?parseFloat(n.replace(/,/,".")):Lf.test(n)?parseFloat(n.replace(/,/g,"")):Rf.test(n)?parseFloat(n.replace(/\./g,"").replace(/,/,".")):NaN}var or=["","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],Gl=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"],If=[""," thousand"," million"," billion"," trillion"," quadrillion"," quintillion"," sextillion"];function Nf(n){let[t,e,s]=n.split(""),i=t==="0"?"":" "+or[+t]+" hundred";return e+s==="00"?i:+e<2?i+" "+or[+(e+s)]:s==="0"?i+" "+Gl[+e]:i+" "+Gl[+e]+"-"+or[+s]}function Ws(n){if(n===0)return"zero";let t=Math.round(Math.abs(n)).toString(),e=Math.ceil(t.length/3),s=t.padStart(3*e,"0"),i="";for(let o=0;o<e;o+=1){let r=s.substr(o*3,3);r!=="000"&&(i+=Nf(r)+If[e-1-o])}return i.trim()}function kt(n,t=0){let e=Math.pow(10,t);return Math.round(n*e)/e}function st(n,t=1){return Math.round(n/t)*t}function M(n,t=-Infinity,e=Infinity){return Math.min(e,Math.max(t,n))}function Ct(n,t,e=.5){return n+(t-n)*e}function Qt(n){return n*n}function $t(n,t){return(n%t+t)%t}function rr(n,t,e){if(C(n,0)&&C(t,0))return[];if(C(n,0))return[-e/t];let s=-t/2/n,i=Math.sqrt(t*t-4*n*e)/2/n;return[s+i,s-i]}function ql(n,t=0){let e=n.slice(0),s=Hl(e);return t?s.filter(i=>i.length===t):s}function Hl(n){if(n.length===1)return[[],n];let t=n.pop(),e=Hl(n),s=[];for(let i of e)s.push(i,[...i,t]);return s}var En=(n,t)=>{let e=n<0?"\u2013":"";return Math.abs(n)===1&&t?e+t:e+Math.abs(n)+(t||"")},rt=class{constructor(t=0,e=0){this.re=t,this.im=e}get modulus(){return Math.sqrt(this.re*this.re+this.im*this.im)}get argument(){return Math.atan2(this.im,this.re)}get conjugate(){return new rt(this.re,-this.im)}root(t,e=0){let s=Math.pow(this.modulus,1/t),i=(this.argument+e*2*Math.PI)/t;return new rt(s*Math.cos(i),s*Math.sin(i))}toString(t=2){let e=kt(this.re,t),s=kt(this.im,t);return s===0?En(e):e===0?En(s,"i"):[En(e),s<0?"\u2013":"+",En(Math.abs(s),"i")].join(" ")}add(t){return rt.sum(this,t)}subtract(t){return rt.difference(this,t)}multiply(t){return rt.product(this,t)}divide(t){return rt.quotient(this,t)}static sum(t,e){return typeof t=="number"&&(t=new rt(t,0)),typeof e=="number"&&(e=new rt(e,0)),new rt(t.re+e.re,t.im+e.im)}static difference(t,e){return typeof t=="number"&&(t=new rt(t,0)),typeof e=="number"&&(e=new rt(e,0)),new rt(t.re-e.re,t.im-e.im)}static product(t,e){typeof t=="number"&&(t=new rt(t,0)),typeof e=="number"&&(e=new rt(e,0));let s=t.re*e.re-t.im*e.im,i=t.im*e.re+t.re*e.im;return new rt(s,i)}static quotient(t,e){if(typeof t=="number"&&(t=new rt(t,0)),typeof e=="number"&&(e=new rt(e,0)),Math.abs(e.re)<Number.EPSILON||Math.abs(e.im)<Number.EPSILON)return new rt(Infinity,Infinity);let s=e.re*e.re+e.im*e.im,i=(t.re*e.re+t.im*e.im)/s,o=(t.im*e.re-t.re*e.im)/s;return new rt(i,o)}static exp(t){typeof t=="number"&&(t=new rt(t,0));let e=Math.exp(t.re);return new rt(e*Math.cos(t.im),e*Math.sin(t.im))}};function us(...n){let[t,...e]=n;if(e.length>1)return us(t,us(...e));let s=Math.abs(t),i=Math.abs(e[0]);for(;i;)[s,i]=[i,s%i];return s}function fs(...n){let[t,...e]=n;return e.length>1?fs(t,fs(...e)):Math.abs(t*e[0])/us(t,e[0])}function Ei(n){if(n%1!=0||n<2)return!1;if(n%2==0)return n===2;if(n%3==0)return n===3;let t=Math.sqrt(n);for(let e=5;e<=t;e+=6)if(n%e==0||n%(e+2)==0)return!1;return!0}function je(n){if(n===1)return[];if(Ei(n))return[n];let t=Math.sqrt(n);for(let e=2;e<=t;++e)if(n%e==0)return je(e).concat(je(n/e));return[]}function _l(n){return Wt(je(n))}function Bl(n,t,e){return er(n,t,e)}function zl(n=2){let t=Bl(0,n,n);for(let e=0;e<n;++e)t[e][e]=1;return t}function Df(n){let t=Math.sin(n),e=Math.cos(n);return[[e,-t],[t,e]]}function Gf(n){return[[1,n],[0,1]]}function Hf(n){let t=Math.sin(2*n),e=Math.cos(2*n);return[[e,t],[t,-e]]}function Fl(...n){let[t,...e]=n,s=e.length>1?Fl(...e):e[0];if(t.length!==s.length||t[0].length!==s[0].length)throw new Error("Matrix sizes don\u2019t match");let i=[];for(let o=0;o<t.length;++o){let r=[];for(let a=0;a<t[o].length;++a)r.push(t[o][a]+s[o][a]);i.push(r)}return i}function qf(n,t){return n.map(e=>e.map(s=>s*t))}function Vn(...n){let[t,...e]=n,s=e.length>1?Vn(...e):e[0];if(t[0].length!==s.length)throw new Error("Matrix sizes don\u2019t match.");let i=[];for(let o=0;o<t.length;++o){let r=[];for(let a=0;a<s[0].length;++a){let h=0;for(let l=0;l<s.length;++l)h+=t[o][l]*s[l][a];r.push(h)}i.push(r)}return i}function Ul(n){let t=[];for(let e=0;e<n[0].length;++e){let s=[];for(let i=0;i<n.length;++i)s.push(n[i][e]);t.push(s)}return t}function _f(n){if(n.length!==n[0].length)throw new Error("Not a square matrix.");let t=n.length;if(t===1)return n[0][0];if(t===2)return n[0][0]*n[1][1]-n[0][1]*n[1][0];let e=0;for(let s=0;s<t;++s){let i=n[0][s],o=n[0][s];for(let r=1;r<t;++r)o*=n[r][s+r%t],i*=n[r][s-r%t];e+=o-i}return e}function jl(n){let t=n.length;if(t!==n[0].length)throw new Error("Not a square matrix.");let e=zl(t),s=Vl((i,o)=>n[i][o],t,t);for(let i=0;i<t;++i){let o=s[i][i];if(!o){for(let r=i+1;r<t;++r)if(s[r][i]!==0){for(let a=0;a<t;++a)[s[r][a],s[i][a]]=[s[i][a],s[r][a]],[e[r][a],e[i][a]]=[e[i][a],e[r][a]];break}if(o=s[i][i],!o)throw new Error("Matrix not invertible.")}for(let r=0;r<t;++r)s[i][r]=s[i][r]/o,e[i][r]=e[i][r]/o;for(let r=0;r<t;++r){if(r===i)continue;let a=s[r][i];for(let h=0;h<t;++h)s[r][h]-=a*s[i][h],e[r][h]-=a*e[i][h]}}return e}var xt=Object.freeze({__proto__:null,fill:Bl,identity:zl,rotation:Df,shear:Gf,reflection:Hf,sum:Fl,scalarProduct:qf,product:Vn,transpose:Ul,determinant:_f,inverse:jl});function Bf(n){n=n.slice(0);for(let t=n.length-1;t>0;--t){let e=Math.floor(Math.random()*(t+1));[n[t],n[e]]=[n[e],n[t]]}return n}function zf(n,t){let e=t===void 0?0:n,s=t===void 0?n:t-n+1;return e+Math.floor(s*Math.random())}function Zl(n){let t=Math.random()*H(n),e=0;return n.findIndex(s=>(e+=s)>=t)}function Ff(n){return n[Math.floor(n.length*Math.random())]}var An=new Map;function Uf(n,t){t||(t=Fe()),An.has(t)||An.set(t,Nt(1,n));let e=An.get(t),s=Zl(e.map(i=>i*i));return e[s]-=1,e[s]<=0&&An.set(t,e.map(i=>i+1)),s}function Wl(n=.5){return Math.random()<n?1:0}function jf(n=1,t=.5){let e=0;for(let s=0;s<n;++s)e+=Wl(t);return e}function Zf(n=1){if(n<=0)return 0;let t=Math.exp(-n),e=1,s=0;for(;e>t;++s)e*=Math.random();return s-1}function Wf(n=0,t=1){return n+(t-n)*Math.random()}function Kf(n=0,t=1){let e=Math.random(),s=Math.random();return Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*s)*Math.sqrt(t)+n}function Xf(n=1){return n<=0?0:-Math.log(Math.random())/n}function Yf(n=.5){if(!(n<=0||n>1))return Math.floor(Math.log(Math.random())/Math.log(1-n))}function Jf(){let n,t,e;do t=2*Math.random()-1,e=2*Math.random()-1,n=t*t+e*e;while(n>=1);return t/e}function Qf(n,t=1,e=0){return Math.exp(-((n-t)**2)/(2*e))/Math.sqrt(2*Math.PI*e)}var Kl=7,Xl=[.9999999999998099,676.5203681218851,-1259.1392167224028,771.3234287776531,-176.6150291621406,12.507343278686905,-.13857109526572012,9984369578019572e-21,15056327351493116e-23];function Yl(n){if(n<.5)return Math.PI/(Math.sin(Math.PI*n)*Yl(1-n));n-=1;let t=Xl[0];for(let s=1;s<Kl+2;s++)t+=Xl[s]/(n+s);let e=n+Kl+.5;return Math.sqrt(2*Math.PI)*Math.pow(e,n+.5)*Math.exp(-e)*t}function Jl(n,t,e,s=1){let i=0;for(let o=t;o<e;o+=s)i+=n(o)*s||0;return i}function tm(n,t){let e=Jl(s=>Math.pow(s,(t-2)/2)*Math.exp(-s/2),0,n);return 1-e/Math.pow(2,t/2)/Yl(t/2)}var ct=Object.freeze({__proto__:null,shuffle:Bf,integer:zf,weighted:Zl,find:Ff,smart:Uf,bernoulli:Wl,binomial:jf,poisson:Zf,uniform:Wf,normal:Kf,exponential:Xf,geometric:Yf,cauchy:Jf,normalPDF:Qf,integrate:Jl,chiCDF:tm});function em(n,t){let e=1,s=n[0];for(let i=1;i<n.length;++i)e*=t,s+=e*n[i];return s}function sm(n,t=!1){let e=0,s=0,i=0,o=0,r=n.length;for(let l=0;l<r;l++)e+=n[l][0],s+=n[l][1],i+=n[l][0]*n[l][0],o+=n[l][0]*n[l][1];if(t){let l=o/i;return[0,l]}let a=(r*o-e*s)/(r*i-e*e);return[s/r-a*e/r,a]}function im(n){let t=[0,0,0,0,0,0];for(let o of n)t[0]+=o[0],t[1]+=o[1],t[2]+=o[0]*o[0]*o[1],t[3]+=o[1]*Math.log(o[1]),t[4]+=o[0]*o[1]*Math.log(o[1]),t[5]+=o[0]*o[1];let e=t[1]*t[2]-t[5]*t[5],s=Math.exp((t[2]*t[3]-t[5]*t[4])/e),i=(t[1]*t[4]-t[5]*t[3])/e;return[s,i]}function nm(n){let t=[0,0,0,0],e=n.length;for(let o of n)t[0]+=Math.log(o[0]),t[1]+=o[1]*Math.log(o[0]),t[2]+=o[1],t[3]+=Math.pow(Math.log(o[0]),2);let s=(e*t[1]-t[2]*t[0])/(e*t[3]-t[0]*t[0]);return[(t[2]-s*t[0])/e,s]}function om(n){let t=[0,0,0,0],e=n.length;for(let o of n)t[0]+=Math.log(o[0]),t[1]+=Math.log(o[1])*Math.log(o[0]),t[2]+=Math.log(o[1]),t[3]+=Math.pow(Math.log(o[0]),2);let s=(e*t[1]-t[2]*t[0])/(e*t[3]-t[0]*t[0]);return[Math.exp((t[2]-s*t[0])/e),s]}function Ql(n,t=2){let e=n.map(h=>Us(t+1).map(l=>Math.pow(h[0],l))),s=Ul(e),i=n.map(h=>[h[1]]),o=Vn(s,e),r=jl(o);return Vn(r,s,i).map(h=>h[0])}function tc(n,t){let s=n.reduce((r,a)=>r+a[1],0)/n.length,i=n.reduce((r,a)=>r+(a[1]-s)**2,0),o=n.reduce((r,a)=>r+(a[1]-t(a[0]))**2,0);return 1-o/i}function rm(n,t=.85,e=8){if(!(n.length<=1))for(let s=1;s<e;++s){let i=Ql(n,s),o=a=>em(i,a);if(tc(n,o)>=t)return{order:s,coefficients:i,fn:o}}}var ec=Object.freeze({__proto__:null,linear:sm,exponential:im,logarithmic:nm,power:om,polynomial:Ql,coefficient:tc,bestPolynomial:rm});function Ks(n){return n.length?H(n)/n.length:0}function Xs(n,t){let e=n.length;if(!e)return 0;let s=n.slice(0).sort((o,r)=>o-r);if(t===1)return s[e-1];let i=e*t;return Number.isInteger(i)?(s[i-1]+s[i])/2:s[Math.floor(i)]}var te=2*Math.PI;function ms(n,t){let e=Math.atan2(n.y-(t?t.y:0),n.x-(t?t.x:0));return $t(e,te)}var d=class{constructor(t=0,e=0){this.x=t,this.y=e,this.type="point"}get unitVector(){return C(this.length,0)?new d(1,0):this.scale(1/this.length)}get length(){return Math.sqrt(this.x**2+this.y**2)}get inverse(){return new d(-this.x,-this.y)}get flip(){return new d(this.y,this.x)}get perpendicular(){return new d(-this.y,this.x)}get array(){return[this.x,this.y]}distanceFromLine(t){return d.distance(this,t.project(this))}clamp(t,e=0){let s=M(this.x,t.xMin+e,t.xMax-e),i=M(this.y,t.yMin+e,t.yMax-e);return new d(s,i)}changeCoordinates(t,e){let s=e.xMin+(this.x-t.xMin)/t.dx*e.dx,i=e.yMin+(this.y-t.yMin)/t.dy*e.dy;return new d(s,i)}add(t){return d.sum(this,t)}subtract(t){return d.difference(this,t)}round(t=1){return new d(st(this.x,t),st(this.y,t))}floor(){return new d(Math.floor(this.x),Math.floor(this.y))}mod(t,e=t){return new d(this.x%t,this.y%e)}angle(t=E){return ms(this,t)}snap(t,e=5){return C(this.x,t.x,e)?new d(t.x,this.y):C(this.y,t.y,e)?new d(this.x,t.y):this}static average(...t){let e=H(t.map(i=>i.x))/t.length,s=H(t.map(i=>i.y))/t.length;return new d(e,s)}static dot(t,e){return t.x*e.x+t.y*e.y}static sum(t,e){return new d(t.x+e.x,t.y+e.y)}static difference(t,e){return new d(t.x-e.x,t.y-e.y)}static distance(t,e){return Math.sqrt(Qt(t.x-e.x)+Qt(t.y-e.y))}static manhattan(t,e){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}static interpolate(t,e,s=.5){return new d(Ct(t.x,e.x,s),Ct(t.y,e.y,s))}static interpolateList(t,e=.5){let s=t.length-1,i=Math.floor(M(e,0,1)*s);return d.interpolate(t[i],t[i+1],s*e-i)}static fromPolar(t,e=1){return new d(e*Math.cos(t),e*Math.sin(t))}static random(t){let e=ct.uniform(t.xMin,t.xMax),s=ct.uniform(t.yMin,t.yMax);return new d(e,s)}static equals(t,e,s){return C(t.x,e.x,s)&&C(t.y,e.y,s)}static colinear(t,e,s,i){let o=t.x-e.x,r=t.y-e.y,a=e.x-s.x,h=e.y-s.y;return C(o*h,a*r,i)}transform(t){let e=t[0][0]*this.x+t[0][1]*this.y+t[0][2],s=t[1][0]*this.x+t[1][1]*this.y+t[1][2];return new d(e,s)}rotate(t,e=E){if(C(t,0))return this;let s=this.x-e.x,i=this.y-e.y,o=Math.cos(t),r=Math.sin(t),a=s*o-i*r+e.x,h=s*r+i*o+e.y;return new d(a,h)}reflect(t){let e=t.p2.x-t.p1.x,s=t.p2.y-t.p1.y,i=this.x-t.p1.x,o=this.y-t.p1.y,r=(e*o-s*i)/(e*e+s*s),a=this.x+2*r*s,h=this.y-2*r*e;return new d(a,h)}scale(t,e=t){return new d(this.x*t,this.y*e)}shift(t,e=t){return new d(this.x+t,this.y+e)}translate(t){return this.shift(t.x,t.y)}equals(t,e){return d.equals(this,t,e)}},E=new d(0,0),ve=class{constructor(t,e,s){this.c=t,this.start=e,this.angle=s,this.type="arc"}get radius(){return d.distance(this.c,this.start)}get end(){return this.start.rotate(this.angle,this.c)}get startAngle(){return ms(this.start,this.c)}contract(t){return new this.constructor(this.c,this.at(t/2),this.angle*(1-t))}get minor(){return this.angle<=Math.PI?this:new this.constructor(this.c,this.end,te-this.angle)}get major(){return this.angle>=Math.PI?this:new this.constructor(this.c,this.end,te-this.angle)}get center(){return this.at(.5)}project(t){let e=this.startAngle,s=e+this.angle,i=ms(t,this.c);return s>te&&i<s-te&&(i+=te),i=M(i,e,s),this.c.shift(this.radius,0).rotate(i,this.c)}at(t){return this.start.rotate(this.angle*t,this.c)}contains(t){return t.equals(this.project(t))}transform(t){return new this.constructor(this.c.transform(t),this.start.transform(t),this.angle)}rotate(t,e=E){return C(t,0)?this:new this.constructor(this.c.rotate(t,e),this.start.rotate(t,e),this.angle)}reflect(t){return new this.constructor(this.c.reflect(t),this.start.reflect(t),this.angle)}scale(t,e=t){return new this.constructor(this.c.scale(t,e),this.start.scale(t,e),this.angle)}shift(t,e=t){return new this.constructor(this.c.shift(t,e),this.start.shift(t,e),this.angle)}translate(t){return this.shift(t.x,t.y)}equals(){return!1}},ye=class extends ve{constructor(){super(...arguments);this.type="sector"}contains(t){return d.distance(t,this.c)<=this.radius&&new Pt(this.start,this.c,t).rad<=this.angle}},dt=class{constructor(t,e){this.p1=t,this.p2=e,this.type="line"}make(t,e){return new dt(t,e)}get length(){return d.distance(this.p1,this.p2)}get lengthSquared(){return(this.p1.x-this.p2.x)**2+(this.p1.y-this.p2.y)**2}get midpoint(){return d.average(this.p1,this.p2)}get slope(){return(this.p2.y-this.p1.y)/(this.p2.x-this.p1.x)}get intercept(){return this.p1.y+this.slope*this.p1.x}get angle(){return ms(this.p2,this.p1)}get unitVector(){return this.p2.subtract(this.p1).unitVector}get perpendicularVector(){return new d(this.p2.y-this.p1.y,this.p1.x-this.p2.x).unitVector}parallel(t){let e=d.sum(t,d.difference(this.p2,this.p1));return new dt(t,e)}perpendicular(t){return new dt(t,d.sum(t,this.perpendicularVector))}get perpendicularBisector(){return this.perpendicular(this.midpoint)}distanceSquared(t){let e=this.project(t);return(t.x-e.x)**2+(t.y-e.y)**2}offset(t){let e=d.difference(this.p2,this.p1),s=d.difference(t,this.p1);return d.dot(e,s)/this.lengthSquared}project(t){return this.at(this.offset(t))}side(t,e){let s=d.difference(this.p2,this.p1),i=d.difference(t,this.p1),o=i.x*s.y-i.y*s.x;return C(o,0,e)?0:Math.sign(o)}contains(t,e){return this.side(t,e)===0}at(t){return d.interpolate(this.p1,this.p2,t)}transform(t){return new this.constructor(this.p1.transform(t),this.p2.transform(t))}rotate(t,e=E){return C(t,0)?this:new this.constructor(this.p1.rotate(t,e),this.p2.rotate(t,e))}reflect(t){return new this.constructor(this.p1.reflect(t),this.p2.reflect(t))}scale(t,e=t){return this.make(this.p1.scale(t,e),this.p2.scale(t,e))}shift(t,e=t){return this.make(this.p1.shift(t,e),this.p2.shift(t,e))}translate(t){return this.shift(t.x,t.y)}equals(t,e){return this.contains(t.p1,e)&&this.contains(t.p2,e)}},Vi=class extends dt{constructor(){super(...arguments);this.type="ray"}make(t,e){return new Vi(t,e)}equals(t,e){return t.type!=="ray"?!1:this.p1.equals(t.p1,e)&&this.contains(t.p2,e)}},Z=class extends dt{constructor(){super(...arguments);this.type="segment"}contains(t,e){return dt.prototype.contains.call(this,t,e)?this.p1.equals(t,e)||this.p2.equals(t,e)?!0:C(this.p1.x,this.p2.x,e)?lt(t.y,this.p1.y,this.p2.y):lt(t.x,this.p1.x,this.p2.x):!1}make(t,e){return new Z(t,e)}project(t){let e=d.difference(this.p2,this.p1),s=d.difference(t,this.p1),i=M(d.dot(e,s)/this.lengthSquared,0,1);return d.sum(this.p1,e.scale(i))}contract(t){return new Z(this.at(t),this.at(1-t))}equals(t,e,s=!1){return t.type!=="segment"?!1:this.p1.equals(t.p1,e)&&this.p2.equals(t.p2,e)||!s&&this.p1.equals(t.p2,e)&&this.p2.equals(t.p1,e)}},Vw=180/Math.PI,am=Math.PI/180;function ar(n){return n*am}var Pt=class{constructor(t,e,s){this.a=t,this.b=e,this.c=s,this.type="angle"}static fromDegrees(t){return Pt.fromRadians(t*(Math.PI/180))}static fromRadians(t){let e=new d(1,0),s=e.rotate(t);return new Pt(e,E,s)}get rad(){let t=Math.atan2(this.a.y-this.b.y,this.a.x-this.b.x),s=Math.atan2(this.c.y-this.b.y,this.c.x-this.b.x)-t;return s<0&&(s+=te),s}get deg(){return this.rad*180/Math.PI}get isRight(){return C(this.rad,Math.PI/2,Math.PI/360)}get bisector(){if(this.b.equals(this.a)||this.b.equals(this.c))return;let t=Math.atan2(this.a.y-this.b.y,this.a.x-this.b.x),e=Math.atan2(this.c.y-this.b.y,this.c.x-this.b.x),s=(t+e)/2;t>e&&(s+=Math.PI);let i=Math.cos(s)+this.b.x,o=Math.sin(s)+this.b.y;return new dt(this.b,new d(i,o))}get sup(){return this.rad<Math.PI?this:new Pt(this.c,this.b,this.a)}get arc(){return new ve(this.b,this.a,this.rad)}project(){return this.c}at(){return this.c}contains(){return!1}transform(t){return new Pt(this.a.transform(t),this.b.transform(t),this.c.transform(t))}rotate(t,e){return C(t,0)?this:new Pt(this.a.rotate(t,e),this.b.rotate(t,e),this.c.rotate(t,e))}reflect(t){return new Pt(this.a.reflect(t),this.b.reflect(t),this.c.reflect(t))}scale(t,e=t){return new Pt(this.a.scale(t,e),this.b.scale(t,e),this.c.scale(t,e))}shift(t,e=t){return new Pt(this.a.shift(t,e),this.b.shift(t,e),this.c.shift(t,e))}translate(t){return new Pt(this.a.translate(t),this.b.translate(t),this.c.translate(t))}equals(t){return!1}},gs=1e-6;function hr(n,t,e){let s=(e.x-t.x)*(n.y-t.y),i=(e.y-t.y)*(n.x-t.x);return s-i>=-gs}function sc(n,t,e){let s=n.y-t.y,i=e.x-t.x,o=n.x-t.x,r=e.y-t.y,a=o*i+s*r;if(a<gs)return!1;let h=i*i+r*r;return a-h<=-gs}function ic(n,t){return C(n.x,t.x)?C(n.y,t.y)?0:n.y<t.y?-1:1:n.x<t.x?-1:1}function nc(n){return n<=-gs?-2:n<gs?-1:n-1<=-gs?0:n-1<gs?1:2}function hm(n,t,e,s){let i=t.x-n.x,o=t.y-n.y,r=s.x-e.x,a=s.y-e.y,h=i*a-o*r;if(C(h,0))return!1;let l=n.x-e.x,p=n.y-e.y,u=(r*p-a*l)/h,m=(i*p-o*l)/h,g=new d(n.x+u*i,n.y+u*o);return{alongA:nc(u),alongB:nc(m),pt:g}}var ws=class{constructor(){this.root={root:!0,next:void 0}}exists(t){return t!==void 0&&t!==this.root}get head(){return this.root.next}insertBefore(t,e){let s=this.root,i=this.root.next;for(;i;){if(e(i)){t.prev=i.prev,t.next=i,i.prev.next=t,i.prev=t;return}s=i,i=i.next}s.next=t,t.prev=s,t.next=void 0}findTransition(t){let e=this.root,s=this.root.next;for(;s&&!t(s);)e=s,s=s.next;return{before:e===this.root?void 0:e,after:s,insert:i=>(i.prev=e,i.next=s,e.next=i,s&&(s.prev=i),i)}}static node(t){let e=t;return e.remove=()=>{e.prev&&(e.prev.next=e.next),e.next&&(e.next.prev=e.prev),e.prev=e.next=void 0},e}};function lr(n,t,e){let s={above:e.myFill.above,below:e.myFill.below};return{start:n,end:t,myFill:s}}function lm(n,t,e,s,i,o){let r=ic(t,i);return r!==0?r:d.equals(e,o)?0:n!==s?n?1:-1:hr(e,s?i:o,s?o:i)?1:-1}function cr(n,t,e){n.insertBefore(t,s=>lm(!!t.isStart,t.pt,e,!!s.isStart,s.pt,s.other.pt)<0)}function cm(n,t,e){let s=ws.node({isStart:!0,pt:t.start,seg:t,primary:e});return cr(n,s,t.end),s}function dm(n,t,e,s){let i=ws.node({pt:e.end,seg:e,primary:s,other:t});t.other=i,cr(n,i,t.pt)}function kn(n,t,e){let s=cm(n,t,e);return dm(n,s,t,e),s}function pm(n,t,e){t.other.remove(),t.seg.end=e,t.other.pt=e,cr(n,t.other,t.pt)}function ae(n,t,e){let s=lr(e,t.seg.end,t.seg);return pm(n,t,e),kn(n,s,!!t.primary)}function um(n,t){let e=n.seg.start,s=n.seg.end,i=t.seg.start,o=t.seg.end;return d.colinear(e,i,o)?d.colinear(s,i,o)||hr(s,i,o)?1:-1:hr(e,i,o)?1:-1}function dr(n,t,e){let s=t.seg,i=e.seg,o=s.start,r=s.end,a=i.start,h=i.end,l=hm(o,r,a,h);if(l===!1){if(!d.colinear(o,r,a)||d.equals(o,h)||d.equals(r,a))return!1;let p=d.equals(o,a),u=d.equals(r,h);if(p&&u)return e;let m=!p&&sc(o,a,h),g=!u&&sc(r,a,h);if(p)return g?ae(n,e,r):ae(n,t,h),e;m&&(u||(g?ae(n,e,r):ae(n,t,h)),ae(n,e,o))}else l.alongA===0&&(l.alongB===-1?ae(n,t,a):l.alongB===0?ae(n,t,l.pt):l.alongB===1&&ae(n,t,h)),l.alongB===0&&(l.alongA===-1?ae(n,e,o):l.alongA===0?ae(n,e,l.pt):l.alongA===1&&ae(n,e,r));return!1}function oc(n,t){var e,s;let i=new ws,o=[];for(;n.head;){let r=n.head;if(r.isStart){let p=function(){if(h){let m=dr(n,r,h);if(m)return m}return l?dr(n,r,l):!1},a=i.findTransition(m=>um(r,m.ev)>0),h=(e=a.before)===null||e===void 0?void 0:e.ev,l=(s=a.after)===null||s===void 0?void 0:s.ev,u=p();if(u&&(t?(r.seg.myFill.below?r.seg.myFill.above!==r.seg.myFill.below:!0)&&(u.seg.myFill.above=!u.seg.myFill.above):u.seg.otherFill=r.seg.myFill,r.other.remove(),r.remove()),n.head!==r)continue;if(t){let m=r.seg.myFill.below?r.seg.myFill.above!==r.seg.myFill.below:!0;r.seg.myFill.below=l?l.seg.myFill.above:!1,r.seg.myFill.above=m?!r.seg.myFill.below:r.seg.myFill.below}else if(r.seg.otherFill===void 0){let m=l?r.primary===l.primary?l.seg.otherFill.above:l.seg.myFill.above:!1;r.seg.otherFill={above:m,below:m}}r.other.status=a.insert(ws.node({ev:r}))}else{let a=r.status;if(a===void 0)throw new Error("[Euclid.js] Zero-length segment detected!");if(i.exists(a.prev)&&i.exists(a.next)&&dr(n,a.prev.ev,a.next.ev),a.remove(),!r.primary){let h=r.seg.myFill;r.seg.myFill=r.seg.otherFill,r.seg.otherFill=h}o.push(r.seg)}n.head.remove()}return o}function fm(n){let t=[],e=[];return n.forEach(s=>{let i=s.start,o=s.end;if(d.equals(i,o))return;let r={index:0,matchesHead:!1,matchesPt1:!1},a={index:0,matchesHead:!1,matchesPt1:!1},h=r;function l(w,y,$){h.index=w,h.matchesHead=y,h.matchesPt1=$;let x=h===r;return h=x?a:void 0,!x}for(let w=0;w<t.length;w++){let y=t[w],$=y[0],x=I(y);if(d.equals($,i)){if(l(w,!0,!0))break}else if(d.equals($,o)){if(l(w,!0,!1))break}else if(d.equals(x,i)){if(l(w,!1,!0))break}else if(d.equals(x,o)&&l(w,!1,!1))break}if(h===r){t.push([i,o]);return}if(h===a){let w=r.index,y=r.matchesPt1?o:i,$=r.matchesHead,x=t[w],T=$?x[0]:x[x.length-1],ft=$?x[1]:x[x.length-2],ue=$?x[x.length-1]:x[0],Ee=$?x[x.length-2]:x[1];if(d.colinear(ft,T,y)&&($?x.shift():x.pop(),T=ft),d.equals(ue,y)){t.splice(w,1),d.colinear(Ee,ue,T)&&($?x.pop():x.shift()),e.push(x);return}$?x.unshift(y):x.push(y);return}function p(w){t[w].reverse()}function u(w,y){let $=t[w],x=t[y],T=$[$.length-1],ft=$[$.length-2],ue=x[0],Ee=x[1];d.colinear(ft,T,ue)&&($.pop(),T=ft),d.colinear(T,ue,Ee)&&x.shift(),t[w]=$.concat(x),t.splice(y,1)}let m=r.index,g=a.index,b=t[m].length<t[g].length;r.matchesHead?a.matchesHead?b?(p(m),u(m,g)):(p(g),u(g,m)):u(g,m):a.matchesHead?u(m,g):b?(p(m),u(g,m)):(p(g),u(m,g))}),e}function mm(n,t){let e=[];for(let s of n){let i=(s.myFill.above?8:0)+(s.myFill.below?4:0)+(s.otherFill&&s.otherFill.above?2:0)+(s.otherFill&&s.otherFill.below?1:0);t[i]!==0&&e.push({start:s.start,end:s.end,myFill:{above:t[i]===1,below:t[i]===2}})}return e}function rc(n){let t=new ws;for(let e of n)for(let s=0;s<e.length;s++){let i=s?e[s-1]:I(e),o=e[s],r=ic(i,o);if(r===0)continue;let a=r<0?i:o,h=r<0?o:i;kn(t,{start:a,end:h,myFill:{}},!0)}return oc(t,!0)}function pr(n,t,e){let s=new ws;for(let o of rc(n))kn(s,lr(o.start,o.end,o),!0);for(let o of rc(t))kn(s,lr(o.start,o.end,o),!1);let i=mm(oc(s,!1),e);return fm(i)}var gm=[0,2,1,0,2,2,0,0,1,0,1,0,0,0,0,0],wm=[0,0,0,0,0,2,0,2,0,0,1,1,0,2,1,0],vm=[0,0,0,0,2,0,2,0,1,1,0,0,0,1,2,0],ym=(n,t)=>pr(n,t,gm),bm=(n,t)=>pr(n,t,wm),$m=(n,t)=>pr(n,t,vm),B=class{constructor(t=E,e=1){this.c=t,this.r=e,this.type="circle"}get circumference(){return te*this.r}get area(){return Math.PI*this.r**2}get arc(){let t=this.c.shift(this.r,0);return new ve(this.c,t,te)}tangentAt(t){let e=this.at(t),s=this.c.rotate(Math.PI/2,e);return new dt(e,s)}collision(t){let e=this.c.x<t.p.x?t.p.x:this.c.x>t.p.x+t.w?t.p.x+t.w:this.c.x,s=this.c.y<t.p.y?t.p.y:this.c.y>t.p.y+t.h?t.p.y+t.h:this.c.y;return d.distance(this.c,new d(e,s))<=this.r}project(t){let e=t.subtract(this.c).unitVector.scale(this.r);return d.sum(this.c,e)}at(t){let e=te*t;return this.c.shift(this.r*Math.cos(e),this.r*Math.sin(e))}contains(t){return d.distance(t,this.c)<=this.r}transform(t){let e=Math.abs(t[0][0])+Math.abs(t[1][1]);return new B(this.c.transform(t),this.r*e/2)}rotate(t,e=E){return C(t,0)?this:new B(this.c.rotate(t,e),this.r)}reflect(t){return new B(this.c.reflect(t),this.r)}scale(t,e=t){return new B(this.c.scale(t,e),this.r*(t+e)/2)}shift(t,e=t){return new B(this.c.shift(t,e),this.r)}translate(t){return this.shift(t.x,t.y)}equals(t,e){return C(this.r,t.r,e)&&this.c.equals(t.c,e)}};function ee(n){return["polygon","polyline","rectangle","triangle"].includes(n.type)}function On(n){return["polygon","triangle"].includes(n.type)}function Ln(n){return n.type==="polyline"}function ur(n){return n.type==="rectangle"}function wt(n){return["line","ray","segment"].includes(n.type)}function fr(n){return n.type==="line"}function xm(n){return n.type==="ray"}function Ys(n){return n.type==="segment"}function et(n){return n.type==="circle"}function he(n){return n.type==="arc"}function Ae(n){return n.type==="sector"}function mr(n){return n.type==="angle"}function vt(n){return n.type==="point"}function Pm(n,t){return C(n.p1.x,n.p2.x)?lt(t.y,n.p1.y,n.p2.y):lt(t.x,n.p1.x,n.p2.x)}function Sm(n,t){return C(n.p1.x,n.p2.x)?(t.y-n.p1.y)/(n.p2.y-n.p1.y)>0:(t.x-n.p1.x)/(n.p2.x-n.p1.x)>0}function Tm(n,t){let e=n.p1.x-n.p2.x,s=n.p1.y-n.p2.y,i=t.p1.x-t.p2.x,o=t.p1.y-t.p2.y,r=e*o-s*i;if(C(r,0))return[];let a=n.p1.x*n.p2.y-n.p1.y*n.p2.x,h=t.p1.x*t.p2.y-t.p1.y*t.p2.x,l=a*i-e*h,p=a*o-s*h;return[new d(l/r,p/r)]}function Cm(n,t){let e=d.distance(n.c,t.c);if(e>n.r+t.r)return[];if(e<Math.abs(n.r-t.r))return[];if(C(e,0)&&C(n.r,t.r))return[];if(C(e,n.r+t.r))return[new dt(n.c,t.c).midpoint];let s=(Qt(n.r)-Qt(t.r)+Qt(e))/(2*e),i=Math.sqrt(Qt(n.r)-Qt(s)),o=(t.c.x-n.c.x)*s/e+(t.c.y-n.c.y)*i/e+n.c.x,r=(t.c.y-n.c.y)*s/e-(t.c.x-n.c.x)*i/e+n.c.y,a=(t.c.x-n.c.x)*s/e-(t.c.y-n.c.y)*i/e+n.c.x,h=(t.c.y-n.c.y)*s/e+(t.c.x-n.c.x)*i/e+n.c.y;return[new d(o,r),new d(a,h)]}function ac(n,t){let e=n.p2.x-n.p1.x,s=n.p2.y-n.p1.y,i=Qt(e)+Qt(s),o=t.c.x,r=t.c.y,a=(n.p1.x-o)*(n.p2.y-r)-(n.p2.x-o)*(n.p1.y-r),h=Qt(t.r)*i-Qt(a);if(h<0)return[];let l=a*s/i,p=-a*e/i;if(C(h,0))return[t.c.shift(l,p)];let u=e*(s<0?-1:1)*Math.sqrt(h)/i,m=Math.abs(s)*Math.sqrt(h)/i;return[t.c.shift(l+u,p+m),t.c.shift(l-u,p-m)]}function Mm(n,t){let e=[];wt(n)&&wt(t)?e=Tm(n,t):wt(n)&&et(t)?e=ac(n,t):et(n)&&wt(t)?e=ac(t,n):et(n)&&et(t)&&(e=Cm(n,t));for(let s of[n,t])s.type==="segment"&&(e=e.filter(i=>Pm(s,i))),s.type==="ray"&&(e=e.filter(i=>Sm(s,i)));return e}function St(...n){if(n.length<2)return[];if(n.length>2)return Ut(ql(n,2).map(s=>St(...s)));let[t,e]=n;if(ee(e)&&([t,e]=[e,t]),ee(t)){let s=wt(e)?t.points.filter(i=>e.contains(i)):[];for(let i of t.edges)s.push(...St(i,e));return s}return Mm(t,e)}var O=class{constructor(...t){this.type="polygon",this.points=t}get circumference(){if(this.points.length<=1)return 0;let t=d.distance(this.points[0],I(this.points));for(let e=1;e<this.points.length;++e)t+=d.distance(this.points[e-1],this.points[e]);return t}get signedArea(){let t=this.points,e=t.length,s=t[e-1].x*t[0].y-t[0].x*t[e-1].y;for(let i=1;i<e;++i)s+=t[i-1].x*t[i].y-t[i].x*t[i-1].y;return s/2}get area(){return Math.abs(this.signedArea)}get centroid(){let t=this.points,e=t.length,s=0;for(let o=0;o<e;++o)s+=t[o].x;let i=0;for(let o=0;o<e;++o)i+=t[o].y;return new d(s/e,i/e)}get edges(){let t=this.points,e=t.length,s=[];for(let i=0;i<e;++i)s.push(new Z(t[i],t[(i+1)%e]));return s}get radius(){let t=this.centroid,e=this.points.map(s=>d.distance(s,t));return Math.max(...e)}get oriented(){if(this.signedArea>=0)return this;let t=[...this.points].reverse();return new this.constructor(...t)}cut(t){let e=this.radius/t.length*10,s=t.at(-e),i=t.at(e),o=t.perpendicularVector.scale(t.length*e),r=[s,i,i.add(o),s.add(o)],a=bm([this.points],[r]),h=$m([this.points],[r]);return[...a,...h].map(l=>new O(...l))}static collision(t,e){if(t.points.some(s=>e.contains(s))||e.points.some(s=>t.contains(s)))return!0;for(let s of t.edges)for(let i of e.edges)if(St(s,i)[0])return!0;return!1}static union(...t){let[e,...s]=t;if(!s.length)return[e];let i=[e.points],o=s.length>1?O.union(...s).map(r=>r.points):[t[1].points];return ym(i,o).map(r=>new O(...r))}static regular(t,e=1){let s=te/t,i=Math.PI/2-s/2,o=_(r=>d.fromPolar(i+s*r,e),t);return new O(...o)}static interpolate(t,e,s=.5){let i=t.points.map((o,r)=>d.interpolate(o,e.points[r],s));return new O(...i)}static convexHull(...t){if(t.length<=3)return new O(...t);let e=t.sort((r,a)=>r.x!==a.x?r.x-a.x:r.y-a.y),s=e.slice(0).reverse(),i=[],o=[];for(let[r,a]of[[e,i],[s,o]]){for(let h of r){for(;a.length>=2;){let l=a[a.length-1],p=a[a.length-2];if((l.x-p.x)*(h.y-p.y)>=(h.x-p.x)*(l.y-p.y))a.pop();else break}a.push(h)}a.pop()}return new O(...i.concat(o))}contains(t){let e=!1;for(let s of this.edges){if(s.p1.equals(t)||s.contains(t))return!1;if(s.p1.y>t.y==s.p2.y>t.y)continue;let i=(s.p2.x-s.p1.x)/(s.p2.y-s.p1.y);t.x<i*(t.y-s.p1.y)+s.p1.x&&(e=!e)}return e}at(t){return d.interpolateList([...this.points,this.points[0]],t)}project(t){let e,s=Infinity;for(let i of this.edges){let o=i.project(t),r=d.distance(t,o);r<s&&(e=o,s=r)}return e||this.points[0]}transform(t){return new this.constructor(...this.points.map(e=>e.transform(t)))}rotate(t,e=E){if(C(t,0))return this;let s=this.points.map(i=>i.rotate(t,e));return new this.constructor(...s)}reflect(t){let e=this.points.map(s=>s.reflect(t));return new this.constructor(...e)}scale(t,e=t){let s=this.points.map(i=>i.scale(t,e));return new this.constructor(...s)}shift(t,e=t){let s=this.points.map(i=>i.shift(t,e));return new this.constructor(...s)}translate(t){return this.shift(t.x,t.y)}equals(t,e,s){let i=this.points.length;if(i!==t.points.length)return!1;let o=s?this:this.oriented,r=s?t:t.oriented;for(let a=0;a<i;++a)if(o.points.every((h,l)=>h.equals(r.points[(l+a)%i],e)))return!0;return!1}},be=class extends O{constructor(){super(...arguments);this.type="polyline"}get length(){let t=0;for(let e=1;e<this.points.length;++e)t+=d.distance(this.points[e-1],this.points[e]);return t}get edges(){let t=[];for(let e=0;e<this.points.length-1;++e)t.push(new Z(this.points[e],this.points[e+1]));return t}},Ai=class extends O{constructor(){super(...arguments);this.type="triangle"}get circumcircle(){let[t,e,s]=this.points,i=2*(t.x*(e.y-s.y)+e.x*(s.y-t.y)+s.x*(t.y-e.y)),o=(t.x**2+t.y**2)*(e.y-s.y)+(e.x**2+e.y**2)*(s.y-t.y)+(s.x**2+s.y**2)*(t.y-e.y),r=(t.x**2+t.y**2)*(s.x-e.x)+(e.x**2+e.y**2)*(t.x-s.x)+(s.x**2+s.y**2)*(e.x-t.x),a=new d(o/i,r/i),h=d.distance(a,this.points[0]);return new B(a,h)}get incircle(){let t=this.edges,e=t.map(u=>u.length),s=e[0]+e[1]+e[2],[i,o,r]=this.points,a=e[1]*i.x+e[2]*o.x+e[0]*r.x,h=e[1]*i.y+e[2]*o.y+e[0]*r.y,l=new d(a/s,h/s),p=l.distanceFromLine(t[0]);return new B(l,p)}get orthocenter(){let[t,e,s]=this.points,i=new dt(t,e).perpendicular(s),o=new dt(t,s).perpendicular(e);return St(i,o)[0]}},S=class{constructor(t,e=1,s=e){this.p=t,this.w=e,this.h=s,this.type="rectangle"}static aroundPoints(t){let e=Infinity,s=-Infinity,i=Infinity,o=-Infinity;for(let r of t)e=e<r.x?e:r.x,s=s>r.x?s:r.x,i=i<r.y?i:r.y,o=o>r.y?o:r.y;return new S(new d(e,i),s-e,o-i)}get center(){return new d(this.p.x+this.w/2,this.p.y+this.h/2)}get centroid(){return this.center}get circumference(){return 2*Math.abs(this.w)+2*Math.abs(this.h)}get area(){return Math.abs(this.w*this.h)}get edges(){return this.polygon.edges}get points(){return this.polygon.points}get polygon(){let t=new d(this.p.x+this.w,this.p.y),e=new d(this.p.x+this.w,this.p.y+this.h),s=new d(this.p.x,this.p.y+this.h);return new O(this.p,t,e,s)}collision(t){return this.p.x<t.p.x+t.w&&this.p.x+this.w>t.p.x&&this.p.y<t.p.y+t.h&&this.p.y+this.h>t.p.y}contains(t,e){return lt(t.x,this.p.x,this.p.x+this.w,e)&&lt(t.y,this.p.y,this.p.y+this.h,e)}project(t){let e;for(let s of this.edges){let i=s.project(t);(!e||d.distance(t,i)<d.distance(t,e))&&(e=i)}return e}at(t){return this.p}transform(t){return this.polygon.transform(t)}rotate(t,e=E){return C(t,0)?this:this.polygon.rotate(t,e)}reflect(t){return this.polygon.reflect(t)}scale(t,e=t){return new S(this.p.scale(t,e),this.w*t,this.h*e)}shift(t,e=t){return new S(this.p.shift(t,e),this.w,this.h)}translate(t){return this.shift(t.x,t.y)}equals(t){return!1}},pt=class{constructor(t,e,s,i){this.xMin=t,this.xMax=e,this.yMin=s,this.yMax=i}contains(t){return this.containsX(t)&&this.containsY(t)}containsX(t){return lt(t.x,this.xMin,this.xMax)}containsY(t){return lt(t.y,this.yMin,this.yMax)}resize(t,e){return new pt(this.xMin,this.xMax+t,this.yMin,this.yMax+e)}get dx(){return this.xMax-this.xMin}get dy(){return this.yMax-this.yMin}get xRange(){return[this.xMin,this.xMax]}get yRange(){return[this.yMin,this.yMax]}get rect(){return new S(new d(this.xMin,this.yMin),this.dx,this.dy)}get center(){return new d(this.xMin+this.dx/2,this.yMin+this.dy/2)}get flip(){return new pt(this.yMin,this.yMax,this.xMin,this.xMax)}};function hc(n,t,e={}){if(e.fill&&(n.fillStyle=e.fill),e.opacity&&(n.globalAlpha=e.opacity),e.stroke&&(n.strokeStyle=e.stroke,n.lineWidth=e.strokeWidth||1,e.lineCap&&(n.lineCap=e.lineCap),e.lineJoin&&(n.lineJoin=e.lineJoin)),n.beginPath(),Ys(t))n.moveTo(t.p1.x,t.p1.y),n.lineTo(t.p2.x,t.p2.y);else if(et(t))n.arc(t.c.x,t.c.y,t.r,0,te);else if(On(t)){n.moveTo(t.points[0].x,t.points[0].y);for(let s of t.points.slice(1))n.lineTo(s.x,s.y);n.closePath()}else if(Ln(t)){n.moveTo(t.points[0].x,t.points[0].y);for(let s of t.points.slice(1))n.lineTo(s.x,s.y)}e.fill&&n.fill(),e.stroke&&n.stroke()}function gr(n,t,e){let i=t.x*(e.y-n.y)+n.x*(t.y-e.y)+e.x*(n.y-t.y)>0?1:0,o=d.distance(t,n);return[n.x,n.y+"A"+o,o,0,i,1,e.x,e.y].join(",")}function wr(n,t={}){return n.isRight&&!t.round?20:24+20*(1-M(n.rad,0,Math.PI)/Math.PI)}function Em(n,t={}){let e=n.a,s=n.b,i=n.c,o=t.size||wr(n,t),r=d.difference(e,s).unitVector,a=d.difference(i,s).unitVector;e=d.sum(s,r.scale(o)),i=d.sum(s,a.scale(o));let h=t.fill?`M${s.x},${s.y}L`:"M";if(n.isRight&&!t.round){let l=d.sum(e,a.scale(o));h+=`${e.x},${e.y}L${l.x},${l.y}L${i.x},${i.y}`}else h+=gr(e,s,i);return t.fill&&(h+="Z"),h}function Kt(...n){return"M"+n.map(t=>t.x+","+t.y).join("L")}function lc(n,t){let e=n.perpendicularVector.scale(6),s=n.unitVector.scale(3),i=n.midpoint;switch(t){case"bar":return Kt(i.add(e),i.add(e.inverse));case"bar2":return Kt(i.add(s).add(e),i.add(s).add(e.inverse))+Kt(i.add(s.inverse).add(e),i.add(s.inverse).add(e.inverse));case"arrow":return Kt(i.add(s.inverse).add(e),i.add(s),i.add(s.inverse).add(e.inverse));case"arrow2":return Kt(i.add(s.scale(-2)).add(e),i,i.add(s.scale(-2)).add(e.inverse))+Kt(i.add(e),i.add(s.scale(2)),i.add(e.inverse));default:return""}}function Rn(n,t){if(!n||!t)return"";let e=t.perpendicular,s=n.add(t.scale(9)).add(e.scale(9)),i=n.add(t.scale(9)).add(e.scale(-9));return Kt(s,n,i)}function Vm(n,t){let e="";return F(t,"start","both")&&(e+=Rn(n.p1,n.unitVector)),F(t,"end","both")&&(e+=Rn(n.p2,n.unitVector.inverse)),e}function Am(n,t){let e="";if(F(t,"start","both")){let s=new dt(n.c,n.start).perpendicularVector.inverse;e+=Rn(n.start,s)}if(F(t,"end","both")){let s=new dt(n.c,n.end).perpendicularVector;e+=Rn(n.end,s)}return e}function $e(n,t={}){if(mr(n))return Em(n,t);if(Ys(n)){if(n.p1.equals(n.p2))return"";let e=Kt(n.p1,n.p2);return t.mark&&(e+=lc(n,t.mark)),t.arrows&&(e+=Vm(n,t.arrows)),e}if(xm(n)){if(!t.box)return"";let e=St(n,t.box)[0];return e?Kt(n.p1,e):""}if(fr(n)){if(!t.box)return"";let e=St(n,t.box);if(e.length<2)return"";let s=Kt(e[0],e[1]);return t.mark&&(s+=lc(n,t.mark)),s}if(et(n))return`M ${n.c.x-n.r} ${n.c.y} a ${n.r},${n.r} 0 1 0 ${2*n.r} 0 a ${n.r} ${n.r} 0 1 0 ${-2*n.r} 0`;if(he(n)){let e="M"+gr(n.start,n.c,n.end);return t.arrows&&(e+=Am(n,t.arrows)),e}return Ae(n)?`M ${n.c.x} ${n.c.y} L ${gr(n.start,n.c,n.end)} Z`:Ln(n)?Kt(...n.points):On(n)?Kt(...n.points)+"Z":ur(n)?Kt(...n.polygon.points)+"Z":""}function xe(n,t,e,s){function i(o){return o instanceof e?o:new e(function(r){r(o)})}return new(e||(e=Promise))(function(o,r){function a(p){try{l(s.next(p))}catch(u){r(u)}}function h(p){try{l(s.throw(p))}catch(u){r(u)}}function l(p){p.done?o(p.value):i(p.value).then(a,h)}l((s=s.apply(n,t||[])).next())})}function km(n){let t=[];for(let e of Object.keys(n)){let s=n[e];if(e=encodeURIComponent(e),s==null){t.push(e);continue}s=Array.isArray(s)?s.join(","):""+s,s=s.replace(/(\r)?\n/g,`\r
`),s=encodeURIComponent(s),s=s.replace(/%20/g,"+"),t.push(e+"="+s)}return t.join("&")}function cc(n){n=n.replace(/^[?,&]/,"");let t=decodeURIComponent(n).split("&"),e={};return t.forEach(s=>{let i=s.split("=");e[i[0]]=i[1]}),e}function ke(n,t){return xe(this,void 0,void 0,function*(){let e=t instanceof FormData,s={method:"POST",body:e?t:t?km(t):void 0,headers:{"X-CSRF-Token":window.csrfToken||""}};e||(s.headers["Content-Type"]="application/x-www-form-urlencoded");let i=n.includes("?")?"&xhr=1":"?xhr=1",o=yield fetch(n+i,s);if(!o.ok)throw new Error(`Fetch error ${o.status}: ${n}`);return o.text()})}function In(n,t=!1){return new Promise(e=>{let s=new Image;t||(s.crossOrigin="Anonymous"),s.onload=()=>e(s),s.src=n})}var ki=new Map;function dc(n,t){ki.has(n)?Jo(ki.get(n),t,(e,s)=>Wt(e.concat(s))):ki.set(n,t)}function pc(){if(!!window.navigator.onLine)for(let[n,t]of ki)ki.delete(n),ke(n,{data:JSON.stringify(t)}).catch(e=>{console.error("Failed to send POST request:",e),dc(n,t)})}var uc=ls(pc,5e3);window.addEventListener("online",uc);window.onbeforeunload=pc;function fc(n,t){dc(n,t),uc()}var gt;(function(n){n[n.Array=0]="Array",n[n.BinaryOp=1]="BinaryOp",n[n.Call=2]="Call",n[n.Conditional=3]="Conditional",n[n.Identifier=4]="Identifier",n[n.Literal=5]="Literal",n[n.Member=6]="Member",n[n.UnaryOp=7]="UnaryOp"})(gt||(gt={}));var mc={"===":(n,t)=>n===t,"!==":(n,t)=>n!==t,"||":(n,t)=>n||t,"&&":(n,t)=>n&&t,"==":(n,t)=>n==t,"!=":(n,t)=>n!=t,"<=":(n,t)=>n<=t,">=":(n,t)=>n>=t,"**":(n,t)=>Math.pow(n,t),"<":(n,t)=>n<t,">":(n,t)=>n>t,"+":(n,t)=>n+t,"-":(n,t)=>n-t,"*":(n,t)=>n*t,"/":(n,t)=>n/t,"%":(n,t)=>n%t},gc={"-":n=>-n,"+":n=>+n,"!":n=>!n},wc={"||":1,"&&":2,"==":3,"!=":3,"===":3,"!==":3,"<":4,">":4,"<=":4,">=":4,"+":5,"-":5,"*":6,"/":6,"%":6,"**":7},vc={true:!0,false:!1,undefined:void 0},Om=/\s/,vr=/[0-9]/,yr=/[a-zA-ZÎ±-Ï‰Î‘-Î©$_]/,Lm=/[0-9a-zA-ZÎ±-Ï‰Î‘-Î©$_]/;function Rm(n){let t=n.length,e=0;function s(w){throw new Error(`${w} at character ${e} of "${n}"`)}function i(){for(;Om.test(n[e]);)e+=1}function o(){let w="";for(;vr.test(n[e]);)w+=n[e++];if(n[e]===".")for(w+=n[e++];vr.test(n[e]);)w+=n[e++];let y=n[e];if(y&&yr.test(y)){let $=w+n[e];s(`Variable names cannot start with a number (${$})`)}else y==="."&&s("Unexpected period");return{type:gt.Literal,value:parseFloat(w)}}function r(){let w=n[e];e+=1;let y=!1,$="";for(;e<t;){let x=n[e++];if(x===w){y=!0;break}$+=x}return y||s(`Unclosed quote after "${$}"`),{type:gt.Literal,value:$}}function a(){let w=n[e];for(yr.test(n[e])||s("Unexpected "+w),e+=1;e<t&&Lm.test(n[e]);)w+=n[e++];return w in vc?{type:gt.Literal,value:vc[w]}:{type:gt.Identifier,name:w}}function h(w){let y=[],$=!1,x;for(;e<t;)if(n[e]===w){x&&y.push(x),$=!0,e+=1;break}else n[e]===","?(y.push(x||{type:gt.Literal,value:void 0}),e+=1):x=g();return $||s("Expected "+w),y}function l(){let w;if(n[e]==="("){if(e+=1,w=g(),i(),n[e]===")")return e+=1,w;s("Unclosed (")}else w=a();for(i();".[(".includes(n[e]);)n[e]==="."?(e++,i(),w={type:gt.Member,object:w,computed:!1,property:a()}):n[e]==="["?(e++,w={type:gt.Member,object:w,computed:!0,property:g()},i(),n[e]!=="]"&&s("Unclosed ["),e++):n[e]==="("&&(e++,w={type:gt.Call,args:h(")"),callee:w}),i();return w}function p(){i();for(let w of[3,2,1]){let y=n.substr(e,w);if(y in mc)return e+=w,y}}function u(){i();let w=n[e];if(vr.test(w)||w===".")return o();if(w==="'"||w==='"')return r();if(w==="[")return e+=1,{type:gt.Array,elements:h("]")};if(w in gc)return e+=1,{type:gt.UnaryOp,operator:w,argument:u()};if(yr.test(w)||w==="(")return l();s("Expression parsing error")}function m(){let w=u(),y=p();if(!y)return w;let $=u();$||s("Expected expression after "+y);let x,T=[w,y,$];for(;y=p();){let ue=wc[y],Ee=y;for(;T.length>2&&ue<=wc[T[T.length-2]];)$=T.pop(),y=T.pop(),w=T.pop(),x={type:gt.BinaryOp,operator:y,left:w,right:$},T.push(x);x=u(),x||s("Expected expression after "+Ee),T.push(Ee,x)}let ft=T.length-1;for(x=T[ft];ft>1;)x={type:gt.BinaryOp,operator:T[ft-1],left:T[ft-2],right:x},ft-=2;return x}function g(){let w=m();if(i(),w&&n[e]==="?"){e+=1;let y=g();if(y||s("Expected expression"),i(),n[e]===":"){e++;let $=g();return $||s("Expected expression"),{type:gt.Conditional,test:w,consequent:y,alternate:$}}else s("Expected :")}else return w}let b=g();return e<n.length&&s(`Unexpected "${n[e]}"`),b}var Nn=[void 0,void 0];function se(n,t,e){switch(n.type){case gt.Array:let s=n.elements.map(b=>se(b,t,e)[0]);return s.some(b=>b===void 0)?Nn:[s,void 0];case gt.BinaryOp:let i=se(n.left,t,e)[0],o=se(n.right,t,e)[0];return"+-**/%".includes(n.operator)&&(i===void 0||o===void 0)?Nn:[mc[n.operator](i,o),void 0];case gt.Call:let[r,a]=se(n.callee,t,e),h=n.args.map(b=>se(b,t,e)[0]);return h.some(b=>b===void 0)||typeof r!="function"?Nn:[r.apply(a,h),void 0];case gt.Conditional:let l=se(n.consequent,t,e),p=se(n.alternate,t,e);return se(n.test,t,e)[0]?l:p;case gt.Identifier:return[e[n.name]||t[n.name],void 0];case gt.Literal:return[n.value,void 0];case gt.Member:let u=se(n.object,t,e)[0],m=n.computed?se(n.property,t,e)[0]:n.property.name;return u?[u[m],u]:[void 0,void 0];case gt.UnaryOp:let g=se(n.argument,t,e)[0];return g===void 0&&n.operator!=="!"?Nn:[gc[n.operator](g),void 0]}}function yt(n){let t=Rm(n);return t?(e={},s={})=>se(t,e,s)[0]:(e={})=>{}}var Im=/\${([^}]+)}/g;function Dn(n){let t=n.split(Im),e=t.map((s,i)=>i%2?yt(s.replace(/Ã—/g,"*")):void 0);return s=>t.map((i,o)=>{if(!(o%2))return i;let r=e[o](s);return typeof r=="number"&&r<0?"\u2013"+-r:r}).join("")}var Oi="ontouchstart"in window,Js="onpointerdown"in window;function jt(n){if(n.touches){let t=n.targetTouches.length?n.targetTouches:n.changedTouches;return new d(t[0].clientX,t[0].clientY)}else return new d(n.clientX||0,n.clientY||0)}function Nm(n){return n.touches||[]}function ie(n,t){return jt(n).transform(t.inverseTransformMatrix)}function yc(n,t){let e=jt(n),s=t.bounds,i=(e.x-s.left)*t.canvasWidth/s.width,o=(e.y-s.top)*t.canvasHeight/s.height;return new d(i,o)}function Dm(n){if(n instanceof PointerEvent&&n.pointerType==="mouse")return N(n.target);let t=jt(n);return N(document.elementFromPoint(t.x,t.y)||void 0)}function Gm(n){if(n._data.tapEvent)return;n._data.tapEvent=!0;let t;n.on("pointerdown",e=>t=jt(e)),n.on("pointerup",e=>{if(!t)return;let s=jt(e);d.distance(t,s)<6&&n.trigger("tap",e),t=void 0}),n.on("pointercancel",()=>t=void 0)}function Hm(n){n._data.clickOutsideEvent||(n._data.clickOutsideEvent=!0,q.on("pointerdown",t=>{var e,s;let i=t.target,o=(s=(e=n._el).getRootNode)===null||s===void 0?void 0:s.call(e),r=jt(t);(o==null?void 0:o.host)&&(i=o.elementFromPoint(r.x,r.y)),!(!i||n._el===i||n._el.contains(i))&&n.trigger("clickOutside",t)}))}function Ze(n,t){let e=t.$box||n,s=jt;e.type==="svg"?s=m=>ie(m,e.$ownerSVG):e.type==="canvas"&&(s=m=>yc(m,e));let i=t.justInside?n:q,o,r,a=!1,h=0;n.css("touch-action")==="auto"&&n.css("touch-action","none"),n.addClass("noselect");function l(m){m.handled||Nm(m).length>1||(m.preventDefault(),a=!1,h=m.pointerId||0,i.on("pointermove",p),i.on("pointerstop",u),o=r=s(m),t.down&&t.down(o))}function p(m){if(!o||h&&m.pointerId!==h)return;m.preventDefault();let g=s(m);d.distance(g,r)<.5||(!a&&t.start&&t.start(o),t.move&&t.move(g,o,r),r=g,a=!0)}function u(m,g=!1){!o||h&&m.pointerId!==h||(m.preventDefault(),i.off("pointermove",p),i.off("pointerstop",u),t.up&&t.up(r,o),a&&t.end&&t.end(r,o),!a&&t.click&&!g&&t.click(o),o=void 0)}v.onKey("escape",()=>{if(!o)return;a&&t.move&&t.move(o,o,r),r=o;let m=document.createEvent("MouseEvent");m.pointerId=h,u(m,!0)}),n.on("pointerdown",l),t.justInside&&n.on("mouseleave",u),t.accessible&&(n.setAttr("tabindex","0"),document.addEventListener("keydown",m=>{if(![37,38,39,40].includes(m.keyCode)||n!==v.getActiveInput())return;let g=n.boxCenter,b=s({clientX:g.x,clientY:g.y}),w=m.keyCode===37?-25:m.keyCode===39?25:0,y=m.keyCode===38?-25:m.keyCode===40?25:0,$=b.shift(w,y);t.down&&t.down(b),t.start&&t.start(b),t.move&&t.move($,b,b),t.end&&t.end($,b)}))}function bc(n,t){let e=jt;n.type==="svg"?e=i=>ie(i,n.$ownerSVG):n.type==="canvas"&&(e=i=>yc(i,n));let s=!1;n.on("touchstart mouseenter",i=>{!s&&t.enter&&t.enter(),t.move&&t.move(e(i)),s=!0},{passive:!0}),n.on("pointermove",i=>{s&&t.move&&t.move(e(i))}),n.on("touchend mouseleave",()=>{s&&t.exit&&t.exit(),s=!1},{passive:!0})}function qm(n){if(n._data.scrollEvents)return;n._data.scrollEvents=!0;let t=!1,e;function s(){let h=n.scrollTop;if(h===e){t=!1;return}e=h,n.trigger("scroll",{top:e}),window.requestAnimationFrame(s)}function i(){t||window.requestAnimationFrame(s),t=!0}(n.type==="window"?window:n._el).addEventListener("scroll",i);function r(){window.addEventListener("touchmove",i),window.addEventListener("touchend",a)}function a(){window.removeEventListener("touchmove",i),window.removeEventListener("touchend",a)}n._el.addEventListener("touchstart",function(h){h.handled||r()})}function Qs(n,t){let e=t.$clickTarget||n,s=0,i=!1,o=!1,r=!1;function a(){i||(t.enter&&t.enter(),i=!0)}function h(){!i||(clearTimeout(s),t.exit&&t.exit(),i=!1)}n.on("mouseover",()=>{t.preventMouseover&&t.preventMouseover()||(clearTimeout(s),s=ge(()=>{a(),o=!0},t.delay))}),n.on("mouseout",()=>{!o||(clearTimeout(s),s=ge(h,t.exitDelay||t.delay))}),e.on("focus",()=>{i||t.preventMouseover&&t.preventMouseover()||(clearTimeout(s),a(),r=!0)});let l=()=>{!r||(t.canFocusWithin?setTimeout(()=>{let p=v.getActiveInput();p&&p.hasParent(n)?p.one("blur",l):h()}):h())};e.on("blur",l),e.on("click",()=>{i&&!o?h():i||(a(),o=!1)}),n.on("clickOutside",h)}var br;function _m(n){for(let t of n){let e=t.isIntersecting?"enterViewport":"exitViewport";setTimeout(()=>N(t.target).trigger(e))}}function $c(n){if(!n._data.intersectionEvents){if(n._data.intersectionEvents=!0,!window.IntersectionObserver){let t=!1;q.on("scroll",()=>{let e=n.isInViewport;t&&!e?(n.trigger("exitViewport"),t=!1):e&&!t&&(n.trigger("enterViewport"),t=!0)});return}br||(br=new IntersectionObserver(_m)),br.observe(n._el)}}function Bm(n,t=!1){if(t&&(n._data.resizeObserver&&n._data.resizeObserver.disconnect(),n._data.resizeObserver=void 0),!n._data.resizeObserver){if(window.ResizeObserver){let e=new window.ResizeObserver(()=>n.trigger("resize"));e.observe(n._el),n._data.resizeObserver=e}else if(window.MutationObserver){let e=new MutationObserver(()=>n.trigger("resize"));e.observe(n._el,{attributes:!0,childList:!0,characterData:!0,subtree:!0}),n._data.resizeObserver=e}}}function xc(n){if(n._data.pointerPositionEvents)return;n._data.pointerPositionEvents=!0;let t=n.parent,e;t.on("pointerend",()=>e=void 0),t.on("pointermove",s=>{let i=e,o=Dm(s);e=o.equals(n)||o.hasParent(n),i!=null&&e&&!i&&n.trigger("pointerenter",s),!e&&i&&n.trigger("pointerleave",s)})}function $r(n,t){t._data["_"+n]||(t._data["_"+n]=!0,Js?t.on(n.replace("mouse","pointer"),e=>{e.pointerType==="mouse"&&t.trigger(n,e)}):Oi||t._el.addEventListener(n,e=>t.trigger(n,e)))}function zm(n){n.on("keydown",t=>{if(t.metaKey||t.ctrlKey||v.isAndroid&&t.keyCode===229)return;let e=t.key||String.fromCharCode(t.which),s=e.toLowerCase(),i=!!t.shiftKey;n.trigger("key",{code:t.keyCode,key:s,char:e,shift:i})}),v.isAndroid&&n.type==="input"&&n.on("input",t=>{let e=t.data[t.data.length-1],s=e.toLowerCase();n.trigger("key",{code:void 0,key:s,char:e}),n.value=""})}var Gn={scrollwheel:"DOMMouseScroll mousewheel",pointerdown:Js?"pointerdown":Oi?"touchstart":"mousedown",pointermove:Js?"pointermove":Oi?"touchmove":"mousemove",pointerup:Js?"pointerup":Oi?"touchend":"mouseup",pointercancel:Js?"pointercancel":"touchcancel",pointerstop:Js?"pointerup pointercancel":Oi?"touchend touchcancel":"mouseup"},Hn={scroll:qm,tap:Gm,clickOutside:Hm,key:zm,mousedown:$r.bind(void 0,"mousedown"),mousemove:$r.bind(void 0,"mousemove"),mouseup:$r.bind(void 0,"mouseup"),pointerenter:xc,pointerleave:xc,enterViewport:$c,exitViewport:$c,resize:Bm};function Fm(n,t,e,s){if(t in Hn)Hn[t](n,!1);else if(t in Gn){let i=tt(Gn[t]);for(let o of i)n._el.addEventListener(o,e,s)}else n._el.addEventListener(t,e,s)}function Um(n,t,e){if(t in Hn)(!n._events[t]||!n._events[t].length)&&Hn[t](n,!0);else if(e&&t in Gn){let s=tt(Gn[t]);for(let i of s)n._el.removeEventListener(i,e)}else e&&n._el.removeEventListener(t,e)}var qn=0,xr=new Map;function Pc(n,t){xr.set(n,t)}function jm(n){if(qn++,n(),qn--,qn==0){for(let[t,e]of xr.entries())t(e);xr.clear()}}function Dt(n,t){let e=new Map,s=new Map,i=new Set,o,r=0;function a(x){o=x;let T=x($,!0);return o=void 0,T}function h(x){for(let T of e.values())T.has(x)&&T.delete(x);i.delete(x)}function l(x,T){return i.add(x),T?void 0:x($,!0)}function p(x,T){s.has(x)&&h(s.get(x));let ft=()=>{n[x]=T($),o===ft&&(o=void 0),u(x)};s.set(x,ft),a(ft)}function u(x){if(qn>0){for(let T of e.get(x)||[])Pc(T,n);for(let T of i)Pc(T,n)}else{for(let T of e.get(x)||[])T(n);for(let T of i)T(n)}}function m(){for(let x of e.values())for(let T of x)T(n);for(let x of i)x(n)}function g(x){jm(()=>{for(let[T,ft]of Object.entries(x))$[T]=ft})}function b(){for(r+=1;"_x"+r in n;)r+=1;return"_x"+r}function w(){n={},e.clear(),s.clear(),r=0}function y(x){!t||t.watch(()=>$[x]=t[x])}let $=new Proxy(n,{get(x,T){return T==="watch"?a:T==="unwatch"?h:T==="watchAll"?l:T==="setComputed"?p:T==="forceUpdate"?m:T==="assign"?g:T==="getKey"?b:T==="clear"?w:T==="_internal"?[n,e]:(o&&(e.has(T)||e.set(T,new Set),e.get(T).add(o)),T in n||y(T),n[T])},set(x,T,ft){return n[T]===ft||(n[T]=ft,s.has(T)&&(h(s.get(T)),s.delete(T)),u(T)),!0},deleteProperty(x,T){return delete n[T],e.delete(T),s.delete(T),!0}});return $}var Zm={A:7,C:6,H:1,L:2,M:2,Q:4,S:4,T:2,V:1,Z:0},Wm=/[astvzqmhlc]([^astvzqmhlc]*)/ig,Km=/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/ig;function _n(n){let t=[],e;for(let s of n.match(Wm)||[]){let i=s[0].toUpperCase();if(i==="Z"){t.push({type:"Z",points:[]});continue}let o=(s.slice(1).match(Km)||[]).map(a=>+a),r=i===s[0];for(let[a,h]of js(o,Zm[i]).entries()){let l=[],p=i==="M"&&a>0?"L":i,u;i==="H"?(p="L",l=[new d(h[0],r&&(e==null?void 0:e.y)||0)]):i==="V"?(p="L",l=[new d(r&&(e==null?void 0:e.x)||0,h[0])]):i==="A"?(p="A",l=[new d(h[5],h[6])],u=h.slice(0,5)):"MLCSQT".includes(i)&&(l=js(h,2).map(m=>new d(m[0],m[1]))),!r&&e&&(l=l.map(m=>m.translate(e))),e=I(l),t.push({type:p,points:l,options:u})}}return t}function vs(n){return n?_n(n).map(e=>I(e.points)).filter(e=>!!e):[]}var Li=class{constructor(t){this._el=t,this._data={},this._events={},this.type="default",t._view=this}get id(){return this._el.id}get data(){return this._el.dataset}get tagName(){return this._el.tagName.toUpperCase()}equals(t){return this._el===t._el}addClass(t){for(let e of tt(t))this._el.classList.add(e)}removeClass(t){for(let e of tt(t))this._el.classList.remove(e)}hasClass(t){return this._el.classList.contains(t)}toggleClass(t){return this._el.classList.toggle(t)}setClass(t,e){e?this.addClass(t):this.removeClass(t)}attr(t){return this._el.getAttribute(t)||""}hasAttr(t){return this._el.hasAttribute(t)}setAttr(t,e){e===void 0?this.removeAttr(t):this._el.setAttribute(t,e.toString())}removeAttr(t){this._el.removeAttribute(t)}get attributes(){return Array.from(this._el.attributes||[])}get html(){return this._el.innerHTML||""}set html(t){this._el.innerHTML=t}get text(){return this._el.textContent||""}set text(t){this._el.textContent=t}set textStr(t){this._el.textContent=""+t}blur(){this._el.blur()}focus(){this._el.focus()}getParentModel(){let t=this.parent;return t?t.model||t.getParentModel():void 0}bindModel(t,e=!0){var s;if(!this.model){if(this.model=t,this.hasAttr(":for"))return this.makeDynamicList(t);for(let{name:i,value:o}of this.attributes)this.makeDynamicAttribute(i,o,t);for(let i of this.childNodes)if(i instanceof Text){if((s=i.textContent)===null||s===void 0?void 0:s.includes("${")){let o=Dn(i.textContent);t.watch(()=>i.textContent=o(t)||"")}}else e&&i.bindModel(t)}}bindVariable(t,e){}makeDynamicAttribute(t,e,s){if(t.startsWith("@")){let i=t.slice(1),o=yt(e);this.on(i,r=>o(s,{$event:r}))}else if(t===":show"){let i=yt(e);s.watch(()=>this.toggle(!!i(s)))}else if(t===":if"){let i=yt(e),o=N(document.createComment(""));this.insertBefore(o);let r=!0;s.watch(()=>{let a=!!i(s);a!==r&&(a&&o.insertBefore(this),a||this.detach(),r=a)})}else if(t===":html"){let i=yt(e);s.watch(()=>this.html=i(s)||"")}else if(t===":draw"){let i=yt(e);s.watch(()=>this.draw(i(s)))}else if(t===":class"){let i=yt(e),o=this.attr("class")+" ";s.watch(()=>this.setAttr("class",o+i(s)))}else if(t===":bind")this.bindVariable(s,e);else if(t.startsWith(":")){let i=yt(e),o=t.slice(1);s.watch(()=>this.setAttr(o,i(s)))}else if(e.includes("${")){let i=Dn(e);s.watch(()=>this.setAttr(t,i(s)||""))}(t.startsWith("@")||t.startsWith(":"))&&this.removeAttr(t)}makeDynamicList(t){let[e,s]=this.attr(":for").split(" in ");this.removeAttr(":for");let i=yt(s),o=N(document.createComment(""));this.insertBefore(o),this.detach();let r=[],a=0;t.watch(()=>{let h=i(t);Array.isArray(h)||(h=[]);for(let l=h.length;l<a;++l)r[l].detach();for(let l=a;l<r.length;++l)o.insertBefore(r[l]);for(let l=r.length;l<h.length;++l){let p=this.copy(!0);p.bindModel(Dt({[e]:void 0},t)),o.insertBefore(p),r.push(p)}a=h.length;for(let l=0;l<a;++l)r[l].model[e]=h[l]})}get bounds(){return this._el.getBoundingClientRect()}get boundsRect(){let t=this.bounds;return new S(new d(t.x,t.y),t.width,t.height)}contains(t){return this.boundsRect.contains(t)}get isInViewport(){if(this.height===0)return!1;let t=this.bounds;return lt(t.top,-t.height,v.height)}get topLeftPosition(){let t=this.bounds;return new d(t.left,t.top)}get boxCenter(){let t=this.bounds;return new d(t.left+t.width/2,t.top+t.height/2)}get scrollWidth(){return this._el.scrollWidth}get scrollHeight(){return this._el.scrollHeight}get scrollTop(){return this._el.scrollTop}set scrollTop(t){this._el.scrollTop=t,this.trigger("scroll",{top:t,left:this.scrollLeft})}get scrollLeft(){return this._el.scrollLeft}set scrollLeft(t){this._el.scrollLeft=t,this.trigger("scroll",{top:this.scrollTop,left:t})}scrollTo(t,e=1e3,s="cubic"){t<0&&(t=0);let i=this.scrollTop,o=t-i;this._data.scrollAnimation&&this._data.scrollAnimation.cancel(),this._data.scrollAnimation=z(r=>{let a=i+o*X(s,r);this.scrollTop=a,this.trigger("scroll",{top:a})},e)}scrollBy(t,e=1e3,s="cubic"){!t||this.scrollTo(this.scrollTop+t,e,s)}css(t,e){if(e===void 0){if(typeof t=="string")return window.getComputedStyle(this._el).getPropertyValue(t);{let s=Object.keys(t);for(let i of s)this._el.style.setProperty(i,""+t[i])}}else typeof t=="string"&&this._el.style.setProperty(t,""+e)}get transform(){return this.css("transform").replace("none","")}get transformMatrix(){let t=this.transform;if(!t)return[[1,0,0],[0,1,0]];let e=t.match(/matrix\(([0-9,.\s-]*)\)/);if(!e||!e[1])return[[1,0,0],[0,1,0]];let s=e[1].split(",");return[[+s[0],+s[2],+s[4]],[+s[1],+s[3],+s[5]]]}get scale(){let t=this.transformMatrix;return[t[0][0],t[1][1]]}setTransform(t,e=0,s=1){let i="";t&&(i+=`translate(${st(t.x,.1)}px,${st(t.y,.1)}px)`),e&&(i+=` rotate(${e}rad)`),s&&(i+=` scale(${s})`),this._el.style.transform=i}translate(t,e){this.setTransform(new d(t,e))}show(){this.hasAttr("hidden")&&this.removeAttr("hidden"),this.data.display==="visibility"?this._el.style.visibility="visible":this._el.style.display=this.data.display||"block"}hide(){this.data.display==="visibility"?this._el.style.visibility="hidden":this._el.style.display="none"}toggle(t){t?this.show():this.hide()}is(t){return this._el.matches?this._el.matches(t):Array.from(document.querySelectorAll(t)).includes(this._el)}index(){let t=0,e=this._el;for(;(e=e.previousSibling||void 0)!==void 0;)++t;return t}prepend(t){let e=this._el.childNodes;e.length?this._el.insertBefore(t._el,e[0]):this._el.appendChild(t._el)}append(t){this._el.appendChild(t instanceof Text?t:t._el)}insertBefore(t){this.parent._el.insertBefore(t._el,this._el)}insertAfter(t){let e=this._el.nextSibling;e?this.parent._el.insertBefore(t._el,e):this.parent._el.appendChild(t._el)}get next(){return N(this._el.nextSibling)}get prev(){return N(this._el.previousSibling)}$(t){return N(t,this)}$$(t){return Pe(t,this)}get parent(){return N(this._el.parentElement||void 0)}parents(t){let e=[],s=this.parent;for(;s;)(!t||s.is(t))&&e.push(s),s=s.parent;return e}hasParent(...t){let e=t.map(i=>i._el),s=this._el.parentNode;for(;s;){if(F(s,...e))return!0;s=s.parentNode}return!1}get children(){return Array.from(this._el.children||[],t=>N(t))}get childNodes(){return Array.from(this._el.childNodes,t=>{if(!(t instanceof Comment))return t instanceof Text?t:N(t)}).filter(t=>t)}restartAnimation(){let t=this.next,e=this.parent;this.detach(),t?t.insertBefore(this):e.append(this)}detach(){this._el&&this._el.parentNode&&this._el.parentNode.removeChild(this._el)}remove(){this.detach()}removeChildren(){for(;this._el.firstChild;)this._el.removeChild(this._el.firstChild)}on(t,e,s){for(let i of tt(t))i in this._events?this._events[i].includes(e)||this._events[i].push(e):this._events[i]=[e],Fm(this,i,e,s)}one(t,e,s){let i=o=>{this.off(t,i),e(o)};this.on(t,i,s)}off(t,e){for(let s of tt(t))s in this._events&&(this._events[s]=e?this._events[s].filter(i=>i!==e):[]),Um(this,s,e)}trigger(t,e={}){for(let s of tt(t)){if(!this._events[s])return;for(let i of this._events[s])i.call(this,e)}}onKeyDown(t,e){let s=tt(t).map(i=>Bt[i]||i);this._el.addEventListener("keydown",i=>{s.indexOf(i.keyCode)>=0&&e(i)})}onAttr(t,e){new MutationObserver(i=>{for(let o of i)o.type==="attributes"&&o.attributeName===t&&e(this.attr(t))}).observe(this._el,{attributes:!0}),e(this.attr(t),!0)}onPromise(t,e=!1){return e?Promise.resolve():new Promise(s=>this.one("solve",()=>s()))}animate(t,e=400,s=0,i="ease-in-out"){return zt(this,t,e,s,i)}enter(t="fade",e=500,s=0){return Xm(this,t,e,s)}exit(t="fade",e=500,s=0,i=!1){return Ym(this,t,e,s,i)}effect(t){this.one("animationend",()=>this.removeClass("effects-"+t)),this.addClass("effects-"+t)}copy(t=!0,e=!0,s){let i=N(this._el.cloneNode(t));return e&&i.copyInlineStyles(this,t,s),i}copyInlineStyles(t,e=!0,s){let i=window.getComputedStyle(t._el);for(let o of s||Array.from(i))this.css(o,i.getPropertyValue(o));if(e){let o=this.children,r=t.children;for(let a=0;a<o.length;++a){let h=o[a].tagName==="foreignObject"?void 0:s;o[a].copyInlineStyles(r[a],!0,h)}}}},We=class extends Li{get offsetTop(){return this._el.offsetTop}get offsetLeft(){return this._el.offsetLeft}get offsetParent(){return N(this._el.offsetParent||void 0)}get width(){return this._el.offsetWidth}get height(){return this._el.offsetHeight}get innerWidth(){let t=parseFloat(this.css("padding-left")),e=parseFloat(this.css("padding-right"));return this._el.clientWidth-t-e}get innerHeight(){let t=parseFloat(this.css("padding-bottom")),e=parseFloat(this.css("padding-top"));return this._el.clientHeight-t-e}get outerWidth(){let t=parseFloat(this.css("margin-left")),e=parseFloat(this.css("margin-right"));return this.width+t+e||0}get outerHeight(){let t=parseFloat(this.css("margin-bottom")),e=parseFloat(this.css("margin-top"));return this.height+t+e||0}get positionTop(){let t=this._el,e=0;for(;t;)e+=t.offsetTop,t=t.offsetParent;return e}get positionLeft(){let t=this._el,e=0;for(;t;)e+=t.offsetLeft,t=t.offsetParent;return e}offset(t){if(t._el===this._el.offsetParent){let e=this.offsetTop+t._el.clientTop,s=this.offsetLeft+t._el.clientLeft,i=e+this.height,o=s+this.width;return{top:e,left:s,bottom:i,right:o}}else{let e=t._el.getBoundingClientRect(),s=this._el.getBoundingClientRect();return{top:s.top-e.top,left:s.left-e.left,bottom:s.bottom-e.top,right:s.right-e.left}}}},Jm=["font-family","font-size","font-style","font-weight","letter-spacing","text-decoration","color","display","visibility","alignment-baseline","baseline-shift","text-anchor","clip","clip-path","clip-rule","mask","opacity","filter","fill","fill-rule","marker","marker-start","marker-mid","marker-end","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-width","text-rendering","transform","dominant-baseline","transform-origin","transform-box","paint-order"],Pr=class extends Li{constructor(){super(...arguments);this.type="svg"}get $ownerSVG(){return N(this._el.ownerSVGElement||void 0)}get width(){return this.bounds.width}get height(){return this.bounds.height}get positionLeft(){let t=this._el.getBBox().x+this._el.getCTM().e;return this.$ownerSVG.positionLeft+t}get positionTop(){let t=this._el.getBBox().y+this._el.getCTM().f;return this.$ownerSVG.positionTop+t}get inverseTransformMatrix(){let t=this._el.getScreenCTM().inverse(),e=[[t.a,t.c,t.e],[t.b,t.d,t.f]];if(v.isFirefox){let s=this.transformMatrix;e[0][2]-=s[0][2],e[1][2]-=s[1][2]}return e}setTransform(t,e=0,s=1){let i=t?`translate(${st(t.x,.1)} ${st(t.y,.1)})`:"",o=C(e,0)?"":`rotate(${e*180/Math.PI})`,r=C(s,1)?"":`scale(${s})`;this.setAttr("transform",[i,o,r].join(" "))}get strokeLength(){if(this._el instanceof SVGGeometryElement)return this._el.getTotalLength();{let t=this.bounds;return 2*t.height+2*t.width}}getPointAtLength(t){if(this._el instanceof SVGGeometryElement){let e=this._el.getPointAtLength(t);return new d(e.x,e.y)}else return new d(0,0)}getPointAt(t){return this.getPointAtLength(t*this.strokeLength)}get points(){return vs(this.attr("d"))}set points(t){let e=t.length?"M"+t.map(s=>s.x+","+s.y).join("L"):"";this.setAttr("d",e)}addPoint(t){let e=this.attr("d")+" L "+t.x+","+t.y;this.setAttr("d",e)}get center(){let t=+this.attr(this.tagName==="TEXT"?"x":"cx"),e=+this.attr(this.tagName==="TEXT"?"y":"cy");return new d(t,e)}setCenter(t){this.setAttr(this.tagName==="TEXT"?"x":"cx",t.x),this.setAttr(this.tagName==="TEXT"?"y":"cy",t.y)}setLine(t,e){this.setAttr("x1",t.x),this.setAttr("y1",t.y),this.setAttr("x2",e.x),this.setAttr("y2",e.y)}setRect(t){this.setAttr("x",t.p.x),this.setAttr("y",t.p.y),this.setAttr("width",t.w),this.setAttr("height",t.h)}draw(t,e={}){if(!t)return this.setAttr("d","");let s={mark:this.attr("mark"),arrows:this.attr("arrows"),size:+this.attr("size")||void 0,fill:this.hasClass("fill"),round:this.hasAttr("round")};this.setAttr("d",$e(t,Sn(e,s)))}},Sc=class extends Pr{get viewBox(){return this._el.viewBox.baseVal||{width:0,height:0}}get $ownerSVG(){return this}get positionLeft(){return parseInt(this.css("margin-left"))+this.parent.positionLeft}get positionTop(){return parseInt(this.css("margin-top"))+this.parent.positionTop}get svgWidth(){return this.viewBox.width||this.width}get svgHeight(){return this.viewBox.height||this.height}drawPath(t,e={},s={}){let i=c("path",e,this);return i.draw(t,s),i}pngImage(t,e,s){return xe(this,void 0,void 0,function*(){let i=this.copy(!0,!0,Jm);e||(e=t||this.svgHeight),t||(t=this.svgWidth),i.setAttr("width",t),i.setAttr("height",e),i.setAttr("viewBox",s||this.attr("viewBox")||`0 0 ${this.svgWidth} ${this.svgHeight}`),i.setAttr("xmlns","http://www.w3.org/2000/svg");let o=i.$$('image[href^="http"]');yield Promise.all(o.map(p=>xe(this,void 0,void 0,function*(){let u=yield In(p.attr("href")),m=c("canvas",{width:u.width,height:u.height});m.ctx.drawImage(u,0,0,u.width,u.height);let g=yield m.pngImage;p.setAttr("href",g)})));let r=new XMLSerializer().serializeToString(i._el),a="data:image/svg+xml;utf8,"+encodeURIComponent(r),h=c("canvas",{width:t,height:e});h.ctx.fillStyle=Mt.css("background-color")||"white",h.ctx.fillRect(0,0,t,e);let l=yield In(a);return h.ctx.drawImage(l,0,0,t,e),h.pngImage})}downloadImage(t,e,s,i){let o=v.isIOS?window.open("","_blank"):void 0;this.pngImage(e,s,i).then(r=>{if(o)return o.location.href=r;c("a",{download:t,href:r,target:"_blank"})._el.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!1,cancelable:!0}))})}},Sr=class extends We{constructor(){super(...arguments);this.type="window"}get width(){return window.innerWidth}get height(){return window.innerHeight}get innerWidth(){return window.innerWidth}get innerHeight(){return window.innerHeight}get outerWidth(){return window.outerWidth}get outerHeight(){return window.outerHeight}get scrollWidth(){return document.body.scrollWidth}get scrollHeight(){return document.body.scrollHeight}get scrollTop(){return window.pageYOffset}set scrollTop(t){document.body.scrollTop=document.documentElement.scrollTop=t,this.trigger("scroll",{top:t,left:this.scrollLeft})}get scrollLeft(){return window.pageXOffset}set scrollLeft(t){document.body.scrollLeft=document.documentElement.scrollLeft=t,this.trigger("scroll",{top:this.scrollTop,left:t})}},Tc=class extends We{constructor(){super(...arguments);this.type="form"}get action(){return this._el.action}get formData(){let t={};for(let e of Array.from(this._el.elements)){let s=e.name||e.id;s&&(t[s]=e.value)}return t}get isValid(){return this._el.checkValidity()}},Cc=class extends We{constructor(){super(...arguments);this.type="input"}get checked(){return this._el.checked||!1}set checked(t){this._el.checked=t}get value(){return this._el.value}set value(t){this._el.value=t}bindVariable(t,e){let s=this._el.type==="number",i=this._el.type==="checkbox";if(e in t?i?this.checked=t[e]:this.value=t[e]:this.value&&(i?t[e]=this.checked:t[e]=this.value),s){let o=this.hasAttr("min")?+this.attr("min"):-Infinity,r=this.hasAttr("max")?+this.attr("max"):Infinity;this.change(a=>t[e]=M(+a,o,r)),this.on("blur",()=>this.value=t[e])}else i?this.on("change",()=>t[e]=this.checked):this.change(o=>t[e]=o);t.watch(()=>{i?this.checked=t[e]:this.value=t[e],this.trigger("model-change",{defaultPrevented:!0})})}setInputPattern(t){if(isNaN(+t))return;let e=t.match(/^[0-9]+$/);this.setAttr("inputmode",e?"numeric":"decimal"),e&&this.setAttr("pattern","[0-9]*")}change(t){let e=this.value||"";this.on("change keyup input paste model-change",s=>{this.value!==e&&(e=this.value.trim(),s.defaultPrevented||t(e))})}validate(t){this.change(e=>this.setValidity(t(e)))}setValidity(t){this._el.setCustomValidity(t)}get isValid(){return this._el.checkValidity()}},Mc=class extends We{constructor(){super(...arguments);this.type="canvas"}getContext(t="2d",e={}){return this._el.getContext(t,e)}get pngImage(){return this._el.toDataURL("image/png")}get canvasWidth(){return this._el.width}get canvasHeight(){return this._el.height}get ctx(){return this._ctx||(this._ctx=this.getContext()),this._ctx}draw(t,e={}){this.ctx.save(),hc(this.ctx,t,e),this.ctx.restore()}clear(){this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight)}fill(t){this.ctx.save(),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.canvasWidth,this.canvasHeight),this.ctx.restore()}clearCircle(t,e){this.ctx.save(),this.ctx.globalCompositeOperation="destination-out",this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e,0,2*Math.PI,!1),this.ctx.fill(),this.ctx.restore()}downloadImage(t){let e=this.pngImage;c("a",{download:t,href:e,target:"_blank"})._el.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!1,cancelable:!0}))}},Ec=class extends We{play(){return this._el.play()||Promise.resolve()}pause(){return this._el.pause()}},Vc=["path","rect","circle","ellipse","polygon","polyline","g","defs","marker","line","text","tspan","pattern","mask","svg","foreignObject","image","use"];function N(n,t){if(!n)return;let e=t?t._el:document.documentElement,s=typeof n=="string"?e.querySelector(n):n;if(!s)return;if(s._view)return s._view;let i=(s.tagName||"").toLowerCase();return i==="svg"?new Sc(s):i==="canvas"?new Mc(s):i==="form"?new Tc(s):i==="input"||i==="select"||i==="textarea"?new Cc(s):i==="video"||i==="audio"?new Ec(s):Vc.includes(i)?new Pr(s):new We(s)}function Pe(n,t){let e=t?t._el:document.documentElement,s=n?e.querySelectorAll(n):[];return Array.from(s,i=>N(i))}function c(n,t={},e){let s=Vc.includes(n)?document.createElementNS("http://www.w3.org/2000/svg",n):document.createElement(n);for(let[o,r]of Object.entries(t))r!==void 0&&(o==="id"?s.id=r:o==="html"?s.innerHTML=r:o==="text"?s.textContent=r:o==="path"?s.setAttribute("d",$e(r)):s.setAttribute(o,r));let i=N(s);return e&&e.append(i),i}var q=new Sr(document.body),Mt=new Sr(document.documentElement),Bt={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,delete:46},Bn="_M",ti=window.navigator.userAgent.toLowerCase(),Ac={};for(let[n,t]of Object.entries(Bt))Ac[t]=n;var Qm=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i,kc=/iphone|ipad|ipod/i,t0=/^((?!chrome|android).)*safari/i,Oc=class{constructor(){var t,e,s;this.isMobile=Qm.test(ti),this.isRetina=(window.devicePixelRatio||1)>1,this.isTouch=!!window.Touch||"ontouchstart"in window,this.isChrome=!!window.chrome,this.isFirefox=ti.indexOf("firefox")>=0,this.isAndroid=ti.indexOf("android")>=0,this.isIOS=kc.test(ti),this.isSafari=kc.test(ti)||t0.test(ti),this.loadQueue=[],this.loaded=!1,this.width=window.innerWidth,this.height=window.innerHeight,this.resizeCallbacks=[],this.theme={name:"light",isDark:!1},this.themeChangedCallbacks=[],this.themeOverride="",this.darkQuery=(t=window.matchMedia)===null||t===void 0?void 0:t.call(window,"(prefers-color-scheme: dark)"),window.onload=()=>this.afterLoad(),document.addEventListener("DOMContentLoaded",()=>this.afterLoad());let i=ls(()=>this.applyResize());window.addEventListener("resize",i);try{(e=this.darkQuery)===null||e===void 0||e.addEventListener("change",()=>this.applyThemeChange())}catch(r){(s=this.darkQuery)===null||s===void 0||s.addListener(()=>this.applyThemeChange())}let o=this.getCookie("theme");o&&this.setTheme(o);try{this.localStorage=window.localStorage}catch(r){console.warn("Unable to access Local Storage in this context.")}}afterLoad(){if(!this.loaded){this.loaded=!0;for(let t of this.loadQueue)t();setTimeout(()=>this.resize())}}ready(t){this.loaded?t():this.loadQueue.push(t)}redraw(){document.body.offsetHeight}applyResize(){let t=window.innerWidth,e=window.innerHeight;if(!(this.width===t&&this.height===e)){this.width=t,this.height=e;for(let s of this.resizeCallbacks)s({width:this.width,height:this.height});q.trigger("scroll",{top:q.scrollTop})}}onResize(t){t({width:this.width,height:this.height}),this.resizeCallbacks.push(t)}offResize(t){let e=this.resizeCallbacks.indexOf(t);e>=0&&this.resizeCallbacks.splice(e,1)}resize(){this.applyResize()}applyThemeChange(){let t=this.theme.name,e=t==="dark"||t==="auto"&&this.darkQuery.matches;if(e!==this.theme.isDark){this.theme.isDark=e,Mt.setAttr("theme",this.themeOverride||(e?"dark":"light"));for(let s of this.themeChangedCallbacks)s(this.theme)}}setTheme(t){t!==this.theme.name&&(this.theme.name=t,this.setCookie("theme",t),this.applyThemeChange())}onThemeChange(t){this.themeChangedCallbacks.push(t)}getHash(){return window.location.hash.slice(1)}setHash(t){let e=document.body.scrollTop;window.location.hash=t,document.body.scrollTop=e}setURL(t,e=""){window.history.replaceState({},e,t),e&&(window.document.title=e)}getCookies(){let t=document.cookie.split(";"),e={};for(let s=0,i=t.length;s<i;++s){let o=t[s].split("=");e[decodeURIComponent(o[0]).trim()]=decodeURIComponent(o[1])}return e}getCookie(t){let e=document.cookie.match(new RegExp(`(^|;) ?${t}=([^;]*)(;|$)`));return e?e[2]:void 0}setCookie(t,e,s=60*60*24*365){let i=window.location.hostname.replace(/^[a-z]{2}\./,"");document.cookie=`${t}=${e};path=/;max-age=${s};domain=${i}`}deleteCookie(t){this.setCookie(t,"",-1)}setStorage(t,e){var s,i;let o=(t||"").split("."),r=tr(((s=this.localStorage)===null||s===void 0?void 0:s.getItem(Bn))||void 0),a=r;for(let h=0;h<o.length-1;++h)a[o[h]]==null&&(a[o[h]]={}),a=a[o[h]];a[o[o.length-1]]=e,(i=this.localStorage)===null||i===void 0||i.setItem(Bn,JSON.stringify(r))}getStorage(t){var e;let s=tr(((e=this.localStorage)===null||e===void 0?void 0:e.getItem(Bn))||void 0);if(!t)return s;let i=(t||"").split("."),o=i.pop();for(let r of i){if(!(r in s))return;s=s[r]}return s[o]}deleteStorage(t){var e;t?this.setStorage(t,void 0):(e=this.localStorage)===null||e===void 0||e.setItem(Bn,"")}getActiveInput(){let t=document.activeElement;return(t==null?void 0:t.shadowRoot)&&(t=t.shadowRoot.activeElement),t===document.body?void 0:N(t)}onKey(t,e,s=!1){let i=tt(t),o=s?"keyup":"keydown";document.addEventListener(o,r=>{let a=Ac[r.keyCode]||r.key;if(!i.includes(a))return;let h=this.getActiveInput();h&&h.is("input, textarea, [contenteditable]")||h&&["space","enter","tab"].includes(a)&&h.is("button, a, [tabindex]")||e(r,a)})}},v=window.BoostBrowser||new Oc;window.BoostBrowser=v;var e0=/\bTrident\/[567]\b|\bMSIE (?:9|10)\.0\b/,s0=/\bAppleWebKit\/(\d+)\b/,i0=/\bEdge\/12\.(\d+)\b/,n0=e0.test(navigator.userAgent)||+(navigator.userAgent.match(i0)||[])[1]<10547||+(navigator.userAgent.match(s0)||[])[1]<537,Tr={};function o0(){if(!n0)return;Array.from(document.querySelectorAll("svg > use")).forEach(function(t){let e=t.getAttribute("xlink:href"),[s,i]=e.split("#");if(!s.length||!i)return;let o=t.parentNode;o.removeChild(t),s in Tr||(Tr[s]=fetch(s).then(a=>a.text())),Tr[s].then(a=>{let h=document.implementation.createHTMLDocument("");h.documentElement.innerHTML=a;let p=h.getElementById(i).cloneNode(!0),u=document.createDocumentFragment();for(;p.childNodes.length;)u.appendChild(p.firstChild);o.appendChild(u)})})}function Lc(){document.addEventListener("keydown",n=>{if(n.keyCode===Bt.enter||n.keyCode===Bt.space){let t=v.getActiveInput();t&&t.hasAttr("tabindex")&&t.tagName!=="TEXTAREA"&&(n.preventDefault(),t.trigger("pointerdown",n),t.trigger("pointerstop",n),q.trigger("pointerstop",n),t.trigger("click",n))}})}var zn=!1;setTimeout(()=>zn=!0);var r0="cubic-bezier(0.175, 0.885, 0.32, 1.275)",a0="cubic-bezier(0.68, -0.275, 0.825, 0.115)",ys={cancel:()=>{},promise:Promise.resolve()};function z(n,t){if(t===0)return n(1,0,()=>{}),ys;let e=Date.now(),s=hs(),i=0,o=!0,r=()=>{o=!1,s.reject()};function a(){o&&(!t||i<=t)&&window.requestAnimationFrame(a);let h=Date.now()-e;n(t?Math.min(1,h/t):h,h-i,r),t&&h>=t&&s.resolve(),i=h}return a(),{cancel:r,promise:s.promise}}function Fn(n,t=0,e=0){switch(n){case"quad":return Math.pow(t,2);case"cubic":return Math.pow(t,3);case"quart":return Math.pow(t,4);case"quint":return Math.pow(t,5);case"circ":return 1-Math.sqrt(1-Math.pow(t,2));case"sine":return 1-Math.cos(t*Math.PI/2);case"exp":return t<=0?0:Math.pow(2,10*(t-1));case"back":return e||(e=1.70158),t*t*((e+1)*t-e);case"elastic":return e||(e=.3),-Math.pow(2,10*(t-1))*Math.sin(((t-1)*2/e-.5)*Math.PI);case"swing":return .5-Math.cos(t*Math.PI)/2;case"spring":return 1-Math.cos(t*4.5*Math.PI)*Math.exp(-t*6);case"bounce":return t<1/11?1/64-7.5625*(.5/11-t)*(.5/11-t):t<3/11?1/16-7.5625*(2/11-t)*(2/11-t):t<7/11?1/4-7.5625*(5/11-t)*(5/11-t):1-7.5625*(1-t)*(1-t);default:return t}}function X(n,t=0,e=0){if(t===0)return 0;if(t===1)return 1;let[s,i]=n.split("-");return i==="in"?Fn(s,t,e):i==="out"?1-Fn(s,1-t,e):t<=.5?Fn(s,2*t,e)/2:1-Fn(s,2*(1-t),e)/2}function zt(n,t,e=400,s=0,i="ease-in-out"){if(!zn)return Object.keys(t).forEach(w=>{let y=t[w];n.css(w,Array.isArray(y)?y[1]:y)}),ys;i==="bounce-in"&&(i=r0),i==="bounce-out"&&(i=a0);let o="";v.isSafari&&(o=n._el.style.transition,n.css("transition","none"),v.redraw());let r=n._data.animation;r&&r.cancel();let a={},h={},l=hs(),p=window.getComputedStyle(n._el);Object.keys(t).forEach(w=>{let y=t[w],$=Mn(w);h[$]=Array.isArray(y)?y[0]:p.getPropertyValue(w),a[$]=Array.isArray(y)?y[1]:y,s&&n.css(w,h[$])});let u=a.height;a.height==="auto"&&(a.height=H(n.children.map(w=>w.outerHeight))+"px");let m,g=!1;ge(()=>{g||(m=n._el.animate([h,a],{duration:e,easing:i,fill:"forwards"}),m.onfinish=()=>{n._el&&Object.keys(t).forEach(w=>n.css(w,w==="height"?u:a[w])),v.isSafari&&n.css("transition",o),l.resolve(),m.cancel()})},s);let b={cancel(){g=!0,n._el&&Object.keys(t).forEach(w=>n.css(w,n.css(w))),m&&m.cancel()},promise:l.promise};return setTimeout(()=>n._data.animation=b),b}var h0=/matrix\([0-9.\-\s]+,[0-9.\-\s]+,[0-9.\-\s]+,[0-9.\-\s]+,([0-9.\-\s]+),([0-9.\-\s]+)\)/;function Xm(n,t="fade",e=500,s=0){if(n.show(),!zn)return ys;let i=+n.css("opacity")||1;if(t==="fade")return zt(n,{opacity:[0,i]},e,s);if(t==="pop"){let o=n.transform.replace(/scale\([0-9.]*\)/,"").replace(h0,"translate($1px,$2px)");return zt(n,{opacity:[0,i]},e,s),zt(n,{transform:[o+" scale(0.5)",o+" scale(1)"]},e,s,"bounce-in")}else{if(t==="descend")return zt(n,{opacity:[0,1],transform:["translateY(-50%)","none"]},e,s);if(t.startsWith("draw")){let o=n.strokeLength;n.css("stroke-dasharray",o+"px"),n.css("opacity")||n.css("opacity",1);let r=t==="draw-reverse"?2*o+"px":0,a={"stroke-dashoffset":[o+"px",r]},h=zt(n,a,e,s,"linear");return h.promise.then(()=>n.css("stroke-dasharray","")),h}else if(t.startsWith("slide")){let o={opacity:[0,i],transform:["translateY(50px)","none"]};return t.includes("down")&&(o.transform[0]="translateY(-50px)"),t.includes("right")&&(o.transform[0]="translateX(-50px)"),t.includes("left")&&(o.transform[0]="translateX(50px)"),zt(n,o,e,s)}else if(t.startsWith("reveal")){let o={opacity:[0,i],height:[0,"auto"]};return t.includes("left")&&(o.transform=["translateX(-50%)","none"]),t.includes("right")&&(o.transform=["translateX(50%)","none"]),zt(n,o,e,s)}}return ys}function Ym(n,t="fade",e=400,s=0,i=!1){if(!n._el)return ys;if(!zn)return n.hide(),ys;if(n.css("display")==="none")return ys;let o;if(t==="fade")o=zt(n,{opacity:[1,0]},e,s);else if(t==="pop"){let r=n.transform.replace(/scale\([0-9.]*\)/,"");zt(n,{opacity:[1,0]},e,s),o=zt(n,{transform:[r+" scale(1)",r+" scale(0.5)"]},e,s,"bounce-out")}else if(t==="ascend")o=zt(n,{opacity:[1,0],transform:["none","translateY(-50%)"]},e,s);else if(t.startsWith("draw")){let r=n.strokeLength;n.css("stroke-dasharray",r);let h={"stroke-dashoffset":[t==="draw-reverse"?2*r+"px":0,r+"px"]};o=zt(n,h,e,s,"linear")}else if(t.startsWith("slide")){let r={opacity:0,transform:"translateY(50px)"};t.includes("up")&&(r.transform="translateY(-50px)"),o=zt(n,r,e,s)}else if(t.startsWith("reveal")){let r={opacity:0,height:0};t.includes("left")&&(r.transform="translateX(-50%)"),t.includes("right")&&(r.transform="translateX(50%)"),o=zt(n,r,e,s)}return o.promise.then(()=>i?n.remove():n.hide()),o}var l0="position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: #0f82f2; pointer-events: none; z-index: 9999; will-change: transform;";function Rc(n,t){let e=t.regex.exec(n);if(e){e.shift();let s={};for(let[i,o]of t.params.entries())s[o]=e[i];return s}else return}function c0(n,t,e){return xe(this,void 0,void 0,function*(){return n.template?typeof n.template=="string"?n.template:n.template(t):(yield fetch(e+(e.indexOf("?")>=0?"&xhr=1":"?xhr=1"))).text()})}var Ic=document.readyState==="complete";window.addEventListener("load",()=>setTimeout(()=>Ic=!0));"scrollRestoration"in window.history&&(window.history.scrollRestoration="manual");var Nc=class extends we{constructor(){super(...arguments);this.$viewport=q,this.views=[],this.active={path:"",hash:""},this.preloaded=!1,this.transition=!1,this.noLoad=!1,this.initialise=()=>{}}setup(t={}){t.$viewport&&(this.$viewport=t.$viewport),t.initialise&&(this.initialise=t.initialise),t.preloaded&&(this.preloaded=t.preloaded),t.transition&&(this.transition=t.transition),t.noLoad&&(this.noLoad=t.noLoad),t.click&&q.on("click",e=>this.onLinkClick(e)),t.history&&window.addEventListener("popstate",e=>xe(this,void 0,void 0,function*(){var s;if(!Ic||!((s=e.state)===null||s===void 0?void 0:s.path))return;(yield this.load(e.state.path,e.state.hash))||window.history.pushState(this.active,"",this.active.path+this.active.hash)}))}view(t,{enter:e,exit:s,template:i}={}){let o=(t.match(/:\w+/g)||[]).map(m=>m.substr(1)),r=t.replace(/:\w+/g,"([\\w-]+)").replace("/","\\/")+"\\/?",a=t.includes("?")?"":"(\\?.*)?",l={regex:new RegExp("^"+r+a+"$","i"),params:o,enter:e,exit:s,template:i};this.views.push(l);let p=window.location.pathname+window.location.search,u=Rc(p,l);!u||(this.active={path:p,hash:window.location.hash},window.history.replaceState(this.active,"",this.active.path+this.active.hash),v.ready(()=>{setTimeout(()=>{this.preloaded?(this.initialise(this.$viewport,u),l.enter&&l.enter(this.$viewport,u)):this.loadView(l,u)})}))}paths(...t){for(let e of t)this.view(e)}getView(t){for(let e of this.views){let s=Rc(t,e);if(s)return{view:e,params:s}}}load(t,e){return xe(this,void 0,void 0,function*(){if(t===this.active.path&&e!==this.active.hash)return this.trigger("hashChange",e.slice(1)),this.trigger("change",t+e),this.active={path:t,hash:e},!0;let s=this.getView(t);return!s||this.beforeChange&&!(yield this.beforeChange())?!1:(this.active={path:t,hash:e},this.trigger("change",t+e),window.ga&&window.ga("send","pageview",t+e),this.noLoad?s.view.enter&&s.view.enter(this.$viewport,s.params):this.loadView(s.view,s.params),!0)})}loadView(t,e={}){return xe(this,void 0,void 0,function*(){this.showLoadingBar();let s=this.active.path,i=yield c0(t,e,s);if(this.active.path!==s)return;yield this.$viewport.animate({opacity:0},200).promise,this.$viewport.removeChildren(),q.scrollTop=0,this.$viewport.html=i,v.resize(),o0(),this.$viewport.animate({opacity:1},200),this.hideLoadingBar();let o=this.$viewport.$("title");o&&(document.title=o.text),this.initialise(this.$viewport,e),t.enter&&t.enter(this.$viewport,e),this.trigger("afterChange",{$viewport:this.$viewport})})}onLinkClick(t){if(t.metaKey||t.ctrlKey||t.shiftKey||t.defaultPrevented)return;let e=t.target;for(;e&&e.nodeName!=="A";)e=e.parentNode;if(!e||e.nodeName!=="A")return;let s=e;if(s.target||s.origin!==window.location.origin||s.hasAttribute("download")||s.getAttribute("rel")==="external")return;let i=s.getAttribute("href");i&&i.indexOf("mailto:")>-1||this.getView(s.pathname+s.search)&&(t.preventDefault(),this.goTo(s.pathname+s.search,s.hash))}goTo(t,e=""){return xe(this,void 0,void 0,function*(){let s=this.active.path+this.active.hash;(yield this.load(t,e))&&s!==this.active.path+this.active.hash&&window.history.pushState(this.active,"",t+e)})}replace(t,e=""){this.active={path:t,hash:e},window.history.replaceState(this.active,"",t+e)}back(){window.history.back()}forward(){window.history.forward()}showLoadingBar(){this.$loadingBar||(this.$loadingBar=c("div",{style:l0},q)),this.$loadingBar.css({transform:"translateX(-100%)",opacity:1}),this.$loadingBar.show(),this.animation=z(t=>{this.$loadingBar.css("transform",`translateX(-${10+90*Math.exp(-4*t)}%)`)},3e3)}hideLoadingBar(){var t,e,s;return xe(this,void 0,void 0,function*(){(t=this.animation)===null||t===void 0||t.cancel(),yield(e=this.$loadingBar)===null||e===void 0?void 0:e.animate({transform:"none",opacity:0}).promise,(s=this.$loadingBar)===null||s===void 0||s.hide()})}},Ri=new Nc;function d0(n,t){let e=Array.from(n.childNodes);n.innerHTML=t;let s={};for(let i of Array.from(n.querySelectorAll("slot")))s[i.getAttribute("name")||""]=i;for(let i of e){let o=i.getAttribute&&i.getAttribute("slot")||"",r=s[o]||s[""];r&&r.parentNode.insertBefore(i,r)}for(let i of Object.values(s))i.parentNode.removeChild(i)}function Dc(n){let t=[];for(let e of Array.from(n.children))e.tagName.startsWith("X-")?t.push(e):t.push(...Dc(e));return t}var Gc=new Map,Hc=class extends HTMLElement{constructor(){super(...arguments);this.wasConnected=!1,this.isReady=!1}connectedCallback(){return xe(this,void 0,void 0,function*(){if(this.wasConnected){this._view.trigger("connected");return}this.wasConnected=!0,this.isReady=!1,this._view.created();let t=Gc.get(this._view.tagName)||{};t.template&&d0(this,t.template);let e=Dc(this).filter(s=>!s.isReady).map(s=>new Promise(i=>s.addEventListener("ready",i)));yield Promise.all(e),this._view.ready(),this.dispatchEvent(new CustomEvent("ready")),this.isReady=!0})}disconnectedCallback(){this._view.trigger("disconnected")}},L=class extends We{created(){}ready(){}};function A(n,t={}){return function(e){class s extends Hc{constructor(){super();this._view=new e(this)}}Gc.set(n.toUpperCase(),t),window.customElements.define(n,s)}}var Cr=class{constructor(t){this.clipEndTime=0;this.player=new Audio(t),this.player.preload="true",this.player.addEventListener("timeupdate",()=>{this.player.currentTime>=this.clipEndTime&&this.triggerCallback(!0)}),window.addEventListener("beforeunload",()=>this.player.pause())}playClip(t,e,s){this.triggerCallback(!1),this.player.currentTime=t,this.clipEndTime=e,this.clipCallback=s,this.player.play()}triggerCallback(t){if(!this.clipCallback)return;let e=this.clipCallback;this.clipCallback=void 0,this.player.pause(),e({ended:t})}pause(){this.triggerCallback(!1)}get isPlaying(){return!!this.clipCallback}},Mr=!1,Er,Vr=class{constructor(t,e){this.audio=t;this.paragraphs=[];this.paragraphs=e.$$(".voice").map(s=>new qc(s,t));for(let[s,i]of this.paragraphs.entries())i.on("end",()=>{var o;if(this.paragraphs[s+1])this.paragraphs[s+1].play();else{let r=e.nextStep;r&&r.isShown&&((o=r.narration)==null||o.play())}})}play(){var t;this.audio.isPlaying||!Mr||(t=this.paragraphs[0])==null||t.play()}},qc=class extends we{constructor(t,e){super();this.$p=t;this.audio=e;this.playing=void 0;this.sentences=t.$$(".sentence[data-timings]").map(s=>new _c(s,e)),this.$button=c("button",{class:"playback-btn",title:"Play Narration"}),this.$button.on("click",()=>{this.playing?this.audio.pause():this.play(),Mr=!Mr,Er=void 0}),t.prepend(this.$button),t.addClass("sentence-wrap");for(let[s,i]of this.sentences.entries())i.on("end",o=>{this.playing=void 0,o&&this.sentences[s+1]?setTimeout(()=>this.play(this.sentences[s+1]),200):(this.$button.removeClass("active"),o&&setTimeout(()=>this.trigger("end"),400))})}play(t){let e=t||this.sentences[0],s=e.$reveal;if(s&&s.css("visibility")==="hidden"){this.$button.removeClass("active"),Er=s,s.one("reveal",()=>{Er===s&&!this.audio.isPlaying&&this.play(e)});return}this.playing=e,this.playing.play(),this.$button.addClass("active");let i=this.$p.parents("x-tabbox .tab")[0];if(i){let a=i.parents("x-tabbox")[0];a.makeActive(i.index());let h=a.active;a.one("change",l=>{this.playing&&l!==h&&this.audio.pause()})}let o=this.$p.bounds,r=o.top+o.height-v.height+20;r>0&&q.scrollBy(r+100),setTimeout(()=>this.$button.focus(),800)}},_c=class extends we{constructor(t,e){super();this.$el=t;this.audio=e;let s=t.attr("data-timings").split("-");this.start=+s[0]/1e3,this.end=(+s[1]-200)/1e3}play(){this.$el.addClass("playing"),this.audio.playClip(this.start,this.end,({ended:t})=>{this.$el.removeClass("playing"),this.trigger("end",t)})}get $reveal(){return this.$el.parents(".reveal")[0]}};var bs=c("div",{class:"modal-background"},q),Un,Oe,Ar;function kr(){Oe&&Oe.canClose&&Oe.close()}bs.on("click",kr);v.onKey("escape",kr);Ri.on("change",kr);bs.on("scrollwheel touchmove",n=>{n.preventDefault(),n.stopPropagation()});v.onKey("space up down pagedown pageup",n=>{Oe&&(n.preventDefault(),n.stopPropagation())});var Or=class extends L{constructor(){super(...arguments);this.isOpen=!1;this.canClose=!0}ready(){this.canClose=!this.hasAttr("no-close"),this.$iframe=this.$("iframe[data-src]"),this.$video=this.$("video");let t=Pe(`[data-modal=${this.id}]`);for(let s of t)s.on("click",()=>this.open());Ri.on("afterChange",({$viewport:s})=>{let i=s.$$(`[data-modal=${this.id}]`);for(let o of i)o.on("click",()=>this.open())}),this.hasClass("open")&&!Oe&&this.open(!0),this.$("input")&&this.addClass("interactive");let e=this.$(".close");e&&e.on("click",()=>this.close());for(let s of this.$$(".btn"))s.on("click",()=>this.trigger("btn-click",s))}open(t=!1){if(this.isOpen)return;bs.setClass("light",this.hasClass("light")),Oe?Oe.close(!0):t?bs.show():bs.css("display")==="block"?Un==null||Un.cancel():bs.enter("fade",250),this.isOpen=!0,Oe=this,this.$iframe&&this.$iframe.setAttr("src",this.$iframe.data.src),this.$video&&this.$video.play(),t?this.show():this.enter("pop",250).promise.then(()=>this.css("transform","")),this.setAttr("role","dialog"),this.trigger("open"),Ar=document.activeElement;let e=this.$('input, a, button, textarea, [tabindex="0"]');e&&e.focus()}close(t=!1,e=!1){!this.isOpen||(this.isOpen=!1,this.removeAttr("role"),Oe=void 0,this.$iframe&&this.$iframe.setAttr("src",""),this.$video&&this.$video.pause(),t||(Un=bs.exit("fade",250)),this.exit("pop",250).promise.then(()=>this.css("transform","")),e||this.trigger("close"),Ar&&Ar.focus())}static confirm(t){return P(this,null,function*(){var i;let e=N(t);if(!e)return"";e.open();let s=yield new Promise(o=>e.one("close btn-click",o));return e.close(),((i=s==null?void 0:s.data)==null?void 0:i.prompt)||""})}};Or=V([A("x-modal")],Or);var Lr=class extends L{constructor(){super(...arguments);this.$options={}}ready(){let t=this.children;this.$active=this.$(".active")||t[0],this.$active.addClass("active");for(let[e,s]of t.entries())!F(s.tagName,"A","BUTTON")&&!s.hasAttr("tabindex")&&s.setAttr("tabindex",0),s.on("click",()=>this.makeActive(s)),this.$options[s.attr("value")||e]=s;this.trigger("change",this.$active)}makeActive(t){t!==this.$active&&(this.$active.removeClass("active"),this.$active=t,t.addClass("active"),this.trigger("change",t))}bindVariable(t,e){t[e]===void 0&&(t[e]=this.$active.attr("value")),this.on("change",s=>t[e]=s.attr("value")),t.watch(()=>{let s=this.$options[t[e]];s&&this.makeActive(s)})}};Lr=V([A("x-select")],Lr);var Rr=class extends L{constructor(){super(...arguments);this.isOpen=!1}ready(){this.animation=this.attr("animation")||"pop",this.$bubble=this.$(".popup-body"),this.$bubble.hide(),this.$(".popup-target").on("click",()=>this.toggle()),this.on("clickOutside",()=>this.close());for(let e of this.$bubble.$$("a"))e.on("click",()=>this.close());v.onKey("escape",()=>this.close())}toggle(){this.isOpen?this.close():this.open()}open(){this.isOpen||(this.isOpen=!0,this.addClass("active"),this.$bubble.enter(this.animation,150),this.$bubble.setAttr("role","dialog"),this.$bubble.focus())}close(){!this.isOpen||(this.isOpen=!1,this.removeClass("active"),this.$bubble.exit(this.animation,150),this.$bubble.removeAttr("role"))}};Rr=V([A("x-popup")],Rr);var Bc=new Map,ei,p0=c("div",{class:"snackbar"},q),Ir=class extends L{ready(){var t;p0.append(this),Bc.set(this.attr("key"),this),(t=this.$("button"))==null||t.on("click",()=>this.close())}open(t=2e3){return P(this,null,function*(){ei!==this&&(ei&&(yield ei.close()),ei=this,yield this.enter("pop",300).promise,this.setAttr("role","alert"),t&&setTimeout(()=>this.close(),t))})}close(){return P(this,null,function*(){ei===this&&(ei=void 0,this.removeAttr("role"),yield this.exit("pop",300).promise)})}};Ir=V([A("x-alert")],Ir);function si(n,t=4e3){var e;return(e=Bc.get(n))==null?void 0:e.open(t)}var Nr=class extends L{ready(){if(this.children.length)return;let t=+this.attr("size")||24;this.css({width:t+"px",height:t+"px"});let e=c("svg",{viewBox:"0 0 24 24"},this);e.css({width:t+"px",height:t+"px"});let s=c("use",{},e);this.onAttr("name",i=>s.setAttr("href",`/icons.ef911569.svg#${i}`))}};Nr=V([A("x-icon")],Nr);var Dr=12;function u0(n){return`M${n},${n/2}a${n/2},${n/2},0,0,1,0,${n}A${n/2},${n/2},0,0,1,${n},${n/2}`}function f0(n){return`M ${n},0 C ${n/2},0,0,${n/2},0,${n}  s ${n/2},${n},${n},${n} s ${n}-${n/2},${n}-${n}     S ${n*1.5},0,${n},0 z M ${n*44.6/50},${n*76.1/50} L ${n*19.2/50},${n*48.8/50} l ${n*4/50}-${n*4.2/50}     l ${n*19.8/50},${n*11.9/50} l ${n*34.2/50}-${n*32.6/50} l ${n*3.5/50},${n*3.5/50} L ${n*44.6/50},${n*76.1/50} z`}var Gr=class extends L{constructor(){super(...arguments);this.completed=!1}ready(){this.r=+this.attr("r")||10,this.r1=this.r+Dr,this.$svg=c("svg",{width:2*this.r1,height:2*this.r1},this),this.$progress=c("path",{class:"pie",d:u0(this.r),"stroke-width":this.r},this.$svg),this.onAttr("p",t=>this.setProgress(+t,!1))}setProgress(t,e=!0){if(t>.99)return this.complete(e);let s=Math.PI*this.r;this.$progress.css("stroke",t?"currentColor":"none"),this.$progress.css("stroke-dasharray",`${t*s} ${s}`)}complete(t=!0){if(this.completed||(this.completed=!0,this.$progress.css("stroke","none"),this.$progress.css("fill","currentColor"),this.$progress.setAttr("d",f0(this.r)),!t))return;let e=`translate(${this.r1} ${this.r1})`,s=c("g",{transform:e},this.$svg),i=_(()=>c("line",{},s),18);z(o=>{let r=this.r+Dr*X("quint-out",o),a=this.r+Dr*o;for(let h=0;h<18;++h){let l=Math.cos(Math.PI*2*h/18),p=Math.sin(Math.PI*2*h/18);i[h].setLine({x:l*r,y:p*r},{x:l*a,y:p*a})}},800).promise.then(()=>s.remove())}};Gr=V([A("x-progress")],Gr);var zc="2.4.1",Hr="i5iSjo",Fc="_av",qr="_au",_r="(not set)";var jn=[],Zn=class{static add(t,e,s){Uc(t,e).add(s)}static remove(t,e,s){Uc(t,e).remove(s)}constructor(t,e){this.context=t,this.methodName=e,this.isTask=/Task$/.test(e),this.originalMethodReference=this.isTask?t.get(e):t[e],this.methodChain=[],this.boundMethodChain=[],this.wrappedMethod=(...s)=>this.boundMethodChain[this.boundMethodChain.length-1](...s),this.isTask?t.set(e,this.wrappedMethod):t[e]=this.wrappedMethod}add(t){this.methodChain.push(t),this.rebindMethodChain()}remove(t){let e=this.methodChain.indexOf(t);e>-1&&(this.methodChain.splice(e,1),this.methodChain.length>0?this.rebindMethodChain():this.destroy())}rebindMethodChain(){this.boundMethodChain=[];for(let t,e=0;t=this.methodChain[e];e++){let s=this.boundMethodChain[e-1]||this.originalMethodReference.bind(this.context);this.boundMethodChain.push(t(s))}}destroy(){let t=jn.indexOf(this);t>-1&&(jn.splice(t,1),this.isTask?this.context.set(this.methodName,this.originalMethodReference):this.context[this.methodName]=this.originalMethodReference)}},Le=Zn;function Uc(n,t){let e=jn.filter(s=>s.context==n&&s.methodName==t)[0];return e||(e=new Zn(n,t),jn.push(e)),e}var ii=window.Element.prototype,cv=ii.matches||ii.matchesSelector||ii.webkitMatchesSelector||ii.mozMatchesSelector||ii.msMatchesSelector||ii.oMatchesSelector;var w0="80",v0="443",$v=RegExp(":("+w0+"|"+v0+")$"),xv=document.createElement("a");function Wn(n,t,e=void 0,s=void 0,i=void 0,o=void 0){if(typeof s=="function"){let r=e.get("buildHitTask");return{buildHitTask:a=>{a.set(n,null,!0),a.set(t,null,!0),s(a,i,o),r(a)}}}else return Ke({},n,t)}var Br={};function Zc(n,t){let e=n.get("trackingId"),s=Br[e]=Br[e]||{},i=()=>{clearTimeout(s.timeout),s.send&&Le.remove(n,"send",s.send),delete Br[e],s.queue.forEach(o=>o())};clearTimeout(s.timeout),s.timeout=setTimeout(i,0),s.queue=s.queue||[],s.queue.push(t),s.send||(s.send=o=>(...r)=>{i(),o(...r)},Le.add(n,"send",s.send))}var Ke=Object.assign||function(n,...t){for(let e=0,s=t.length;e<s;e++){let i=Object(t[e]);for(let o in i)Object.prototype.hasOwnProperty.call(i,o)&&(n[o]=i[o])}return n};function Wc(n){return n.charAt(0).toUpperCase()+n.slice(1)}function Kc(n){return typeof n=="object"&&n!==null}function Xe(){return+new Date}var Ii=function n(t){return t?(t^Math.random()*16>>t/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,n)};function zr(n,t){let e=window.GoogleAnalyticsObject||"ga";window[e]=window[e]||function(...s){(window[e].q=window[e].q||[]).push(s)},window.gaDevIds=window.gaDevIds||[],window.gaDevIds.indexOf(Hr)<0&&window.gaDevIds.push(Hr),window[e]("provide",n,t),window.gaplugins=window.gaplugins||{},window.gaplugins[Wc(n)]=t}var Fr=class{constructor(){this.registry_={}}on(t,e){this.getRegistry_(t).push(e)}off(t=void 0,e=void 0){if(t&&e){let s=this.getRegistry_(t),i=s.indexOf(e);i>-1&&s.splice(i,1)}else this.registry_={}}emit(t,...e){this.getRegistry_(t).forEach(s=>s(...e))}getEventCount(){let t=0;return Object.keys(this.registry_).forEach(e=>{t+=this.getRegistry_(e).length}),t}getRegistry_(t){return this.registry_[t]=this.registry_[t]||[]}},Xc=Fr;var Kn="autotrack",ni={},Ur=!1,Ni,le=class extends Xc{static getOrCreate(t,e,s){let i=[Kn,t,e].join(":");return ni[i]||(ni[i]=new le(i,s),Ur||b0()),ni[i]}static isSupported_(){if(Ni!=null)return Ni;try{window.localStorage.setItem(Kn,Kn),window.localStorage.removeItem(Kn),Ni=!0}catch(t){Ni=!1}return Ni}static get_(t){return window.localStorage.getItem(t)}static set_(t,e){window.localStorage.setItem(t,e)}static clear_(t){window.localStorage.removeItem(t)}constructor(t,e={}){super();this.key_=t,this.defaults_=e,this.cache_=null}get(){if(this.cache_)return this.cache_;if(le.isSupported_())try{this.cache_=jr(le.get_(this.key_))}catch(t){}return this.cache_=Ke({},this.defaults_,this.cache_)}set(t){if(this.cache_=Ke({},this.defaults_,this.cache_,t),le.isSupported_())try{le.set_(this.key_,JSON.stringify(this.cache_))}catch(e){}}clear(){if(this.cache_={},le.isSupported_())try{le.clear_(this.key_)}catch(t){}}destroy(){delete ni[this.key_],Object.keys(ni).length||$0()}},Xn=le;function b0(){window.addEventListener("storage",Yc),Ur=!0}function $0(){window.removeEventListener("storage",Yc),Ur=!1}function Yc(n){let t=ni[n.key];if(t){let e=Ke({},t.defaults_,jr(n.oldValue)),s=Ke({},t.defaults_,jr(n.newValue));t.cache_=s,t.emit("externalSet",s,e)}}function jr(n){let t={};if(n)try{t=JSON.parse(n)}catch(e){}return t}var x0=1e3,P0=60*x0,Yn={},$s=class{static getOrCreate(t,e,s){let i=t.get("trackingId");return Yn[i]?Yn[i]:Yn[i]=new $s(t,e,s)}constructor(t,e,s){this.tracker=t,this.timeout=e||$s.DEFAULT_TIMEOUT,this.timeZone=s,this.sendHitTaskOverride=this.sendHitTaskOverride.bind(this),Le.add(t,"sendHitTask",this.sendHitTaskOverride);try{this.dateTimeFormatter=new Intl.DateTimeFormat("en-US",{timeZone:this.timeZone})}catch(o){}let i={hitTime:0,isExpired:!1};this.store=Xn.getOrCreate(t.get("trackingId"),"session",i),this.store.get().id||this.store.set({id:Ii()})}getId(){return this.store.get().id}isExpired(t=this.getId()){if(t!=this.getId())return!0;let e=this.store.get();if(e.isExpired)return!0;let s=e.hitTime;if(s){let i=new Date,o=new Date(s);if(i-o>this.timeout*P0||this.datesAreDifferentInTimezone(i,o))return!0}return!1}datesAreDifferentInTimezone(t,e){return this.dateTimeFormatter?this.dateTimeFormatter.format(t)!=this.dateTimeFormatter.format(e):!1}sendHitTaskOverride(t){return e=>{t(e);let s=e.get("sessionControl"),i=s=="start"||this.isExpired(),o=s=="end",r=this.store.get();r.hitTime=Xe(),i&&(r.isExpired=!1,r.id=Ii()),o&&(r.isExpired=!0),this.store.set(r)}}destroy(){Le.remove(this.tracker,"sendHitTask",this.sendHitTaskOverride),this.store.destroy(),delete Yn[this.tracker.get("trackingId")]}},Zr=$s;$s.DEFAULT_TIMEOUT=30;var Wr={CLEAN_URL_TRACKER:1,EVENT_TRACKER:2,IMPRESSION_TRACKER:3,MEDIA_QUERY_TRACKER:4,OUTBOUND_FORM_TRACKER:5,OUTBOUND_LINK_TRACKER:6,PAGE_VISIBILITY_TRACKER:7,SOCIAL_WIDGET_TRACKER:8,URL_CHANGE_TRACKER:9,MAX_SCROLL_TRACKER:10},Jc=Object.keys(Wr).length;function Qc(n,t){T0(n),S0(n,t)}function C0(n){return parseInt(n||"0",16).toString(2)}function M0(n){return parseInt(n||"0",2).toString(16)}function E0(n,t){if(n.length<t){let e=t-n.length;for(;e;)n="0"+n,e--}return n}function V0(n,t){return n.substr(0,t)+1+n.substr(t+1)}function S0(n,t){let e=n.get("&"+qr),s=E0(C0(e),Jc);s=V0(s,Jc-t),n.set("&"+qr,M0(s))}function T0(n){n.set("&"+Fc,zc)}var Di="hidden",Se="visible",oi=Ii(),td=1e3,ed=class{constructor(t,e){if(Qc(t,Wr.PAGE_VISIBILITY_TRACKER),!document.visibilityState)return;let s={sessionTimeout:Zr.DEFAULT_TIMEOUT,visibleThreshold:5*td,sendInitialPageview:!1,fieldsObj:{}};this.opts=Ke(s,e),this.tracker=t,this.lastPageState=document.visibilityState,this.visibleThresholdTimeout_=null,this.isInitialPageviewSent_=!1,this.trackerSetOverride=this.trackerSetOverride.bind(this),this.handleChange=this.handleChange.bind(this),this.handleWindowUnload=this.handleWindowUnload.bind(this),this.handleExternalStoreSet=this.handleExternalStoreSet.bind(this),this.store=Xn.getOrCreate(t.get("trackingId"),"plugins/page-visibility-tracker"),this.store.on("externalSet",this.handleExternalStoreSet),this.session=Zr.getOrCreate(t,this.opts.sessionTimeout,this.opts.timeZone),Le.add(t,"set",this.trackerSetOverride),window.addEventListener("unload",this.handleWindowUnload),document.addEventListener("visibilitychange",this.handleChange),Zc(this.tracker,()=>{document.visibilityState==Se?(this.opts.sendInitialPageview&&(this.sendPageview({isPageLoad:!0}),this.isInitialPageviewSent_=!0),this.store.set({time:Xe(),state:Se,pageId:oi,sessionId:this.session.getId()})):this.opts.sendInitialPageview&&this.opts.pageLoadsMetricIndex&&this.sendPageLoad()})}handleChange(){if(!(document.visibilityState==Se||document.visibilityState==Di))return;let t=this.getAndValidateChangeData(),e={time:Xe(),state:document.visibilityState,pageId:oi,sessionId:this.session.getId()};document.visibilityState==Se&&this.opts.sendInitialPageview&&!this.isInitialPageviewSent_&&(this.sendPageview(),this.isInitialPageviewSent_=!0),document.visibilityState==Di&&this.visibleThresholdTimeout_&&clearTimeout(this.visibleThresholdTimeout_),this.session.isExpired(t.sessionId)?(this.store.clear(),this.lastPageState==Di&&document.visibilityState==Se&&(clearTimeout(this.visibleThresholdTimeout_),this.visibleThresholdTimeout_=setTimeout(()=>{this.store.set(e),this.sendPageview({hitTime:e.time})},this.opts.visibleThreshold))):(t.pageId==oi&&t.state==Se&&this.sendPageVisibilityEvent(t),this.store.set(e)),this.lastPageState=document.visibilityState}getAndValidateChangeData(){let t=this.store.get();return this.lastPageState==Se&&t.state==Di&&t.pageId!=oi&&(t.state=Se,t.pageId=oi,this.store.set(t)),t}sendPageVisibilityEvent(t,{hitTime:e}={}){let s=this.getTimeSinceLastStoredChange(t,{hitTime:e});if(s&&s>=this.opts.visibleThreshold){let i=Math.round(s/td),o={transport:"beacon",nonInteraction:!0,eventCategory:"Page Visibility",eventAction:"track",eventValue:i,eventLabel:_r};e&&(o.queueTime=Xe()-e),this.opts.visibleMetricIndex&&(o["metric"+this.opts.visibleMetricIndex]=i),this.tracker.send("event",Wn(o,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}}sendPageLoad(){let t={transport:"beacon",eventCategory:"Page Visibility",eventAction:"page load",eventLabel:_r,["metric"+this.opts.pageLoadsMetricIndex]:1,nonInteraction:!0};this.tracker.send("event",Wn(t,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}sendPageview({hitTime:t,isPageLoad:e}={}){let s={transport:"beacon"};t&&(s.queueTime=Xe()-t),e&&this.opts.pageLoadsMetricIndex&&(s["metric"+this.opts.pageLoadsMetricIndex]=1),this.tracker.send("pageview",Wn(s,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}trackerSetOverride(t){return(e,s)=>{let i=Kc(e)?e:{[e]:s};i.page&&i.page!==this.tracker.get("page")&&this.lastPageState==Se&&this.handleChange(),t(e,s)}}getTimeSinceLastStoredChange(t,{hitTime:e}={}){return t.time?(e||Xe())-t.time:0}handleExternalStoreSet(t,e){t.time!=e.time&&e.pageId==oi&&e.state==Se&&!this.session.isExpired(e.sessionId)&&this.sendPageVisibilityEvent(e,{hitTime:t.time})}handleWindowUnload(){this.lastPageState!=Di&&this.handleChange()}remove(){this.store.destroy(),this.session.destroy(),Le.remove(this.tracker,"set",this.trackerSetOverride),window.removeEventListener("unload",this.handleWindowUnload),document.removeEventListener("visibilitychange",this.handleChange)}};zr("pageVisibilityTracker",ed);Lc();Mt.addClass((v.isMobile?"is":"not")+"-mobile");v.isSafari&&Mt.addClass("is-safari");setTimeout(()=>Mt.addClass("ready"));window.addEventListener("keydown",n=>{n.keyCode===9&&Mt.addClass("is-tabbing")});window.addEventListener("mousedown",()=>{Mt.removeClass("is-tabbing")});var sd=N(".cookie-warning");sd&&N("#yes-to-cookies").on("click",function(){sd.exit("pop",300),v.setCookie("cookie_consent",1)});var id;(id=navigator.serviceWorker)==null||id.register("/service_worker.js",{scope:"/"}).catch(()=>console.warn("Unable to register Service Worker."));window.addEventListener("beforeinstallprompt",n=>{n.prompt()});var nd;(nd=N("#skip-nav"))==null||nd.on("click",()=>{var t;(t=(N("article")||N(".panel.active")||N(".body")||q).$("input, button, a, textarea, [contenteditable], [tabindex]"))==null||t.focus()});var Kr=N("nav x-popup");if(Kr){let n=Kr.$$(".popup-body a, .popup-body button");for(let t of n)t.on("click",()=>Kr.close())}var A0=Pe("#language .locale-link");Ri.on("change",n=>{for(let t of A0)t.setAttr("href",t.data.host+n)});var Jn=N("#dark-mode");Jn&&(Jn.checked=v.theme.isDark,Jn.on("change",()=>v.setTheme(Jn.checked?"dark":"light")));var Gi={},xs=N("#search"),Ye=xs==null?void 0:xs.$(".form-field input"),Qn=xs==null?void 0:xs.$(".search-body");Gi[""]=(Qn==null?void 0:Qn.html)||"";function k0(n){return n=n.trim().replace(/\s+/," ").toLowerCase().slice(0,50),n==="pi"||n.length>=3?n:""}function O0(n){return P(this,null,function*(){if(n=encodeURIComponent(k0(n)),n in Gi)return Gi[n];let t=yield fetch(`/api/search?q=${n}`);return t.ok?Gi[n]=yield t.text():Gi[n]=""})}var L0=0,od=0;function rd(n){return P(this,null,function*(){let t=L0+=1,e=yield O0(n);t<=od||(od=t,Qn.html=e)})}Ye==null||Ye.change(n=>{v.setCookie("search",n,60*60*24),setTimeout(()=>{Ye.value===n&&rd(n)},300)});(Ye==null?void 0:Ye.value)&&xs.one("open",()=>rd(Ye.value));var ad='<label class="target"><input maxlength="15" autocomplete="off" aria-label="Fill in this blank"></label>';function hd(n){if(n.match("^[0-9]+/[0-9]+$")){let t=n.split("/");return+t[0]/+t[1]}else return Mi(n)}var Xr=class extends L{constructor(){super(...arguments);this.solution="";this.solutionNum=NaN;this.solutionDisplay="";this.range=0;this.input="";this.hint="";this.attempts=0;this.placeholder="???";this.done=!1}ready(){if(this.$input=this.$("input"),this.$target=this.$(".target"),this.solution=this.attr("solution"),this.solution.indexOf("\xB1")>=0){let t=this.solution.split("\xB1");this.solution=t[0].trim(),this.range=+t[1]}this.solutionNum=hd(this.solution),this.solutionDisplay=this.solution,this.hint=this.attr("hint"),this.removeAttr("solution"),this.removeAttr("hint"),this.$input.setInputPattern(this.solution),this.hasAttr("placeholder")&&(this.placeholder=this.attr("placeholder")),this.$input.setAttr("placeholder",this.placeholder),this.removeAttr("placeholder"),this.$input.change(t=>{this.input=t,this.isCorrect&&(this.solve(),this.trigger("valid",t),this.moveCursor())}),this.$input.onKeyDown("enter",()=>this.$input.blur()),this.$input.on("focus",()=>{this.addClass("on"),this.removeClass("invalid"),this.$input.setAttr("placeholder"," ")}),this.$input.on("blur",()=>{if(this.removeClass("on"),this.setClass("invalid",!!this.input&&!this.done),this.$input.setAttr("placeholder",this.placeholder),this.input&&!this.done){this.attempts+=1;let t=this.attempts>=(this.hint?4:3)?`Hmmm\u2026 maybe try ${this.solution}?`:this.attempts>=2?this.hint:void 0;this.trigger("invalid",{hint:t})}})}setup(t,e,s){var i;this.goal=e,this.$step=t,((i=s==null?void 0:s.scores)==null?void 0:i.includes(e))&&this.solve(!0),this.one("valid",()=>{t.addHint("correct"),t.score(this.solvedBlank?this.solvedBlank.goal:e)}),this.on("invalid",o=>t.addHint(o.hint||"incorrect",{class:"incorrect"}))}get isCorrect(){if(this.done)return!0;if(this.linkedBlanks){let t=this.linkedBlanks.map(e=>e.solvedBlank);return this.solvedBlank=this.linkedBlanks.find(e=>{if(e.done&&!e.solvedBlank||t.includes(e))return!1;if(e.checkAnswer(this.input))return!0}),this.solvedBlank&&(this.solutionDisplay=this.solvedBlank.solution),!!this.solvedBlank}return this.checkAnswer(this.input)}checkAnswer(t){let e=hd(t);return t.toLowerCase()===this.solution.toLowerCase()?!0:this.range&&Math.abs(e-this.solutionNum)<=this.range?(this.solutionDisplay=t,!0):C(e,this.solutionNum)||Ws(e)===this.solution||t===Ws(this.solutionNum)}moveCursor(){if(!this.$step)return;let t=this.$step.$blanks[this.$step.$blanks.indexOf(this)+1];!t||t.done||t.tagName==="X-BLANK-MC"||t.css("visibility")==="hidden"||!t.bounds.width||t.focus()}solve(t=!1){this.done=!0,this.$input.remove(),this.$target.html=this.solutionDisplay,this.addClass("done"),this.trigger("solve",{solution:this.solutionDisplay,restore:t})}focus(){this.$input.focus()}blur(){this.$input.blur()}};Xr=V([A("x-blank",{template:ad})],Xr);var ld='<span class="target" slot="target" tabindex="0" aria-label="Fill in this blank">???</span><div class="popup"><slot></slot></div>';var Yr=class extends L{constructor(){super(...arguments);this.done=!1}ready(){this.$target=this.$(".target"),this.$popup=this.$(".popup");let t=this.$popup.$$(".choice");this.solution=t[0].html,ct.shuffle(Us(t.length)).forEach(i=>{this.$popup.append(t[i]),t[i].on("click",()=>{this.removeClass("on"),t[i].blur(),i?(this.$target.html=t[i].html,this.addClass("invalid"),this.trigger("invalid")):(this.solve(),this.trigger("valid",this.solution))})});let s=this.$target.bounds.left+this.$popup.width>v.width-15;this.setClass("left",s),Qs(this,{enter:()=>{if(this.done)return;this.addClass("on");let i=this.$target.bounds,o=this.$popup.width,r=this.$popup.height,a=v.width-10-i.left,h=o<a,l=i.right-o>10,p=i.top+i.height+r>v.height-10;this.setClass("left",l&&!h),this.setClass("top",p),this.$popup.css("max-width",!l&&!h?`${a}px`:"none")},exit:()=>{this.removeClass("on")},delay:100,exitDelay:400,$clickTarget:this.$target})}setup(t,e,s){var i;((i=s==null?void 0:s.scores)==null?void 0:i.includes(e))&&this.solve(!0),this.one("valid",()=>{t.addHint("correct"),t.score(e)}),this.on("invalid",o=>t.addHint(o.hint||"incorrect",{class:"incorrect"}))}solve(t=!1){this.done=!0,this.$target.html=this.solution,this.removeClass("on invalid"),this.addClass("done"),this.trigger("solve",{solution:this.solution,restore:t}),setTimeout(()=>this.$popup.remove(),250),this.$target.removeAttr("tabindex")}};Yr=V([A("x-blank-mc",{template:ld})],Yr);var cd='<div class="text-area" contenteditable="true"></div><div class="toolbar"><button class="command" data-command="bold"><x-icon name="bold" size="20"></x-icon></button><button class="command" data-command="italic"><x-icon name="italic" size="20"></x-icon></button><button class="command" data-command="underline"><x-icon name="underlined" size="20"></x-icon></button><div class="space"></div><button class="btn btn-green submit"><x-icon name="check"></x-icon> Done</button></div>';var dd=40,pd="free-text",Jr=class extends L{setup(t,e,s){var l,p;let i=this.$(".text-area"),o=this.$(".toolbar .submit"),r=((l=s==null?void 0:s.data)==null?void 0:l[pd])||"";r&&(i.html=r);for(let u of this.$$(".toolbar .command")){let m=u.data.command.split(":");u.on("click",()=>document.execCommand(m[0],!1,m[1]))}let a=r,h=ls(()=>{a!==r&&t.storeData(pd,r),a=r},5e3);i.on("change keyup input paste",()=>{r=i.html.replace(/&nbsp;/g," ").trim().slice(0,500).trim(),o.setClass("invisible",r.length<dd),h()}),((p=s==null?void 0:s.scores)==null?void 0:p.includes(e))?o.remove():(o.setClass("invisible",r.length<dd),o.on("click",()=>{h(),t.score(e),o.exit("pop"),this.trigger("submit")}))}};Jr=V([A("x-free-text",{template:cd})],Jr);var ud='<div class="wrapper"><div class="panel"><slot></slot></div></div><div class="nav"><button class="btn back" aria-label="Previous Step"><x-icon name="left"></x-icon></button><button class="btn next" aria-label="Next Step"><x-icon name="right"></x-icon></button><div class="dots"></div></div>';var Qr=class extends L{ready(){let t=this.$(".wrapper"),e=this.$(".panel"),s=e.children,i=this.$(".next"),o=this.$(".back"),r=this.$(".dots"),a=s.map(()=>c("div",{class:"dot"},r)),h=s.length,l=+this.attr("slide-width")||void 0,p=this.width,u=1,m=p,g=0,b=0,w=mt=>{b=mt,e.translate(mt,0),this.trigger("move",mt)},y=mt=>{g=mt;for(let[fe,Ci]of a.entries())Ci.setClass("on",fe>=mt&&fe<mt+u);i.setClass("disabled",mt===h-u),o.setClass("disabled",mt===0),this.trigger("change",mt)};v.onResize(()=>{p=this.width,u=l?Math.ceil(p/l):1,m=p/u;for(let mt of s)mt.css("width",m+"px");e.css("width",h*m+"px"),w(-g*m),y(g)});let $="quad",x=500,T,ft,ue,Ee,Wo=!1,Sl=()=>{T=Date.now()-Ee,w(ft+ue*X($,T/x)),!Wo&&T<x?requestAnimationFrame(Sl):this.trigger("slide-end")},Ko=mt=>{Wo=!1,T=0,ft=b,ue=-mt*m-b,Ee=Date.now(),y(mt),Sl()};i.on("click",()=>{$="quad",g<h-u&&Ko(g+1)}),o.on("click",()=>{$="quad",g>0&&Ko(g-1)});let Tl,Xo,Yo,Pn;Ze(t,{start:mt=>{Wo=!0,Tl=b,Xo=mt.x,Pn=Yo=Xo},move:mt=>{Yo=Pn,Pn=mt.x;let fe=Tl-Xo+mt.x,Ci=-(h-u)*m,yf=fe>0?fe/4:fe<Ci?Ci+(fe-Ci)/4:fe;w(yf),this.css("pointer-events","none")},end:()=>{let mt=Pn-Yo,fe=mt>12?1:mt<-12?-1:0;$="quad-out",Ko(M(Math.round(-b/m-fe),0,h-u)),setTimeout(()=>this.css("pointer-events","auto"))}})}};Qr=V([A("x-gallery",{template:ud})],Qr);var fd='<svg width="70" height="80"><path d="M20.5,7.4,27.2,24c-1.9-4.7,6-7.1,8-2.3l1.4,3.6c-1.9-4.8,6.1-7.1,8-2.3l1.3,3.1c-2-4.7,5.7-6.5,7.7-1.8,3.3,7.8,5.8,13.6,9,21.3S60.8,56.2,65,66.7L44.9,75A13.9,13.9,0,0,0,36,66.9c-7.7-2.2-11.4-8.3-18.4-14.3a44.2,44.2,0,0,0-9.5-6.5c-2.6-1.5-4.2-3.4-2.2-5.7,3.5-4.1,9.3-1.3,13.1,1.5,1.6,1.2,4.4,4.1,5.9,3.8s1.7-.8,1-2.6L12.8,10.5c-1.9-4.7,5.8-7.9,7.7-3.1Z"></path></svg>';function ta(n,t){let e=t.positionLeft-n.positionLeft+t.width/2,s=t.positionTop-n.positionTop+t.height/2;return new d(e,s)}function md(n){return n?new d(...n.split(",").map(t=>+t)):void 0}var ea=class extends L{constructor(){super(...arguments);this.doAnimation=!1}created(){this.slide=md(this.attr("slide")),this.shift=md(this.attr("offset"))}ready(){this.$target=N(this.attr("target")),this.$target&&(this.$target.on("click pointerdown focus",()=>this.stop()),this.hasAttr("start")&&this.start())}setTarget(t,e,s){this.$target=typeof t=="string"?N(t):t,e&&(this.slide=e),s&&(this.slide=s)}start(t){this.doAnimation||!this.from&&!this.$target||(this.doAnimation=!0,t&&(this.slide=t),this.slide||this.$end?this.runSlideAnimation():this.runClickAnimation())}startSlide(t,e){this.$target=t,this.$end=e,this.start()}stop(){this.doAnimation=!1}runSlideAnimation(){return P(this,null,function*(){this.show();let t=this.from||ta(this,this.$target);this.shift&&(t=t.add(this.shift));let e=this.slide?t.add(this.slide):ta(this,this.$end),s=`translate(${t.x-15}px,${t.y-10}px)`,i=`translate(${e.x-15}px,${e.y-10}px)`;yield this.animate({transform:[s+" scale(2)",s],opacity:[0,1]},300).promise,yield this.animate({transform:[s,i]},1e3).promise,yield this.animate({transform:[i,i+" scale(2)"],opacity:[1,0]},300).promise,this.hide(),setTimeout(()=>{this.doAnimation&&this.runSlideAnimation()},1e3)})}runClickAnimation(){return P(this,null,function*(){this.show();let t=this.from||ta(this,this.$target);this.shift&&(t=t.add(this.shift));let e=`translate(${t.x-15}px,${t.y-10}px)`;yield this.animate({transform:[e+" scale(2)",e],opacity:[0,1]},500).promise,yield this.animate({transform:[e,e+" scale(2)"],opacity:[1,0]},500,200).promise,this.hide(),setTimeout(()=>{this.doAnimation&&this.runClickAnimation()},1e3)})}};ea=V([A("x-gesture",{template:fd})],ea);var sa='<span class="target" tabindex="0"><slot></slot></span><div class="popup"></div>';var R0=JSON.parse(N("#glossary").text),I0=JSON.parse(N("#bios").text),ia=600,to;v.onResize(()=>{to&&to.hide()});var eo=class extends L{ready(){this.xid=this.attr("xid"),this.$target=this.$(".target"),this.$popup=this.$(".popup"),this.$popup.html=this.body()||"",this.setClass("left",v.width>ia&&this.$target.bounds.left+this.$popup.width>v.width-15),Qs(this,{enter:()=>this.show(),exit:()=>this.hide(),delay:100,exitDelay:200,$clickTarget:this.$target,canFocusWithin:!0,preventMouseover:()=>v.width<=ia})}show(){if(to=this,this.addClass("on"),v.width<=ia){let r=N("#glossary-modal");return r.$(".modal-body").html=this.body(),r.open()}let t=this.$target.bounds,e=this.$popup.width,s=this.$popup.height,i=t.top+t.height+s<v.height-10,o=t.top-s>54;this.setClass("top",o&&!i),this.setClass("left",t.left+e>v.width-15)}hide(){to=void 0,this.removeClass("on")}body(){let t=R0[this.xid];if(!t)return console.warn("missing gloss:",this.xid);let e=t.text;return t.image&&(e+=`<img class="gloss-img" alt="" src="/content/shared/glossary/${t.image}"/>`),t.link&&(location.pathname===t.link.split("#")[0]||(e+=`<p><a href="${t.link}" class="btn btn-white btn-small">Learn more\u2026</a></p>`)),e}};eo=V([A("x-gloss",{template:sa})],eo);var na=class extends eo{body(){let t=I0[this.xid];if(!t)return console.warn("missing bio:",this.xid);let e=`<img class="bio-img" alt="" src="/content/shared/bios/${this.xid}.jpg"/>`,s=t.born?`<p><a href="/timeline/${this.xid}" class="btn btn-white btn-small" target="_blank">Timeline</a></p>`:"";return(t.image===!1?"":e)+t.bio+s}};na=V([A("x-bio",{template:sa})],na);var gd='<div class="wrap"><img alt=""><div class="credit"></div><button class="zoom"><x-icon name="fullscreen" size="24"></x-icon></button><slot></slot></div>';var N0=document.createElement("a").relList.supports("ar"),so=!1,oa={x:0,y:0,s:1},wd,Ps=c("div",{class:"lightbox-overlay"},q),Re=c("div",{class:"lightbox-img"},Ps);function D0(n,t,e){so=!0,wd=n,Ps.show(),Re.show();let s=n.bounds,i=Re.bounds,o=s.left+s.width/2-i.left-i.width/2,r=s.top+s.height/2-i.top-i.height/2,a=Math.max(s.width/i.width,s.height/i.height);oa={x:o,y:r,s:a},Re.css("background-image",`url(${e}), url(${t})`),Re.css("transform",`translate(${o}px, ${r}px) scale(${a})`),v.redraw(),Re.addClass("transitions"),v.redraw(),n.css("visibility","hidden"),Ps.addClass("on"),Re.css("transform","scale(1) translate(0,0)")}function vd(){!so||(so=!1,Ps.removeClass("on"),Re.setTransform(oa,0,oa.s),setTimeout(()=>{wd.css("visibility","visible"),Ps.css("display","none"),Re.css("transform","none"),Re.removeClass("transitions")},400))}Ps.on("click touchmove",vd);v.onKey("escape",vd);Ps.on("scrollwheel touchmove",n=>{n.preventDefault(),n.stopPropagation()});v.onKey("space up down left right pagedown pageup",n=>{so&&(n.preventDefault(),n.stopPropagation())});var ra=class extends L{ready(){let t=this.attr("src"),e=this.$(".wrap"),s=this.attr("width"),i=this.attr("height");this.css("width",s+"px"),e.css("padding-bottom",+i/+s*100+"%");let o=e.$("img");o.setAttr("src",t),o.setAttr("alt",this.attr("alt")||""),o.setAttr("width",s),o.setAttr("height",i),t.endsWith(".gif")&&o.on("click",()=>o.setAttr("src",t));let r=e.$(".credit"),a=this.attr("credit");a?r.text=a:r.remove();let h=e.$(".zoom");if(this.hasAttr("lightbox")){this.addClass("interactive");let l=t.replace(/\.(?=[^.]*$)/,"-large.");this.on("click",()=>D0(this,t,l))}else h.remove();if(N0&&this.hasAttr("ar")){let l=c("a",{href:this.attr("ar"),rel:"ar"});e.prepend(l),l.append(o)}}};ra=V([A("x-img",{template:gd})],ra);var aa=class extends L{constructor(){super(...arguments);this.correctCount=0;this.solvedCount=0;this.isSolved=!1}setup(t,e,s){var a;let i=this.children,o=i.map(()=>!1);for(let[h,l]of i.entries()){let p=l.data.error,u=p?"incorrect":"correct";p||(this.correctCount+=1),l.one("click",()=>{o[h]||this.isSolved||(t.addHint(p||"correct",{class:u}),l.addClass(u),p||(this.solvedCount+=1,t.score("picker-"+h),this.checkSolved()))})}let r=((a=s==null?void 0:s.scores)==null?void 0:a.filter(h=>h.startsWith("picker-")))||[];for(let h of r){let l=+h.slice(7);o[l]=!0,i[l].addClass("correct")}this.solvedCount=r.length,this.checkSolved()}checkSolved(){this.solvedCount<this.correctCount||(this.addClass("solved"),this.isSolved=!0)}};aa=V([A("x-picker")],aa);var yd='<a class="btn classroom" title="Classroom" href="https://classroom.google.com/share?url=${url}&amp;title=${title}" target="_blank" rel="noopener"></a><a class="btn twitter" title="Twitter" href="https://twitter.com/intent/tweet?url=${url}&amp;text=${title}&amp;via=MathigonOrg" target="_blank" rel="noopener"><x-icon name="twitter" size="36"></x-icon></a><a class="btn facebook" title="Facebook" href="https://www.facebook.com/dialog/share?app_id=522356201246169&amp;display=page&amp;href=${url}" target="_blank" rel="noopener"><x-icon name="facebook" size="36"></x-icon></a><a class="btn pinterest" title="Pinterest" href="https://pinterest.com/pin/create/bookmarklet/?media=${img}&amp;url=${url}&amp;description=${title}" target="_blank" rel="noopener"><x-icon name="pinterest" size="36"></x-icon></a><a class="btn reddit" title="Reddit" href="https://reddit.com/submit?url=${url}&amp;title=${title}" target="_blank" rel="noopener"><x-icon name="reddit" size="36"></x-icon></a><button class="btn" title="Copy to Clipboard" :show="canCopy" @click="copy()"><x-icon name="link" size="36"></x-icon></button><x-alert class="success" key="clipboard"><x-icon name="check" size="24"></x-icon> URL copied to clipboard!</x-alert>';var ha=class extends L{ready(){this.bindModel(Dt({title:"",url:"",img:"",body:"",fbAppId:this.attr("facebook"),twitterHandle:this.attr("twitter"),canCopy:!!window.navigator.clipboard,copy:()=>this.copyUrl()}));for(let t of["title","url","img","body"])this.onAttr(t,e=>this.model[t]=encodeURIComponent(e));for(let t of this.$$("a.btn"))t.on("click",e=>{window==null||window.ga("send","event","Share",t.attr("title")),e.preventDefault();let s=window.screen.height/2-320,i=window.screen.width/2-360,o=`menubar=no,toolbar=no,width=720,height=640,top=${s},left=${i}`;window.open(t.attr("href"),"",o)})}copyUrl(){return P(this,null,function*(){let t=this.attr("url");yield window.navigator.clipboard.writeText(t),navigator.canShare&&navigator.share({title:this.attr("title"),url:t}),si("clipboard")})}};ha=V([A("x-share",{template:yd})],ha);var Je=class extends we{constructor(t,e={}){super();this.$el=t;this.startPos=new d(0,0);this.position=new d(0,0);this.disabled=!1;this.options=Sn(e,{moveX:!0,moveY:!0,withinBounds:!0}),v.onResize(()=>this.updateBounds()),Ze(t,{start:()=>{this.disabled||(this.startPos=this.position,this.trigger("start"),Mt.addClass("grabbing"))},move:(s,i)=>{this.disabled||(this.setPosition(this.startPos.x+s.x-i.x,this.startPos.y+s.y-i.y),this.trigger("drag",{posn:this.position,pointerPosn:s}),this.checkTarget(s))},end:(s,i)=>{this.disabled||(this.trigger(s.equals(i)?"click":"end",{$target:this.$over}),this.options.$targets&&!this.$over&&this.options.resetOnMiss&&this.resetPosition(),this.$over=void 0,Mt.removeClass("grabbing"))},click:()=>this.trigger("click"),accessible:!0})}addTarget(t){var e;this.options.$targets||(this.options.$targets=[]),(e=this.options.$targets)==null||e.push(t)}removeTarget(t){var e,s;this.options.$targets=(e=this.options.$targets)==null?void 0:e.filter(i=>i!=t),((s=this.options.$targets)==null?void 0:s.length)||(this.options.$targets=void 0)}checkTarget(t){if(!this.options.$targets)return;let e=this.options.$targets.find(s=>s.boundsRect.contains(t));e!==this.$over&&(this.$over&&this.trigger("exit-target",{$target:this.$over}),e&&this.trigger("enter-target",{$target:e}),this.$over=e)}updateBounds(){if(!this.options.withinBounds)return this.bounds=void 0;if(this.options.bounds)return this.bounds=this.options.bounds;let t=this.bounds,e=this.options.$parent||this.$el.parent,s=e.type==="svg"?e.svgWidth:e.width,i=e.type==="svg"?e.svgHeight:e.height;this.bounds=new pt(0,s,0,i),!s&&!i&&setTimeout(()=>this.updateBounds()),t&&this.setPosition(this.position.x*this.bounds.dx/t.dx||0,this.position.y*this.bounds.dy/t.dy||0)}setPosition(t,e){var i;let s=new d(this.options.moveX?t:0,this.options.moveY?e:0);this.bounds&&(s=s.clamp(this.bounds,(i=this.options.margin)!=null?i:0)),s=s.round(this.options.snap||1),this.options.round&&(s=this.options.round(s)),!s.equals(this.position)&&(this.position=s,this.options.useTransform?this.$el.translate(s.x,s.y):(this.options.moveX&&this.$el.css("left",s.x+"px"),this.options.moveY&&this.$el.css("top",s.y+"px")),this.trigger("move",{posn:s}))}resetPosition(t=250){return P(this,null,function*(){let e=this.position;this.$el.css({"pointer-events":"none"}),yield z(s=>{let i=d.interpolate(e,this.startPos,s);this.setPosition(i.x,i.y)},t).promise,this.$el.css({"pointer-events":"initial"})})}};var bd='<button class="play" aria-label="Play Slider"><x-icon name="play" size="32"></x-icon></button><div class="bar"><div class="knob"></div></div>';var la=class extends L{constructor(){super(...arguments);this.current=0}ready(){this.onAttr("steps",r=>this.steps=+r),this.speed=+this.attr("speed")||1;let t=this.$(".bar"),e=this.$(".knob"),s=this.$(".play");this.hasAttr("no-play")?s.remove():s.on("click",()=>this.play());let i=this.hasAttr("continuous"),o=this.hasAttr("snap")?t.width/this.steps:.001;this.drag=new Je(e,{moveY:!1,snap:o}),this.drag.on("start",()=>{this.animation&&this.animation.cancel(),this.animation=void 0}),this.drag.on("move",({posn:r})=>{let a=r.x/this.drag.bounds.dx*this.steps;i||(a=Math.round(a)),!C(a,this.current)&&(this.current=a,this.trigger("move",a))}),this.drag.on("end",()=>this.trigger("slide-end"))}setup(t,e){this.bindModel(t.model),this.one("slide-end",()=>t.score(e))}set(t){C(t,this.current)||this.drag.setPosition(t*this.drag.bounds.dx/this.steps,0)}play(){return P(this,null,function*(){this.current>=this.steps&&this.set(0);let t=(1-this.current/this.steps)*3e3/this.speed;this.moveTo(this.steps,t)})}moveTo(t,e=600){return P(this,null,function*(){if(this.animation||t===this.current)return;let s=this.current;this.animation=z(i=>{this.set(s+(t-s)*X("quad",i))},e),yield this.animation.promise,this.animation=void 0,this.trigger("slide-end")})}bindVariable(t,e){t[e]=0,this.on("move",s=>t[e]=s),t.watch(()=>this.set(t[e]))}};la=V([A("x-slider",{template:bd})],la);var $d='<slot name="stage"></slot><div class="nav"><button class="btn back disabled" aria-label="Previous Step"><x-icon name="left" size="24"></x-icon></button><button class="btn next" aria-label="Next Step"><x-icon name="right" size="24"></x-icon></button><div class="dots"></div></div><div class="legend-box"><slot></slot></div>';function G0(n){let t=n.$$("x-blank, x-blank-mc");if(!t.length)return Promise.resolve();let e=0;return new Promise(s=>{for(let i of t)i.on("solve",()=>{e+=1,e>=t.length&&s()})})}var ca=class extends L{constructor(){super(...arguments);this.length=0;this.current=0;this.locked=!1}ready(){this.$legend=this.$(".legend-box"),this.$steps=this.$legend.children,this.$back=this.$(".back"),this.$next=this.$(".next");let t=this.$(".dots");this.$dots=this.$steps.map(()=>c("div",{class:"dot"},t)),this.length=this.$steps.length,this.current=0,this.$back.on("click",()=>this.goBack()),this.$next.on("click",()=>this.goNext()),this.blanks=this.$steps.map(e=>G0(e)),this.reveals=this.$$("[slide]").map(e=>{let s=e.attr("slide").split("-"),i=s.length>1?[+s[0]||0,+s[1]||this.length]:[+s[0],+s[0]],o=[e.data.animation||"fade",+e.data.duration||400];return e.data.display="visibility",i[0]>=0&&!e.hasClass("reveal")&&e.hide(),[e,i,o]}),this.autoAdvance=this.attr("step")==="auto",this.$steps[0].show(),this.$dots[0].addClass("on"),this.setupSlide(0)}setup(t,e,s){var o;let i=(o=s==null?void 0:s.scores)==null?void 0:o.filter(r=>r.startsWith("slide-")).length;if(i&&i<this.$steps.length-1){this.go(i);for(let r=1;r<=i;++r)this.trigger("next",r)}this.on("next",r=>t.score("slide-"+(r-1)))}go(t){if(this.locked||t<0||t>this.length-1||t===this.current)return;this.locked=!0,setTimeout(()=>this.locked=!1,600),this.$back.setClass("disabled",t===0),this.$next.setClass("disabled",t===this.length-1),this.$dots[this.current].removeClass("on"),this.$dots[t].addClass("on"),this.$steps[t].show();let e=this.$steps[t].height+"px";this.$steps[t].hide(),this.$steps[this.current].exit("fade",300).promise.then(()=>this.$steps[t].enter("fade",300)),this.$legend.animate({height:e},600).promise.then(()=>this.$legend.css("height","auto")),this.setupSlide(t),this.current=t,this.trigger("step",t)}setupSlide(t){this.$next.setAttr("disabled","true"),this.blanks[t].then(()=>this.$next.removeAttr("disabled"));for(let[e,s,i]of this.reveals){if(e.hasClass("reveal"))continue;let o=e.css("visibility")!=="hidden",r=t>=s[0]&&t<=s[1];r&&!o&&e.enter(...i,300),!r&&o&&e.exit(...i)}}goNext(){this.locked||(this.go(this.current+1),this.trigger("next",this.current))}goBack(){this.locked||(this.go(this.current-1),this.trigger("back",this.current))}};ca=V([A("x-slideshow",{template:$d})],ca);var da=class extends L{ready(){var g,b;(g=N(".sidebar-toggle"))==null||g.on("click",()=>this.addClass("open")),(b=N(".sidebar-shadow"))==null||b.on("pointerdown",()=>this.removeClass("open"));let t=N("#feedback form"),e=N("#feedback button"),s=N("#feedback .error"),i=N("#feedback-success"),o=N('#feedback textarea[name="message"]'),r=N("x-course").id;t==null||t.on("submit",w=>{w.preventDefault(),e.setAttr("disabled","true"),s.hide(),ke(`/course/${r}/feedback`,t.formData).then(()=>{i.open(),o.value=""}).catch(()=>s.show()).then(()=>e.removeAttr("disabled"))});let a=JSON.parse(N("#glossary").text),h=N("#glossary-search"),l=h.$(".gloss-body"),p=h.$(".gloss-list"),u=h.$(".gloss-search input"),m;for(let w of Object.keys(a).sort()){let y=a[w],$=c("div",{class:"gloss-item",html:y.title,tabindex:0},p);$.on("click",()=>{m&&m.removeClass("on"),m=$,$.addClass("on"),l.html=y.text});let x=y.title.toLowerCase();u.change(T=>$.setClass("hidden",!!T&&x.indexOf(T.toLowerCase())<0))}}};da=V([A("x-course-sidebar")],da);function pa(n,t){let e=Tn(n.map(s=>s.h+10));for(let[s,i]of n.entries())i.drag.bounds=new pt(0,0,0,I(e)),i!==t&&i.drag.setPosition(0,e[s-1]||0)}function H0(n){return n.every((t,e)=>t.index===e)||n.every((t,e)=>t.index===n.length-e-1)}var ua=class extends L{ready(){this.items=this.children.map(t=>({drag:new Je(t,{moveX:!1,useTransform:!0}),index:+t.data.index,h:0}));for(let t of this.children)t.removeAttr("data-index");for(let t of this.items)t.drag.on("drag",()=>{this.items=cs(this.items,e=>e.drag.position.y-(e===t?10:0)),pa(this.items,t)}),t.drag.on("end",()=>{pa(this.items),H0(this.items)&&this.solve()});v.onResize(()=>{for(let e of this.items)e.h=e.drag.$el.height;let t=H(this.items.map(e=>e.h));this.css("height",t+this.items.length*10-10+"px"),pa(this.items)})}setup(t,e,s){var i;((i=s==null?void 0:s.scores)==null?void 0:i.includes(e))&&this.solve(),this.one("solve",()=>{t.addHint("correct"),t.score(e)})}solve(){this.trigger("solve"),this.addClass("solved");for(let t of this.items)t.drag.disabled=!0}};ua=V([A("x-sortable")],ua);function xd(n,t=!1){return P(this,null,function*(){if(n.css("visibility")==="visible")return;n.data.display="visibility";let e=+n.data.duration||400,s=(t?0:600)+(+n.data.delay||0);yield n.enter(n.data.animation||"fade",e,s).promise,n.css({opacity:"",transform:""}),n.trigger("reveal"),n.removeClass("reveal")})}var fa=class extends L{constructor(){super(...arguments);this.model=Dt({});this.isShown=!1;this.isCompleted=!1;this.scores=new Set}ready(){var e,s,i,o;this.$course=this.parents("x-course")[0],this.$blanks=this.$$("x-blank, x-blank-mc"),this.$components=this.$$("[goal]"),this.userData=(i=(s=(e=this.$course)==null?void 0:e.userData)==null?void 0:s.steps)==null?void 0:i[this.id],this.goals=tt(this.attr("goals")),this.$reveals=this.$$(".reveal");let t=this.$$(".check[data-when]");for(let r of[...this.$reveals,...t])this.onScore(r.data.when,()=>xd(r));this.$nextBtn=this.$$(".next-step");for(let[r,a]of this.$nextBtn.entries())this.onScore("next-"+r,()=>a.exit("pop")),a.one("click",()=>this.score("next-"+r));for(let r of this.$$(".step-target"))r.tagName!=="X-TARGET"&&Qs(r,{enter:()=>{let a=this.$$('[target~="'+r.data.to+'"]');for(let h of a)h.addClass("focus");this.addClass("focus"),this.trigger("target-focus",{$targets:a})},exit:()=>{for(let a of this.$$(".focus"))a.removeClass("focus");this.removeClass("focus")}});for(let r of this.$$(".var, .var-action"))r.bindModel(this.model);((o=this.$course)==null?void 0:o.audio)&&(this.narration=new Vr(this.$course.audio,this))}show(){var s,i,o;if(this.isShown)return;this.isShown=!0,(s=StepFunctions==null?void 0:StepFunctions[Mn(this.id)])==null||s.call(StepFunctions,this);for(let r of this.$components)r.setup(this,r.attr("goal"),this.userData);let t=((i=this.userData)==null?void 0:i.scores)||[];for(let r of t)this.score(r,!1);let e=this.$$("x-gesture[target]");setTimeout(()=>{if(!this.isReady)for(let r of e)r.start()},2e3),(o=this.$course)==null||o.log("Step","show",this.id),this.trigger("show"),this.addClass("on"),this.narration&&setTimeout(()=>this.narration.play(),400)}complete(){if(!this.isCompleted){this.isShown||this.show(),this.isCompleted=!0;for(let t=0;t<this.$nextBtn.length;++t)this.score("next-"+t);for(let t of this.$reveals)t.parents("svg").length||xd(t,!0);this.trigger("complete")}}get isReady(){return this.goals.every(t=>this.scores.has(t))}get isPageLoaded(){return this.$course?this.$course.isReady:!0}score(t,e=!0){this.scores.has(t)||(this.scores.add(t),this.trigger("score-"+t),this.trigger("score"),this.$course&&(this.$course.trigger("score"),this.$course.saveProgress({steps:{[this.id]:{scores:[t]}}}),this.$course.log("Step","score",this.id+"/"+t)),e&&this.isReady&&this.$course&&this.$course.isReady&&setTimeout(()=>{this.$course.$activeStep===this&&this.$course.nextStep()},1200))}storeData(t,e){var s;(s=this.$course)==null||s.saveProgress({steps:{[this.id]:{data:{[t]:e}}}})}onScore(t,e){let s=tt(t);if(s.every(r=>this.scores.has(r)))return e&&e(),Promise.resolve();let i=hs(),o=()=>{!s.every(r=>this.scores.has(r))||(e&&e(),i.resolve(),this.off("score",o))};return this.on("score",o),i.promise}addHint(t,e={}){var s,i,o;return this.trigger("hint",t),((s=this.$course)==null?void 0:s.isReady)?this.isInViewport?(i=this.$course.$tutor)==null?void 0:i.showHint(t,e):(this.one("enterViewport",()=>{var r;return(r=this.$course.$tutor)==null?void 0:r.showHint(t,e)}),{text:((o=this.$course.$tutor)==null?void 0:o.hints[t])||t}):{text:t}}delayedHint(t,e=1e4){let s=setTimeout(t,e);this.on("score",()=>{clearTimeout(s),this.isCompleted||(s=setTimeout(t,e))}),this.on("complete",()=>clearTimeout(s))}get nextStep(){if(!this.$course)return;let t=this.$course.$steps.indexOf(this);return this.$course.$steps[t+1]}groupBlanks(...t){let e=t.map(s=>this.$blanks[s]);for(let s of e)s.linkedBlanks=e}};fa=V([A("x-step")],fa);var q0='<div class="titles"></div><div class="body"><slot></slot></div>',ma=class extends L{constructor(){super(...arguments);this.$titles=[];this.active=0}ready(){let t=this.$(".titles");this.$body=this.$(".body"),this.$tabs=this.$$(".tab");for(let e=0;e<this.$tabs.length;++e){let s=this.$tabs[e].$("h3")||c("h3");s.setAttr("tabindex","0"),t.append(s),this.$titles.push(s),s.on("click",()=>this.makeActive(e))}this.$titles[0].addClass("active"),this.$tabs[0].show()}makeActive(t){if(this.active===t)return;this.$titles[this.active].removeClass("active"),this.$titles[t].addClass("active"),this.$tabs[t].show();let e=this.$tabs[t].outerHeight+"px";this.$tabs[t].hide(),this.$tabs[this.active].exit("fade",300).promise.then(()=>this.$tabs[t].enter("fade",300)),this.$body.animate({height:e},600).promise.then(()=>this.$body.css("height","auto")),this.active=t,this.trigger("change",t)}};ma=V([A("x-tabbox",{template:q0})],ma);var Pd='<defs><mask id="masking"><rect width="100%" height="100%" fill="white"></rect></mask></defs><marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="4" markerHeight="4" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><rect x="0" y="0" width="100%" height="100%" mask="url(#masking)" opacity="0.8"></rect><path class="target-arrow" stroke-width="5" marker-end="url(#arrow)" opacity="0.4" stroke-linecap="round"></path>';function _0(n,t,e,s){let i=new d(n.left-15,n.top+e-15),o=new S(i,n.width+30,n.height+30),r=new d(t.left-15,t.top+s-15),a=new S(r,t.width+30,t.height+30),h=new Z(o.center,a.center);return[St(h,o)[0],St(h,a)[0]]}function B0(n,t){return Math.abs(n[0]-t[0])+Math.abs(n[1]-t[1])}var Sd=Pe("header, x-tutor, .sidebar"),ri=c("svg",{class:"target-body",html:Pd},q),z0=ri.$("mask"),F0=ri.$(".target-arrow"),ai=!1,Td=[],ga=class extends L{ready(){this.setAttr("tabindex",0);let t=this.attr("to").replace(/_/g," "),e=this.hasClass("no-margins"),s,i,o,r,a=()=>{ai=!0;let u=Pe(t);if(!u.length)return;let m=u[0].hasParent(...Sd);s===void 0&&(s=this.hasParent(...Sd));let g=this.bounds,b=u.map(w=>w.bounds).filter(w=>w.width||w.height);if(o=0,!m){let w=Math.min(...b.map(T=>T.top)),y=Math.max(...b.map(T=>T.top+T.height)),$=v.height-12-y,x=56-w;o=$<0?$:x>0?x:0}for(let w of Td)w.remove();Td=[g,...b].map((w,y)=>{let $=!y||e?4:10;return c("rect",{x:w.left-$,y:w.top-$+(y||!s?o:0),width:w.width+2*$,height:w.height+2*$,rx:y?4:18,ry:y?4:18},z0)}),F0.points=_0(g,b[0],s?0:o,m?0:o)},h=()=>{o&&q.scrollBy(-o,300),ri.css("display","block"),v.redraw(),ge(function(){ri.css("opacity",1)},o?300:0)},l=u=>{!ai||u&&F(u.type,"mousemove","pointermove")&&B0(i,[u.clientX,u.clientY])<40||(clearTimeout(r),ai=!1,ri.css("opacity",0),setTimeout(()=>{ai||ri.css("display","none")},300),q.off("mousewheel mousemove touchend touchmove",l),this.off("mouseleave blur",l))},p=()=>{o&&!s?q.on("mousemove",l):this.on("mouseleave",l),q.on("mousewheel touchend touchmove",l),this.on("blur",l)};this.on("mouseenter touchstart focus",u=>{i=[u.clientX,u.clientY],a(),r=window.setTimeout(h,o?50:30),p()}),this.on("click",u=>{ai?(u.handled=!0,l(),setTimeout(()=>N(t).trigger("click mousedown"))):(ai=!0,o=0,h(),p())})}};ga=V([A("x-target")],ga);var K=class extends Error{constructor(t,e){super(e);this.name=t}static undefinedVariable(t){return new K("EvalError",`Undefined variable \u201C${t}\u201D.`)}static undefinedFunction(t){return new K("EvalError",`Undefined function \u201C${t}\u201D.`)}static evalLoop(t){return new K("EvalError",`Loop in nested evaluation \u201C${t}\u201D.`)}static invalidCharacter(t){return new K("SyntaxError",`Unknown symbol \u201C${t}\u201D.`)}static conflictingBrackets(t){return new K("SyntaxError",`Conflicting brackets \u201C${t}\u201D.`)}static unclosedBracket(t){return new K("SyntaxError",`Unclosed bracket \u201C${t}\u201D.`)}static startOperator(t){return new K("SyntaxError",`A term cannot start with a \u201C${t}\u201D.`)}static endOperator(t){return new K("SyntaxError",`A term cannot end with a \u201C${t}\u201D.`)}static consecutiveOperators(t,e){return new K("SyntaxError",`A \u201C${t}\u201D cannot be followed by a \u201C${e}\u201D.`)}static invalidExpression(){return new K("SyntaxError","This expression is invalid.")}},wa={pi:Math.PI,\u03C0:Math.PI,e:Math.E},va={"(":")","[":"]","{":"}"},hi={"*":"\xB7","**":"\u2217","//":"//","+-":"\xB1","\u2013":"\u2212","-":"\u2212",xx:"\xD7",sum:"\u2211",prod:"\u220F",int:"\u222B",del:"\u2202",grad:"\u2207",aleph:"\u2135",not:"\xAC",AA:"\u2200",EE:"\u2203","'":"\u2019","!=":"\u2260","<=":"\u2264",">=":"\u2265",in:"\u2208","!in":"\u2209","==":"\u2261","~=":"\u2245","~~":"\u2248",sub:"\u2282",sube:"\u2286",prop:"\u221D",oo:"\u221E",cap:"\u2229",cup:"\u222A","<-":"\u2190","->":"\u2192","=>":"\u21D2","<=>":"\u21D4","|->":"\u21A6",uarr:"\u2191",darr:"\u2193",lArr:"\u21D0"},Hi={Gamma:"\u0393",Delta:"\u0394",Theta:"\u0398",Lambda:"\u039B",Xi:"\u039E",Pi:"\u03A0",Sigma:"\u03A3",Phi:"\u03A6",Psi:"\u03A8",Omega:"\u03A9",alpha:"\u03B1",beta:"\u03B2",gamma:"\u03B3",delta:"\u03B4",epsilon:"\u025B",zeta:"\u03B6",eta:"\u03B7",theta:"\u03B8",iota:"\u03B9",kappa:"\u03BA",lambda:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",pi:"\u03C0",rho:"\u03C1",sigma:"\u03C3",tau:"\u03C4",upsilon:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",omega:"\u03C9",CC:"\u2102",NN:"\u2115",QQ:"\u211A",RR:"\u211D",ZZ:"\u2124"},Cd="abcdefghijklmnopqrstuvwxyz",U0=Cd.split(""),j0=Cd.toUpperCase().split(""),Z0=Object.values(Hi),W0=[...U0,...j0,...Z0,"$"],K0="|()[]{}\xF7,!<>=*/+-\u2013\u2212~^_\u2026\xB0\u2022\u2225\u22A5'\u2220:%\u223C\u25B3",X0=Object.values(hi),Y0=[...K0,...X0],J0={_:"sub","^":"sup","//":"/","\xF7":"/"},Md={"<":"&lt;",">":"&gt;"};function Ed(n){return n in Md?Md[n]:n}var Q0=["abs","round","floor","ceil","max","min","mod","lcm","gcd","gcf","log","exp","ln","sqrt","root","sin","cos","tan","sec","csc","cot","cosec","cotan","arcsin","arccos","arctan","sinh","cosh","tanh","sech","csch","coth","cosech"];function qi(n){return Q0.includes(n)}var li={"+":"plus","\u2212":"minus","\xB7":"times","\xD7":"times","/":"over","//":"divided by","%":"percent","!":"factorial","\xB1":"plus-minus","=":"equals","\u2260":"does not equal","<":"is less than",">":"is greater than","\u2264":"is less than or equal to","\u2265":"is greater than or equal to",\u03C0:"pi","\u2245":"is congruent to","\u2225":"is parallel to","\u22A5":"is perpendicular to"};for(let n of Object.keys(Hi))li[Hi[n]]=n;var Vd=n=>typeof n=="number"?n:n[0],Ad=n=>typeof n=="number"?[n,n]:n,Ie=class{evaluate(t={},e){return NaN}interval(t={},e){return Ad(this.evaluate(t))}substitute(t={}){return this}get simplified(){return this}get unknowns(){return this.variables.filter(t=>!Object.prototype.hasOwnProperty.call(wa,t))}get variables(){return[]}get functions(){return[]}collapse(){return this}toString(){return""}toVoice(t={}){return""}toMathML(t={}){return""}},ya=new Set;function ba(n,t,e=!1){var s;let i=(s=t[n])!==null&&s!==void 0?s:wa[n];if(i===void 0)throw K.undefinedVariable(n);if(typeof i=="string"||i instanceof Ie){if(e||ya.clear(),ya.has(n))throw K.evalLoop(n);return ya.add(n),typeof i=="string"&&(i=Gt.parse(i)),i.evaluate(t,!0)}else return typeof i=="function"?i():i}var _i=class extends Ie{constructor(t){super();this.n=t}evaluate(){return this.n}toString(){return""+this.n}toVoice(){return""+this.n}toMathML(){return`<mn>${this.n}</mn>`}},io=class extends Ie{constructor(t){super();this.i=t}evaluate(t={},e){return Vd(ba(this.i,t,e))}interval(t={},e){return Ad(ba(this.i,t,e))}toMathML(){return`<mi${qi(this.i)?' mathvariant="normal"':""}>${this.i}</mi>`}substitute(t={}){return t[this.i]||this}get variables(){return[this.i]}toString(){return this.i}toVoice(){return this.i in li?li[this.i]:this.i.length===1?`_${this.i}_`:this.i}},kd=class extends Ie{constructor(t){super();this.s=t}evaluate(t={},e){return Vd(ba(this.s,t,e))}toString(){return'"'+this.s+'"'}toVoice(){return this.s}toMathML(){return`<mtext>${this.s}</mtext>`}},$a=class extends Ie{toString(){return" "}toMathML(){return"<mspace></mspace>"}},Te=class extends Ie{constructor(t){super();this.o=t}toString(){return this.o.replace("//","/")}toVoice(){return li[this.o]||this.o}get functions(){return[this.o]}toMathML(){let t=Ed(this.toString());return`<mo value="${t}">${t}</mo>`}},Od=[-Infinity,Infinity],ci=[NaN,NaN],Ss=Math.PI/2,xa=Math.PI*2,at=(n,t)=>[n-Number.EPSILON,t+Number.EPSILON],Ts=(...n)=>at(Math.min(...n),Math.max(...n)),tg=n=>Math.abs(n[1]-n[0]),di=n=>isNaN(n[0])||isNaN(n[1]),Ld=n=>!isFinite(n[0])&&n[0]===n[1],eg=(n,t)=>lt(t,n[0]-Number.EPSILON,n[1]+Number.EPSILON),no=n=>eg(n,0),Ne={add:(...n)=>n.reduce((t,e)=>t+e,0),sub:(...n)=>n.length>1?n[0]-n[1]:-n[0],mul:(...n)=>n.reduce((t,e)=>t*e,1),div:(n,t)=>n/t,abs:n=>Math.abs(n),round:n=>Math.round(n),floor:n=>Math.floor(n),ceil:n=>Math.ceil(n),max:(...n)=>Math.max(...n),min:(...n)=>Math.min(...n),mod:(n,t)=>n%t,lcm:(...n)=>fs(...n),gcd:(...n)=>us(...n),gcf:(...n)=>us(...n),sup:(n,t)=>Math.pow(n,t),log:(n,t)=>Math.log(n)/(t===void 0?1:Math.log(t)),exp:n=>Math.exp(n),ln:n=>Math.log(n),sqrt:n=>Math.sqrt(n),root:(n,t)=>Math.pow(n,1/t),sin:n=>Math.sin(n),cos:n=>Math.cos(n),tan:n=>Math.tan(n),sec:n=>1/Math.cos(n),csc:n=>1/Math.sin(n),cot:n=>1/Math.tan(n),cosec:n=>Ne.csc(n),cotan:n=>Ne.cot(n),arcsin:n=>Math.asin(n),arccos:n=>Math.acos(n),arctan:n=>Math.atan(n),sinh:n=>Math.sinh(n),cosh:n=>Math.cosh(n),tanh:n=>Math.tanh(n),sech:n=>1/Math.cosh(n),csch:n=>1/Math.sinh(n),coth:n=>1/Math.tanh(n),cosech:n=>Ne.csch(n)};function oo(n,t){if(n[0]>0)return t[0]>=0?at(n[0]**t[0],n[1]**t[1]):Ts(n[0]**t[0],n[0]**t[1],n[1]**t[0],n[1]**t[1]);let e=t[0];return Number.isInteger(e)&&e===t[1]?e===0?[no(n)?0:1,1]:e%2?at(n[0]**e,n[1]**e):no(n)?[0,Math.max(n[0]**e,n[1]**e)]:Ts(n[1]**e,n[0]**e):ci}function Rd(n,t=xa){let e=Math.floor(n[0]/t)*t;return[n[0]-e,n[1]-e]}var W={add:(...n)=>at(H(n.map(t=>t[0])),H(n.map(t=>t[1]))),sub:(n,t)=>t!==void 0?at(n[0]-t[1],n[1]-t[0]):at(-n[1],-n[0]),mul:(n,...t)=>(t.length>1&&(t=[W.mul(...t)]),Ts(n[0]*t[0][0],n[0]*t[0][1],n[1]*t[0][0],n[1]*t[0][1])),div:(n,t)=>no(t)?Od:Ts(n[0]/t[0],n[0]/t[1],n[1]/t[0],n[1]/t[1]),abs:n=>no(n)?at(0,Math.max(-n[0],n[1])):Ts(Math.abs(n[0]),Math.abs(n[1])),round:n=>at(Math.round(n[0]),Math.round(n[1])),floor:n=>at(Math.floor(n[0]),Math.floor(n[1])),ceil:n=>at(Math.ceil(n[0]),Math.ceil(n[1])),max:(...n)=>at(Math.max(...n.map(t=>t[0])),Math.max(...n.map(t=>t[1]))),min:(...n)=>at(Math.min(...n.map(t=>t[0])),Math.min(...n.map(t=>t[1]))),mod:(n,t)=>{if(di(n)||di(t))return ci;let e=n[0]/(n[0]<0?t[0]:t[1]);return e=e<0?Math.ceil(e):Math.floor(e),W.sub(n,W.mul(t,[e,e]))},lcm:(...n)=>Ts(fs(...n.map(t=>t[0]))),gcd:(...n)=>Ts(us(...n.map(t=>t[0]))),gcf:(...n)=>W.gcd(...n),sup:(n,t)=>oo(n,t),log:(n,t)=>(t!==void 0&&W.div(W.log(n),W.log(t)),at(n[0]<=0?-Infinity:Math.log(n[0]),Math.log(n[1]))),exp:n=>oo([Math.E,Math.E],n),ln:n=>W.log(n),sqrt:n=>oo(n,[.5,.5]),root:(n,t)=>oo(n,W.div([1,1],t)),sin:n=>W.cos(W.sub(n,[Ss,Ss])),cos:n=>di(n)||Ld(n)?ci:tg(n)>=xa-Number.EPSILON?[-1,1]:(n=Rd(n),n[0]>=Math.PI?W.sub(W.cos(W.sub(n,[Math.PI,Math.PI]))):n[1]<=Math.PI?at(Math.cos(n[1]),Math.cos(n[0])):n[1]<=xa?at(-1,Math.max(Math.cos(n[1]),Math.cos(n[0]))):at(-1,1)),tan:n=>di(n)||Ld(n)?ci:(n=Rd(n,Math.PI),n[0]>=Ss&&(n=W.sub(n,[Math.PI,Math.PI])),n[0]<=-Ss||n[1]>=Ss?Od:at(Math.tan(n[0]),Math.tan(n[1]))),sec:n=>W.div([1,1],W.cos(n)),csc:n=>W.div([1,1],W.sin(n)),cot:n=>W.div([1,1],W.tan(n)),cosec:n=>W.csc(n),cotan:n=>W.cot(n),arcsin:n=>di(n)||n[1]<-1||n[0]>1?ci:at(n[0]<=-1?-Ss:Math.asin(n[0]),n[1]>=1?Ss:Math.asin(n[1])),arccos:n=>di(n)||n[1]<-1||n[0]>1?ci:at(n[1]>=1?0:Math.acos(n[1]),n[0]<=-1?Math.PI:Math.acos(n[0])),arctan:n=>at(Math.atan(n[0]),Math.atan(n[1])),sinh:n=>at(Math.sinh(n[0]),Math.sinh(n[1])),cosh:n=>n[1]<0?at(Math.cosh(n[1]),Math.cosh(n[0])):n[0]>0?at(Math.cosh(n[0]),Math.cosh(n[1])):at(1,Math.cosh(Math.max(-n[0],n[1]))),tanh:n=>at(Math.tanh(n[0]),Math.tanh(n[1])),sech:n=>W.div([1,1],W.cosh(n)),csch:n=>W.div([1,1],W.sinh(n)),coth:n=>W.div([1,1],W.tanh(n)),cosech:n=>W.csch(n)},ro=tt("+ \u2212 * \xD7 \xB7 / \xF7 // sup sub subsup"),Id=tt("sub sup subsup"),Pa='<mo value="," lspace="0">,</mo>';function Nd(n,t){return ro.includes(t)?n instanceof Bi?!0:!(n instanceof Zt)||!ro.includes(n.fn)?!1:Id.includes(n.fn)&&Id.includes(t)?!0:ro.indexOf(t)>ro.indexOf(n.fn):!1}function sg(n,t,e){return Nd(n,t)?`<mfenced>${e}</mfenced>`:e}function Qe(n,t){return n instanceof Bi||n instanceof Zt?`<mrow>${t}</mrow>`:t}function Dd(n){return n==="2"?"squared":n==="3"?"cubed":`to the power of ${n}`}var Zt=class extends Ie{constructor(t,e=[]){super();this.fn=t,this.args=e}evaluate(t={}){let e=this.args.map(s=>s.evaluate(t));if(this.fn in t)return t[this.fn](...e);if(this.fn==="+")return Ne.add(...e);if(this.fn==="\u2212")return Ne.sub(...e);if(["*","\xB7","\xD7"].includes(this.fn))return Ne.mul(...e);if(this.fn==="/")return Ne.div(...e);if(this.fn==="sup")return Ne.sup(...e);if(qi(this.fn))return Ne[this.fn](...e);if(this.fn==="(")return e[0];throw K.undefinedFunction(this.fn)}interval(t={}){if(this.fn in t)return Nt(this.evaluate(t),2);let e=this.args.map(s=>s.interval(t));if(this.fn==="+")return W.add(...e);if(this.fn==="\u2212")return W.sub(...e);if(["*","\xB7","\xD7"].includes(this.fn))return W.mul(...e);if(this.fn==="/")return W.div(...e);if(this.fn==="sup")return W.sup(...e);if(qi(this.fn))return W[this.fn](...e);if(this.fn==="(")return e[0];throw K.undefinedFunction(this.fn)}substitute(t={}){return new Zt(this.fn,this.args.map(e=>e.substitute(t)))}collapse(){return this.fn==="("?this.args[0].collapse():new Zt(this.fn,this.args.map(t=>t.collapse()))}get simplified(){return this}get variables(){return Wt(Ut(this.args.map(t=>t.variables)))}get functions(){return Wt([this.fn,...Ut(this.args.map(t=>t.functions))])}toString(){let t=this.args.map(e=>Nd(e,this.fn)?"("+e.toString()+")":e.toString());return this.fn==="\u2212"?t.length>1?t.join(" \u2212 "):"\u2212"+t[0]:this.fn==="sup"?t.join("^"):this.fn==="sub"?t.join("_"):this.fn==="subsup"?`${t[0]}_${t[1]}^${t[2]}`:tt("+ * \xD7 \xB7 / = < > \u2264 \u2265 \u2248").includes(this.fn)?t.join(" "+this.fn+" "):F(this.fn,"(","[","{")?this.fn+this.args.join(", ")+va[this.fn]:F(this.fn,"!","%")?t[0]+this.fn:`${this.fn}(${t.join(", ")})`}toMathML(t={}){let e=this.args.map(o=>o.toMathML(t)),s=this.args.map((o,r)=>sg(o,this.fn,e[r]));if(this.fn in t){let o=e.map((r,a)=>({toString:()=>r,val:this.args[a]}));return t[this.fn](...o)}if(this.fn==="\u2212")return s.length>1?s.join('<mo value="\u2212">\u2212</mo>'):'<mo rspace="0" value="\u2212">\u2212</mo>'+s[0];if(F(this.fn,"+","=","<",">","\u2264","\u2265","\u2248")){let o=Ed(this.fn);return s.join(`<mo value="${o}">${o}</mo>`)}if(F(this.fn,"*","\xD7","\xB7")){let o=s[0];for(let r=1;r<s.length-1;++r)o+=(this.args[0]instanceof _i&&this.args[1]instanceof _i?'<mo value="\xD7">\xD7</mo>':"")+s[1];return o}if(this.fn==="//")return s.join('<mo value="/">/</mo>');if(this.fn==="sqrt")return`<msqrt>${s[0]}</msqrt>`;if(F(this.fn,"/","root")){let o=this.fn==="/"?"mfrac":"mroot",r=this.args.map((a,h)=>Qe(a,e[h]));return`<${o}>${r.join("")}</${o}>`}if(F(this.fn,"sup","sub")){let o=[Qe(this.args[0],s[0]),Qe(this.args[1],e[1])];return`<m${this.fn}>${o.join("")}</m${this.fn}>`}return this.fn==="subsup"?`<msubsup>${[Qe(this.args[0],s[0]),Qe(this.args[1],e[1]),Qe(this.args[2],e[2])].join("")}</msubsup>`:F(this.fn,"(","[","{")?`<mfenced open="${this.fn}" close="${va[this.fn]}">${s.join(Pa)}</mfenced>`:F(this.fn,"!","%")?s[0]+`<mo value="${this.fn}" lspace="0">${this.fn}</mo>`:this.fn==="abs"?`<mfenced open="|" close="|">${s.join(Pa)}</mfenced>`:this.fn==="bar"?`<mover>${Qe(this.args[0],s[0])}<mo value="\u203E">\u203E</mo></mover>`:this.fn==="vec"?`<mover>${Qe(this.args[0],s[0])}<mo value="\u2192">\u2192</mo></mover>`:`<mi${qi(this.fn)?' mathvariant="normal"':""}>${this.fn}</mi><mfenced>${s.join(Pa)}</mfenced>`}toVoice(t={}){let e=this.args.map(i=>i.toVoice(t)),s=e.join(" ");if(this.fn in t){let i=e.map((o,r)=>({toString:()=>o,val:this.args[r]}));return t[this.fn](...i)}return F(this.fn,"(","[","{")?s:this.fn==="sqrt"?`square root of ${s}`:this.fn==="%"?`${s} percent`:this.fn==="!"?`${s} factorial`:this.fn==="/"?`${e[0]} over ${e[1]}`:this.fn==="//"?`${e[0]} divided by ${e[1]}`:this.fn==="sub"?s:this.fn==="subsup"?`${e[0]} ${e[1]} ${Dd(e[2])}`:this.fn==="sup"?`${e[0]} ${Dd(e[1])}`:li[this.fn]?e.join(` ${li[this.fn]} `):qi(this.fn)?`${this.fn} ${s}`:`${this.fn} of ${s}`}},Bi=class extends Ie{constructor(t){super();this.items=t}evaluate(t={}){return this.collapse().evaluate(t)}interval(t={}){return this.collapse().interval(t)}substitute(t={}){return this.collapse().substitute(t)}get simplified(){return this.collapse().simplified}get variables(){return Wt(Cn(...this.items.map(t=>t.variables)))}get functions(){return this.collapse().functions}toString(){return this.items.map(t=>t.toString()).join(" ")}toMathML(t={}){return this.items.map(e=>e.toMathML(t)).join("")}toVoice(t={}){return this.items.map(e=>e.toVoice(t)).join(" ")}collapse(){return Sa(this.items).collapse()}},ht;(function(n){n[n.UNKNOWN=0]="UNKNOWN",n[n.SPACE=1]="SPACE",n[n.STR=2]="STR",n[n.NUM=3]="NUM",n[n.VAR=4]="VAR",n[n.OP=5]="OP"})(ht||(ht={}));function Ta(n,t){if(t===ht.STR)return new kd(n);if(!(!n||!t)){if(t===ht.SPACE&&n.length>1)return new $a;if(t===ht.NUM){if(isNaN(+n))throw K.invalidExpression();return new _i(+n)}if(t===ht.VAR)return n in Hi?new io(Hi[n]):n in hi?new Te(hi[n]):new io(n);if(t===ht.OP)return n in hi?new Te(hi[n]):new Te(n)}}function ig(n){let t=[],e="",s=ht.UNKNOWN;for(let o of n){if(o==='"'){let a=s===ht.STR?ht.UNKNOWN:ht.STR,h=Ta(e,s);h&&t.push(h),e="",s=a;continue}else if(s===ht.STR){e+=o;continue}let r=o.match(/[0-9.]/)?ht.NUM:W0.includes(o)?ht.VAR:Y0.includes(o)?ht.OP:o.match(/\s/)?ht.SPACE:ht.UNKNOWN;if(!r)throw K.invalidCharacter(o);if(!s||s===ht.NUM&&r!==ht.NUM||s===ht.VAR&&r!==ht.VAR&&r!==ht.NUM||s===ht.OP&&!(e+o in hi)||s===ht.SPACE&&r!==ht.SPACE){let a=Ta(e,s);a&&t.push(a),e="",s=r}e+=o}let i=Ta(e,s);return i&&t.push(i),t}function ng(n){return n.length>1?new Bi(n):n[0]instanceof Te?new Bi(n):n[0]}function og(n,t){let e=[[]];for(let s of n)t(s)?e.push([]):I(e).push(s);return e}function Ht(n,t){return n instanceof Te&&tt(t).includes(n.o)}function zi(n){return n instanceof Zt&&n.fn==="("?n.args[0]:n}function ao(n,t){if(Ht(n[0],t))throw K.startOperator(n[0]);if(Ht(I(n),t))throw K.endOperator(I(n));for(let e=1;e<n.length-1;++e){if(!Ht(n[e],t))continue;let s=n[e],i=n[e-1],o=n[e+1];if(i instanceof Te)throw K.consecutiveOperators(i.o,s.o);if(o instanceof Te)throw K.consecutiveOperators(s.o,o.o);let r=n[e+2];if(t==="^ _"&&Ht(s,"_ ^")&&Ht(r,"_ ^")&&s.o!==r.o){let a=n[e+3];if(a instanceof Te)throw K.consecutiveOperators(r.o,a.o);let h=[zi(i),zi(o),zi(a)];s.o==="^"&&([h[1],h[2]]=[h[2],h[1]]),n.splice(e-1,5,new Zt("subsup",h)),e-=4}else{let a=J0[s.o]||s.o,h=[zi(i),zi(o)];n.splice(e-1,3,new Zt(a,h)),e-=2}}}function Gd(n){return ao(n,"^ _"),ao(n,"/"),ng(n)}function rg(n,t){let e=[[]],s=["\u03C0",...(t==null?void 0:t.variables)||[]];for(let i of n){let o=I(e).length?I(e)[0].o:void 0;if(Ht(i,") ] }")){if(!Ht(i,va[o]))throw K.conflictingBrackets(i.o);let r=e.pop(),a=I(e),h=I(a),p=Ht(i,")")&&h instanceof io&&!s.includes(h.i)?a.pop().i:r[0].o,u=og(r.slice(1),m=>Ht(m,","));a.push(new Zt(p,u.map(Gd)))}else Ht(i,"( [ {")?e.push([i]):I(e).push(i)}if(e.length>1)throw K.unclosedBracket(I(e)[0].o);return Gd(e[0])}function Hd(n,t,e=!1){let s=[],i=[],o=!1;function r(){if(o)throw K.invalidExpression();!i.length||(s.push(i.length>1?new Zt(t[0],i):i[0]),i=[])}for(let a of n)if(Ht(a,t)){if(o||!i.length)throw K.invalidExpression();o=!0}else if(a instanceof Te)r(),s.push(a),o=!1;else{let h=!e||a instanceof _i;if(i.length&&!o&&h)throw K.invalidExpression();i.push(a),o=!1}return r(),s}function Sa(n){if(n=n.filter(e=>!(e instanceof $a)),!n.length)throw K.invalidExpression();let t=n.findIndex(e=>Ht(e,"= < > \u2264 \u2265"));if(t===0)throw K.startOperator(n[0]);if(t===n.length-1)throw K.endOperator(n[0]);if(t>0){let e=Sa(n.slice(0,t)),s=Sa(n.slice(t+1));return new Zt(n[t].o,[e,s])}if(Ht(n[0],"%!"))throw K.startOperator(n[0]);for(let e=0;e<n.length;++e)!Ht(n[e],"%!")||(n.splice(e-1,2,new Zt(n[e].o,[n[e-1]])),e-=1);if(ao(n,"// \xF7"),n=Hd(n,"\xD7 * \xB7",!0),Ht(n[0],"\u2212 \xB1")&&n.splice(0,2,new Zt(n[0].o,[n[1]])),ao(n,"\u2212 \xB1"),Ht(n[0],"+")&&(n=n.slice(1)),n=Hd(n,"+"),n.length>1)throw K.invalidExpression();return n[0]}function ag(n,t=!1,e){let s=rg(ig(n),e);return t?s.collapse():s}function hg(n,t){try{let e=Wt([...n.variables,...t.variables]),s=n.collapse(),i=t.collapse(),o=0;for(let r=0;r<5;++r){let a={};for(let p of e)a[p]=wa[p]||Math.random()*5;let h=s.evaluate(a),l=i.evaluate(a);if(!(isNaN(h)||isNaN(l))){if(!C(h,l))return!1;o+=1}}return!!o}catch(e){return!1}}var Gt={numEquals:hg,parse:Jt(ag)};var qd='<div class="toasts"><div class="msg-wrap"><button class="msg archie" aria-label="Virtual Tutor"><slot name="icon"></slot></button></div></div><div class="chat" data-display="flex"><div class="chat-header"><slot name="header"></slot><button class="close"><x-icon name="close" size="24"></x-icon></button></div><div class="chat-body"></div><div class="chat-footer"><div class="input" contenteditable></div><button class="hint"><x-icon name="lightbulb" size="24"></x-icon></button></div></div>';var lg=/[0-9+\-*/()^\s]+/g,cg=ds(ct.shuffle(["happy","spongebob","sloth","party","robot","excited","cute","highfive1","applause","highfive2"])),dg=ds(ct.shuffle(["minions","panther","dog","snape","what","door","horrible"]));function Ca(n,t,e={}){let s=c("div",{class:"msg-wrap","data-display":"flex"}),i=c("div",{class:"msg "+t},s);return e.class&&i.addClass(e.class),e.visible||s.hide(),F(t,"hint","question")?i.html=n:t==="img"?i.css("background-image",`url(${n})`):t==="video"&&c("iframe",{src:n,allowfullscreen:!0},i),s}var Ma=class extends L{constructor(){super(...arguments);this.recentMessages=[];this.isOpen=!1;this.queuePromise=Promise.resolve()}ready(){var i;this.$course=this.parents("x-course")[0],this.hints=this.$course?JSON.parse(this.$course.$("#hints").text):{};let t=window.user;this.correct=ds(ct.shuffle(this.hints.correct||[])),this.incorrect=ds(ct.shuffle(this.hints.incorrect||[])),this.$toasts=this.$(".toasts"),this.$chat=this.$(".chat"),this.$chatBody=this.$(".chat-body"),this.$toasts.on("click",o=>{o.handled||this.open()}),this.$(".close").on("click",()=>this.close());let e=this.$(".chat-footer");if(this.$query=e.$(".input"),this.$query.onKeyDown("enter",o=>{o.preventDefault(),this.askQuestion(this.$query.text.trim()),this.$query.text=""}),this.$query.on("focus",()=>e.addClass("focus")),this.$query.on("blur",()=>e.removeClass("focus")),this.$(".hint").on("click",()=>{this.queue(this.hints.tutorial1),this.queue(t?this.hints.tutorial2:this.hints.account)}),this.$course&&((i=this.$course.userData)==null?void 0:i.messages))for(let o of this.$course.userData.messages)this.$chatBody.append(Ca(o.content,o.kind||"hint",{visible:!0}));if(!v.getCookie("sessionWelcome")&&this.$course){v.setCookie("sessionWelcome",1,60*60*4);let o=new Date().getHours(),r=o<12?"Morning":o<18?"Afternoon":"Evening";t?setTimeout(()=>this.showHint(`welcome${r}Named`,{variables:{name:t.shortName}}),3e3):v.getCookie("welcome")?(setTimeout(()=>this.showHint(`welcome${r}`),3e3),setTimeout(()=>this.queue(this.hints.account),4500)):(v.setCookie("welcome",1),setTimeout(()=>this.queue(this.hints.welcome),3e3),setTimeout(()=>this.queue(this.hints.tutorial1),4500))}}open(){this.isOpen||(this.isOpen=!0,this.$chat.enter("slide-up",200),this.$chatBody.scrollTop=this.$chatBody.scrollHeight,this.trigger("open"))}close(){!this.isOpen||(this.isOpen=!1,this.$query.blur(),this.trigger("close"),this.$chat.exit("slide-down",200))}queue(t,e="hint",s={}){this.queuePromise=this.queuePromise.then(()=>(this.display(t,e,s),Ve(500)))}display(t,e="hint",s={}){let i=s.timeout||8e3;if(v.width<640&&(i*=.7),(s.toast==null?!0:s.toast)&&!this.isOpen){let a=Ca(t,e,s);a.setAttr("role","alert"),this.$toasts.append(a),a.enter("reveal-right"),setTimeout(()=>a.exit("reveal-right",400,0,!0),i),this.on("open",()=>a.exit("reveal",200,0,!0))}let r=Ca(t,e,{class:s.class,visible:!this.isOpen});this.$chatBody.append(r),this.isOpen&&(r.enter("reveal",300),z(()=>this.$chatBody.scrollTop=this.$chatBody.scrollHeight,200))}showHint(t,e={}){if(F(t,"correct","incorrect")){let i=t==="correct"?this.correct():this.incorrect(),o=t==="correct"?3e3:5e3;if(this.queue(i,"hint",{class:e.class||t,timeout:o}),Math.random()<.2){let r=t==="correct"?cg():dg(),a="";this.queue(`${a}/images/gifs/${r}.gif`,"img",{timeout:o})}return{text:i}}let s=this.hints[t]||t;if(e.variables)for(let[i,o]of Object.entries(e.variables))s=s.replace(new RegExp("\\$"+i,"g"),o);return!e.force&&this.recentMessages.includes(t)?{text:s}:(this.recentMessages.push(t),setTimeout(()=>this.recentMessages.shift(),1e4),e.store!==!1&&this.$course&&this.$course.saveProgress({hints:[{content:s,kind:"hint"}]}),this.queue(s,"hint",{class:e.class}),{text:s})}askQuestion(t){if(!t)return;this.queue(t,"question"),this.$course&&this.$course.log("Tutor","ask",t);let e=(t.match(lg)||[]).filter(s=>s.length>=3&&!s.match(/^[\s0-9]+$/));if(e.length)try{let s=Gt.parse(e[0],!0),i=Gt.parse("="+s.evaluate());return this.queue(`<span class="math">${s.toMathML()}${i.toMathML()}</span>`)}catch(s){console.log("Parse Error:",e[0])}this.$chatBody.addClass("loading"),ke(this.attr("api"),{query:t}).then(s=>{this.$chatBody.removeClass("loading");let i=JSON.parse(s);for(let o of i)this.queue(o.content,o.kind)}).catch(s=>{this.$chatBody.removeClass("loading"),this.queue(this.hints.serverError),console.error("Tutor Error:",s)})}};Ma=V([A("x-tutor",{template:qd})],Ma);var _d='<div class="left" tabindex="0"><x-icon name="left" size="14"></x-icon></div><div class="content"><slot></slot></div><div class="right" tabindex="0"><x-icon name="right" size="14"></x-icon></div><div class="bubble"><div class="bubble-box"><div class="progress"></div></div><div class="bubble-arrow"></div></div>';var Bd=c("div",{class:"var-overlay"},q),Ea=class extends L{constructor(){super(...arguments);this.valueChange=!1}ready(){let t=this.attr("bind");if(!t)return;let[e,s,i]=t.split("|");[this.min,this.max,this.step]=i.split(",").map(h=>+h),this.name=e,this.model=this.getParentModel(),this.$(".content").bindModel(this.model),this.$progress=this.$(".progress"),this.setValue(+s);let o=20*(v.isMobile?1.5:1)/M((this.max-this.min)/this.step/12,1,3),r=0,a=0;for(let h of this.$$(".left, .right")){let l=h.hasClass("left")?-this.step:this.step;h.on("click",()=>{this.setValue(this.value+l),this.trigger("slide-end")})}Ze(this,{start:h=>{r=h.x,a=this.value,this.addClass("on"),this.valueChange=!1,Bd.show(),Mt.addClass("grabbing")},move:h=>{let l=(h.x-r)/o;this.setValue(a+kt(l)*this.step)},end:()=>{this.removeClass("on"),this.valueChange&&this.trigger("slide-end"),Bd.hide(),Mt.removeClass("grabbing")}})}setup(t,e){this.one("slide-end",()=>t.score(e))}setValue(t){let e=kt(M(t,this.min,this.max),2);if(e===this.value)return;this.value=e,this.valueChange=!0,this.model&&(this.model[this.name]=e);let s=this.max-this.min;this.$progress.css("width",116*(e-this.min)/s+"px")}};Ea=V([A("x-var",{template:_d})],Ea);var zd='<button class="play-btn-box" aria-label="Play"><x-icon name="play" size="44"></x-icon></button>';var Va=class extends L{constructor(){super(...arguments);this.visible=!0}ready(){this.on("click",()=>{this.play(),setTimeout(()=>this.trigger("play"),400)})}play(){!this.visible||(this.visible=!1,this.exit("pop",400))}reset(){this.visible||(this.visible=!0,setTimeout(()=>this.enter("pop"),400))}};Va=V([A("x-play-btn",{template:zd})],Va);var Aa=class extends L{constructor(){super(...arguments);this.playing=!1}ready(){this.$icon=this.$("x-icon"),this.$("button").on("click",()=>this.toggle())}toggle(){this.playing?this.pause():this.play()}play(){this.playing||(this.playing=!0,this.$icon.setAttr("name","pause"),this.trigger("play"))}pause(){!this.playing||(this.playing=!1,this.$icon.setAttr("name","play"),this.trigger("pause"))}};Aa=V([A("x-play-toggle",{template:'<button class="icon-btn"><x-icon name="play"></x-icon></button>'})],Aa);var Fd='<div class="video-wrap"><video preload playsinline></video></div><div class="credit"></div><x-play-btn></x-play-btn><div class="controls"><div class="shadow"></div><div class="play-pause-btn"><div class="play-icon" tabindex="0" aria-label="Play Video"><x-icon name="play" size="32"></x-icon></div><div class="pause-icon" aria-label="Pause Video"><x-icon name="pause" size="32"></x-icon></div></div><div class="timeline"><div class="bar"><div class="background"></div><div class="buffer"></div><div class="progress"></div></div><div class="handle"></div></div><div class="timecode"></div></div>';function Ud(n){let t=Math.floor(n/60),e=Math.floor(n%60);return t+":"+(e<10?"0":"")+e}var ka=class extends L{ready(){let t=this.attr("src"),e=this.$(".video-wrap"),s=this.$("video"),i=this.attr("width"),o=this.attr("height");this.css("width",i+"px"),e.css("padding-bottom",+o/+i*100+"%"),s.setAttr("poster",this.attr("poster")||t.replace(/mp4$/,"jpg")),this.hasAttr("loop")&&(s._el.loop=!0),this.hasAttr("audio")||(s._el.muted=!0),c("source",{src:t,type:"video/mp4"},s),this.hasAttr("credit")&&(this.$(".credit").text=this.attr("credit"));let r=this.$(".bar"),a=this.$(".progress"),h=this.$(".buffer"),l=this.$(".timecode"),p=new Je(this.$(".handle"),{$parent:r,moveY:!1}),u=this.video=s._el,m=this.width-110;v.onResize(()=>m=this.width-110),s.on("canplay",()=>{l.text=Ud(+u.duration)}),s.on("timeupdate",()=>{let w=u.currentTime/u.duration;a.css("width",w*100+"%"),l.text=Ud(+u.currentTime),p.setPosition(w*m,0),this.trigger("timeupdate",u.currentTime)}),s.on("progress",()=>{if(u.buffered.length<=0||u.duration<=0)return;let y=u.buffered.end(u.buffered.length-1)/u.duration*100;h.css("width",y+"%")}),s.on("ended",()=>{u.pause(),this.removeClass("playing"),this.trigger("end")});let g=()=>u.paused?this.play():this.pause(),b=w=>this.setTime(w/m*u.duration);this.hasAttr("hover")?(s.on("mouseover touchstart",()=>this.play()),s.on("mouseout touchend touchcancel",()=>this.pause())):s.on("click",g),this.hasAttr("controls")&&(this.$(".controls").show(),this.$(".play-pause-btn").on("click",g),p.on("start",()=>this.pause()),p.on("drag",({posn:w})=>b(w.x)),r.on("click",w=>b(w.offsetX)))}setTime(t){this.video.currentTime=t}play(){this.video.play(),this.addClass("playing"),this.trigger("play")}pause(){this.video.pause(),this.removeClass("playing")}};ka=V([A("x-video",{template:Fd})],ka);var Oa=class extends L{constructor(){super(...arguments);this.isCompleted=!1;this.isReady=!1}created(){this.userData=window.progressData||JSON.parse(this.$("#userdata").text)||{},this.$steps=this.$$("x-step");for(let t of this.$steps)t.on("score",()=>this.trigger("score"));this.data.audio&&(this.audio=new Cr(this.data.audio))}ready(){this.$footer=this.$("footer"),this.$skipStep=this.$footer.$(".skip-step"),this.$progress=this.$(".sidebar-row.active x-progress"),this.$tutor=this.$("x-tutor"),this.$stepsWrap=this.$(".steps");let t=this.findStep(v.getHash()),e=this.findStep(this.userData.activeStep);this.$activeStep=e||this.$steps[0];for(let i of this.$steps){if(i.show(),i===this.$activeStep)break;i.complete()}if(this.userData.completed||v.getHash()==="full"||this.data.reveal)this.complete();else for(;this.$activeStep&&this.$activeStep.isReady&&!this.isCompleted;)this.nextStep();(t||e&&!this.userData.completed)&&this.goToStep(t||e,!1),this.$(".section-dev")&&this.complete();let s=this.$(".reveal-banner");setTimeout(()=>{this.isCompleted||(s.removeClass("off"),this.on("score complete",()=>s.addClass("off")))},1500),s.$(".complete").one("click",()=>this.complete()),v.onKey("space",i=>{i.preventDefault(),this.nextStep(),s.addClass("off")}),this.$footer.$(".skip").on("click",()=>this.nextStep()),this.$footer.$(".show-all").on("click",()=>this.complete()),this.$footer.show(),this.isReady=!0,setTimeout(()=>this.addClass("ready"))}nextStep(){if(this.isCompleted)return;let t=this.$activeStep,e=this.$stepsWrap.height;do{if(t.complete(),t=this.$steps[this.$steps.indexOf(t)+1],!t)return this.complete(!0);t.show()}while(t.isReady);this.$stepsWrap.animate({height:[e+"px","auto"]},800),this.$activeStep=t,this.saveProgress({activeStep:t.id})}goToStep(t,e=!0){let s=this.$stepsWrap.height;for(let r of this.$steps){if(r.isShown||(this.$activeStep=r),r.show(),t.isShown&&!r.isReady)break;r.complete()}let i=t.positionTop-Math.max(50,(v.height-t.height)/2);e?(this.$stepsWrap.animate({height:[s+"px","auto"]},800),q.scrollTo(i)):q.scrollTop=i;let o=I(this.$steps);if(o.isShown&&o.isReady)return this.complete();this.$activeStep&&this.saveProgress({activeStep:this.$activeStep.id})}complete(t=!1){if(this.isCompleted)return;this.isCompleted=!0,this.$steps.forEach(s=>s.complete()),this.$activeStep=void 0;let e=this.$footer.$(".next-section");t?(this.$skipStep.exit("fade",200),e&&e.enter("pop")):(this.$skipStep.hide(),e&&e.show()),this.trigger("complete"),this.saveProgress({completed:!0}),this.log("Course","complete")}findStep(t){for(let e of this.$steps)if(e.id===t)return e}saveProgress(t){if(!this.isReady)return;let s=H(this.$steps.map(i=>i.scores.size))/+this.data.goals||0;this.$progress.setProgress(s),fc(`/course/${this.id}/${this.data.section}`,t)}log(t,e,s){if(window.ga&&this.isReady){let i=e+(s?":"+s:"");window.ga("send","event",t,i,this.id)}}};Oa=V([A("x-course")],Oa);var pg={"*":"\xB7","**":"\u2217","//":"//","+-":"\xB1","\u2013":"\u2212","-":"\u2212",xx:"\xD7",sum:"\u2211",prod:"\u220F",int:"\u222B",del:"\u2202",grad:"\u2207",aleph:"\u2135",not:"\xAC",AA:"\u2200",EE:"\u2203","'":"\u2019","!=":"\u2260","<=":"\u2264",">=":"\u2265",in:"\u2208","!in":"\u2209","==":"\u2261","~=":"\u2245","~~":"\u2248",sub:"\u2282",sube:"\u2286",prop:"\u221D",oo:"\u221E",cap:"\u2229",cup:"\u222A","<-":"\u2190","->":"\u2192","=>":"\u21D2","<=>":"\u21D4","|->":"\u21A6",uarr:"\u2191",darr:"\u2193",lArr:"\u21D0"},pi={Gamma:"\u0393",Delta:"\u0394",Theta:"\u0398",Lambda:"\u039B",Xi:"\u039E",Pi:"\u03A0",Sigma:"\u03A3",Phi:"\u03A6",Psi:"\u03A8",Omega:"\u03A9",alpha:"\u03B1",beta:"\u03B2",gamma:"\u03B3",delta:"\u03B4",epsilon:"\u025B",zeta:"\u03B6",eta:"\u03B7",theta:"\u03B8",iota:"\u03B9",kappa:"\u03BA",lambda:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",pi:"\u03C0",rho:"\u03C1",sigma:"\u03C3",tau:"\u03C4",upsilon:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",omega:"\u03C9",CC:"\u2102",NN:"\u2115",QQ:"\u211A",RR:"\u211D",ZZ:"\u2124"},jd="abcdefghijklmnopqrstuvwxyz",ug=jd.split(""),fg=jd.toUpperCase().split(""),mg=Object.values(pi),t$=[...ug,...fg,...mg,"$"],gg="|()[]{}\xF7,!<>=*/+-\u2013\u2212~^_\u2026\xB0\u2022\u2225\u22A5'\u2220:%\u223C\u25B3",wg=Object.values(pg),e$=[...gg,...wg];var vg=["abs","round","floor","ceil","max","min","mod","lcm","gcd","gcf","log","exp","ln","sqrt","root","sin","cos","tan","sec","csc","cot","cosec","cotan","arcsin","arccos","arctan","sinh","cosh","tanh","sech","csch","coth","cosech"];function Zd(n){return vg.includes(n)}var yg={"+":"plus","\u2212":"minus","\xB7":"times","\xD7":"times","/":"over","//":"divided by","%":"percent","!":"factorial","\xB1":"plus-minus","=":"equals","\u2260":"does not equal","<":"is less than",">":"is greater than","\u2264":"is less than or equal to","\u2265":"is greater than or equal to",\u03C0:"pi","\u2245":"is congruent to","\u2225":"is parallel to","\u22A5":"is perpendicular to"};for(let n of Object.keys(pi))yg[pi[n]]=n;var La=class{constructor(){this.callbacks=[]}add(t){this.callbacks.push(t)}start(t=1e3){return z(s=>{for(let i of this.callbacks)i(s)},t).promise}};function Wd(n,t){return n.every((e,s)=>C(e,t[s]))}function Kd(n,t){n.scale*=t.scale,n.x=n.x*t.scale+t.x,n.y=n.y*t.scale+t.y}function Xd(n,t){return C(n.x,t.x)&&C(n.y,t.y)&&C(n.scale,t.scale)}function ho(n,t,e){if(e==="adding"){let s=n.strokeLength,i=t<.5?0:X("cubic-in",t*2-1);n.css({"stroke-dasharray":s+"px","stroke-dashoffset":s*(1-i)+"px"})}else if(e==="deleting"){let s=n.strokeLength,i=t<.5?X("cubic-in",2*t):1;n.css({"stroke-dasharray":s+"px","stroke-dashoffset":s*(2-i)+"px"})}}function Yd(n,t){let e=[n],s=n.expr;for(;t.startsWith(s);){if(t===s)return e;let i=I(e).next;if(!i)return;e.push(i),s+=i.expr}}function Jd(n,t,e=1){let s=e*Math.abs(t.x-n.x)/3,i=d.average(n,t).shift(0,s);return function(o){let r=(1-o)**2*n.x+2*o*(1-o)*i.x+o*o*t.x,a=(1-o)**2*n.y+2*o*(1-o)*i.y+o*o*t.y;return{x:r,y:a}}}function Ra(n,t){return Math.max(t*n,.4)/n}function Ge(n){return n instanceof De&&n.children.length>1||n instanceof ui?`(${n.expr})`:n.expr}function Ce(n,t){return t.length===1&&t[0].type==="mrow"?t[0]:new De(t,n)}var Lt=class{constructor(t,e,s,i){this.type=t;this.equation=s;this.$element=i;this.children=[];this.status="";this.value="";this.customColor="";this.roundedMotion=!1;this.width=0;this.height=0;this.baseline=0;this.transform={x:0,y:0,scale:1};this.currentDimensions=[0,0,0];this.currentWorldTransform={x:0,y:0,scale:1};this.addChildren(e),i&&s.$row.append(i)}get expr(){return""}get log(){let t=this.children.map(e=>e.log);return`<${this.type}>${t.join("")}</${this.type}>`}get color(){return this.customColor||(this.parent?this.parent.color:"")}static create(t,e){let s=t.nodeName.toLowerCase();if(F(s,"mn","mi","mo","mtext")){if(t.textContent==="placeholder")return new co(e);let o=t.getAttribute("mathvariant")||void 0;return new Cs(s,t.textContent||"",e,o)}if(!F(s,"mrow","mfrac","mfenced","msqrt","mroot","msub","msup","msubsup","munder","mover","munderover","mspace"))return new ep(t,e);if(s==="mfenced"&&t.getAttribute("open")==="["){let o=t.children.length,r=Ut(Array.from(t.children,h=>Array.from(h.children,l=>Lt.create(l,e)))),a=new tp(r,e,o);return new Fi([a],e)}let i=Array.from(t.children,o=>Lt.create(o,e));switch(s){case"mrow":return new De(i,e);case"mfrac":return i=i.map(o=>Ce(e,[o])),new po(i,e);case"mfenced":return i=[Ce(e,i)],new Fi(i,e);case"msqrt":return i=[Ce(e,i)],new fi(s,i,e);case"mroot":return i=i.map(o=>Ce(e,[o])),new fi(s,i,e);case"msub":case"msup":case"msubsup":return i=i.map(o=>Ce(e,[o])),new ui(s,i,e);case"munder":case"mover":case"munderover":return i=i.map(o=>Ce(e,[o])),new Qd(s,i,e);case"mspace":return new lo(e)}throw new Error(`Unknown element type tag ${t.nodeName}`)}get marginLeft(){return .1}get marginRight(){return .1}setTransform(t=0,e=0,s=1){this.transform.x=t,this.transform.y=e,this.transform.scale=s}get worldTransform(){let t=this,e=Object.assign({},this.transform);for(;t=t.parent;)Kd(e,t.transform);return e}get index(){return this.parent?this.parent.children.indexOf(this):-1}get next(){if(!this.parent)return;let t=this.parent.children.indexOf(this);return this.parent.children[t+1]}get prev(){if(!this.parent)return;let t=this.parent.children.indexOf(this);return this.parent.children[t-1]}addChildren(t,e=this.children.length){for(let s of this.children)s.type==="placeholder"&&s.deleteFromDom();for(let s of t)s.detach(),s.parent=this;this.children.splice(e,0,...t)}insertAfter(t){let e=this.parent.children.indexOf(this);this.parent.addChildren(t,e+1)}insertBefore(t){let e=this.parent.children.indexOf(this);this.parent.addChildren(t,e)}detach(){if(this.parent){let t=this.parent.children.indexOf(this);t>=0&&this.parent.children.splice(t,1),this.parent=void 0}}deleteFromDom(){this.parent&&this.detach(),this.$element&&this.$element.remove(),this.$element=void 0;for(let t of this.children.slice(0))t.deleteFromDom()}*parents(t=!1){let e=t?this:this.parent;for(;e;)yield e,e=e.parent}hasParent(t,e=!1){return Ue(this.parents(e),t)}hitTest(t){let{x:e,scale:s}=this.worldTransform,i=this.marginLeft*s*this.equation.fontSize,o=this.marginRight*s*this.equation.fontSize;if(lt(t.x,e-i,e+this.width*s+i+o))return this.hitTestChildren(t)||this}hitTestChildren(t){for(let e of this.children){let s=e.hitTest(t);if(s)return s}}measure(t=1){for(let e of this.children)e.measure(t)}clean(){for(let t of this.children)t.clean()}setStatus(t){this.status=t;for(let e of this.children)e.setStatus(t)}render(t){for(let h of this.children)h.render(t);if(!this.$element)return;let e=this.currentWorldTransform,s=this.currentWorldTransform=this.worldTransform,i=this.currentDimensions,o=this.currentDimensions=[this.width,this.height,this.baseline];if(Xd(e,s)&&Wd(i,o)&&!this.status)return;if(!t){this.positionElement(s),this.drawElement(1,o[0],o[1],o[2],s.scale);return}this.status==="adding"&&this.positionElement(s);let r=s.y+this.baseline<this.equation.root.baseline?-1:1,a=this.roundedMotion?Jd(e,s,r):void 0;this.roundedMotion=!1,t.add(h=>{if(!this.$element)return;let l=X("cubic",h),p=F(this.status,"adding","deleting"),u=p?o[0]:Ct(i[0],o[0],l),m=p?o[1]:Ct(i[1],o[1],l),g=p?o[2]:Ct(i[2],o[2],l),b=p?s.scale:Ct(e.scale,s.scale,l);if(this.drawElement(h,u,m,g,b),!this.status){let w=a?a(l):d.interpolate(e,s,l);this.positionElement({x:w.x,y:w.y,scale:b})}})}positionElement(t){this.$element.setTransform(t,0,t.scale)}drawElement(t,e,s,i,o){}},bg="acegmnopqrsuvwxyz",Ms=1.1,mi=.2,Ia=["=","\u2248","<",">","\u2264","\u2265"],$g=document.createElement("canvas"),sp=$g.getContext("2d"),xg=Jt((n,t)=>(sp.font=`${t}px "Source Sans Pro", sans-serif`,sp.measureText(n).width)),Cs=class extends Lt{constructor(t,e,s,i){super(t,[],s,c("text",{}));this.variant=i;this.setValue(e)}setValue(t){this.$element.text=this.value=t;let e=this.value.split("").every(i=>bg.includes(i));this.width=xg(t,this.equation.fontSize),this.height=(Ms-(e?.1:0))*this.equation.fontSize,this.baseline=this.height-mi*this.equation.fontSize;let s=this.type==="mtext"||this.variant==="normal";this.$element.setClass("font-normal",s||Zd(this.value))}get expr(){return this.value==="xx"?'"xx"':this.type==="mtext"?`"${this.value}"`:this.value}get log(){return`<${this.type}>${this.value}</${this.type}>`}get marginLeft(){if(this.type==="mo")return Ia.includes(this.value)?this.equation.isDisplay?.5:.35:F(this.value,"\u2221","\u25B3","!","%","\u2019")||F(this.value,"\u2026","\xB0")&&this.prev&&this.prev.type==="mn"?0:.25;if(this.type==="mi"){if(this.prev&&this.prev.type==="mn")return .1;if(this.prev&&this.prev.type==="mi")return .05;if(this.prev&&this.prev.type==="mfrac")return .15}return 0}get marginRight(){return this.type==="mo"?this.equation.isDisplay&&Ia.includes(this.value)?.5:F(this.value,"\u2221","\u25B3")?0:this.value==="\u2212"&&(!this.prev||Ia.includes(this.prev.value))?.1:.25:0}positionElement(t){if(!this.$element)return;let e=(this.equation.fontSize-this.baseline)*t.scale;this.$element.setTransform({x:t.x,y:t.y-e},0,t.scale)}drawElement(t,e,s,i,o){this.status==="adding"?this.$element.setAttr("opacity",t<.5?0:X("cubic-in",t*2-1)):this.status==="deleting"&&this.$element.setAttr("opacity",t<.5?1-X("cubic-in",2*t):0),this.$element.css("stroke-width",(1-o)*1.5+"px"),this.$element.css("color",this.color||"currentColor")}},lo=class extends Lt{constructor(t){super("mspace",[],t);this.height=(Ms-.1)*t.fontSize,this.baseline=this.height-mi*this.equation.fontSize,this.width=t.fontSize*.2}get expr(){return" "}},De=class extends Lt{constructor(t,e,s,i=0){super("mrow",t,e);this.align=s;this.dx=i}addChildren(t,e=this.children.length){let s=[];for(let i of t)i.type==="mrow"?(s.push(...i.children),i.detach()):s.push(i);super.addChildren(s,e)}get expr(){return this.children.map(t=>t.expr).join(" ").replace(/âˆ’ /,"\u2212")||"placeholder"}measure(t=1){if(super.measure(t),!this.children.length){this.height=this.width=this.baseline=0;return}this.baseline=Math.max(...this.children.map(s=>s.baseline)),this.height=this.baseline+Math.max(...this.children.map(s=>s.height-s.baseline));let e=0;for(let[s,i]of this.children.entries())i.setTransform(e,this.baseline-i.baseline),e+=i.width,s<this.children.length-1&&(e+=Math.max(i.marginRight,this.children[s+1].marginLeft)*this.equation.fontSize);if(this.align){let s=this.children.find(i=>i.expr===this.align);s&&(this.transform.x=this.dx-s.transform.x-s.width/2)}this.width=e}},co=class extends Lt{constructor(t){let e=t.fontSize,s=`M${.1*e} ${.3*e}h${e/2}v${e/2}h-${e/2}Z`,i=c("path",{class:"placeholder",d:s});super("placeholder",[],t,i);this.width=.7*e,this.height=Ms*e,this.baseline=this.height-mi*e}get expr(){return"placeholder"}get marginLeft(){return 0}get marginRight(){return 0}},po=class extends Lt{constructor(t,e){super("mfrac",t,e,c("line"))}get expr(){return this.children.map(t=>Ge(t)).join("/")}measure(t){let e=this.hasParent(a=>a.type==="mfrac"||a.type==="matrix"),s=Ra(t,!this.equation.isDisplay||e?.66:1),i=.1*this.equation.fontSize,[o,r]=this.children;super.measure(t*s),this.width=(Math.max(o.width,r.width)+2*i)*s,this.height=(o.height+r.height)*s,this.baseline=o.height*s+this.equation.fontSize*(Ms/2-mi),o.setTransform((this.width-o.width*s)/2,0,s),r.setTransform((this.width-r.width*s)/2,o.height*s,s)}drawElement(t,e,s,i){let o=i-this.equation.fontSize*(Ms/2-mi);this.$element.setLine({x:0,y:o},{x:e,y:o}),this.$element.setAttr("stroke",this.color||"currentColor"),ho(this.$element,t,this.status)}hitTestChildren(t){let{scale:e,y:s}=this.worldTransform,i=this.baseline-this.equation.fontSize*(Ms/2-mi),o=t.y<=s+i*e,r=this.children[o?0:1];return r.hitTestChildren(t)||r}},ui=class extends Lt{get expr(){let t=Ge(this.children[0]);return this.type!=="msup"&&(t+="_"+Ge(this.children[1])),this.type==="msup"&&(t+="^"+Ge(this.children[1])),this.type==="msubsup"&&(t+="^"+Ge(this.children[2])),t}measure(t){let[e,s,i]=this.children,o=this.type==="msup"?void 0:s,r=this.type==="msubsup"?i:this.type==="msup"?s:void 0,a=.05*this.equation.fontSize,h=Ra(t,.65);e.measure(t),o&&o.measure(t*h),r&&r.measure(t*h);let l=r?r.height*h-.4*this.equation.fontSize:0,p=o?o.height*h-.5*this.equation.fontSize:0,u=r?r.width:0,m=o?o.width:0;this.width=e.width+a+Math.max(u,m)*h,this.height=e.height+l+p,this.baseline=e.baseline+l,e.setTransform(0,this.baseline-e.baseline),r&&r.setTransform(e.width+a,0,h),o&&o.setTransform(e.width+a,this.height-o.height*h,h)}clean(){if(super.clean(),this.children=this.children.filter(t=>t.type!=="mrow"||t.children.length),this.children.length===0)return this.detach();this.children.length===1&&(this.insertAfter(this.children),this.detach())}},Qd=class extends Lt{get expr(){let t=this.children[0].expr;return this.type!=="munder"&&(t+="_"+Ge(this.children[1])),this.type==="mover"&&(t+="^"+Ge(this.children[1])),this.type==="munderover"&&(t+="^"+Ge(this.children[2])),t}measure(t){super.measure(t)}},Fi=class extends Lt{constructor(t,e){super("mfenced",t,e,c("path"))}get expr(){return`(${this.children.map(t=>t.expr).join()})`}get marginLeft(){return .2}get marginRight(){return .2}measure(t){super.measure(t);let e=this.children[0];this.height=e.height+2,this.baseline=e.baseline+1;let s=1+this.height/this.equation.fontSize,i=.1*this.equation.fontSize;this.width=e.width+2*(s+i),e.setTransform(s+i,1)}drawElement(t,e,s){let i=Math.min(2+s/this.equation.fontSize,5),o=s-4,r=e-i,a=`M${i},2c${-2*i/3},${.15*o},${-i},${.32*o},${-i},${o/2}s${i/3},${.35*o},${i},${o/2}M${r},2c${2*i/3},${.15*o},${i},${.32*o},${i},${o/2}s${-i/3},${.35*o},${-i},${o/2}`;this.$element.setAttr("d",a),this.$element.css("stroke",this.color||"currentColor"),ho(this.$element,t,this.status)}clean(){super.clean(),this.children.length||this.detach()}},fi=class extends Lt{constructor(t,e,s){super(t,e,s,c("path"))}get expr(){return`sqrt(${this.children.map(t=>t.expr).join(", ")})`}get marginLeft(){return .2}get marginRight(){return .2}measure(t){super.measure(t);let e=this.children[0];this.height=e.height+2,this.baseline=e.baseline+2;let s=Math.min(16,3+5*this.height/this.equation.fontSize),i=.05*this.equation.fontSize;this.width=e.width+s+2*i,e.setTransform(s+i,2)}drawElement(t,e,s){let i=Math.min(16,3+5*s/this.equation.fontSize),o=s-2,r=`M0,${.55*o}L${.18*i},${.51*o}L${.45*i},${o}L${i},2L${e},2`;this.$element.setAttr("d",r),this.$element.css("stroke",this.color||"currentColor"),ho(this.$element,t,this.status)}clean(){super.clean(),this.children.length||this.detach()}},tp=class extends Lt{constructor(t,e,s){super("matrix",t,e,c("g"));this.rows=s;this.cols=Math.floor(t.length/s)}get expr(){return`${this.children.map(t=>t.expr).join(", ")}`}measure(t){super.measure(t);let e=.6*this.equation.fontSize,s=_(r=>Math.max(..._(a=>this.children[r*this.cols+a].height,this.cols)),this.rows),i=_(r=>Math.max(..._(a=>this.children[a*this.cols+r].width,this.rows)),this.cols);this.height=H(s)+(this.rows-1)*e/2,this.width=H(i)+this.cols*e,this.baseline=(this.height+Ms*this.equation.fontSize)/2;let o=0;for(let r=0;r<this.rows;++r){let a=e/2;for(let h=0;h<this.cols;++h){let l=this.children[r*this.cols+h],p=a+(i[h]-l.width)/2,u=o+(s[r]-l.height)/2;l.setTransform(p,u),a+=i[h]+e}o+=s[r]+e/2}}},ep=class extends Lt{constructor(t,e){super("foreign",[],e,c("g"));var s;this.$body=c("div",{},e.$overlay),this.$body._el.appendChild(t),this.$measure=c("span",{text:".",style:"font-size: 0"},this.$body),this.checkForResize(),this.$body.on("resize",()=>{this.checkForResize()&&this.equation.resize()}),(s=this.$body.$("x-blank, x-blank-mc"))==null||s.on("solve",i=>{ge(()=>this.replace(i.solution,"#0f82f2"),i.restore?0:200)})}deleteFromDom(){var t;super.deleteFromDom(),(t=this.$body)==null||t.remove(),this.$body=void 0,this.$measure=void 0}replace(t,e){var o;let s=isNaN(+t)?"mtext":"mn",i=new Cs(s,t,this.equation);i.customColor=e,this.insertAfter([i]),(o=this.$body)==null||o.off("resize"),this.deleteFromDom(),this.equation.resize()}checkForResize(){var i,o;let t=this.height,e=this.width,s=this.baseline;return this.height=((i=this.$body)==null?void 0:i.height)||0,this.width=((o=this.$body)==null?void 0:o.width)||0,this.baseline=this.$measure.bounds.top-this.$body.bounds.top,!(C(t,this.height)&&C(e,this.width)&&C(s,this.baseline))}positionElement(t){var e,s;(e=this.$body)==null||e.css({left:t.x+"px",top:t.y+"px"}),C(t.scale,1)||(s=this.$body)==null||s.css("transform",`scale(${t.scale})`)}get expr(){var t;return`"${(t=this.$body)==null?void 0:t.text}"`}get log(){return`<foreign>${this.expr}</foreign>`}};var He=class extends we{constructor(t,e,s=0,i="=",o=18,r=!0){super();this.$row=t;this.$overlay=e;this.fontSize=o;this.isDisplay=r;this.isReady=!0;this.deletedNodes=new Set;this.root=new De([],this,i,s)}setValue(t){let e=Array.isArray(t)?t.map(s=>Lt.create(s,this)):this.parse(t);for(let s of this.root.children)s.deleteFromDom();this.root.addChildren(e),this.updateDescription(),this.resize()}updateDescription(){let t=Gt.parse(this.root.expr).toVoice();this.$row.setAttr("aria-label",t)}resize(){this.root.measure(),this.root.render()}parse(t){var r;let e=new DOMParser,s=Gt.parse(t).toMathML(),i=e.parseFromString(`<math>${s}</math>`,"text/xml");if(((r=i.firstChild)==null?void 0:r.nodeName)==="parsererror")throw new Error(i.firstChild.textContent);let o=i.firstChild.childNodes;return Array.from(o,a=>Lt.create(a,this))}find(t){let[e,s]=t.split("`");e=e.replace(/[â€“-]/g,"\u2212");let i=+s||1,o=this.root.children.slice(0),r=0;for(;o.length;){let a=o.shift(),h=a instanceof De?void 0:Yd(a,e);if(h&&(r+=1,r===i))return h;o.unshift(...a.children)}throw new Error(`Can't find element ${e}.`)}animate(t=1200){return P(this,null,function*(){this.isReady=!1,this.root.clean(),this.root.measure();let e=new La;this.root.render(e),this.trigger("resize",{height:this.root.height});for(let s of this.deletedNodes)s.render(e);yield e.start(t);for(let s of this.deletedNodes)s.deleteFromDom();this.root.setStatus(""),this.deletedNodes.clear(),this.isReady=!0})}addTermAfter(t,e){let s=I(e?this.find(e):this.root.children),i=this.parse(t);s.insertAfter(i);for(let o of i)o.setStatus("adding");this.updateDescription()}addTermBefore(t,e){let s=e?this.find(e)[0]:this.root.children[0],i=this.parse(t);s.insertBefore(i);for(let o of i)o.setStatus("adding");this.updateDescription()}deleteTerm(t){for(let e of this.find(t))e.setStatus("deleting"),e.detach(),this.deletedNodes.add(e);this.updateDescription()}replaceTerm(t,e){let s=this.find(t),i=this.parse(e);s[0].insertBefore(i);for(let o of i)o.setStatus("adding");for(let o of s)o.setStatus("deleting"),o.detach(),this.deletedNodes.add(o);this.updateDescription()}moveTermAfter(t,e){let s=this.find(t);for(let o of s)o.roundedMotion=!0;I(e?this.find(e):this.root.children).insertAfter(s),this.updateDescription()}moveTermBefore(t,e){let s=this.find(t);for(let o of s)o.roundedMotion=!0;(e?this.find(e)[0]:this.root.children[0]).insertBefore(s),this.updateDescription()}moveTermToStart(t){let e=this.find(t);for(let s of e)s.roundedMotion=!0;this.root.children[0].insertBefore(e),this.updateDescription()}wrapTerms(t,...e){let s=e.map(o=>this.find(o));for(let o of s)for(let r of o)r.roundedMotion=!0;let i=this.parse(t);for(let o of i)o.setStatus("adding");s[0][0].insertBefore(i);for(let[o,r]of s.entries()){let a=this.find("$"+(o+1))[0];a.insertAfter(r),a.deleteFromDom()}this.updateDescription()}unwrapTerm(t,e=1){let s=this.find(t),i=s[0],o=1;for(;o<=e;)i=i.parent,i instanceof De&&(i=i.parent),o+=1;i.insertAfter(s),i.setStatus("deleting"),i.detach(),this.deletedNodes.add(i),this.updateDescription()}get leftSide(){let t=this.root.children.findIndex(e=>e.expr==="=");return this.root.children.slice(0,t-1)}get rightSide(){let t=this.root.children.findIndex(e=>e.expr==="=");return this.root.children.slice(t+1)}};var ip='<svg class="equation"><g></g></svg><div class="overlay"></div><div class="nav"><div class="btn back hide"><x-icon name="left"></x-icon></div><div class="btn next"><x-icon name="right"></x-icon></div></div><div class="legend-box"><slot></slot></div>';var np=1200,Pg=400,op=1200,gi=600,Ui=16,Na=class extends L{constructor(){super(...arguments);this.rows=[];this.isReady=!0;this.topOffset=4;this.currentHeight=0;this.currentStep=0;this.nextEvents={};this.backEvents={}}ready(){this.$svg=this.$("svg"),this.$lastRow=this.$svg.$("g"),this.$overlay=this.$(".overlay"),this.$legend=this.$(".legend-box"),this.$steps=this.$legend.$$("li"),this.$back=this.$(".back"),this.$next=this.$(".next");let t=+this.attr("dx")||0;this.equation=new He(this.$lastRow,this.$overlay,t);let e=this.$(".math"),s=e?Array.from(e._el.children):[];this.equation.setValue(this.attr("expr")||s),this.currentHeight=this.topOffset+this.$lastRow.height+16,this.$svg.css("height",this.currentHeight+"px"),this.equation.on("resize",({height:o})=>{let r=this.topOffset+o+Ui;Math.abs(r-this.currentHeight)<Ui/2||(this.currentHeight=r,this.$svg.animate({height:r+"px"},op))}),this.$back.on("click",()=>this.goBack()),this.$next.on("click",()=>this.goNext()),this.$steps[0].show(),v.onResize(()=>{let o=this.$svg.width/2;for(let r of[this.$lastRow,this.$overlay])r.css("transform",`translate(${o}px, ${this.topOffset}px)`);for(let r of this.rows)r.$el.css("transform",`translate(${o}px, ${r.top}px)`)});let i=this.$overlay.$$("x-blank, x-blank-mc");i.length&&(this.$next.addClass("hide"),Promise.all(i.map(o=>o.onPromise("solve"))).then(()=>setTimeout(()=>this.goNext(),np)))}setup(t){this.one("next",({step:e})=>t.score("algebra-flow-"+(e-1)))}newRow(){return P(this,null,function*(){let t=this.$lastRow.copy(!0,!1),e=this.equation.root.height;this.rows.push({$el:t,height:e,top:this.topOffset}),this.$lastRow.insertBefore(t),v.redraw(),this.topOffset+=e+Ui,this.currentHeight=this.topOffset+e+Ui;for(let s of[this.$lastRow,this.$overlay])s.animate({transform:`translate(${this.$svg.width/2}px, ${this.topOffset}px)`},gi);yield this.$svg.animate({height:this.currentHeight+"px"},gi).promise})}hideLastRow(){return P(this,null,function*(){if(!this.rows.length)return;let t=this.rows.pop();this.topOffset=t.top;for(let e of[this.$lastRow,this.$overlay])e.animate({transform:`translate(${this.$svg.width/2}px, ${t.top}px)`},gi);this.currentHeight=t.top+this.$lastRow.height+Ui,this.$svg.animate({height:this.currentHeight+"px"},gi),yield t.$el.exit("fade",gi/2,gi/2).promise,t.$el.remove()})}onNextStep(t){this.nextEvents=t}onBackStep(t){this.backEvents=t}goNext(){return P(this,null,function*(){if(!this.isReady||!this.equation.isReady||this.currentStep>=this.$steps.length-1)return;this.isReady=!1;let t=this.currentStep+1;this.$steps[t].hasClass("new-row")&&(yield this.newRow(),yield Ve(Pg)),t in this.nextEvents&&(yield this.nextEvents[t](this.equation),yield this.equation.animate(op),yield Ve(np)),yield this.go(t),this.trigger("next",{step:t}),this.isReady=!0})}goBack(){return P(this,null,function*(){if(!this.isReady||!this.equation.isReady||this.currentStep<=0)return;let t=this.currentStep-1;this.isReady=!1,this.currentStep in this.backEvents&&(yield this.backEvents[this.currentStep](this.equation),yield this.equation.animate()),this.$steps[this.currentStep].hasClass("new-row")&&this.hideLastRow(),yield this.go(t),this.trigger("back",{step:t}),this.isReady=!0})}go(t){return P(this,null,function*(){this.$steps[t].show();let e=this.$steps[t].height+"px";this.$steps[t].hide(),this.$legend.animate({height:e},800).promise.then(()=>this.$legend.css("height","auto"));let s=this.currentStep;this.currentStep=t,this.trigger("step",t),yield this.$steps[s].exit("fade",400).promise,this.$back.setClass("hide",t<=0),this.$next.setClass("hide",t>=this.$steps.length-1),yield this.$steps[t].enter("fade",400).promise})}};Na=V([A("x-algebra-flow",{template:ip})],Na);var rp='<div class="input"><textarea></textarea></div><div class="math empty"><span class="cursor">&#8203;</span></div><div class="keys"><!-- TODO Make these buttons tabbable--><div class="btn" data-type="+">+</div><div class="btn" data-type="\u2212">\u2212</div><div class="btn" data-type="\xD7">\xD7</div><div class="btn" data-type="\xF7">\xF7</div><div class="btn i" data-type="\u03C0">\u03C0</div><div class="btn" data-type="frac"><x-icon name="fraction"></x-icon></div><div class="btn" data-type="sup"><x-icon name="power"></x-icon></div><div class="btn" data-type="sqrt"><x-icon name="sqrt"></x-icon></div><div class="btn" data-type="brackets"><x-icon name="brackets"></x-icon></div></div><div class="error"><x-icon name="warning"></x-icon></div><div class="error-message"></div>';var ts=Bt;function ap(n){let t=n.prev;t&&F(t.tagName,"MO","MI","MN")?t.insertBefore(n):t?I(t.children).append(n):n.parent.hasClass("math")||(n.parent.prev?n.parent.prev.append(n):n.parent.parent.insertBefore(n))}function Sg(n){let t=n.next;if(t&&F(t.tagName,"MO","MI","MN"))return t.insertAfter(n);t?t.children[0].prepend(n):n.parent.hasClass("math")||(n.parent.next?n.parent.next.prepend(n):n.parent.parent.insertAfter(n))}function Tg(n){let t=n.parent;for(;t.parent.tagName!=="MFRAC"||!t.prev;){if(t.hasClass("math"))return;t=t.parent}t.prev.append(n)}function Cg(n){let t=n.parent;for(;t.parent.tagName!=="MFRAC"||!t.next;){if(t.hasClass("math"))return;t=t.parent}t.next.prepend(n)}function Mg(n){let t=n.prev,e=n.parent;if(t&&F(t.tagName,"MO","MI","MN"))t.remove(),e.children.length<=1&&e.addClass("empty");else if(!t&&!e.prev&&!e.hasClass("math")){let s=e.parent;s.insertBefore(n);for(let i of s.children)for(let o of i.children)s.insertBefore(o);s.remove(),n.parent.children.length<=1&&n.parent.addClass("empty")}else ap(n)}function Es(n,t){t.insertBefore(n),t.parent.removeClass("empty"),n.children.length&&n.children[0].append(t)}function hp(n,t){"abcdefghijklmnopqrstuvwxyz\u03C0".includes(t)?Es(c("mi",{text:t}),n):"0123456789.".includes(t)?Es(c("mn",{text:t}),n):"+\u2212\xB1\xD7\xF7<>\u2264\u2265=%!".includes(t)?Es(c("mo",{text:t,value:t}),n):t==="frac"?Es(c("mfrac",{html:'<mrow class="empty"></mrow><mrow class="empty"></mrow>'}),n):t==="sqrt"?Es(c("msqrt",{html:'<mrow class="empty"></mrow>'}),n):F(t,"^","sup")?Es(c("msup",{html:'<mrow class="empty"></mrow>'}),n):t==="brackets"||"([{|".includes(t)?Es(c("mfenced",{html:'<mrow class="empty"></mrow>',type:"("}),n):")]}".includes(t)&&!n.next&&n.parent.parent.tagName==="MFENCED"&&n.parent.parent.insertAfter(n)}function lp(n,t){let e=n.$$(`${t}:first-child, *:not(${t}) + ${t}`);for(let s of e)if(s.parent.tagName!=="MFRAC")for(;s.next&&s.next.tagName===t.toUpperCase();)s.text+=s.next.text,s.next.remove()}var Eg="This is not a valid mathematical expression.",Vg="Fill in all empty placeholders in the expression.",Ag={"+":"addition","\xD7":"multiplication","/":"fractions or division","\u2212":"subtraction",sqrt:"square roots","^":"powers"};function Vs(n,t){if(n instanceof Text)return n.textContent||"";if(n.hasClass("cursor"))return"";let e=n.childNodes;return n.tagName==="MI"?n.text+(t?" ":""):n.tagName==="MFENCED"?"("+Vs(e[0],t)+")":n.tagName==="MSUP"?"^("+Vs(e[0],t)+")":n.tagName==="MFRAC"?`(${Vs(e[0],t)})/(${Vs(e[1],t)})`:n.tagName==="MSQRT"?"sqrt("+Vs(e[0],t)+")":e.map(s=>Vs(s,t)).join("")}function kg(n,t){try{return{expr:Gt.parse(n,!0,{variables:t})}}catch(e){return{error:e instanceof K?e.message:Eg}}}function Og(n,t,e){let s=n.variables;if(t.length){let i=s.find(r=>!t.includes(r));if(i){let r=Al(i,e||t);return r?`Did you mean \u201C<em>${r}</em>\u201D instead of \u201C<em>${i}</em>\u201D?`:`There shouldn\u2019t be a variable called \u201C<em>${i}</em>\u201D.`}let o=t.find(r=>!s.includes(r));if(o)return`Your expression should contain \u201C<em>${o}</em>\u201D.`}}function Lg(n,t){if(t.length){let e=n.functions.find(s=>!t.includes(s));if(e)return`This expression should not contain ${Ag[e]||"\u201C"+e+"\u201D"}.`}}function Rg(n,t,e=.001){try{return C(n.evaluate(),t.evaluate(),e)}catch(s){return!1}}var Da=class extends L{constructor(){super(...arguments);this.isDone=!1;this.shortVar=!1;this.lastAttempt="";this.errorCount=0;this.hints=[];this.fns=[];this.vars=[];this.validate=void 0}ready(){if(this.$math=this.$(".math"),this.$textarea=this.$("textarea"),this.$cursor=this.$(".cursor"),this.$error=this.$(".error-message"),this.solution=Gt.parse(this.attr("solution")),this.hasAttr("numeric")&&(this.numeric=+this.attr("precision")||.01),this.vars=this.hasAttr("vars")?tt(this.attr("vars")):this.solution?this.solution.variables:[],this.hasAttr("fns")&&(this.fns=tt(this.attr("fns"))),this.solution&&this.fns.push(...this.solution.functions),this.fns.includes("/")&&!this.fns.includes("\xD7")&&this.fns.push("\xD7"),this.hasAttr("hints")&&(this.hints=tt(this.attr("hints"))),this.hasAttr("substitutions")){this.substitutions={},this.autocomplete=this.vars.slice(0);for(let s of this.attr("substitutions").split("|"))if(s.trim()){let[i,o]=s.split(":");this.autocomplete.push(i.trim()),this.substitutions[i.trim()]=Gt.parse(o)}}for(let s of["solution","precision","vars","fns","vars-required","substitutions"])this.removeAttr(s);this.shortVar=this.hasAttr("short-var");let t=tt(this.attr("keys")||"+ \u2212 \xD7 \xF7 frac sup sqrt brackets"),e=this.$(".keys");for(let s of e.children)t.includes(s.data.type)?(s.on("pointerdown",i=>i.preventDefault()),s.on("pointerup",()=>{hp(this.$cursor,s.data.type),this.check()})):s.remove();this.on("pointerdown",s=>this.onPointerdown(s)),this.$textarea.on("focus",()=>this.onPointerdown()),this.$textarea.on("blur",()=>this.onBlur()),this.$textarea.on("key",s=>this.onKey(s))}setup(t,e,s){var i;this.$step=t,((i=s==null?void 0:s.scores)==null?void 0:i.includes(e))&&this.solve(),this.on("solve",()=>{t.addHint("correct"),t.score(e)})}focus(){this.trigger("pointerdown")}onPointerdown(t){if(this.isDone)return;t&&t.preventDefault&&t.preventDefault(),this.addClass("active"),this.$textarea.focus();let e=t&&t.target?N(t.target):this;if(e.tagName==="X-EQUATION"||e.hasClass("math")){let s=this.$math.children,i=H(s.map(r=>r.outerWidth))/2;(t?jt(t).x<this.$math.bounds.left+i:!0)?this.$math.prepend(this.$cursor):this.$math.append(this.$cursor)}else if(e.tagName[0]==="M"){let s=jt(t).x<e.boxCenter.x;e.tagName==="MROW"?s?e.prepend(this.$cursor):e.append(this.$cursor):s?e.insertBefore(this.$cursor):e.insertAfter(this.$cursor)}}onKey(t){if(F(t.code,ts.enter,ts.escape))this.$textarea.blur();else if(t.code===ts.left)ap(this.$cursor);else if(t.code===ts.right)Sg(this.$cursor);else if(t.code===ts.up)Tg(this.$cursor);else if(t.code===ts.down)Cg(this.$cursor);else if(F(t.code,ts.backspace,ts.delete))Mg(this.$cursor),this.check();else{let e=t.key.replace("*","\xD7").replace("/","\xF7").replace("-","\u2212");hp(this.$cursor,e),this.check()}}onBlur(){if(this.isDone)return;if(!this.value)return this.removeClass("active has-error");if(this.removeClass("active"),this.addClass("has-error"),this.value===this.lastAttempt||(this.lastAttempt=this.value,!this.$step))return;let t=this.error||(this.hints||[]).shift()||"incorrect",e=this.$step.addHint(t,{class:"incorrect"});this.$error.html=(e==null?void 0:e.text)||"",this.errorCount+=1,this.trigger("error",{count:this.errorCount,msg:t}),this.errorCount>=5&&this.$step.addHint(`Hmmm\u2026 maybe try ${this.solution.toMathML()}?`)}check(){if(this.error=void 0,this.value=Vs(this.$math,this.shortVar).trim(),!this.value)return;if(this.$math.$(".empty"))return this.error=Vg;let t=kg(this.value,this.vars);if(t.error)return this.error=t.error;let e=this.substitutions?t.expr.substitute(this.substitutions):t.expr;if(this.numeric&&Rg(this.solution,e,this.numeric))return this.solve();if(this.validate){let o=this.validate(t.expr)||{};if(o.isCorrect)return this.complete(t.expr);if(o.error)return this.error=o.error}if(this.solution&&Gt.numEquals(this.solution,e))return this.complete(t.expr);let s=Og(e,this.vars,this.autocomplete);if(s)return this.error=s;let i=Lg(e,this.fns);if(i)return this.error=i}complete(t){this.isDone||(this.isDone=!0,this.removeClass("has-error active"),this.addClass("done"),this.$textarea.blur(),this.shortVar||lp(this.$math,"mi"),lp(this.$math,"mn"),this.trigger("solve",{expr:t}))}solve(){this.$math.removeClass("empty"),this.$math.html=this.solution.toMathML(),this.complete(this.solution)}};Da=V([A("x-equation",{template:rp})],Da);var Ig={opacity:[0,1],transform:["translateX(-50px)","none"]},Ng={error:"You\u2019ve already had this expression before. Try simplifying it."},Dg="You have to fully simplify this expression. The correct solution is $0.",Ga=class extends L{constructor(){super(...arguments);this.rowCount=1;this.previousAnswers=[];this.isSolved=!1;this.maxRows=6;this.steps=[];this.hints=[]}created(){this.$table=this.$("table tbody"),this.lastRowContent=this.$table.$("tr:last-child").html}ready(){this.hasAttr("max-rows")&&(this.maxRows=+this.attr("max-rows")),this.hasAttr("steps")&&(this.steps=this.attr("steps").split("|")),this.hasAttr("hints")&&(this.hints=this.attr("hints").split("|")),this.removeAttr("steps"),this.removeAttr("hints"),this.setupEquation(this.$("x-equation"))}setup(t,e,s){var i;this.$step=this.$equation.$step=t,((i=s==null?void 0:s.scores)==null?void 0:i.includes(e))&&this.solve(),this.on("solve",()=>{t.addHint("correct"),t.score(e)}),this.on("hint",o=>t.addHint(o))}setupEquation(t){this.$equation=t,this.$equation.$step=this.$step,t.one("solve",e=>this.onSolveRow(e.expr)),t.hints=this.hints,t.validate=e=>{let s=this.previousAnswers.includes(e.toString());return(this.validate?this.validate(e,s):void 0)||(s?Ng:{})}}onSolveRow(t){if(this.trigger("solve-row",{expr:t,$math:this.$equation.$math}),this.isFinal&&this.isFinal(t))return this.trigger("solve");if(this.isSolved)return;if(this.rowCount+=1,this.previousAnswers.push(t.toString()),this.rowCount>this.maxRows){let s=this.$equation.solution.toMathML();this.trigger("hint",Dg.replace("$0",s)),this.trigger("solve")}let e=c("tr",{html:this.lastRowContent},this.$table);e.animate(Ig,400,500),this.setupEquation(e.$("x-equation")),setTimeout(()=>this.$equation.focus(),1200)}solve(){if(this.isSolved=!0,this.steps.length){let t=this.$table.$("tr:last-child"),e=this.lastRowContent.replace(/<x-equation.*<\/x-equation>/,'<span class="math fill"></span>');for(let s of this.steps){let i=c("tr",{html:e},this.$table),o=i.$(".math.fill"),r=Gt.parse(s);o.html=r.toMathML(),t.insertBefore(i),this.trigger("solve-row",{expr:r,$math:o})}}this.$equation.solve()}};Ga=V([A("x-equation-system")],Ga);var Gg=80,Hg=[5,2,1];function Ha(n){let t=Math.min(...n.map(s=>Math.min(...s.map(i=>i.y)))),e=Math.max(...n.map(s=>Math.max(...s.map(i=>i.y))));return[t,e]}function Ft(n,t,e){return n.hasAttr(t)?n.attr(t)!=="no":e}function cp(n){let t=tt(n).map(e=>+e);return t.length===1?[t[0],t[0],t[0],t[0]]:t.length===2?[t[0],t[1],t[0],t[1]]:t.length===3?[t[0],t[1],t[2],t[1]]:t}function dp(n){let t=n.split(",");return[t[0]!=="no",(t.length>1?t[1]:t[0])!=="no"]}function es(n,t,e,s=.01){let i=n?n.split(","):[];if(i.length===3)return i.map(m=>+m);let o=i.length>0?+i[0]:e?e[0]:0,r=i.length>1?+i[1]:e?e[1]:t;if(C(o,r))return[o-1,r+1,1];s&&(r+=.01*(r-o));let a=Math.floor(Math.abs(t)/Gg),h=(r-o)/a,l=Math.floor(Math.log10(h)),p=Math.pow(10,l),u=Hg.find(m=>p*m<=h)*p;return r=u*Math.ceil(r/u),o=u*Math.floor(o/u),[o,r,u]}var ji={hasGeoModel:!0,pi:Math.PI,point:(n,t)=>n!==void 0&&t!==void 0?new d(n,t):void 0,angle:(n,t,e)=>n&&t&&e?new Pt(n,t,e):void 0,line:(n,t)=>n&&t&&!n.equals(t)?new dt(n,t):void 0,ray:(n,t)=>n&&t&&!n.equals(t)?new Vi(n,t):void 0,segment:(n,t)=>n&&t&&!n.equals(t)?new Z(n,t):void 0,circle:(n,t)=>n&&t?new B(n,t):void 0,arc:(n,t,e)=>n&&t&&e?new ve(n,t,e):void 0,sector:(n,t,e)=>n&&t&&e?new ye(n,t,e):void 0,polygon:(...n)=>n.every(t=>t)?new O(...n):void 0,polyline:(...n)=>n.every(t=>t)?new be(...n):void 0,triangle:(n,t,e)=>n&&t&&e?new Ai(n,t,e):void 0,rectangle:(n,t,e)=>n?new S(n,t,e):void 0,distance:d.distance,round:(n,t=0)=>kt(n,t),sqrt:Math.sqrt,floor:Math.floor,ceil:Math.ceil,intersections:St};function uo(n,t,e){let s=e,i;for(let o of n){let r=t(o);r!==void 0&&r<s&&(s=r,i=o)}return i}function pp(n,t){t.clear();for(let e of n)if(!(e.isHidden||!e.value))for(let s of n){if(e.isHidden||!s.value||e===s)continue;let i=St(e.value,s.value);for(let[o,r]of i.entries())t.add({path1:e,path2:s,posn:r,index:o})}}function As(n,t){return wt(n)?n.offset(t):et(n)?new dt(n.c,t).angle/2/Math.PI:he(n)?new Pt(n.start,n.c,t).rad/n.angle:.5}var up="M100,50h0l-5.2-4.9L52.6,10.2v-9C52.6.6,51.4,0,50,0s-2.6.6-2.6,1.2v9L5.2,45.1,0,50H0l6.6-3L35,25.9H65L93.4,47ZM38.4,23.5,50,14.8l11.6,8.7Z",fp="M0,0V8H100V0ZM7,6A2,2,0,1,1,9,4,2,2,0,0,1,7,6Z";function ks(n,t,e,s){return`translate(${n.x}px, ${n.y-t}px) scale(${s/100}) rotate(${e}rad)`}var mp=4,qg=`<marker id="axis-arrow" refX="3" refY="3" markerWidth="6"
    markerHeight="6" orient="auto"><path d="M 0 0 L 6 3 L 0 6 z"/></marker>`,Os=class extends L{constructor(){super(...arguments);this.labelSuffix=["",""];this.gridSize=[1,1];this.showGrid=!1;this.showXAxis=!1;this.showYAxis=!1;this.showLabels=!1}setupCoordinates(t,e={}){this.$svg=t,t.addClass("canvas"),this.proportional=!!e.proportional,this.padding=cp(this.attr("padding")||e.padding||"0"),Ft(this,"grid",e.showGrid||!1)&&(this.$grid=c("g",{class:"grid"}),t.prepend(this.$grid),this.showGrid=!0);let s=this.attr("axes")||(e.showAxes?"yes":"no");[this.showXAxis,this.showYAxis]=dp(s),(this.showXAxis||this.showYAxis)&&(c("defs",{html:qg},t),this.$axes=c("g",{class:"axes"}),t.prepend(this.$axes),this.axisNames=(this.attr("axis-names")||",").split(",")),this.$axes&&Ft(this,"labels",!0)&&(this.labelSuffix=(this.attr("label-suffix")||",").split(","),this.showLabels=!0),(this.showLabels||this.axisNames)&&(this.$labels=c("g",{class:"labels"},t)),this.resize()}resize(){this.css("max-width","none");let t=+this.attr("width")||this.width,e=+this.attr("height")||(this.hasAttr("width")?t:this.height);this.css("max-width",t+"px"),this.$svg.setAttr("width",t),this.$svg.setAttr("height",e),this.$svg.setAttr("viewBox",`0 0 ${t} ${e}`);let s=this.padding;this.viewportBounds=new pt(s[3],t-s[1],s[0],e-s[2]),this.updatePlotBounds(),this.positionElements(t,e)}updatePlotBounds(t){let[e,s,i]=es(this.attr("x-axis"),this.viewportBounds.dx,t==null?void 0:t.xRange),[o,r,a]=es(this.attr("y-axis"),this.viewportBounds.dy,t==null?void 0:t.yRange),h=Math.abs(this.viewportBounds.dx/(s-e)),l=Math.abs(this.viewportBounds.dy/(r-o)),p=Math.min(h,l),u=this.proportional?h/p:1,m=this.proportional?l/p:1;this.plotBounds=new pt(u*e,u*s,m*r,m*o),this.plotScale=this.proportional?p:(h+l)/2,this.gridSize=[i,a];let[g,b]=[this.plotBounds,this.viewportBounds];this.plotToViewportMatrix=[[b.dx/g.dx,0,b.xMin-g.xMin/g.dx*b.dx],[0,b.dy/g.dy,b.yMin-g.yMin/g.dy*b.dy]];let w=e>0?u*e:s<0?u*s:0,y=o>0?m*o:r<0?m*r:0;this.plotOrigin=new d(w,y),this.drawAxes()}drawAxes(){let[t,e]=[this.plotBounds,this.viewportBounds],s=this.toViewportCoords(this.plotOrigin),[i,o]=this.gridSize;if(this.$grid&&this.$grid.removeChildren(),this.$axes&&this.$axes.removeChildren(),this.$labels&&this.$labels.removeChildren(),this.showGrid||this.showXAxis){let r=i*Math.trunc(t.xMin/i+.01);for(let a=r;a<t.xMax;a+=i){if(this.showYAxis&&a===this.plotOrigin.x)continue;let h=this.toViewportCoords(new d(a,0)).x;this.showGrid&&c("line",{x1:h,y1:e.yMin,x2:h,y2:e.yMax},this.$grid),this.showLabels&&this.makeLabel(0,a,h,s)}}if(this.showGrid||this.showYAxis){let[r,a]=t.yMin<t.yMax?[t.yMin,t.yMax]:[t.yMax,t.yMin],h=o*Math.trunc(r/o+.01);for(let l=h;l<a;l+=o){if(this.showXAxis&&l===this.plotOrigin.y)continue;let p=this.toViewportCoords(new d(0,l)).y;this.showGrid&&c("line",{x1:e.xMin,y1:p,x2:e.xMax,y2:p},this.$grid),this.showLabels&&this.makeLabel(1,l,p,s)}}this.showXAxis&&(this.$xAxis=c("line",{x1:e.xMin,x2:e.xMax,y1:s.y,y2:s.y},this.$axes)),this.showYAxis&&(this.$yAxis=c("line",{x1:s.x,x2:s.x,y1:e.yMax,y2:e.yMin},this.$axes)),this.showLabels&&this.showXAxis&&this.showYAxis&&(t.xMin===0&&t.yMax===0&&!this.labelSuffix[0]&&!this.labelSuffix[1]?c("text",{text:0,x:s.x-5,y:s.y+15,"text-anchor":"end"},this.$labels):t.yMax===this.plotOrigin.y?this.makeLabel(0,this.plotOrigin.x,s.x,s):this.makeLabel(1,this.plotOrigin.y,s.y,s)),this.axisNames&&(this.axisNames[0]&&c("text",{text:this.axisNames[0],x:this.viewportBounds.xMax-2,y:s.y-12,"text-anchor":"end"},this.$labels),this.axisNames[1]&&c("text",{text:this.axisNames[1],x:s.x+10,y:this.viewportBounds.yMin+5},this.$labels))}makeLabel(t,e,s,i){let o=this.labelSuffix[t],r=o==="i"?new rt(0,e).toString():ot(e,4)+o;c("text",{text:r,x:t?i.x-8:s,y:t?s+4:i.y+18,"text-anchor":t?"end":"middle"},this.$labels),c("line",{class:"tick",x1:t?i.x:s,y1:t?s:i.y,x2:t?i.x-mp:s,y2:t?s:i.y+mp},this.$axes)}positionElements(t,e){for(let s of this.$$("[data-bounds]")){let i=s.data.bounds.split(","),o=this.toViewportCoords(new d(+i[3],+i[0])),r=this.toViewportCoords(new d(+i[1],+i[2]));s.css({left:`${o.x/t*100}%`,top:`${o.y/e*100}%`,width:`${(r.x-o.x)/t*100}%`,height:`${(r.y-o.y)/e*100}%`})}}toPlotCoords(t){return t.changeCoordinates(this.viewportBounds,this.plotBounds)}toViewportCoords(t){return t.transform(this.plotToViewportMatrix)}};var qa=class extends Os{constructor(){super(...arguments);this.steps=400}ready(){let t=c("svg",{},this),e=c("g",{class:"plot"},t);this.$path=c("path",{},e),this.setupCoordinates(t,{showGrid:!0,showAxes:!0,padding:"20"}),this.clear();let s=this.viewportBounds,i=this.steps/s.dx,o;Ze(t,{start:()=>o=void 0,move:r=>{let a=M(Math.round((r.x-s.xMin)*i),0,this.steps-1);this.points[a]=this.toPlotCoords(new d(s.xMin+a/i,r.y)),o&&this.interpolate(o,a),o=a,this.redraw()},end:()=>this.snap()})}interpolate(t,e){e<t&&([t,e]=[e,t]);let s=this.points[t],i=this.points[e];for(let o=t+1;o<e;++o)this.points[o]=d.interpolate(s,i,(o-t)/(e-t))}redraw(){let t="",e=!0;for(let s of this.points){if(s){let i=this.toViewportCoords(s);t+=(e?"M":"L")+`${i.x},${i.y}`}e=!s}this.$path.setAttr("d",t)}snap(){let t=this.points.filter(s=>s).map(s=>[s.x,s.y]),e=ec.bestPolynomial(t);if(!!e){for(let s=0;s<this.steps;++s){if(!this.points[s])continue;let i=this.plotBounds.xMin+s/this.steps*this.plotBounds.dx;this.points[s]=new d(i,e.fn(i))}this.redraw(),this.trigger("snap",{regression:e})}}clear(){this.points=Nt(void 0,this.steps),this.$path.setAttr("d","")}};qa=V([A("x-coordinate-sketch")],qa);var _g=2,gp=5e3,_a=class extends Os{constructor(){super(...arguments);this.isAnimated=this.hasAttr("animate");this.crosshairGrid=10;this.getCrosshairPosn=t=>t}ready(){let t=c("svg",{},this);if(this.$plot=c("g",{class:"plot"},t),this.$overlay=c("g",{class:"overlay"},t),this.setupCoordinates(t,{showGrid:!0,showAxes:!0,padding:"20"}),this.hasAttr("fn")){let e=Gt.parse(this.attr("fn"),!0);this.setFunctions(s=>e.evaluate({x:s}))}Ft(this,"crosshairs",!0)&&(this.crosshairGrid=+this.attr("crosshair-grid")||10,this.setupCrosshairs(t))}setPoints(t,e=1){let s=t.map((i,o)=>new d(o+e,i));this.setSeries(s)}setSeries(...t){let e=Math.max(...t.map(o=>I(o).x)),[s,i]=Ha(t);this.updatePlotBounds(new pt(0,e,s,i)),this.$plot.removeChildren();for(let o of t)this.drawLinePlot(o);this.getCrosshairPosn=o=>t[0].reduce((r,a)=>Math.abs(a.x-o.x)<=Math.abs(r.x-o.x)?a:r)}setFunctions(...t){let[e,s]=[this.plotBounds,this.viewportBounds],i=t.map(h=>{let l=[];for(let p=s.xMin;p<s.xMax;p+=_g){let u=this.toPlotCoords(new d(p,0)).x;l.push(new d(u,h(u)))}return l}),[o,r]=Ha(i);this.updatePlotBounds(new pt(e.xMin,e.xMax,o,r)),this.$plot.removeChildren();for(let h of i)this.drawLinePlot(h);let a=this.gridSize[0]/this.crosshairGrid;this.getCrosshairPosn=h=>{let l=st(M(h.x,e.xMin,e.xMax),a);return new d(l,t[0](l))}}drawLinePlot(t){let e=c("g",{},this.$plot),s=c("path",{},e),i=this.plotBounds;t=t.filter(r=>r.y>=i.yMax&&r.y<=i.yMin);let o=t.map(r=>this.toViewportCoords(r));this.isAnimated?z(r=>{let a=t.findIndex(h=>h.x>i.xMin+r*i.dx);s.points=o.slice(0,a)},gp):s.points=o}drawPoints(t){let e=c("g",{},this.$plot),s=this.plotBounds;for(let i of t){let o=this.toViewportCoords(i),r=c("circle",{r:4,cx:o.x,cy:o.y},e);if(this.isAnimated){r.hide();let a=gp*(i.x-s.xMin)/(s.xMax-s.xMin);setTimeout(()=>r.show(),a)}}}setupCrosshairs(t){let e=c("g",{class:"crosshair"},t),s=c("path",{},e),i=c("circle",{r:4},e),o=c("text",{},e),r=0,a=h=>{let l=this.getCrosshairPosn(this.toPlotCoords(h));if(C(l.x,r))return;r=l.x;let p=this.toViewportCoords(l),u=this.toViewportCoords(this.plotOrigin);i.setCenter(p),s.points=[new d(u.x,p.y),p,new d(p.x,u.y)],o.text=`(${ot(l.x,5,!1)}, ${ot(l.y,5,!1)})`;let m=o.width,g=p.x+8+m<this.viewportBounds.dx;o.setAttr("x",g?p.x+5:p.x-m-5),o.setAttr("y",p.y>20?p.y-7:p.y+18)};bc(t,{enter:()=>e.show(),move:h=>a(h),exit:()=>e.hide()})}};_a=V([A("x-coordinate-system")],_a);var Zi=class{constructor(t,e){this.$canvas=t;this.defaultCallbacks=e;this.callbacks=new WeakMap;this.isMoving=!1;this.shiftKey=!1;this.altKey=!1;this.cancelled=!1;setTimeout(()=>{document.addEventListener("keydown",s=>{this.shiftKey=s.shiftKey,this.altKey=s.altKey}),document.addEventListener("keyup",s=>{this.shiftKey=s.shiftKey,this.altKey=s.altKey}),document.addEventListener("visibilitychange",()=>{this.shiftKey=this.altKey=!1})},2e3),t.css("touch-action","none"),t.on("pointerdown",s=>this.startEvent(s)),v.onKey("escape",()=>this.cancel()),e.hover&&t.on("pointermove",s=>{this.isMoving||e.hover({posn:ie(s,t),event:s})})}listen(t,e){this.callbacks.set(t._el,e),t.hasParent(this.$canvas)||(t.css("touch-action","none"),t.on("pointerdown",s=>this.startEvent(s)))}startEvent(t){var l;if(t.handled||t.button)return;this.isMoving=!0,this.cancelled=!1,t.preventDefault();let e=t.pointerId,s=this.getCallbacks(t.target);"shiftKey"in t&&(this.shiftKey=t.shiftKey),s.blurInput!==!1&&((l=v.getActiveInput())==null||l.blur());let i=ie(t,this.$canvas),o=i,r=!1,a=p=>{if(p.pointerId&&p.pointerId!==e)return;if(p.preventDefault(),this.cancelled)return h(p);let u=ie(p,this.$canvas);d.distance(u,o)<.5||(!r&&s.start&&s.start({posn:i,event:p}),s.move&&s.move({posn:u,startPosn:i,lastPosn:o,event:p}),!r&&s.cursor!==!1&&Mt.addClass("grabbing"),o=u,r=!0)},h=p=>{var u,m;p.pointerId&&p.pointerId!==e||(p.preventDefault(),q.off("pointermove",a),q.off("pointerstop",h),r?(u=s.end)==null||u.call(s,{posn:o,lastPosn:o,startPosn:i,event:p,cancelled:this.cancelled}):this.cancelled||(m=s.click)==null||m.call(s,{posn:i,event:p}),Mt.removeClass("grabbing"),this.isMoving=this.cancelled=!1)};s.down&&s.down({posn:i,event:t}),q.on("pointermove",a),q.on("pointerstop",h)}getCallbacks(t){for(;t;){let e=this.callbacks.get(t);if(e&&(!e.checkIfActive||e.checkIfActive()))return e;t=t.parentNode||void 0}return this.defaultCallbacks}cancel(){this.cancelled=!0}};function Bg(n,t){if(typeof n=="string"){let e=yt(n);return s=>{var i;return(i=e(t))==null?void 0:i.equals(s)}}return typeof n=="function"?n:e=>n.equals(e)}function Ba(n,t,e){let s=t.map(g=>Bg(g,n.model)),i=Nt(void 0,t.length),o=hs(),r=[],a=({point:g})=>r.push(g),h=e.maxErrors||4,l=0,p=({path:g})=>{e.onBegin&&e.onBegin(g)},u=()=>{i.every(g=>g)&&(e.onComplete&&e.onComplete(!0),n.off("add:path",m),n.off("begin:path",p),n.off("add:point",a),o.resolve(i))},m=({path:g})=>{let b=g.value;if(!!b){for(let[w,y]of s.entries())if(!i[w]&&y(b))return i[w]=g,e.onCorrect&&e.onCorrect(g,w),l=0,r=[],u();g.delete();for(let w of r)w.delete();if(r=[],!(wt(b)&&b.length<1))if(l+=1,l>=h){let w=i.findIndex($=>!$),y=t[w];if(typeof y!="function"){let $=n.drawPath(y,{animated:1e3});i[w]=$,e.onHint&&e.onHint($,w),l=0,u()}}else e.onIncorrect&&e.onIncorrect(g)}};return n.on("begin:path",p),n.on("add:path",m),n.on("add:point",a),o.promise}function wp(n,t){return c("text",{target:n.attr("target")||void 0,class:n.attr("label-class")||n.attr("class")||void 0,"data-when":n.data.when,style:t?`color: ${t}`:void 0,"text-anchor":"middle"})}function vp(n,t){let e=[];for(let s of t.paths)s!==n&&s.value&&e.push(s.value.transform(t.plotToViewportMatrix));return e}var zg=new B(new d(0,-9),12);function yp(n,t,e){for(let s of e)if(t.every(i=>!St(zg.translate(s),i).length))return s;return e[0]}function bp(n,t){let e=n.value.transform(t.plotToViewportMatrix),s=n.$el;if(wt(e)){let i=e.perpendicularVector,o=e.angle;i.y>=0&&(i=i.scale(-1),o+=Math.PI);let r=[];for(let l of[.5,.35,.65])for(let p of[-15,5])r.push(e.at(l).add(i.scale(p)));if(!t.labelPositioning)return[r[0],o];let a=vp(n,t),h=yp(e,a,r);return s.hasAttr("mark")&&(h=h.add(e.unitVector.scale(12))),[h,o]}if(Ae(e))return[e.at(.5).subtract(e.c).scale(.6).add(e.c).shift(0,5)];if(he(e)){let i=new dt(e.start,e.end),o=i.perpendicularVector.y>=0,r=i.angle+(o?Math.PI:0);return[e.at(.5).add(i.perpendicularVector.scale(o?14:5)),r]}if(mr(e)){let i=(+s.attr("size")||wr(e,{round:s.hasAttr("round")}))+8;return[e.b.add(e.bisector.unitVector.scale(i+5)).shift(0,3)]}if(vt(e)){let i=s.hasClass("move")?10:8,o=[e.shift(i,-i),e.shift(-i,-i),e.shift(i,10+i),e.shift(-i,10+i)];if(!t.labelPositioning)return[o[0]];let r=vp(n,t);return[yp(e,r,o)]}return ee(e)?[e.centroid.shift(0,5)]:et(e)?[e.c.shift(0,5)]:[]}var za=class{constructor(t,e,s,i){this.$parent=t;this.$el=s;this.color="";this.label="";this.isPending=!1;this.isLocked=!1;this.components=[];this.dependencies=[];this.fixedLabel=!1;this.name=i||t.model.getKey(),t.shapes.set(this.name,this),t.model.watch(o=>{let r=o[this.name];this.$el.css("display",r?"block":"none"),this.$label&&this.$label.css("display",r?"block":"none"),r&&this.redraw(r),t.queueLabelPositioning()}),this.color=s.css("color")||"",this.setValue(e),s.hasAttr("label")&&this.setLabel(s.attr("label"))}get value(){return this.$parent.model[this.name]}get type(){var t;return(t=this.value)==null?void 0:t.type}get locked(){return this.isLocked}get isHidden(){return this.isPending||this.$el.hasAttr("hidden")||this.$el.hasClass("transparent")}setValue(t){t instanceof Function?this.$parent.model.setComputed(this.name,t):this.$parent.model[this.name]=t}setLabel(t,e,s){this.$label||(this.$label=wp(this.$el,e),this.$parent.$objLabels.append(this.$label));let i=Dn(t);if(this.$parent.model.watch(o=>this.$label.text=i(o)||""),this.fixedLabel=!!s,s){let o=yt(s);this.$parent.model.watch(r=>{this.$label.setTransform(o(r).shift(0,5))})}this.updateLabelPosition()}setColor(t){this.color=t,this.$el.css("color",t);for(let e of this.dependencies)e.setColor(t);this.$label&&this.$label.css("color",t)}updateLabelPosition(){if(!this.$label||!this.value||this.fixedLabel)return;let[t,e]=bp(this,this.$parent);this.$label.setTransform(t,e)}select(){this.$el.addClass("selected"),this.$el.parent.append(this.$el);for(let t of this.dependencies)t.select()}deselect(){this.$el.removeClass("selected");for(let t of this.dependencies)t.deselect()}hover(t=!1){if(!t){if(this.$parent.hovering===this)return;this.$parent.hovering&&this.$parent.hovering.unhover(),this.$parent.hovering=this}this.$el.addClass("hover");for(let e of this.dependencies)e.hover(!0)}unhover(t=!1){if(!t){if(this.$parent.hovering!==this)return;this.$parent.hovering=void 0}this.$el.removeClass("hover");for(let e of this.dependencies)e.unhover(!0)}delete(t=300){return P(this,null,function*(){this.$parent.shapes.delete(this.name);for(let e of this.components)e.deselect();this.$label&&this.$label.exit("fade",t,0,!0),yield this.removeElement(t),this.$parent.model[this.name]=void 0})}},qe=class extends za{constructor(t,e,s,i,o=!1){i||(i=c("circle",{})),super(t,e,i,s),this.$parent.hidePoints||t.$points.append(this.$el),t.points.add(this),this.projectionId=t.model.getKey(),this.projectionOffset=void 0,t.model.watch(r=>{this.projection=r[this.projectionId],this.projection&&(this.projectionOffset===void 0&&(this.projectionOffset=As(this.projection,this.$parent.model[this.name])),this.$parent.model[this.name]=this.projection.at(this.projectionOffset))}),this.lock(o)}setValue(t){t instanceof Function?(this.project(void 0),this.$parent.model.setComputed(this.name,t)):(t&&this.projection&&(t=this.projection.project(t),this.projectionOffset=As(this.projection,t)),this.$parent.model[this.name]=t)}redraw(t){let e=t.transform(this.$parent.plotToViewportMatrix);this.$el.setCenter(e),this.$halo&&this.$halo.setCenter(e),this.$pulse&&this.$pulse.setCenter(e)}removeElement(t){return P(this,null,function*(){this.$parent.points.delete(this),yield this.$el.exit("pop",t,0,!0).promise})}distance(t){return this.value?d.distance(t,this.value):Infinity}lock(t=!0){this.isLocked=t,this.$el.setClass("move",!t),t?this.$el.removeAttr("tabindex"):this.$el.setAttr("tabindex",0)}project(t){if(this.projectionOffset=void 0,typeof t=="string"){let e=yt(t);this.$parent.model.setComputed(this.projectionId,e)}else t?this.$parent.model.setComputed(this.projectionId,()=>t.value):this.$parent.model[this.projectionId]=void 0}makeIntersection({path1:t,path2:e,index:s}){this.setValue(i=>{if(!i[t.name]||!i[e.name])return;let o=St(i[t.name],i[e.name]);return o[Math.min(s,o.length-1)]}),this.lock()}addHalo(){this.$halo=c("circle",{class:"halo",r:18},this.$parent.$pulses),this.$halo.setCenter(this.$el.center),this.$halo.enter("pop")}removeHalo(){return P(this,null,function*(){!this.$halo||(this.$halo.exit("pop",500,0,!0),this.$halo=void 0)})}pulsate(){this.$pulse=c("circle",{class:"pulse",r:8},this.$parent.$pulses),this.$pulse.setCenter(this.$el.center),this.$el.one("mouseover pointerdown focus",()=>{this.$pulse&&this.$pulse.remove(),this.$pulse=void 0})}},ss=class extends za{constructor(t,e,s,i){super(t,e,i||c("path"),s);t.$paths.append(this.$el),t.paths.add(this)}get locked(){return this.isLocked||!this.components.length||this.components.every(t=>t.locked)}redraw(t){let e=t.transform(this.$parent.plotToViewportMatrix);this.$el.draw(e,{box:this.$parent.viewportRect})}distance(t){return this.value?d.distance(t,this.value.project(t)):Infinity}removeElement(t){return P(this,null,function*(){this.$parent.paths.delete(this),yield this.$el.exit("draw",t,0,!0).promise})}setComponents(t,e){this.components=this.dependencies=t,this.setValue(()=>{let s=t.map(i=>i.value);if(!s.some(i=>i===void 0))return e(...s)})}};var fo=class{constructor(t){this.$parent=t}enable(){}down(t){}start(t){}move(t,e){}end(t){}hover(t){}click(t){}cancel(){}snapToGrid(t){return this.$parent.snapToGrid?t.round(this.$parent.snapToGrid):t}snapToPoint(t,e){if(this.snapPoint=this.$parent.getPointAt(e),this.snapPoint)return t.$el.setClass("move",!this.snapPoint.locked),t.setValue(this.snapPoint.value);if(this.snapIntersect=this.$parent.getIntersectionAt(e),this.snapIntersect)return t.$el.removeClass("move"),t.setValue(this.snapIntersect.posn);if(!this.$parent.snapToGrid&&(this.snapPath=this.$parent.getPathAt(e),this.snapPath))return t.setValue(this.snapPath.value.project(e));t.$el.addClass("move"),t.setValue(this.snapToGrid(e))}getOrMakePointAt(t){let e=this.$parent.getPointAt(t);if(!e){e=new qe(this.$parent,this.snapToGrid(t));let s=this.$parent.getIntersectionAt(t);if(s)e.makeIntersection(s);else if(!this.$parent.snapToGrid){let i=this.$parent.getPathAt(t);i&&e.project(i)}this.$parent.trigger("add:point",{point:e})}return e}showPendingPointAt(t){var i,o,r;let e=((i=this.$parent.getIntersectionAt(t))==null?void 0:i.posn)||((r=(o=this.$parent.getPathAt(t))==null?void 0:o.value)==null?void 0:r.project(t)),s=!!e;if(this.$parent.$pendingPoint.toggle(s),s){let a=this.$parent.toViewportCoords(e||t);this.$parent.$pendingPoint.setCenter(a)}}},mo=class extends fo{constructor(){super(...arguments);this.isMoving=!1}enable(){}down(t){this.obj=this.$parent.getPointAt(t)||this.$parent.getPathAt(t),this.obj||this.$parent.deselect();let e=this.$parent.selection;e!==this.obj&&(e&&e.components.includes(this.obj)||this.$parent.select(this.obj))}start(){!this.obj||(this.isMoving=!0,this.obj.isPending=!0,this.$parent.updateIntersections(),this.$parent.trigger("move",{obj:this.obj}))}move(t,e){if(!(!this.obj||this.obj.locked||this.$parent.locked))if(this.obj instanceof ss){let s=t.subtract(e);for(let i of this.obj.components)i.locked||i.setValue(i.value.add(s))}else this.obj instanceof qe&&this.obj.setValue(this.snapToGrid(t))}end(){!this.obj||(this.isMoving=!1,this.obj.isPending=!1,this.snapPoint||(this.snapIntersect?this.obj.makeIntersection(this.snapIntersect):this.snapPath&&this.obj.project(this.snapPath)),this.$parent.trigger("moveEnd",{path:this.obj}),this.obj=void 0,this.$parent.updateIntersections())}hover(t){if(this.isMoving)return;let e=this.$parent.getPointAt(t)||this.$parent.getPathAt(t),s=e&&!this.$parent.locked&&!e.locked,i=e&&this.$parent.canSelect;this.$parent.setCursor(s?"grab":i?"pointer":"default"),s||i?e.hover():this.$parent.hovering&&this.$parent.hovering.unhover()}},Fa=class extends mo{down(t){this.$parent.deselect(),this.obj=this.getOrMakePointAt(t),this.$parent.select(this.obj)}hover(t){let e=this.$parent.getPointAt(t);if(e)return this.$parent.setCursor(this.$parent.locked||e.locked?"default":"grab"),this.$parent.$pendingPoint.hide(),e.hover();this.$parent.hovering&&this.$parent.hovering.unhover(),this.$parent.setCursor("crosshair"),this.showPendingPointAt(t)}},Wi=class extends fo{enable(){this.$parent.setCursor("crosshair")}down(t){this.$parent.deselect(),this.startPoint=this.getOrMakePointAt(t)}start(t){!this.startPoint||(this.$parent.$pendingPoint.hide(),this.endPoint=new qe(this.$parent,t),this.endPoint.isPending=!0,this.endPoint.$el.addClass("pending"),this.path=new ss(this.$parent,void 0),this.path.setComponents([this.startPoint,this.endPoint],this.expr),this.path.isPending=!0,this.$parent.updateIntersections(),this.$parent.trigger("begin:path",{path:this.path,start:this.startPoint}))}move(t){if(!this.startPoint||!this.path||!this.endPoint)return;if(d.distance(t,this.startPoint.value)<20/this.$parent.plotScale)return this.endPoint.setValue(this.snapToGrid(t));this.snapToPoint(this.endPoint,t)}end(){if(!this.startPoint||!this.path||!this.endPoint)return;this.path.isPending=!1,this.endPoint.isPending=!1,this.startPoint.value.equals(this.endPoint.value)?(this.endPoint.delete(),this.path.delete(),this.path=this.endPoint=void 0):this.snapPoint?(this.path.setComponents([this.startPoint,this.snapPoint],this.expr),this.endPoint.delete(),this.endPoint=void 0):this.snapIntersect?this.endPoint.makeIntersection(this.snapIntersect):this.snapPath&&this.endPoint.project(this.snapPath),this.endPoint&&(this.$parent.trigger("add:point",{point:this.endPoint}),this.endPoint.$el.removeClass("pending"));let t=this.path;this.startPoint=this.endPoint=this.path=void 0,t&&(this.$parent.trigger("add:path",{path:t}),this.$parent.updateIntersections())}hover(t){let e=this.$parent.getPointAt(t);if(e)return this.$parent.$pendingPoint.hide(),e.hover();this.$parent.hovering&&this.$parent.hovering.unhover(),this.showPendingPointAt(t)}cancel(){this.endPoint&&this.endPoint.delete(),this.path&&this.path.delete(),this.$parent.$pendingPoint.hide(),this.startPoint=this.endPoint=this.path=void 0}},Ua=class extends Wi{expr(t,e){return new Z(t,e)}},ja=class extends Wi{expr(t,e){return new B(t,d.distance(t,e))}},Za=class extends Wi{expr(t,e){return new S(t,e.x-t.x,e.y-t.y)}},Wa=class extends Wi{expr(t,e){return new Z(t,e).perpendicularBisector}},$p=(n,t,e)=>new Pt(n,t,e).bisector,Ka=class extends fo{enable(){}down(t){if(this.$parent.deselect(),!this.firstPoint)this.firstPoint=this.getOrMakePointAt(t),this.firstPoint&&this.firstPoint.addHalo();else if(this.secondPoint){this.path.isPending=this.thirdPoint.isPending=!1,this.thirdPoint.$el.removeClass("pending"),this.firstPoint.removeHalo(),this.secondPoint.removeHalo(),this.snapPoint?(this.path.setComponents([this.firstPoint,this.secondPoint,this.snapPoint],$p),this.thirdPoint.delete(),this.thirdPoint=void 0):this.snapIntersect?this.thirdPoint.makeIntersection(this.snapIntersect):this.snapPath&&this.thirdPoint.project(this.snapPath);let e=this.path,s=this.thirdPoint;this.firstPoint=this.secondPoint=this.thirdPoint=this.path=void 0,s&&this.$parent.trigger("add:point",{point:s}),this.$parent.trigger("add:path",{path:e}),this.$parent.updateIntersections()}else{if(this.secondPoint=this.getOrMakePointAt(t),!this.secondPoint)return;this.secondPoint.addHalo(),this.thirdPoint=new qe(this.$parent,this.secondPoint.value),this.thirdPoint.$el.addClass("pending"),this.path=new ss(this.$parent,void 0),this.path.setComponents([this.firstPoint,this.secondPoint,this.thirdPoint],$p),this.path.isPending=this.thirdPoint.isPending=!0}}hover(t){if(this.$parent.$pendingPoint.hide(),this.thirdPoint){this.snapToPoint(this.thirdPoint,t),this.$parent.setCursor(this.snapPoint?"pointer":"crosshair");return}let e=this.$parent.getPointAt(t);if(e)return this.$parent.setCursor("pointer"),e.hover();this.$parent.hovering&&this.$parent.hovering.unhover(),this.$parent.setCursor("crosshair"),this.showPendingPointAt(t)}cancel(){this.firstPoint&&this.firstPoint.removeHalo(),this.secondPoint&&this.secondPoint.removeHalo(),this.thirdPoint&&this.thirdPoint.delete(),this.path&&this.path.delete(),this.firstPoint=this.secondPoint=this.thirdPoint=this.path=void 0}};var xp='<x-select class="tools"><div class="tool" data-tool="move"><x-icon name="hand" size="28"></x-icon></div><div class="tool" data-tool="point"><x-icon name="geo-point" size="28"></x-icon></div><div class="tool" data-tool="line"><x-icon name="geo-line" size="28"></x-icon></div><div class="tool" data-tool="rectangle"><x-icon name="geo-rectangle" size="28"></x-icon></div><div class="tool" data-tool="circle"><x-icon name="geo-circle" size="28"></x-icon></div><div class="tool" data-tool="perpBisector"><x-icon name="geo-perp-bisector" size="28"></x-icon></div><div class="tool" data-tool="angleBisector"><x-icon name="geo-angle-bisector" size="28"></x-icon></div></x-select><slot></slot>';var Xa=class extends Os{constructor(){super(...arguments);this.shapes=new Map;this.points=new Set;this.paths=new Set;this.intersections=new Set;this.snapToGrid=0;this.locked=!1;this.hidePoints=!1;this.canSelect=!1;this.canIntersect=!1;this.canProject=!0;this.labelPositioning=!1;this.cursor="default"}ready(){let t=this.children.filter(a=>a.tagName==="SVG")[0];if(this.hasAttr("complex")&&(this.setAttr("label-suffix",",i"),this.setAttr("axis-names","Real, Imaginary"),this.setAttr("axes","true"),this.setAttr("grid","true")),!this.hasAttr("x-axis")&&!this.hasAttr("y-axis")){let a=+this.attr("grid"),h=+this.attr("width")||this.width,l=+this.attr("height")||h;this.setAttr("x-axis",a?`-0.5,${h/a-.5},1`:`0,${h},1`),this.setAttr("y-axis",a?`${l/a-.5},-0.5,1`:`${l},0,1`),a&&this.setAttr("snap",1)}this.setupCoordinates(t,{proportional:!0}),this.viewportRect=this.viewportBounds.rect,this.model=this.getParentModel()||Dt({}),this.model.hasGeoModel||this.model.assign(ji),this.$paths=c("g",{class:"paths"},t),this.$pulses=c("g",{class:"pulses"},t),this.$points=c("g",{class:"points"},t),this.$objLabels=c("g",{class:"labels"},t),this.snapToGrid=this.hasAttr("snap")?+this.attr("snap")||1:0,this.hidePoints=this.hasAttr("no-points"),this.canIntersect=Ft(this,"intersections",!1),this.canProject=Ft(this,"projections",!0),this.canSelect=Ft(this,"selectable",!1),this.labelPositioning=Ft(this,"label-positioning",!0),this.hasClass("sticky")&&this.css("top",`calc(50vh - ${this.height/2}px)`),this.queueLabelPositioning=ls(()=>{for(let a of this.shapes.values())a.updateLabelPosition()},0,!0);let e=t.$$("path[x], path[\\:d], circle");for(let a of e){let h=a.hasAttr("x")?yt(a.attr("x")):void 0,l=a.attr("name");if(a.hasAttr(":d"))this.$paths.append(a),a.bindModel(this.model);else if(a.tagName==="PATH")this.$paths.append(a),new ss(this,h,l,a);else{this.$points.append(a);let p=!a.hasClass("move"),u=h||a.center,m=new qe(this,u,l,a,p);a.hasAttr("project")&&m.project(a.attr("project")),a.hasClass("pulsate")&&m.pulsate()}}this.$pendingPoint=c("circle",{class:"pending"},this.$points),this.$pendingPoint.hide(),this.updateIntersections();let s={move:new mo(this),point:new Fa(this),line:new Ua(this),circle:new ja(this),perpBisector:new Wa(this),angleBisector:new Ka(this),rectangle:new Za(this)};this.$tools=this.$(".tools");let i=s[this.$tools.$active.data.tool];i.enable();let o=()=>this.toolOverride||i;this.$tools.on("change",a=>{o().cancel(),this.toolOverride=void 0,i=s[a.data.tool],this.hovering&&this.hovering.unhover(),this.$pendingPoint.hide(),this.hovering=void 0,this.deselect(),i.enable()});let r=(a,h=!1)=>this.toPlotCoords(h?a.clamp(this.viewportBounds,8):a);new Zi(t,{down:a=>o().down(r(a.posn)),start:a=>o().start(r(a.posn)),move:a=>o().move(r(a.posn,!0),r(a.lastPosn,!0)),end:a=>o().end(r(a.posn,!0)),click:a=>o().click(r(a.posn)),hover:a=>o().hover(r(a.posn))}),v.onKey("escape",()=>o().cancel()),v.onKey("backspace delete",()=>this.delete()),document.addEventListener("keydown",a=>{if([37,38,39,40].indexOf(a.keyCode)<0)return;let l=v.getActiveInput();if(!(!l||!l.hasParent(this))){a.preventDefault();for(let p of this.points){if(p.$el!==l||!p.value)continue;let u=15/this.plotScale,m=this.plotBounds.yMin>this.plotBounds.yMax?-1:1,g=a.keyCode===37?-u:a.keyCode===39?u:0,b=a.keyCode===38?-m*u:a.keyCode===40?m*u:0;p.setValue(p.value.shift(g,b));return}}})}switchTool(t){this.$tools.makeActive(this.$(`.tool[data-tool="${t}"]`))}setCursor(t="default"){t!==this.cursor&&(this.cursor=t,this.$svg.css("cursor",t))}select(t){!this.canSelect||(this.deselect(),t&&(this.selection=t,t.select()),this.trigger("select",{shape:t}))}deselect(){!this.selection||(this.selection.deselect(),this.selection=void 0,this.trigger("select",{shape:void 0}))}delete(){this.hovering&&this.hovering.unhover(),this.selection&&this.selection.delete(),this.trigger("select",{shape:void 0})}redraw(){this.resize(),this.viewportRect=this.viewportBounds.rect,this.model.forceUpdate()}getPointAt(t,e=20){if(this.hidePoints)return;let s=i=>i.isHidden?void 0:i.distance(t);return uo(this.points,s,e/this.plotScale)}getPathAt(t,e=10){if(this.hidePoints||!this.canProject)return;let s=i=>i.isHidden?void 0:i.distance(t);return uo(this.paths,s,e/this.plotScale)}getIntersectionAt(t,e=20){if(!this.canIntersect)return;let s=i=>d.distance(t,i.posn);return uo(this.intersections,s,e/this.plotScale)}updateIntersections(){!this.canIntersect||this.hidePoints||pp(this.paths,this.intersections)}drawPath(t,e={}){typeof t=="string"&&(t=yt(t));let s=new ss(this,t,e.name);e.classes&&s.$el.addClass(e.classes),e.target&&s.$el.setAttr("target",e.target);let i=s.$el.hasClass("fill")?"fade":"draw";return e.animated&&s.$el.enter(i,e.animated),s}drawPoint(t,e={}){typeof t=="string"&&(t=yt(t));let s=new qe(this,t,e.name,void 0,e.interactive===!1);return e.classes&&s.$el.addClass(e.classes),e.target&&s.$el.setAttr("target",e.target),e.animated!==0&&s.$el.enter("pop",e.animated||500),s}animatePoint(t,e,s=400){let i=this.shapes.get(t),o=new Z(this.model[t],e);return z(r=>i.setValue(o.at(X("quad",r))),s)}animateConstruction(t,e=2e3){return P(this,null,function*(){let s=this.shapes.get(t),i=s.value;if(et(i)&&(i=i.arc),wt(i)){this.$ruler||(this.$ruler=c("path",{d:fp,class:"sketch"},this.$svg));let o=ks(i.at(-.1),12,i.angle-.3,i.length*1.2),r=ks(i.at(-.1),12,i.angle,i.length*1.2);this.$ruler.show(),s.$el.hide(),yield this.$ruler.animate({opacity:[0,1],transform:[o,r]},500).promise,yield s.$el.enter("draw",e).promise,yield this.$ruler.animate({opacity:[1,0],transform:[r,o]},500).promise}else if(he(i)){this.$compass||(this.$compass=c("path",{d:up,class:"sketch"},this.$svg));let o=ks(i.c,50,i.startAngle,i.radius*1.5),r=ks(i.c,50,i.startAngle,i.radius),a=ks(i.c,50,i.startAngle+i.angle,i.radius),h=ks(i.c,50,i.startAngle+i.angle,i.radius*1.5);this.$compass.show(),s.$el.hide(),yield this.$compass.animate({opacity:[0,1],transform:[o,r]},500).promise,s.$el.enter("draw",e),yield this.$compass.animate({transform:[r,a]},e,0,"linear").promise,yield this.$compass.animate({opacity:[1,0],transform:[a,h]},500).promise}})}showGesture(t,e){this.$gesture||(this.$gesture=c("x-gesture",{},this)),this.$gesture.stop();let s=this.toViewportCoords(yt(t)(this.model));if(this.$gesture.from=s,e){let i=this.toViewportCoords(yt(e)(this.model));this.$gesture.start(i.subtract(s))}else this.$gesture.start();this.one("click mouseover pointerdown",()=>this.$gesture.stop())}waitForPoint(){return P(this,null,function*(){return new Promise(t=>{this.one("add:point",({point:e})=>t(e))})})}waitForPath(s){return P(this,arguments,function*(t,e={}){return(yield Ba(this,[t],e))[0]})}waitForPaths(t,e={}){return Ba(this,t,e)}};Xa=V([A("x-geopad",{template:xp})],Xa);var Pp='<div class="image"></div><div class="content"><slot></slot></div>';var Ya=class extends L{ready(){let t=this.$(".image"),e=this.positionTop<50,s,i;t.css({"background-image":`url("${this.attr("background")}")`,height:e?"100%":"150%"});let o=({height:a})=>{let h=this.positionTop;s=Math.max(0,h-a),i=h+this.height};function r(a){if(a.top<s||a.top>i)return;let h=(a.top-s)/(i-s)*(e?50:33);t.css("transform",`translateY(${h}%)`)}v.onResize(o),q.on("scroll",r)}};Ya=V([A("x-parallax",{template:Pp})],Ya);function go(n,t,e,s){let i,o;t:for(let[r,a]of e)for(let h of t){let l=(s?s(r,h):r).subtract(h),p=l.length;if(p<n&&(n=p,i=l,o=a,p<1))break t}return i?{shift:i,target:o}:void 0}function Sp(n){if(vt(n))return[n];if(ee(n))return n.points;if(Ys(n))return[n.p1,n.p2];if(et(n))return[n.c.shift(n.r,0),n.c.shift(-n.r,0),n.c.shift(0,n.r),n.c.shift(0,-n.r)];if(Ae(n)||he(n)){let t=[n.start,n.end];Ae(n)&&t.push(n.c);let e=n.radius;for(let[s,i]of[[e,0],[0,e],[-e,0],[0,-e]]){let o=n.c.shift(s,i);ve.prototype.contains.call(n,o)&&t.push(o)}return t}return[]}function Ls(...n){return S.aroundPoints(function*(){for(let t of n)for(let e of Sp(t))yield e}())}function wo(n,t,e=0){if(!n.size&&!t.size)return new pt(0,100,0,100);let s=S.aroundPoints(function*(){for(let i of n.values())if(i.transformed)for(let o of Sp(i.transformed))yield o;for(let i of t.values()){yield i.segments[0].p1;for(let o of i.segments)yield o.p2}}());return new pt(s.p.x-e,s.p.x+s.w+e,s.p.y-e,s.p.y+s.h+e)}function Ki(n,t,e){if(vt(t))return n.contains(t);if(On(t))return O.collision(n.polygon,t);if(ur(t))return t.collision(n);if(wt(t))return St(t,n).length>0||n.contains(t.p1);if(et(t))return e==="geo"?St(t,n).length>0||n.contains(t.at(0)):t.collision(n);if(Ae(t)){let s=new O(t.c,t.start,t.at(.25),t.at(.5),t.at(.75),t.end);return O.collision(n.polygon,s)}return!1}var Ja=new Map;function R(n){if(!n||!v.theme.isDark)return n;if(Ja.has(n))return Ja.get(n);let t=G.fromHex(n),e=t.hsl;lt(e[2],20,80)||(e[2]=100-e[2]);let s=G.fromHsl(...e);s.a=t.a;let i=s.hex;return Ja.set(n,i),i}function Tp(n){let t=n==null?void 0:n.items;if(!!(t==null?void 0:t.length))for(let e=0;e<t.length;++e){if(!t[e].type.startsWith("image/"))continue;let s=t[e].getAsFile();if(s)return s}}function Cp(n,t){let e;if(vt(t)){let u=ps(n.edges,g=>d.distance(g.midpoint,t)),m=u.p1.subtract(u.p2);e=[u,new Z(t.subtract(m),t.add(m))]}else et(t)&&(t=new S(t.c.shift(-t.r),2*t.r,2*t.r)),e=ps(Il(n.edges,t.edges),([u,m])=>d.distance(u.midpoint,m.midpoint));let s=e.map(u=>u.midpoint),i=e.map(u=>u.perpendicularBisector),o=d.distance(s[0],s[1]),r=s[0],a=i[1].at(20),h=i[0].at(o/2),l=i[1].at(20+o/2);return[`M${r.x} ${r.y}C${h.x} ${h.y},${l.x} ${l.y},${a.x} ${a.y}`,i[1].at(12),i[1].angle+Math.PI]}var Et=180/Math.PI,it=Math.PI/180,f={grey:"#cccccc",darkGrey:"#242436",red:"#cd0e66",orange:"#eb4726",yellow:"#fd8c00",lime:"#bfc212",green:"#22ab24",teal:"#009ea6",blue:"#0f82f2",purple:"#6d3bbf"},Fg="M12.5,0H0V25H12.5a12.5,12.5,0,0,0,0-25Z",Ug="M0,0V12.5a12.5,12.5,0,0,0,25,0V0Z",vo=new Map,Rs=class{constructor(t,e){this.source=t;let s=t.linkTypes||[],i=c("g",{class:"link-bar"});t.$el.prepend(i),this.$line=c("path",{},i),this.$handle=c("path",{class:"link-handle",d:"M-6 -8L6 0L-6 8Z"},i);let o;t.$parent.events.listen(i,{down:()=>o=this.target,start:()=>t.$parent.selection.add(t,!0),move:({posn:r})=>this.link(t.$parent.getTileAt(r,s),t.relativePosn(r),!0),end:()=>{var r;this.target||this.link(),(r=this.target)==null||r.highlight(!1),this.redraw(),this.target!==o&&t.$parent.change({changed:[t]})},click:()=>{this.link(),o&&t.$parent.change({changed:[t]})}}),e&&this.link(e),this.redraw()}redraw(t){var r,a,h,l;if(!this.source.path)return;if(!((r=this.target)==null?void 0:r.transformed)&&!t){this.$line.setAttr("d","");let p=this.source.path.edges[1].midpoint.shift(10,0);return this.$handle.setTransform(p)}let e=(l=(h=(a=this.target)==null?void 0:a.transformed)==null?void 0:h.translate(this.source.posn.scale(-1)))==null?void 0:l.rotate(-this.source.rot*it),[s,i,o]=Cp(this.source.path,e||t);this.$line.setAttr("d",s),this.$handle.setTransform(i,o)}change(){var t;(t=this.target)==null||t.link(this)}delete(){this.link(),this.target=void 0,this.source.links.delete(this);for(let t of[this.$line,this.$handle])t.remove()}link(t,e,s){var i,o;t&&t===this.target||(s&&((i=this.target)==null||i.highlight(!1),t==null||t.highlight()),(o=this.target)==null||o.unlink(this),this.target=t,this.redraw(e),t==null||t.link(this))}static serialize(t){if(!!t.links)return Array.from(t.links).filter(e=>e.target).map(e=>e.target.id).join(",")||void 0}static restore(t,e){if(t.links)for(let s of t.links)s.delete();!e||setTimeout(()=>{t.links||(t.links=new Set);for(let s of e.split(",")){let i=t.$parent.tiles.get(s);i&&t.links.add(new Rs(t,i))}})}},k=class{constructor(t,e,s){this.$parent=t;this.options="";this.colour="";this.posn=E;this.rot=0;this.snapAngles=[0,90];this.canDragToSelect=!0;this.canRotate=!0;this.canMove=!0;this.$el=s||c("g",{class:"tile"},t.$tiles[2]),this.id=e||Fe(10),t.tiles.set(this.id,this),vo.set(this.$el._el,this)}makeHandle(t,e,s){let o=c(t==="c"?"circle":"path",{class:"handle"},this.$el);t==="h"&&o.setAttr("d",Fg),t==="v"&&o.setAttr("d",Ug),t==="c"&&o.setAttr("r",10);let r="",a;return this.$parent.events.listen(o,{start:()=>{this.$parent.selection.add(this,!0),r=this.options,a=this.size},move:({posn:h})=>e(this.relativePosn(h),h),click:()=>s==null?void 0:s(),end:()=>{(this.options!==r||this.size!==a)&&this.$parent.change({changed:[this]})}}),o}is(t){return this.type===t}makeLink(){this.links||(this.links=new Set),this.links.add(new Rs(this))}link(t){this.linkSources||(this.linkSources=new Set),this.linkSources.add(t)}unlink(t){var e;(e=this.linkSources)==null||e.delete(t)}setColour(t,e){this.colour=t;for(let s of this.links||[])s.change()}setSize(t){this.size=t}setOrder(t){t!==this.order&&(this.order=t,this.$container.append(this.$el))}lock(t=!0){t!==!!this.locked&&(this.$el.css("pointer-events",t?"none":"all"),this.locked=t,t&&this.$parent.selection.remove(this))}hide(t=!0){t!==!!this.hidden&&(this.$el.toggle(!t),this.hidden=t,t&&this.$parent.selection.remove(this))}flip(t){this.flipped=!this.flipped}click(t){}doubleClick(t){}format(t){}blur(){}get $container(){let t=this.order==="back"?0:this.order==="front"?2:1;return this.$parent.$tiles[t*2+(this.isActive?1:0)]}select(){this.isActive=!0,this.$el.addClass("active"),this.$container.append(this.$el);for(let t of this.links||[])t.redraw()}deselect(){this.isActive=!1,this.$el.removeClass("active"),this.$container.append(this.$el)}watch(t){this.watchCallbacks||(this.watchCallbacks=[]),this.watchCallbacks.push(t),this.$parent.options.watch(t)}moveStart(){this.startPosn=this.posn}move(t,e){t&&(this.posn=this.startPosn.add(t),this.transform(!0))}moveEnd(){this.collision&&this.collide(this.collision)}highlight(t=!0){}findNearby(t,e,s=this.posn){for(let i of this.$parent.tiles.values())if(i!==this&&i.is(t)&&d.distance(s,i.posn)<e)return i}setCollision(t){var e;t&&t===this.collision||((e=this.collision)==null||e.highlight(!1),this.collision=t,t==null||t.highlight(!0))}collide(t){}transform(t=!1){let e=this.rot*it;this.$el.setTransform(this.posn,e),this.customTransform(this.posn,e);for(let s of this.links||[])s.redraw();!t&&this.path&&(this.transformed=this.path.rotate(e).translate(this.posn),this.snapPoints=this.getSnapPoints().map(s=>s.rotate(e).translate(this.posn)),this.snapLines=this.getSnapLines().map(s=>s.rotate(e).translate(this.posn)))}customTransform(t,e){}setTransform(t,e=this.rot){this.posn=t,this.rot=$t(e,360),this.transform()}animateTo(t,e=this.posn,s=400){return this.setTransform(t),z(i=>{i=X("sine",i),this.$el.setTransform(d.interpolate(e,t,i),this.rot*it)},s).promise}static makeThumbnail(t,e,s,i){}getSnapPoints(){return this.path?vt(this.path)?[this.path]:ee(this.path)?this.path.points:wt(this.path)?[this.path.p1,this.path.p2]:et(this.path)?[this.path.c,this.path.c.shift(0,this.path.r),this.path.c.shift(0,-this.path.r),this.path.c.shift(this.path.r,0),this.path.c.shift(-this.path.r,0)]:Ae(this.path)?[this.path.c,this.path.start,this.path.end]:he(this.path)?[this.path.start,this.path.end]:[]:[]}getSnapLines(){return[]}delete(){for(let t of this.watchCallbacks||[])this.$parent.options.unwatch(t);for(let t of this.links||[])t.delete();for(let t of this.linkSources||[])t.delete();this.$parent.selection.remove(this),this.$parent.tiles.delete(this.id),vo.delete(this.$el._el),this.$el.remove()}copy(t={},e=25){let s=new this.constructor(this.options,this.$parent);return this.colour&&s.setColour(this.colour),this.flipped&&s.flip(),s.setTransform(this.posn.shift(e,e),this.rot),this.size&&s.setSize(this.size),s}relativePosn(t){return t.subtract(this.posn).rotate(-this.rot*it)}get center(){return this.path?Ls(this.path).center:E}get ariaDescription(){return`${this.type}: ${this.options}`}static action(t,e,s){}applyChange(t){var e;if(t.options!==this.options){this.delete(),k.unSerialize(t,this.$parent);return}this.setTransform(new d(t.x,t.y),t.rot),t.colour!==this.colour&&this.setColour(t.colour),!t.flipped!=!this.flipped&&this.flip(),!t.locked!=!this.locked&&this.lock(!!t.locked),!t.hidden!=!this.hidden&&this.hide(!!t.hidden),this.fixed=!!t.fixed,t.size&&t.size!==this.size&&this.setSize(t.size),t.order!==this.order&&this.setOrder(t.order),t.links!==((e=this.lastSavedData)==null?void 0:e.links)&&Rs.restore(this,t.links),this.lastSavedData=t}serialize(){return this.lastSavedData={id:this.id,name:this.type,options:this.options,x:this.posn.x,y:this.posn.y,rot:this.rot,size:this.size||void 0,flipped:this.flipped||void 0,locked:this.locked||void 0,fixed:this.fixed||void 0,hidden:this.hidden||void 0,order:this.order,colour:this.colour,links:Rs.serialize(this)}}static unSerialize(t,e,s=!1){if(!(t==null?void 0:t.name))return;let i=e.newTile(t.name,t.options||"",s?void 0:t.id);return t.flipped&&i.flip(),i.setTransform(new d(t.x,t.y),t.rot),t.colour&&i.setColour(t.colour),t.size&&i.setSize(t.size),i.setOrder(t.order||void 0),t.locked&&i.lock(),t.links&&Rs.restore(i,t.links),i.lastSavedData=t,i}};var ce=Dt({});ce.assign(ji);var is=new Map,Xi=new Map,jg=/^_x[0-9]+\.at\([0-9-.e]+\)$/,Zg=/^intersections\(|\.midpoint$|\.centroid$/,bt=class extends k{constructor(t,e,s){super(e,s,c("path",{class:"geo-path"},e.$geoPaths));this.$parent=e;this.type="geo";this.hideSelectionOutline=!0;this.isProjection=!1;this.parentKeys=[];this.deleted=!1;this.onDraw=()=>this.draw();this.$shadow=c("path",{class:"geo-shadow"},e.$geoShadows),this.options=t;let[i,o]=t.split("=");o||(o=i,i=ce.getKey()),this.key=i,is.set(i,this),this.snapPoints=this.snapLines=this.snapAngles=[],this.setExpr(o),ce.watch(this.onDraw),this.setColour(e.penColour)}setExpr(t,e=!1){let s=yt(t);ce.setComputed(this.key,s),!e&&(this.options=`${this.key}=${t}`,this.expr=t,this.setParentKeys(t.match(/_x[0-9]+/g)||[]),this.isProjection=jg.test(t),this.computed=Zg.test(t),this.$el.setClass("intersection",this.computed))}draw(){let t=ce[this.key];if(t===this.path)return;this.path=t,this.$el.toggle(t&&!this.hidden),this.isActive&&!t&&this.$shadow.hide();let e=t==null?void 0:t.type;e!==this.geoType&&(this.$el.setClass("geo-point",e==="point"),this.$el.setClass("geo-path",e!=="point"),(e==="point"?this.$parent.$geoPoints:this.$parent.$geoPaths).append(this.$el),this.geoType=e),!!t&&(e==="point"&&(t=new B(t,this.computed?3.5:6)),this.$el.draw(t,{box:this.$parent.canvasBounds.rect}),this.$shadow.setAttr("d",this.$el.attr("d")),this.transform())}setParentKeys(t){var e;for(let s of this.parentKeys)(e=Xi.get(s))==null||e.delete(this.key);this.parentKeys=t;for(let s of t)Xi.has(s)||Xi.set(s,new Set),Xi.get(s).add(this.key)}get parents(){return this.parentKeys.map(t=>is.get(t)).filter(t=>t)}get children(){let t=Xi.get(this.key);return t?Array.from(t).map(e=>is.get(e)).filter(e=>e):[]}get ariaDescription(){var t;return`${(t=this.path)==null?void 0:t.type} ${this.key}: ${this.expr}`}setOrder(){}select(){var t;this.isActive=!0,this.path&&this.$shadow.show(),(t=this.$el.parent)==null||t.append(this.$el)}deselect(){this.isActive=!1,this.$shadow.hide()}hover(t=!0){this.isActive||!this.path||(t?this.$shadow.show():this.$shadow.hide())}transform(){this.transformed=this.path,this.pending||(this.snapPoints=this.path&&vt(this.path)?[this.path]:[],this.snapLines=!this.path||vt(this.path)?[]:[this.path])}setTransform(){this.transform()}setColour(t){var e,s;this.colour=t,(e=this.$el)==null||e.css("color",R(t)),(s=this.$shadow)==null||s.css("color",R(t))}copy(t={}){if(!this.path)return;if(t[this.key])return t[this.key];let e=this.expr;if(vt(this.path))e=`point(${this.path.x+25},${this.path.y+25})`;else for(let s of this.parents){let i=t[s.key]||s.copy(t);e=e.replace(s.key,i.key)}return t[this.key]=new bt(e,this.$parent)}delete(){this.deleted=!0,super.delete(),ce.unwatch(this.onDraw),ce[this.key]=void 0,is.delete(this.key),this.$shadow.remove();for(let t of this.parents)t.geoType==="point"&&!t.deleted&&!t.parentKeys.length&&!t.children.length&&t.delete();for(let t of this.children)t.delete()}setPending(t=!0){this.pending=t,t||this.transform();for(let e of this.children)e.setPending(t)}moveStart(){if(!(this.computed||!this.path)){if(this.isProjection){if(this.$parent.selection.size>1)return;this.setParentKeys([])}this.setPending(!0);for(let t of this.parents)t.moveStart();this.moveStartValue=this.transformed}}move(t,e){if(!(!t||!this.path||!this.moveStartValue))if(vt(this.path))this.snapTarget=e,this.$el.setClass("intersection",this.computed||!!(e==null?void 0:e.intersection)),ce[this.key]=this.moveStartValue.translate(t);else for(let s of this.parents)s.move(t)}moveEnd(){var t,e,s,i;if(!!this.moveStartValue){for(let o of this.parents)o.moveEnd();if(this.setPending(!1),(t=this.snapTarget)==null?void 0:t.intersection)this.setExpr(this.snapTarget.intersection.expr);else if(((s=(e=this.snapTarget)==null?void 0:e.tile)==null?void 0:s.type)==="geo"){let o=(i=this.snapTarget)==null?void 0:i.tile;if(o.path&&vt(o.path)){for(let r of this.children)r.setExpr(r.expr.replace(this.key,o.key));return this.$parent.selection.add(o),this.delete()}else if(o.path){let r=As(o.path,ce[this.key]);this.setExpr(`${o.key}.at(${r})`)}}else this.path&&vt(this.path)&&(this.expr=`point(${this.path.x},${this.path.y})`,this.options=`${this.key}=${this.expr}`,this.isActive||this.$parent.selection.implicitChanges.add(this))}}applyChange(t){let[e,s]=t.options.split("=");s!==this.expr&&this.setExpr(s),t.colour!==this.colour&&this.setColour(t.colour),!t.locked!=!this.locked&&this.lock(t.locked),this.lastSavedData=t}static get tiles(){return is.values()}static computeIntersections(t){t.intersections.clear();let e=Array.from(is.values()).filter(i=>i.path&&!vt(i.path)),s=e.length;for(let i=0;i<s;++i)for(let o=i+1;o<s;++o){let r=St(e[i].path,e[o].path);for(let[a,h]of r.entries())t.intersections.add({value:h,expr:`intersections(${e[i].key},${e[o].key})[${a}]`})}}static getInferredShape(t){let e=t.filter(h=>h.type==="geo"&&h.path);if(!e.length)return;if(e.length===1)return{type:e[0].path.type,expr:e[0].key,value:e[0].path};let s=e.filter(h=>vt(h.path)),i=e.filter(h=>wt(h.path)||et(h.path));if(i.length===1&&s.length===e.length-1){let h=i[0].path;if(s.every(l=>h.contains(l.path)))return{type:h.type,expr:i[0].key,value:h}}let o=i.filter(h=>wt(h.path));if(s.length+o.length!==e.length)return;for(let h of o)if(Ys(h.path)){let l=h.parentKeys.map(p=>is.get(p));for(let p of l)s.includes(p)||s.push(p)}else if(s.filter(l=>h.path.contains(l.path)).length<2)return;let r=s.map(h=>h.key).join(","),a=s.map(h=>h.path);if(s.length===2){let h=new Z(a[0],a[1]);return{type:"segment",expr:`segment(${r})`,value:h}}return s.length===3?{type:"triangle",expr:`triangle(${r})`,value:new Ai(...a)}:{type:"polygon",expr:`polygon(${r})`,value:new O(...a)}}static construct(t,e,s){if(t=t.replace(/\$0/g,e||""),t.includes("$1"))s.tools.geoPending.enable(t);else{let i=new bt(t,s);s.selection.add(i,!0);let o=vt(i.path)?"pop":"draw";i.$el.enter(o,400),i.$shadow.enter(o,400),bt.computeIntersections(s),s.change({added:[i]})}}static redrawLines(t){for(let e of is.values())e.path&&fr(e.path)&&(e.$el.draw(e.path,{box:t}),e.$shadow.setAttr("d",e.$el.attr("d")))}static clearModel(){ce.clear(),ce.assign(ji)}};var Wg=3,Kg=.15;function Mp(n,t,e,s=!1){let i=t||n,o=e||n,r=Math.atan2(o.y-i.y,o.x-i.x)+(s?Math.PI:0),a=d.distance(i,o)*Kg;return n.shift(Math.cos(r)*a,Math.sin(r)*a)}function Xg(n){return n.length<=2?$e(new be(...n)):n.map((t,e)=>{if(e===0)return`M${t.x.toFixed(2)} ${t.y.toFixed(2)}`;if(d.distance(n[e-1],t)<4)return`L${t.x.toFixed(2)},${t.y.toFixed(2)}`;let s=Mp(n[e-1],n[e-2],t),i=Mp(t,n[e-1],n[e+1],!0);return`C${s.x.toFixed(2)},${s.y.toFixed(2)} ${i.x.toFixed(2)},${i.y.toFixed(2)} ${t.x.toFixed(2)},${t.y.toFixed(2)}`}).join("")}var ns=class{constructor(t,e,s,i,o){this.$parent=t;this.brush=i;this.path="";this.$el=c("path",{class:`stroke ${i}`},t.$strokes),this.setColor(s),this.id=o||Fe(10),t.strokes.set(this.id,this),e.length===1&&e.push(e[0].shift(.01)),this.draw(e)}setColor(t){this.color=t,this.$el.setAttr("stroke",R(t))}addPoint(t){this.segments.push(new Z(I(this.segments).p2,t)),this.path+=`L${t.x},${t.y}`,this.$el.setAttr("d",this.path)}setLine(t){this.segments=[t],this.path=$e(t),this.$el.setAttr("d",this.path)}makeSnapPoints(){this.snapPoints=Cn(...this.segments.map(t=>[t.p1,t.p2])),this.snapLines=this.segments}simplify(){let t=this.segments.map(i=>i.p1);t.push(I(this.segments).p2);let e=[t[0]],s=0;for(let i=2;i<t.length;++i){let o=new Z(I(e),t[i]);t.slice(s+1,i).every(a=>o.contains(a,Wg))||(e.push(t[i-1]),s=i-1)}e.push(I(t)),this.draw(e)}draw(t){this.path=Xg(t),this.segments=new be(...t).edges,this.$el.setAttr("d",this.path)}hitTest(t,e){let s=e**2;return this.segments.some(i=>i.distanceSquared(t)<s)}delete(){this.$parent.strokes.delete(this.id),this.$el.remove()}serialize(t=Infinity){return{points:this.path.slice(0,t),colour:this.color,brush:this.brush,id:this.id}}get lastSavedData(){return this.serialize()}static unSerialize(t,e){let s=vs(t==null?void 0:t.points);if(!s.length)return;let i=new ns(e,s,t.colour||"#000",t.brush||"",t.id);return s.length===2&&i.makeSnapPoints(),i}};var Yg=[[0,0]],Ep=[[0,-39],[0,39]],Jg=[...Ep,[0,0]],yo=[[-18,-39],[18,-39],[-18,39],[18,39]],Qg=[...yo,[0,0]],Vp=[...yo,[-18,0],[18,0]],t1=[...Vp,[0,-19]],Qa=[...yo,[-18,-13],[18,-13],[-18,13],[18,13]],e1=[...Qa,[0,0]],s1=[...Qa,[0,-26],[0,26]],i1={C:"#333",S:"#333",H:f.orange,D:f.orange},n1={A:Yg,2:Ep,3:Jg,4:yo,5:Qg,6:Vp,7:t1,8:Qa,9:e1,10:s1},o1="AH:2H:3H:4H:5H:6H:7H:8H:9H:0H:JH:QH:KH:AC:2C:3C:4C:5C:6C:7C:8C:9C:0C:JC:QC:KC:KD:QD:JD:0D:9D:8D:7D:6D:5D:4D:3D:2D:AD:KS:QS:JS:0S:9S:8S:7S:6S:5S:4S:3S:2S:AS".split(":").map(n=>n+"f").join(":"),r1={A:1,J:11,Q:12,K:13,0:10};function Ap(n,t){n.removeChildren();let[e,s,i]=t.split("");if(t==="deck"||i)return c("rect",{x:-39,y:-57,width:78,height:114,rx:2,fill:"url(#card-bg)"},n);e==="0"&&(e="10"),n.setAttr("fill",i1[s]);let o=`#suit-${s.toLowerCase()}`;if(s==="J")c("image",{href:"/images/polypad/cards/joker.svg",style:"transform: translate(-35px, -53px)",width:70},n),e="Joker";else if(["K","Q","J"].includes(e))c("use",{href:o,style:"transform: translate(-35px, -36px) scale(0.6)",width:24,height:24},n),c("use",{href:o,style:"transform: rotate(180deg) translate(-35px, -36px) scale(0.6)",width:24,height:24},n),c("image",{href:`/images/polypad/cards/${t.toLowerCase()}.svg`,style:"transform: translate(-35px, -53px)",width:70},n);else{let a=e==="A"?" scale(1.7)":"";for(let h of n1[e]||[]){let l=h[1]>0?" rotate(180deg)":"";c("use",{href:o,style:`transform: translate(${h[0]}px, ${h[1]}px)`+l+a,width:24,height:24},n)}}let r={text:e,x:-40,y:-45,style:"font-size: 16px; letter-spacing: -1px;"};c("text",r,n),c("text",me(me({},r),{style:"transform: rotate(180deg)"}),n)}var wi=class extends k{constructor(t,e,s){super(e,s);this.type="card";this.count=0;this.$label=c("g",{class:"outline card-label"},this.$el),this.$labelRect=c("rect",{width:30,height:35,rx:5},this.$label),this.$labelText=c("text",{x:6,y:30},this.$label),this.$stack=c("rect",{class:"polygon-tile",fill:"url(#card-gradient)",rx:10},this.$el),this.$path=c("rect",{class:"polygon-tile",fill:"#eee",rx:10},this.$el),this.$body=c("g",{transform:"scale(1.4)"},this.$el),this.$outline=c("rect",{class:"outline",rx:10},this.$el),this.$path.setRect(new S(new d(-125/2,-175/2),125,175)),this.setOptions(t==="deck"?o1:t)}setOptions(t){if(t===this.options)return;this.options=t;let e=t.split(":");this.count=e.length,this.value=H(e.map(o=>+(r1[o[0]]||o[0])));let s=Math.sqrt(this.count-1)*3;this.path=new S(new d(-125/2,-175/2),125,175+s);for(let o of[this.$stack,this.$outline])o.setRect(this.path);this.transform(),this.$label.setAttr("hidden",this.count<=1?!0:void 0),this.$label.setTransform({x:-125/2,y:175/2-15+s}),this.$labelRect.setAttr("width",46+this.count.toFixed().length*8),this.$labelText.text=`${this.count} cards`;let i=I(e);i!==this.top&&Ap(this.$body,i),this.top=i}setColour(t){super.setColour(t||f.blue)}addCards(t){this.setOptions(this.options+":"+t)}highlight(t=!0){this.$el.setClass("active",t)}move(t){super.move(t),!(this.$parent.selection.tiles.size>1)&&this.setCollision(this.findNearby("card",75))}collide(t){t.highlight(!1),t.addCards(this.options),this.delete();let e=this.lastSavedData?[this]:void 0;this.$parent.change({changed:[t],deleted:e})}doubleClick(){let t=this.draw();t&&this.$parent.change({added:[t],changed:[this]})}flip(){let t=this.options.split(":").reverse();this.setOptions(t.map(e=>e.length>2?e.slice(0,2):e+"f").join(":"))}draw(){if(this.count<=1)return;this.$parent.selection.clear();let t=this.options.split(":"),e=t.pop();this.setOptions(t.join(":"));let s=new wi(e,this.$parent);return s.rot=this.rot,s.animateTo(this.posn.shift(150,0),this.posn),s}shuffle(){this.count<=1||this.setOptions(ct.shuffle(this.options.split(":")).join(":"))}static action(t,e){return P(this,null,function*(){if(t==="stack"){let s=Array.from(e),i=s.map(r=>r.options).join(":"),o=new wi(i,s[0].$parent);o.setTransform(d.average(...s.map(r=>r.posn)));for(let r of e)r.delete();return s[0].$parent.selection.add(o),e[0].$parent.change({added:[o],deleted:e})}else if(t==="flip")for(let s of e)s.flip();else if(t==="draw"){let s=e.map(i=>i.draw()).filter(i=>i);return e[0].$parent.change({added:s,changed:e})}else if(t==="shuffle")for(let s of e)s.shuffle();e[0].$parent.change({changed:e})})}static makeThumbnail(t,e){let s=c("svg",{width:60,height:74},e);c("rect",{x:5,y:2,width:50,height:70,fill:"white",rx:4},s);let i=c("g",{style:"transform: translate(30px, 37px) scale(0.55)"},s);e.onAttr("data-options",o=>Ap(i,o))}};var U=class{constructor(t=0,e=0,s=0){this.x=t;this.y=e;this.z=s}transform(t){if(t instanceof bo&&(t=t.matrix),t.length!=4||t[0].length!=4)throw new Error("Must use a 4x4 matrix for 3D transforms!");let[[e],[s],[i],[o]]=xt.product(t,[[this.x],[this.y],[this.z],[1]]);return new U(e/o,s/o,i/o)}equals(t){return C(this.x,t.x)&&C(this.y,t.y)&&C(this.z,t.z)}fixFloat(){return new U(C(this.x,0)?0:this.x,C(this.y,0)?0:this.y,C(this.z,0)?0:this.z)}add(t){return this.x+=t.x||0,this.y+=t.y||0,this.z+=t.z||0,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}lerp(t,e){return new U(Ct(this.x,t.x||0,e),Ct(this.y,t.y||0,e),Ct(this.z,t.z||0,e))}scale(t){return new U(this.x*t,this.y*t,this.z*t)}get magnitude(){return Math.hypot(this.x,this.y,this.z)}get normalize(){return this.scale(1/this.magnitude)}get asArray(){return[this.x,this.y,this.z]}get inverse(){return new U(-this.x,-this.y,-this.z)}get xy(){return new d(this.x,this.y)}[Symbol.iterator](){return this.asArray.values()}static get zero(){return new U(0,0,0)}static get oneZ(){return new U(0,0,1)}static get one(){return new U(1,1,1)}static all(t){return new U(t,t,t)}static from2D(t){return new U(t.x,t.y,0)}static average(t){return new U(Ks(t.map(e=>e.x)),Ks(t.map(e=>e.y)),Ks(t.map(e=>e.z)))}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static cross(t,e){let s=t.y*e.z-t.z*e.y,i=t.z*e.x-t.x*e.z,o=t.x*e.y-t.y*e.x;return new U(s,i,o)}};var J={translate({x:n,y:t,z:e}){return[[1,0,0,n],[0,1,0,t],[0,0,1,e],[0,0,0,1]]},rotateX(n){let t=Math.cos(n),e=Math.sin(n);return[[1,0,0,0],[0,t,-e,0],[0,e,t,0],[0,0,0,1]]},rotateY(n){let t=Math.cos(n),e=Math.sin(n);return[[t,0,e,0],[0,1,0,0],[-e,0,t,0],[0,0,0,1]]},rotateZ(n){let t=Math.cos(n),e=Math.sin(n);return[[t,-e,0,0],[e,t,0,0],[0,0,1,0],[0,0,0,1]]},rotateAxis({x:n,y:t,z:e},s){let i=Math.hypot(n,t,e);i=1/i,n*=i,t*=i,e*=i;let o=Math.sin(s),r=Math.cos(s),a=1-r;return[[n*n*a+r,n*t*a-e*o,n*e*a+t*o,0],[t*n*a+e*o,t*t*a+r,t*e*a-n*o,0],[e*n*a-t*o,e*t*a+n*o,e*e*a+r,0],[0,0,0,1]]},fromEulerAngles(n,t,e){return xt.product(J.rotateX(n),J.rotateY(t),J.rotateZ(e))},scale({x:n,y:t,z:e}){return[[n,0,0,0],[0,t,0,0],[0,0,e,0],[0,0,0,1]]},scaleAll(n){return[[n,0,0,0],[0,n,0,0],[0,0,n,0],[0,0,0,1]]},perspective(n,t,e,s){let i=e*Math.tan(Math.PI/180*n/2),o=-i,r=i*t,a=-r;return[[2*e/(r-a),0,(r+a)/(r-a),0],[0,2*e/(i-o),(i+o)/(i-o),0],[0,0,-((s+e)/(s-e)),-(2*s*e/(s-e))],[0,0,-1,0]]},transformPoint(n,t){return t instanceof U?t.transform(n):new U(t.x,t.y).transform(n)}},bo=class{constructor(){this.matrix=xt.identity(4)}clear(){return this.matrix=xt.identity(4),this}translate(t=0,e=0,s=0){return this.matrix=xt.product(this.matrix,J.translate({x:t,y:e,z:s})),this}rotate(t=0,e=0,s=0){return this.matrix=xt.product(this.matrix,J.rotateZ(s),J.rotateY(e),J.rotateX(t)),this}scale(t){return this.matrix=xt.product(this.matrix,J.scale(t)),this}dragToRotate(t,e,s=100){let i=new U(t.x,t.y,s**3/(s**2+t.length**2)).normalize,o=new U(e.x,e.y,s**3/(s**2+e.length**2)).normalize,r=M(U.dot(i,o),-1,1),a=U.cross(i,o),h=J.rotateAxis(a,2*Math.acos(r));return this.matrix=xt.product(h,this.matrix),this}isRotationMatrix(){if(!C(xt.determinant(this.matrix),1))return!1;let t=xt.transpose(this.matrix);return xt.product(this.matrix,t).every((s,i)=>s.every((o,r)=>C(o,i===r?1:0)))}toEulerAngles(){let t=this.matrix,e=Math.sqrt(t[0][0]*t[0][0]+t[1][0]*t[1][0]);if(C(e,0)){let a=Math.atan2(-t[1][2],t[1][1]),h=Math.atan2(-t[2][0],e);return[a,h,0]}let i=Math.atan2(t[2][1],t[2][2]),o=Math.atan2(-t[2][0],e),r=Math.atan2(t[1][0],t[0][0]);return[i,o,r]}};var a1=new G(0,0,0);function h1(n){let t=n.r,e=n.c.x,s=n.c.y,i=.5523*t;return`M${e} ${s-t}C${e+i} ${s-t} ${e+t} ${s-i} ${e+t} ${s}C${e+t} ${s+i} ${e+i} ${s+t} ${e} ${s+t}C${e-i} ${s+t} ${e-t} ${s+i} ${e-t} ${s}C${e-t} ${s-i} ${e-i} ${s-t} ${e} ${s-t}`}var th=class{constructor(){this.transform=new bo;this.visible=!0}getTransformed(t){let e=this;do t=t.transform(e.transform);while(e=e.parent);return t}get normal(){return this.getTransformed(U.oneZ).add(this.getTransformed(U.zero).inverse).normalize}project(t,e={fov:120}){if(e.fov===!1)return new d(t.x,t.y);let s=Math.exp(t.z/e.fov);return new d(t.x*s,t.y*s)}*getProjectedVertices(t){for(let e of this.getVertices())yield this.project(e,t)}},ne=class extends th{constructor(t,e={},s){super();this.children=[];this.sorting=!1;this.$el=c("g",e,s);for(let i of t)this.addChild(i)}addChild(t){return t.parent&&t.parent.removeChild(t),this.children.push(t),this.$el&&t.$el&&this.$el.append(t.$el),t.parent=this,t}removeChild(t){let e=this.children.indexOf(t);e>=0&&this.children.splice(e,1),t.$el&&t.$el.remove(),t.parent=void 0}render(t){if(!!this.visible){if(this.sorting)for(let e of cs(this.children,s=>s.zIndex))this.$el.append(e.$el);for(let e of this.children)e.render(t)}}*getFaces(){for(let t of this.children)for(let e of t.getFaces())yield e}*getVertices(){for(let t of this.children)for(let e of t.getVertices())yield e}get zIndex(){return Ks(this.children.map(t=>t.zIndex))}},Xt=class extends th{constructor(t,e={},s){super();this.shape=t;if(t==null)this.commands=[];else if(typeof t=="string")this.commands=_n(t);else{let o=et(t)?h1(t):$e(t);this.commands=_n(o)}let i=d.average(...this.commands.filter(o=>o.points.length).map(o=>d.average(...o.points)));this.centroid=new U(i.x,i.y,0),s&&(this.color=s),this.$el=c("path",e)}render(t){if(!this.visible)return;if(t==null?void 0:t.hideBackface){let s=this.getTransformed(U.zero).z>0;if(this.$el.toggle(s),!s)return}if(this.color){let s=G.mix(this.color,a1,(Math.abs(this.normal.z)+1)/2);this.$el.setAttr("fill",s),this.$el.setAttr("stroke",s)}let e=this.commands.map(s=>{let i=s.points.map(o=>{let r=this.project(this.getTransformed(new U(o.x,o.y)),t);return`${r.x},${r.y}`});return s.type+i.join(",")}).join("");this.$el.setAttr("d",e)}get zIndex(){return this.getTransformed(this.centroid).z}*getFaces(){yield this}*getVertices(){if(!(typeof this.shape=="string"||!ee(this.shape)))for(let t of this.commands)for(let e of t.points)yield this.getTransformed(new U(e.x,e.y))}};var Y=O.regular(3),vi=O.regular(4),oe=O.regular(5),$o={shape:Y,children:[{shape:Y,dihedral:70.53,rot:180},{shape:Y,dihedral:70.53,parentEdge:1,rot:300},{shape:Y,dihedral:70.53,parentEdge:2,rot:60}]},xo={shape:vi,children:[{shape:vi,dihedral:90,myEdge:2,children:[{shape:vi,dihedral:90,myEdge:2}]},{shape:vi,dihedral:90,parentEdge:1,rot:270},{shape:vi,dihedral:90,parentEdge:2},{shape:vi,dihedral:90,parentEdge:3,rot:90}]},Po={shape:Y,children:[{shape:Y,dihedral:109.47,rot:180},{shape:Y,dihedral:109.47,parentEdge:1,rot:300,children:[{shape:Y,dihedral:109.47,parentEdge:1,rot:300}]},{shape:Y,dihedral:109.47,parentEdge:2,rot:60,children:[{shape:Y,dihedral:109.47,parentEdge:1,rot:300},{shape:Y,dihedral:109.47,parentEdge:2,rot:60,children:[{shape:Y,dihedral:109.47,parentEdge:1,rot:300}]}]}]},So={shape:oe,children:[{shape:oe,dihedral:116.57,rot:180},{shape:oe,dihedral:116.57,parentEdge:1,rot:252},{shape:oe,dihedral:116.57,parentEdge:2,rot:324},{shape:oe,dihedral:116.57,parentEdge:3,rot:36},{shape:oe,dihedral:116.57,parentEdge:4,rot:108,children:[{shape:oe,dihedral:116.57,parentEdge:2,rot:324,children:[{shape:oe,dihedral:116.57,parentEdge:3,rot:36,children:[{shape:oe,dihedral:116.57,parentEdge:1,rot:252},{shape:oe,dihedral:116.57,parentEdge:2,rot:324},{shape:oe,dihedral:116.57,parentEdge:3,rot:36},{shape:oe,dihedral:116.57,parentEdge:4,rot:108}]}]}]}]},To={shape:Y,children:[{shape:Y,dihedral:138.19,rot:180},{shape:Y,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:Y,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:Y,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:Y,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:Y,dihedral:138.19,parentEdge:1,rot:300}]},{shape:Y,dihedral:138.19,parentEdge:2,rot:60}]},{shape:Y,dihedral:138.19,parentEdge:1,rot:300}]},{shape:Y,dihedral:138.19,parentEdge:2,rot:60}]},{shape:Y,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:Y,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:Y,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:Y,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:Y,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:Y,dihedral:138.19,parentEdge:1,rot:300}]},{shape:Y,dihedral:138.19,parentEdge:2,rot:60}]},{shape:Y,dihedral:138.19,parentEdge:1,rot:300}]},{shape:Y,dihedral:138.19,parentEdge:2,rot:60}]},{shape:Y,dihedral:138.19,parentEdge:1,rot:300}]}]};function kp(n,t,e){let s=O.regular(n).scale(t*qt(n)),i=new S(E,t,e).polygon,o=[{shape:s,rot:180,parentEdge:2}],r=_(a=>({shape:i,parentEdge:a,rot:360/n*a,children:a?void 0:o}),n);return{shape:s,children:r}}function Op(n,t,e){let s=O.regular(n).scale(t*qt(n)),i=new O(new d(-t/2,0),new d(t/2,0),new d(0,-e)),o=Et*Math.acos(t/e/2/Math.tan(Math.PI/n)),r=_(a=>({shape:i,dihedral:o,parentEdge:a,rot:180+360/n*a}),n);return{shape:s,children:r}}var l1=xt.identity(4);function Lp(n,t,e,s){var g;let i=t.shape.edges[n.parentEdge||0],o=n.shape.edges[n.myEdge||0],r=(n.dihedral||90)/Et,a=s(n);e.addChild(a);let h=U.from2D(i.midpoint),l=U.from2D(o.midpoint),p=U.from2D(i.unitVector),u=n.rot?n.rot*it:0,m=((g=n.children)==null?void 0:g.map(b=>Lp(b,n,e,s)))||[];return[a,h,l,p,u,r,m]}function Yi(n,t,e=1){var r;let s=t(n),i=new ne([s]);i.sorting=!0;let o=((r=n.children)==null?void 0:r.map(a=>Lp(a,n,i,t)))||[];return eh(o,i,e),{group:new ne([i]),foldTree:o}}function Rp(n,t,e=l1){let[s,i,o,r,a,h,l]=n,p=Ct(Math.PI,h,t),u=J.rotateAxis(r,Math.PI-p);a&&(u=xt.product(u,J.rotateZ(a)));let m=o.transform(u),g=J.translate(m.inverse.add(i));s.transform.matrix=xt.product(e,g,u);for(let b of l||[])Rp(b,t,s.transform.matrix)}function eh(n,t,e){t.transform.clear();for(let o of n)Rp(o,e);let s=Array.from(t.getFaces()).map(o=>o.getTransformed(o.centroid)),i=U.average(s).inverse;t.transform.translate(i.x,i.y,i.z)}function c1(n,t,e){let s=Math.cos(n),i=Math.cos(t),o=Math.cos(e),r=Math.sin(t),a=Math.acos((o-s*i)/(Math.sin(n)*r)),h=Math.acos((s-i*o)/(r*Math.sin(e)));return[a,h]}function Ip(n,t){return Math.asin(Math.cos(n*t)/Math.cos(n/2))}var d1=[60,90,108],p1=[{internal:[60,90,90,90],dihedral:[144.74,135,135,135]},{internal:[60,60,60,60,90],dihedral:[153.23,153.23,153.23,142.98,142.98]},{internal:[60,90,108,90],dihedral:[159.09,148.28,148.28,159.09]},{internal:[60,60,60,60,108],dihedral:[164.18,164.18,152.93,152.93,152.93]}];function u1(...n){let t=n.length;if(t===3)return c1(n[0],n[1],n[2]);let e=n.map(i=>Math.round(i*Et));if((t===4||t===5)&&e.includes(60)&&e.every(i=>d1.includes(i))){for(let i of p1)if(i.internal.length===t){for(let o=0;o<n.length;++o)if(e.every((r,a)=>r===i.internal[(a+o)%t]))return sr(i.dihedral,o).slice(0,t-1).map(r=>r*it)}}if(t===4&&e.filter(i=>i===60).length===3){let i=e.findIndex(l=>l!==60),o=(Math.PI-n[i])/4,r=Math.acos(-1/Math.sqrt(3)*Math.tan(o)),a=Math.acos(1-2/3*((3-Math.tan(o)**2)/4+(Math.sin(3*o)/Math.sin(2*o))**2));return sr([r,a,a,r],4-i).slice(0,t-1)}let s=Math.PI/H(n);return _(i=>{let o=Ip(n[i],s),r=Ip(n[i+1],s);return o+r},n.length-1)}var sh=(n,t)=>$t(n+1,t.size),ih=(n,t)=>$t(n-1,t.size);function f1(n,t){let e=n.polygon.points[ih(t,n)],s=n.polygon.points[t],i=n.polygon.points[sh(t,n)];return new Pt(i,s,e).sup.rad}function m1(n){let t=n.find(a=>a.neighbours.filter(h=>h).length===1),e=ih(t.neighbours.findIndex(a=>a),t),s=[],i=t,o=e;do{let a=[];for(;a.push({face:i,vertex:o}),!!i.neighbours[o];){let h=i;i=i.neighbours[o],o=sh(i.neighbours.indexOf(h),i)}o=sh(o,i),s.push(a)}while(i!==t||o!==e);let r=new ir(s);for(;;){let a=Math.max(3,...r.array.map(p=>p.val.length)),h=r.array.filter(p=>p.val.length>=a);if(!h.length)break;let l=new Set;for(let p of h){if(l.has(p))continue;let u=p.val.map(g=>f1(g.face,g.vertex)),m=u1(...u);for(let[g,b]of m.entries()){let w=p.val[g],y=p.val[g+1],$=w.vertex,x=ih(y.vertex,y.face);w.face.dihedral[$]=y.face.dihedral[x]=Math.max(b,w.face.dihedral[$]||0,y.face.dihedral[x]||0)}p.prev.val.push(...p.next.val),l.add(p.next),r.delete(p.next),r.delete(p)}}}function Np(n,t){return Math.max(...n.neighbours.map(e=>!e||e===t?0:Np(e,n)))+1}function Dp(n,t){return n.visited?!0:(n.visited=!0,n.neighbours.filter(e=>e&&e!==t).some(e=>Dp(e,n)))}function Gp(n,t,e,s){let i=n.neighbours.map((o,r)=>{if(!(!o||o===e))return Gp(o,t,n,n.dihedral[r])}).filter(o=>o);return{shape:ut(n.polygon.points.map(o=>o.subtract(t))),color:n.tile.colour,children:i.length?i:void 0,dihedral:s?+(s*Et).toFixed(2):void 0,parentEdge:e?e.neighbours.indexOf(n):void 0,myEdge:e?n.neighbours.indexOf(e):void 0}}function g1(n){let t=n.map(e=>{let s=e.transformed.oriented,i=s.points.length;return{tile:e,polygon:s,size:i,neighbours:Nt(void 0,i),dihedral:Nt(void 0,i),edges:s.edges,center:s.centroid,radius:s.radius}});if(!t.some(e=>e.size<3)){for(let[e,s]of t.entries())for(let[i,o]of t.entries())if(!(e>=i)&&!(s.radius+o.radius<d.distance(s.center,o.center)-2)){for(let[r,a]of s.edges.entries())for(let[h,l]of o.edges.entries())if(a.equals(l,2)){if(s.neighbours[r]||o.neighbours[h])return;s.joined=o.joined=!0,s.neighbours[r]=o,o.neighbours[h]=s}}if(!t.some(e=>!e.joined)&&!Dp(t[0]))return t}}function Hp(n){let t=g1(n);if(!t)return;m1(t);let e=ps(t,i=>Np(i)),s=e.polygon.centroid;return[s,Gp(e,s)]}function qp(n){var e;let t=((e=n.c||n.children)==null?void 0:e.map(s=>qp(s)))||[];return{shape:yi(n.shape||n.s),color:n.color||n.a,children:t,dihedral:n.dihedral||n.d,parentEdge:n.parentEdge||n.p,myEdge:n.myEdge||n.m,rot:n.rot||n.r}}function _p(n){var e;let t=(e=n.children)==null?void 0:e.map(s=>_p(s));return(t==null?void 0:t.length)||(t=void 0),{s:ut(n.shape.points),a:n.color,children:t,d:n.dihedral,p:n.parentEdge,m:n.myEdge,r:n.rot}}function w1(n){try{let{net:t,angle:e,rotation:s}=JSON.parse(n.replace(/([a-z]):/g,'"$1":')),i;return typeof t=="string"?(i=`"${t}"`,t=Qi[t].net||Qi.Cube.net):(t=qp(t),i=JSON.stringify(_p(t)).replace(/"([a-z])":/g,"$1:")),{net:t,serialized:i,angle:e,rotation:s}}catch(t){return{net:Qi.Cube.net,serialized:'"Cube"',angle:1}}}function bi(n,t=1){var s;let e=(s=n.children)==null?void 0:s.map(i=>bi(i,t));return Object.assign({},n,{children:e,shape:n.shape.scale(t)})}var Qi={Tetrahedron:{net:bi($o,qt(3)*50),scale:1.1},Cube:{net:bi(xo,qt(4)*50),scale:.8},Octahedron:{net:bi(Po,qt(3)*50),scale:.95},Dodecahedron:{net:bi(So,qt(5)*50),scale:.42},Icosahedron:{net:bi(To,qt(3)*50),scale:.67},Pyramid:{net:Op(6,50,100),scale:.57},Prism:{net:kp(6,50,100),scale:.45}},Is={fov:400},Bp=[1.066,.243,-.088],Ns=class extends k{constructor(t,e,s){super(e,s);this.type="polyhedron";this.canRotate=!1;this.options=t,t in Qi&&(t=`{"net":"${t}","angle":1,"rotation":${JSON.stringify(Bp)}}`);let i=w1(t);this.net=i.net,this.serialized=i.serialized;let o=Yi(this.net,r=>new Xt(r.shape,{class:"polygon-tile"},r.color||Ji(r.shape.points.length)));this.solid=o.group,this.foldTree=o.foldTree,this.$el.append(this.solid.$el),this.$outline=c("path",{class:"outline"},this.$el),this.$moveBar=c("path",{d:"M0 0h30",class:"handle"},this.$el),this.$moveHandle=c("path",{d:"M0 0h14v14h-14Z",class:"handle",style:"cursor: grab"},this.$el),this.solid.$el.css("cursor","move"),this.setRotation(i.rotation||[0,0,0]),this.hinge(i.angle||0),this.solid.render(Is),this.updateOutline(),e.events.listen(this.solid.$el,{start:()=>{e.selection.add(this,!0),this.$el.removeClass("active")},move:({posn:r,lastPosn:a})=>{this.solid.transform.dragToRotate(a.subtract(this.posn),r.subtract(this.posn),100),this.solid.render(Is)},end:()=>{this.rotation=this.solid.transform.toEulerAngles(),this.updateOutline(),this.updateOptions(),e.change({changed:[this]}),this.$el.addClass("active")},click:r=>e.tools.move.down(r),checkIfActive:()=>this.angle>0})}updateOutline(){let t=this.solid.getProjectedVertices(Is);this.path=O.convexHull(...t),this.$outline.draw(this.path),this.transform(),this.$moveBar.translate(this.path.points[0].x-30,this.path.points[0].y),this.$moveHandle.translate(this.path.points[0].x-45,this.path.points[0].y-7)}setRotation(t){this.rotation=t,this.solid.transform.clear().rotate(...t)}updateOptions(){let t=JSON.stringify(this.rotation.map(e=>+e.toFixed(4)));this.options=`{"net":${this.serialized},"angle":${this.angle},"rotation":${t}}`}animateHinges(t,e=!1,s=800){let i=e?this.rotation:[0,0,0],o=this.angle;return z(r=>{this.hinge(Ct(o,t,r)),e&&this.setRotation(i.map(a=>a*(1-r))),this.solid.render(Is)},s)}hinge(t){this.angle=M(t,0,1);let e=this.solid.transform.matrix;this.solid.transform.clear(),eh(this.foldTree,this.solid.children[0],-this.angle),this.solid.transform.matrix=e}hingeStart(){this.startRotation=this.rotation,this.startAngle=this.angle,this.$el.removeClass("active")}hingeMove(t){if(!C(t,this.angle)){if(this.hinge(t),this.startRotation&&this.startAngle){let e=M(t/this.startAngle,0,1);this.setRotation(this.startRotation.map(s=>e*s))}this.solid.render(Is)}}hingeEnd(){this.updateOutline(),this.$el.addClass("active"),this.updateOptions()}setColour(t){super.setColour(t);for(let e of this.solid.getFaces())e.color=t;this.solid.render(Is)}static fold(t){let e=Hp(t);if(!e){si("polyhedron-error");return}let s=JSON.stringify({net:e[1],angle:1}),i=new Ns(s,t[0].$parent);i.hinge(0);let o=i.solid.children[0].transform.matrix;i.setTransform(e[0].shift(-o[0][3],-o[1][3])),i.animateHinges(1).promise.then(()=>i.updateOutline());for(let a of t)a.delete();return i}unfold(){return P(this,null,function*(){this.$parent.selection.remove(this),this.angle>0&&(yield this.animateHinges(0,!0).promise);let t=Array.from(this.solid.getFaces()).map(e=>{let s=Array.from(e.getProjectedVertices()),i=new j(ut(s),this.$parent);return i.setColour(this.colour||e.color||Ji(s.length)),i.setTransform(this.posn),i});return this.delete(),t})}static action(t,e){return P(this,null,function*(){if(t==="unfold"){let s=Ut(yield Promise.all(e.map(i=>i.unfold())));e[0].$parent.change({added:s,deleted:e})}})}static makeThumbnail(t,e){let s=c("svg",{width:70,height:70},e),i=c("g",{transform:"translate(35, 35)"},s),{net:o,scale:r}=Qi[t],a=Yi(o,h=>new Xt(h.shape,{class:"polygon-tile"},Ji(h.shape.points.length)),-1).group;a.transform.clear().rotate(...Bp).scale({x:r,y:r,z:r}),i.append(a.$el),a.render(Is)}};function qt(n){let t=Math.cos(2*Math.PI/n);return 1/Math.sqrt(2-2*t)}var nh=n=>$t(Math.round(n.angle*Et),180),ut=n=>n.map(t=>`${kt(t.x,2)} ${kt(t.y,2)}`).join(",");function Co(n,t){let e=new d(-n/2,-t/2);return ut(new S(e,n,t).points)}var D=50,nt=Math.sqrt(3)/4*D,oh=new dt(E,new d(0,1)),zp={"equ-triangle":new O(new d(-D/2,nt),new d(D/2,nt),new d(0,-nt)),square:O.regular(4,D*qt(4)),"reg-pentagon":O.regular(5,D*qt(5)),"reg-hexagon":O.regular(6,D*qt(6)),"reg-heptagon":O.regular(7,D*qt(7)),"reg-octagon":O.regular(8,D*qt(8)),"reg-decagon":O.regular(10,D*qt(10)),"reg-dodecagon":O.regular(12,D*qt(12)),rectangle:new S(new d(-D,-D/2),2*D,D).polygon,trapezium:new O(new d(-D,nt),new d(D,nt),new d(D/2,-nt),new d(-D/2,-nt)),rhombus:new O(new d(-D*3/4,nt),new d(D/4,nt),new d(D*3/4,-nt),new d(-D/4,-nt)),"right-triangle":new O(new d(-D/2,-D/2),new d(D/2,-D/2),new d(-D/2,D/2)),"rhombus-2":new O(new d(D/2-nt,D/4),new d(-nt-D/2,D/4),new d(nt-D/2,-D/4),new d(nt+D/2,-D/4)),chevron:new O(new d(-.75*D,2*nt),new d(.25*D,2*nt),new d(.75*D,0),new d(.25*D,-2*nt),new d(-.75*D,-2*nt),new d(-.25*D,0)),"right-triangle-2":new O(new d(-2*nt,-D/2),new d(-2*nt,D/2),new d(2*nt,-D/2)),kite:new O(new d(0,-D),new d(2*nt,-D/2),new d(0,D),new d(-2*nt,-D/2)),dart:new O(new d(2*nt,.75*D),new d(0,-.75*D),new d(-2*nt,.75*D),new d(0,.25*D))},rh=["","","",f.yellow,f.blue,f.green,f.red,f.teal,f.purple,"",f.lime,"",f.orange],Fp={trapezium:f.red,"right-triangle":f.green,"rhombus-2":f.orange,chevron:f.orange,kite:f.purple,dart:f.teal},Up={"equ-triangle":f.green,square:f.yellow,"reg-pentagon":f.blue,"reg-hexagon":"#ffd615","reg-decagon":f.red,rectangle:f.yellow,trapezium:"#cc1030",rhombus:f.blue,"rhombus-2":"#e6e2c6",chevron:"#cc1030","right-triangle-2":"#ffd615",kite:"#134791",dart:f.purple};function Ji(n){return rh[n%rh.length]||f.yellow}function yi(n){if(n in zp)return zp[n];if(n.match(/^[0-9.,\-\s]+$/)){let t=n.split(",").map(e=>new d(...e.split(" ").map(s=>+s)));return new O(...t)}throw new Error("Unknown polygon type.")}var v1=["trapezium","rhombus","rhombus-2","rectangle","right-triangle","right-triangle-2"],y1=["equ-triangle","square","reg-pentagon","reg-hexagon","reg-heptagon","reg-octagon","reg-decagon","reg-dodecagon","rectangle","trapezium","kite","dart"],j=class extends k{constructor(t,e,s){super(e,s);this.type="polygon";this.options=t,this.path=yi(t),this.snapAngles=Wt(this.path.edges.map(nh)),this.symmetric=y1.includes(t);let i=e.options.altColors?Up:Fp;this.colour=i[t]||Ji(this.path.points.length);let o=S.aroundPoints(this.path.points),r=new d(o.center.x,o.p.y);this.showSelectionOutline=d.distance(r,this.path.project(r))>5;let a={class:"polygon-tile",path:this.path,fill:this.colour};this.$path=c("path",a,this.$el),this.$outline=c("path",{class:"outline",path:this.path},this.$el)}static makeThumbnail(t,e,s,i){let o=v1.includes(t)?30:40,r=yi(t),a=Math.max(...r.points.map(p=>p.length));r=r.scale(36/a).shift(40,o);let h=c("svg",{width:80,height:2*o},e),l=c("path",{class:"polygon-tile",path:r},h);s.options.watch(p=>{let u=p.altColors?Up:Fp,m=i||u[t]||rh[r.points.length];l.setAttr("fill",m)})}setColour(t){super.setColour(t),this.$path.setAttr("fill",R(this.colour))}flip(t){t&&(this.posn=new d(2*t.x-this.posn.x,this.posn.y)),this.rot=-this.rot,this.flipped=!this.flipped,this.symmetric||(this.path=this.path.reflect(oh),this.$path.draw(this.path),this.$outline.draw(this.path)),this.transform()}static action(t,e,s){if(t==="flip"){for(let i of e)i.flip(s);e[0].$parent.selection.update(),e[0].$parent.change({changed:e})}else if(t==="join"){let i=e.map(h=>h.transformed),o=O.union(...i),r=e[0].colour,a=o.map(h=>new j(ut(h.points),e[0].$parent));for(let h of a)h.transform(),h.setColour(r);for(let h of e)h.delete();e[0].$parent.selection.select(a,!0),e[0].$parent.change({added:a,deleted:e})}else if(t==="fold"){let i=Ns.fold(e);i&&e[0].$parent.change({added:[i],deleted:e})}}};var b1=[[0,-.2],[1.2,-1],[.6,1],[-.6,1],[-1.2,-.2]],jp=b1.map(n=>new d(n[0]*50,n[1]*50)),ah=class extends j{constructor(t,e,s){super(t||ut(jp),e,s);this.type="custom-polygon";this.$handles=[];this.showSelectionOutline=!0;for(let[o,r]of this.path.points.entries())this.makeVertex(r,o);this.updatePath();let i;this.$parent.events.listen(this.$outline,{down:({posn:o})=>{o=this.relativePosn(o);let r=this.path.edges.findIndex(a=>o.distanceFromLine(a)<5);i=this.makeVertex(o,(r+1)%this.$handles.length),this.updatePath()},move:({posn:o})=>{i&&this.moveVertex(i,o)},end:()=>{i&&this.$parent.change({changed:[this]})}}),this.$outline.css("cursor","crosshair")}makeVertex(t,e){if(this.$handles.length>=24)return;let s=this.makeHandle("c",(i,o)=>this.moveVertex(s,o),()=>this.deleteVertex(s));return s.setCenter(t),s.setAttr("r",8),s.css("cursor","move"),this.$handles.splice(e,0,s),s}deleteVertex(t){t.remove(),this.$handles.splice(this.$handles.indexOf(t),1),this.updatePath()}moveVertex(t,e){var i;let s=(i=this.$parent.snap([e]))==null?void 0:i.shift;t.setCenter(this.relativePosn(s?e.add(s):e)),this.updatePath()}updatePath(){let t=this.$handles.map(e=>e.center);this.path=new O(...t),this.$path.draw(this.path),this.$outline.draw(this.path),this.transform(),this.snapAngles=Wt(this.path.edges.map(nh)),this.options=ut(t),this.$parent.selection.update()}flip(t){t&&(this.posn=new d(2*t.x-this.posn.x,this.posn.y)),this.rot=-this.rot,this.transform();for(let e of this.$handles)e.setCenter(e.center.reflect(oh));this.updatePath()}lock(){let t=new j(this.options,this.$parent);return t.setColour(this.colour),t.setTransform(this.posn,this.rot),this.$parent.selection.add(t),this.delete(),t}static makeThumbnail(t,e){let s=new O(...jp).scale(.5).shift(40),i=c("svg",{width:80,height:80},e);c("path",{class:"polygon-tile",path:s,fill:f.green},i);for(let o of s.points)c("circle",{cx:o.x,cy:o.y,r:3,fill:"white"},i)}static action(t,e){if(t==="lock"){let s=[];for(let i of Array.from(e))s.push(i.lock());e[0].$parent.change({added:s,deleted:e})}}};var hh=25/2,Zp=[[[0,2],[0,-4],[-2,-4],[-2,4],[2,4],[2,2],[0,2]],[[0,0],[0,-4],[-2,-4],[-2,2],[0,2],[0,4],[2,4],[2,0],[0,0]],[[-5,-1],[5,-1],[5,1],[-5,1]],[[-3,-2],[-3,2],[1,2],[1,0],[3,0],[3,-2],[-3,-2]],[[3,-2],[3,0],[1,0],[1,-2],[-1,-2],[-1,2],[5,2],[5,-2],[3,-2]],[[-1,-3],[-1,-1],[-3,-1],[-3,3],[-1,3],[-1,1],[1,1],[1,-1],[3,-1],[3,-3],[-1,-3]],[[1,1],[1,-3],[-1,-3],[-1,1],[-3,1],[-3,3],[3,3],[3,1],[1,1]],[[1,-1],[1,-3],[-1,-3],[-1,-1],[-3,-1],[-3,1],[-1,1],[-1,3],[1,3],[1,1],[3,1],[3,-1],[1,-1]],[[-1,-3],[-1,-1],[-3,-1],[-3,1],[-1,1],[-1,3],[1,3],[1,-1],[3,-1],[3,-3],[-1,-3]],[[-4,-2],[-4,0],[-2,0],[-2,2],[0,2],[0,0],[4,0],[4,-2],[-4,-2]],[[-1,-3],[-1,1],[-3,1],[-3,3],[1,3],[1,-1],[3,-1],[3,-3],[-1,-3]],[[-1,-3],[-1,1],[-5,1],[-5,3],[1,3],[1,-3],[-1,-3]],[[-1,2],[1,2],[1,0],[3,0],[3,-2],[-3,-2],[-3,0],[-1,0]],[[-3,2],[-3,0],[-1,0],[-1,-2],[3,-2],[3,0],[1,0],[1,2]],[[-3,2],[-3,-2],[3,-2],[3,0],[-1,0],[-1,2]],[[-2,2],[2,2],[2,-2],[-2,-2]],[[-4,1],[4,1],[4,-1],[-4,-1]]].map(n=>n.map(t=>new d(t[0]*hh,t[1]*hh))),$1=[[2,4],[4,4],[5,9],[7,2],[7,6],[11,3],[13,7],[15,3],[17,7],[20,2],[21,5],[23,7],[3,2],[7,2],[5,6],[10,4],[8,7]],Wp=[...G.rainbow(12).map(n=>n.hex),f.red,f.blue,f.green,f.yellow,f.purple],lh=class extends j{constructor(t,e,s){super(ut(Zp[+t]),e,s);this.type="pentomino";this.options=t,this.setColour(Wp[+t])}static makeThumbnail(t,e){let s=$1[+t],i=new O(...Zp[+t]).scale(10/hh);e.draw(i.shift(10*s[0],10*s[1]).shift(1,1)),e.setAttr("fill",Wp[+t])}};var Kp=[[[-4,-2],[0,2],[4,-2]],[[-4,-2],[0,2],[4,-2]],[[-2,0],[0,-2],[2,0],[0,2]],[[-3,1],[1,1],[3,-1],[-1,-1]],[[0,-1],[2,1],[-2,1]],[[0,-1],[2,1],[-2,1]],[[-2,-2],[2,-2],[2,2]]],Xp=[f.red,f.blue,f.green,f.yellow,f.orange,f.teal,f.purple],x1=[[2,4],[4,2],[6,4],[3,7],[7,2],[4,5],[6,6]],Yp=[-90,0,0,0,-90,0,90],P1=25,ch=class extends j{constructor(t,e,s){super(ut(Kp[+t].map(i=>new d(...i).scale(P1))),e,s);this.type="tangram";this.snapAngles=[0,45,90,135];this.options=t,this.setColour(Xp[+t]),this.rot=Yp[+t],this.transform()}static makeThumbnail(t,e,s,i){let o=x1[+t],r=Kp[+t].map(h=>new d(...h).rotate(Yp[+t]*it).shift(...o).scale(18).shift(2,2)),a=new O(...r);e.draw(a),e.setAttr("fill",i||Xp[+t])}getSnapLines(){return this.path.edges}};var Jp=25,tn=(1+Math.sqrt(5))/2*Jp,Mo=Math.sqrt((5+Math.sqrt(5))/2)*Jp,en=tn*(Math.sqrt(5)-1)/2,Qp=[`0 ${-tn},${Mo} ${-en},0 ${tn},${-Mo} ${-en}`,`0 ${2*en-tn},${Mo} ${en},0 ${-tn},${-Mo} ${en}`],tu=[["M29.4-30.9C25.3-18.2,13.4-9.5,0-9.5c-13.4,0-25.3-8.6-29.4-21.4","M29.4,0C20.8-6.2,10.6-9.5,0-9.5c-10.6,0-20.8,3.3-29.4,9.5"],["M18.2,15.5C20.1,9.6,19,3.3,15.5-1.7C11.9-6.6,6.1-9.5,0-9.5c-6.1,0-11.9,2.9-15.5,7.9c-3.6,4.9-4.6,11.3-2.7,17.1","M18.2-15.5C12.9-11.6,6.5-9.5,0-9.5c-6.5,0-12.9-2.1-18.2-5.9"]],eu=[f.red,f.blue],dh=class extends j{constructor(t,e,s){super(Qp[+t],e,s);this.type="penrose";this.setColour(eu[+t]),this.options=t;let i=c("g",{class:"penrose-circles"});this.$path.insertAfter(i);for(let o of tu[+t])c("path",{d:o},i)}static makeThumbnail(t,e,s,i){let o=+t,r=c("svg",{width:80,height:80,viewBox:"-50 -50 100 100"},e),a=i||eu[o];c("polygon",{points:Qp[o],class:"polygon-tile",fill:a},r);let h=c("g",{class:"penrose-circles"},r);for(let l of tu[o])c("path",{d:l},h)}};var su=["M13.9-13.9,2.8-25H-2.8L-25-2.8V2.8L-2.8,25H2.8L13.9,13.9C21.6,6.6,21.6-6.6,13.9-13.9Zm-2.8,25L0,22.2-22.2,0,0-22.2,11.1-11.1A15.8,15.8,0,0,1,11.1,11.1Z","M25-2.8,13.9-13.9c-7.3-7.7-20.5-7.7-27.8,0L-25-2.8V2.8l11.1,11.1c7.3,7.7,20.5,7.7,27.8,0L25,2.8ZM11.1,11.1a15.8,15.8,0,0,1-22.2,0L-22.2,0l11.1-11.1a15.8,15.8,0,0,1,22.2,0L22.2,0Z","M-25-2.8V2.8l11.1,11.1c7.3,7.6,20.5,7.6,27.8,0s7.6-20.5,0-27.8L2.8-25H-2.8ZM15.7,0a15.9,15.9,0,0,1-4.6,11.1,15.8,15.8,0,0,1-22.2,0L-22.2,0,0-22.2,11.1-11.1A15.9,15.9,0,0,1,15.7,0Z","M-25-2.8V2.8L-2.8,25H2.8L25,2.8V-2.8L2.8-25H-2.8Zm25,25L-22.2,0,0-22.2,22.2,0Z","M0-19.7a19.5,19.5,0,0,0-13.9,5.8c-7.6,7.3-7.6,20.5,0,27.8s20.5,7.6,27.8,0C26.3,1.6,17.5-19.7,0-19.7ZM11.1,11.1c-5.8,6.1-16.3,6.1-22.2,0a15.8,15.8,0,0,1,0-22.2,15.8,15.8,0,0,1,22.2,0A15.8,15.8,0,0,1,11.1,11.1Z","M0-19.7a19.5,19.5,0,0,0-13.9,5.8L-25-2.8V2.8l11.1,11.1c7.3,7.6,20.5,7.6,27.8,0C26.3,1.6,17.5-19.7,0-19.7ZM11.1,11.1a15.8,15.8,0,0,1-22.2,0L-22.2,0l11.1-11.1c5.9-6.1,16.4-6.1,22.2,0A15.8,15.8,0,0,1,11.1,11.1Z"],ph=class extends j{constructor(t,e,s){super("square",e,s);this.type="kolam";this.setColour(f.orange),this.options=t,c("path",{d:su[+t],fill:"white"},this.$el),c("circle",{r:3,fill:"white"},this.$el),this.$el.append(this.$outline),this.$path.css("stroke-width",".5px")}static makeThumbnail(t,e){let s=c("svg",{width:60,height:60},e);c("rect",{class:"polygon-tile",fill:f.orange,x:5,y:5,width:50,height:50},s),c("path",{d:su[+t],fill:"white",transform:"translate(30 30)"},s),c("circle",{r:3,cx:30,cy:30,fill:"white"},s)}};var $i=["M-32.3,6.5,0,84.3H0L32.3,6.5A80.4,80.4,0,0,0,0,0,86.6,86.6,0,0,0-32.3,6.5Z","M-32.3,6.5,0,84.3H0L32.3,6.5A80.4,80.4,0,0,0,0,0,86.6,86.6,0,0,0-32.3,6.5Z","M-42.1,0A288.5,288.5,0,0,0-20.2,110.2a287.6,287.6,0,0,0,62.3,93.3V0Z","M-42.1,0V203.5a289.5,289.5,0,0,0,62.4-93.3A286.5,286.5,0,0,0,42.1,0Z","M0 0L-101.7 101.7L101.7 101.7Z","M0 0L-101.7 101.7L101.7 101.7Z","M0 0L-59.6 59.6L59.6 59.6Z","M42.1.1H-42.2l-59.5,59.6A143.4,143.4,0,0,0,0,101.8,143,143,0,0,0,101.7,59.7Z","M42.1.1H-42.2l-59.5,59.6A143.4,143.4,0,0,0,0,101.8,143,143,0,0,0,101.7,59.7Z"],iu=[[66,-17.5,-22.5],[82,-17.5,22.5],[23,-36.5,45],[125,-36.5,-45],[56,47.3,135],[92,47.3,-135],[74,101,180],[41,98,45],[107,98,-45]],S1={0:1,1:1,2:3,3:2,7:8,8:7},nu=[f.lime,f.teal,f.blue,f.red,f.yellow,f.green,f.grey,f.orange,f.purple],uh=class extends j{constructor(t,e,s){super(ut(vs($i[+t])),e,s);this.type="egg";this.snapAngles=[0,45,90,135];this.options=t,this.$path.setAttr("d",$i[+t]),this.$outline.setAttr("d",$i[+t]),this.setColour(nu[+t]),this.rot=iu[+t][2],this.transform(),+t<=1&&this.snapAngles.push(22.5,67.5,112.5,157.5)}flip(t){super.flip(t);let e=this.flipped?S1[this.options]||this.options:this.options;this.$path.setAttr("d",$i[+e]),this.$outline.setAttr("d",$i[+e])}static makeThumbnail(t,e){e.setAttr("d",$i[+t]);let s=iu[+t];e.css("transform",`translate(${s[0]}px, ${s[1]}px) rotate(${s[2]}deg) scale(0.5)`),e.setAttr("fill",nu[+t]),e.css("stroke-width","2px")}};var fh=1/Math.sqrt(3),T1=50/fh,ou=[f.blue,f.purple,f.red,f.orange,f.yellow],xi=O.regular(6,T1).rotate(Math.PI/6).points;xi.splice(3,1);xi.splice(2,0,new d(2*xi[1].x,xi[0].y));var mh=class extends j{constructor(t,e,s){super(ut(xi.map(i=>i.scale(fh**+t))),e,s);this.type="fractal";this.setColour(ou[+t]),this.options=t}static makeThumbnail(t,e){let s=new O(...xi).scale(.6*fh**+t),i=S.aroundPoints(s.points),o=c("svg",{width:20+i.w,height:20+i.h},e);s=s.shift(10-i.center.x+i.w/2,10-i.center.y+i.h/2),c("path",{class:"polygon-tile",path:s,fill:ou[+t]},o)}};var Eo=["M-25,34.4a81.3,81.3,0,0,1,50,0h0A81.1,81.1,0,0,0,40.4-13.1h.1A81.5,81.5,0,0,1,0-42.5H0A81.5,81.5,0,0,1-40.5-13.2h.1A81.1,81.1,0,0,0-25,34.4Z","M-15.4-21.3A80.5,80.5,0,0,1,0-68.8,80.5,80.5,0,0,1,15.4-21.3a80.6,80.6,0,0,1,50,0A80.3,80.3,0,0,1,25,8.1,80.4,80.4,0,0,1,40.4,55.7,80.2,80.2,0,0,1,0,26.3,80.2,80.2,0,0,1-40.4,55.7,80.4,80.4,0,0,1-25,8.1,80.3,80.3,0,0,1-65.4-21.3,80.6,80.6,0,0,1-15.4-21.3Z","M65.4-21.3A80.5,80.5,0,0,1,0,12.1,80.5,80.5,0,0,1-65.4-21.3a80.6,80.6,0,0,1,50,0A80.5,80.5,0,0,1,0-68.8,80.5,80.5,0,0,1,15.4-21.3,80.6,80.6,0,0,1,65.4-21.3Z","M80.9-47.5h0A81.5,81.5,0,0,1,40.4-76.9,80.4,80.4,0,0,0,0-47.5,80.2,80.2,0,0,0-40.5-76.9h0A80.8,80.8,0,0,1-80.9-47.6h0A80.3,80.3,0,0,1-65.5,0,80.3,80.3,0,0,1-80.9,47.5h0A80.8,80.8,0,0,1-40.5,76.9h0A80.2,80.2,0,0,0,0,47.5,80.4,80.4,0,0,0,40.4,76.9,81.5,81.5,0,0,1,80.9,47.6h0A80.3,80.3,0,0,1,65.5,0,80.3,80.3,0,0,1,80.9-47.5Z","M0-47.5A80.3,80.3,0,0,1,15.5,0,80.3,80.3,0,0,1,0,47.5,80.3,80.3,0,0,1-15.5,0,80.3,80.3,0,0,1,0-47.5Z","M130.9,153.8a80.5,80.5,0,0,1,15.4-47.5,80.2,80.2,0,0,1-40.4-29.4A80.1,80.1,0,0,1,90.5,29.4a80.6,80.6,0,0,1-50,0A80.6,80.6,0,0,1,0,0,80.3,80.3,0,0,1-40.4,29.4a80.9,80.9,0,0,1-50.1,0,80.8,80.8,0,0,1-15.4,47.5,80.9,80.9,0,0,1-40.5,29.4,79.9,79.9,0,0,1,15.5,47.5,81.3,81.3,0,0,1,50,0A80.9,80.9,0,0,1,0,72.9a80.9,80.9,0,0,1,80.9,80.9A81.3,81.3,0,0,1,130.9,153.8Z","M40.4-13.2A80.4,80.4,0,0,0,0-42.5,80.7,80.7,0,0,0-40.4-13.1,80.9,80.9,0,0,0-25,34.4a80.6,80.6,0,0,0,50,0A81.2,81.2,0,0,0,40.4-13.2Z","M40.4-13.1A82,82,0,0,1,0-42.5,81.1,81.1,0,0,1-40.5-13.2,81.3,81.3,0,0,1-25,34.4a81.3,81.3,0,0,1,50,0A81.6,81.6,0,0,1,40.4-13.1Z"],ru=["M16.2-.3a5.5,5.5,0,0,1-4.4,6.4A5.3,5.3,0,0,1,5.5,1.8,5.4,5.4,0,0,1,9.8-4.6,5.5,5.5,0,0,1,16.2-.3Zm8-8A3.8,3.8,0,0,0,28-4.5a3.7,3.7,0,0,0,3.7-3.8A3.6,3.6,0,0,0,28-12,3.7,3.7,0,0,0,24.2-8.3ZM19,23.4a4.9,4.9,0,0,0,4.8-4.8A4.8,4.8,0,0,0,19,13.9a4.7,4.7,0,0,0-4.7,4.7A4.8,4.8,0,0,0,19,23.4ZM-11.7,6.1A5.3,5.3,0,0,0-5.4,1.8,5.4,5.4,0,0,0-9.7-4.6,5.5,5.5,0,0,0-16.1-.3,5.5,5.5,0,0,0-11.7,6.1ZM-27.9-4.5a3.8,3.8,0,0,0,3.8-3.8A3.7,3.7,0,0,0-27.9-12a3.6,3.6,0,0,0-3.7,3.7A3.7,3.7,0,0,0-27.9-4.5ZM20.9-22A139.9,139.9,0,0,1,3-19.5a1.1,1.1,0,0,1-.1.5L1-15.2V30H-1V-15.2L-2.9-19a1.1,1.1,0,0,1-.1-.5,127,127,0,0,1-17.8-2.6A80.8,80.8,0,0,0,0-41.7,83.3,83.3,0,0,0,20.9-22ZM-3.8-26.7A3.2,3.2,0,0,0-7-30a3.3,3.3,0,0,0-3.3,3.3A3.2,3.2,0,0,0-7-23.5,3.2,3.2,0,0,0-3.8-26.7ZM6.5-30a3.2,3.2,0,0,0-3.2,3.3,3.2,3.2,0,0,0,3.2,3.2,3.2,3.2,0,0,0,3.3-3.2A3.3,3.3,0,0,0,6.5-30ZM-23.7,18.6a4.9,4.9,0,0,0,4.8,4.8,4.8,4.8,0,0,0,4.7-4.8,4.7,4.7,0,0,0-4.7-4.7A4.8,4.8,0,0,0-23.7,18.6Z","M-16.9-4.7l-17.7-6.1a.8.8,0,0,1-.5-.9.8.8,0,0,1,.9-.5L-16.5-6a.7.7,0,0,1,.5.9.7.7,0,0,1-.7.4ZM-24.6-13l9.7,5.4h.3a.9.9,0,0,0,.7-.3.9.9,0,0,0-.3-1l-9.7-5.4a.8.8,0,0,0-1,.2A.8.8,0,0,0-24.6-13ZM-7.8-4.9l5.9,1.2h.5c.2-.1.3-.2.3-.4l.3-1.4a.6.6,0,0,0-.5-.8L-7.2-7.7h-.6l-.3.4-.3,1.4A.8.8,0,0,0-7.8-4.9ZM2.8-2.5a.9.9,0,0,0,.7.6h.2l1.6-.3a1,1,0,0,0,.5-.4.7.7,0,0,0,.1-.5l-1.4-6a.8.8,0,0,0-.9-.6L2-9.4l-.5.3a1.3,1.3,0,0,0-.1.6ZM10.9.4a.7.7,0,0,0-.1-.5L10-1.3a.8.8,0,0,0-1-.2L4,1.9c-.2.1-.3.2-.3.4a.7.7,0,0,0,.1.5L4.6,4a.6.6,0,0,0,.6.3h.4l5-3.4ZM-4.5-1l-1.4-.3a.4.4,0,0,0-.5.1c-.2.1-.3.2-.3.4L-8.2,5.1a.7.7,0,0,0,.5.8l1.4.4h.5a.5.5,0,0,0,.3-.5L-4-.1A.7.7,0,0,0-4.5-1Zm-12.1-.6a.7.7,0,0,0,.7-.6c.1-.4-.2-.7-.6-.8l-11-1.7a.8.8,0,0,0-.8.6c0,.4.2.8.6.8l11,1.7Zm16.1,6H-1c-.2,0-.3.1-.5.3l-.8,1.1a.8.8,0,0,0,.1,1l4.9,3.6.4.2h.1l.4-.3.9-1.1c.2-.4.2-.8-.1-1Zm-9.4,8.8a.7.7,0,0,0-1,.1L-22.2,28.2a.7.7,0,0,0,.1,1l.4.2a.9.9,0,0,0,.6-.3l11.3-15A.6.6,0,0,0-9.9,13.2Zm-11.2,5.6c.2.2.3.3.5.3l.5-.2,8.2-7.6a.7.7,0,0,0,0-1,.8.8,0,0,0-1,0L-21,17.8A.7.7,0,0,0-21.1,18.8Zm14-4.9a.8.8,0,0,0-1,.4L-13,24.2a.6.6,0,0,0,.3.9h.3a.6.6,0,0,0,.6-.4l5-9.9A.8.8,0,0,0-7.1,13.9Zm17.4-.7a.8.8,0,0,0-1-.2.8.8,0,0,0-.2,1L19.9,29.4a.5.5,0,0,0,.5.3h.4a.7.7,0,0,0,.2-1ZM7,14.4A.7.7,0,0,0,6,14a.7.7,0,0,0-.3.9L10.3,25a.8.8,0,0,0,.7.4h.3a.8.8,0,0,0,.3-1Zm4-2.8,7.8,7.8.5.2.5-.2a.7.7,0,0,0,0-1L12,10.6a.7.7,0,0,0-1,1ZM34.4-11.2a.7.7,0,0,0-.8-.5l-18,5.5a.7.7,0,0,0-.4.9.6.6,0,0,0,.6.5c.1,0,.2,0,.2-.1l18-5.4A.7.7,0,0,0,34.4-11.2ZM26.7-4l-11,1.3a.6.6,0,0,0-.6.8.7.7,0,0,0,.7.6h.1l11-1.3c.4,0,.6-.4.6-.8S27.1-4,26.7-4ZM14-7.3h.3l9.8-5.1a.7.7,0,0,0,.3-1,.7.7,0,0,0-.9-.3L13.6-8.6a.8.8,0,0,0-.3,1A.8.8,0,0,0,14-7.3ZM-.5-16.6h0a.7.7,0,0,0,.7-.6L.6-36a.7.7,0,0,0-.7-.7.7.7,0,0,0-.7.7l-.4,18.7A.7.7,0,0,0-.5-16.6Zm3.2,1.2h.2a.7.7,0,0,0,.7-.6L5.7-26.9a.7.7,0,0,0-.5-.8.8.8,0,0,0-.9.6L2.2-16.3A.7.7,0,0,0,2.7-15.4Zm-6.1-.1h.1c.4-.1.7-.5.6-.8l-1.8-11c0-.4-.4-.6-.8-.6a.8.8,0,0,0-.6.8l1.8,11A.9.9,0,0,0-3.4-15.5Z","M60.8-16.2l-3.6-2.5,1.4-3.9-.9-.3-1.3,3.5h0l-9.5,3,2.8-7.8h-1l-3,8.3-9.5,3.1,4.4-11.8H39.5L35-12.5,25.5-9.4l5-14.7H29.4L24.3-9.1l-9.1,3,6-16.3-1.2.3L14-5.7l-1.8.5a50.6,50.6,0,0,0,5.3-16.2l-1.9.6-.4.2L1-9.8v-10L14.4-30.3c0-.4-.1-.8-.1-1.2L1-21.1v-10l11.7-9.1-.3-1.1L1-32.4v-10l8.9-6.9a3,3,0,0,0-.4-1L1-43.7v-10l5.2-4a4.1,4.1,0,0,0-.5-.9l-5.2,4h-1l-5.2-4a4.1,4.1,0,0,0-.5.9l5.2,4v10l-8.5-6.6a3,3,0,0,0-.4,1L-1-42.4v10l-11.4-8.9-.3,1.1L-1-31.1v10L-14.3-31.5c0,.4-.1.8-.1,1.2L-1-19.8v10L-15.2-20.6l-.4-.2-1.9-.6A50.6,50.6,0,0,0-12.2-5.2L-14-5.7l-6-16.4-1.2-.3,6,16.3-9.1-3L-29.4-24h-1.1l5,14.7L-35-12.5l-4.5-12.2h-1.1l4.4,11.8L-45.7-16l-3-8.3h-1l2.8,7.8-9.5-3h0l-1.3-3.5-.9.3,1.4,3.9-3.6,2.5.7.7,3.1-2.2v.2l9.4,3-6.8,4.8.7.7,7.3-5.1,9.6,3.1L-47.3-3.8l.9.6,10.8-7.4,9.5,3.1-13,8.9,1,.5,13.2-9,9.6,3-14.4,10,1.2.4,14.3-9.9h.4l3,1C-9.8-1-8.9.5-7.9,1.9L-18.4,9.4l1.3.3,9.8-7a64.2,64.2,0,0,0,6.6,8H.7a64.2,64.2,0,0,0,6.6-8l9.8,7,1.3-.3L7.9,1.9C8.9.5,9.8-1,10.8-2.6l3-1h.4L28.5,6.3l1.2-.4L15.3-4.1l9.6-3,13.2,9,1-.5-13-8.9,9.5-3.1L46.4-3.2l.9-.6L36.8-11l9.6-3.1L53.7-9l.7-.7-6.8-4.8,9.4-3v-.2l3.1,2.2Zm-76-3.2L-1-8.5V.6l-9.7-7.4A45.9,45.9,0,0,1-15.2-19.4ZM0,8.5A66.6,66.6,0,0,1-9.6-4.7L-1,1.8V6.3a1,1,0,0,0,1,1,1,1,0,0,0,1-1V1.8L9.6-4.7A71,71,0,0,1,0,8.5ZM10.7-6.8,1,.6V-8.5L15.2-19.4A45.9,45.9,0,0,1,10.7-6.8Z","M65-1V1.1A81.6,81.6,0,0,1,40,5c-8.9,0-12.7-.4-20.6-2.9A1,1,0,0,1,18.8.8.9.9,0,0,1,20,.2C27.7,2.7,31.2,3,40,3A79.7,79.7,0,0,0,64.7-.9ZM-64.6,1.1A82.4,82.4,0,0,0-39.4,5c8.8,0,12.6-.4,20.5-2.9A1.2,1.2,0,0,0-18.2.8,1,1,0,0,0-19.5.2C-27.2,2.7-30.7,3-39.4,3A79.9,79.9,0,0,1-64.2-.9H-65V1ZM-45.8,36a6.7,6.7,0,0,1,6.7-6.7A6.7,6.7,0,0,1-32.4,36a6.7,6.7,0,0,1-6.7,6.7A6.7,6.7,0,0,1-45.8,36Zm2,0a4.7,4.7,0,0,0,4.7,4.7A4.7,4.7,0,0,0-34.4,36a4.7,4.7,0,0,0-4.7-4.7A4.7,4.7,0,0,0-43.8,36Zm10.4-71.4a5.7,5.7,0,0,0-5.7-5.7,5.6,5.6,0,0,0-5.7,5.7,5.7,5.7,0,0,0,5.7,5.7A5.8,5.8,0,0,0-33.4-35.4ZM4.9-37.1a2.2,2.2,0,0,0,2.2,2.2,2.2,2.2,0,0,0,2.2-2.2,2.2,2.2,0,0,0-2.2-2.2A2.2,2.2,0,0,0,4.9-37.1ZM38.7,42.7h0A6.8,6.8,0,0,1,32,36a6.7,6.7,0,1,1,6.7,6.7ZM43.4,36a4.7,4.7,0,1,0-4.7,4.7h0A4.7,4.7,0,0,0,43.4,36ZM0,42.9c4.1.7,8.7-9.6,11.4-17.9A78.6,78.6,0,0,0,15.3.3c0-6.7-1.3-13.7-3.2-21.6-.6-1.6-3.4-4.2-5.8-5.1,2.2-2,1.8-2.9,2.3-3.7s.1-3.3,0-3.8c-4.5,1.1-6.3-2.7-4.3-5.5C9-44,19.3-53.3,29-55.2a6.4,6.4,0,0,0,1,1.3,3.1,3.1,0,0,0,1.8.5,2.9,2.9,0,0,0,2.4-1.2h0a3,3,0,0,0-.6-4.2,2.9,2.9,0,0,0-4.2.7,2.6,2.6,0,0,0-.5.9C19-55.4,8.7-46.5,3.6-41.5A33.5,33.5,0,0,1-.2-42.6l-3.7,1.2c-5-4.9-15.3-13.9-25.4-15.8a2.7,2.7,0,0,0-.5-1.1,3,3,0,0,0-4.2-.6,3,3,0,0,0-.6,4.2h0a3,3,0,0,0,2.4,1.2,3.2,3.2,0,0,0,1.8-.6,3.1,3.1,0,0,0,.9-1.1c10.1,2,20.8,11.8,25.2,16.3,1.3,2.5-.4,5.8-4.2,5-.1.6-.5,3,0,4s.6,1.5,2.3,3.5c-2.4.7-6,4-6.3,5.3-1.6,7-3,15.5-3,21.4a78.8,78.8,0,0,0,4,24.7C-8.8,33.3-3.5,43.8,0,42.9Zm-5.2-80a2.2,2.2,0,0,0-2.2-2.2,2.2,2.2,0,0,0-2.2,2.2,2.2,2.2,0,0,0,2.2,2.2A2.2,2.2,0,0,0-5.2-37.1ZM33-35.4a5.8,5.8,0,0,0,5.7,5.7,5.7,5.7,0,0,0,5.7-5.7,5.6,5.6,0,0,0-5.7-5.7A5.7,5.7,0,0,0,33-35.4Z","M.9,33.4v-9l12.7-9.9.3-1.4L.9,23.2v-10l14-10.9V1L.9,12V2L14.5-8.6c0-.3-.1-.7-.1-1.1L.9.8v-10l11.9-9.3a3.6,3.6,0,0,1-.2-1L.9-10.4v-10l9.2-7.1a4.2,4.2,0,0,0-.4-1L.9-21.6v-9.9h0l5.6-4.3L6-36.8.4-32.4H-.4L-6-36.8l-.5.9L-1-31.6a.1.1,0,0,0-.1.1v9.8l-8.6-6.8a4.2,4.2,0,0,0-.4,1l9,7v10l-11.5-9a3.6,3.6,0,0,1-.2,1L-1.1-9.3V.7L-14.4-9.7c0,.4-.1.8-.1,1.1L-1.1,1.9v10L-14.9,1V2.3L-1.1,13.1v10l-12.8-10,.3,1.4,12.5,9.8v9l-9.6-7.5.6,1.8,9,7v4.1a1,1,0,0,0,1,1,.9.9,0,0,0,1-1v-4l9.2-7.1.6-1.7Z","M0,.8A76.2,76.2,0,0,0,7.8,9.9c-1.6,1.9-5.4,7.6-6.6,21.6h-2C-2,17.1-6,11.4-7.6,9.7A72.7,72.7,0,0,0,0,.8ZM124.3,117.2c-6.5,4.7-6.3,16,.5,25.4a30,30,0,0,0,5.8,6,81.7,81.7,0,0,1,8.3-31.1C133.6,114.7,128.1,114.4,124.3,117.2ZM-82.6,86.3A82.8,82.8,0,0,0-104,75l-1.2,1.7A81,81,0,0,1-83.8,87.9a79.9,79.9,0,0,1,17.6,17.7l.3.5,1.3-1.7A81.3,81.3,0,0,0-82.6,86.3Zm47.3-33.1a80,80,0,0,1-3.9-23.7l-1.1.4-.9.2a83.5,83.5,0,0,0,4,23.7A79.9,79.9,0,0,0-25.8,76.6l2-.6-.3-.4A78.4,78.4,0,0,1-35.3,53.2Zm-81,62.7.6-1.9c-11.9-5.1-16.5-10-18.1-12.4a81.4,81.4,0,0,1-11.8,4.9,85.1,85.1,0,0,1,5.8,9.4C-138.6,115.3-132.2,112.1-116.3,115.9ZM-90,30.1a81.7,81.7,0,0,1-.8,11.1c2,.4,8.7,2.3,18.5,13.8l1.7-1.2c-6.9-11.4-7.6-18.1-7.4-20.9A99.4,99.4,0,0,1-90,30.1ZM38,53.8a85.2,85.2,0,0,0,4.1-23.4l-1.8-.5h-.2a81.5,81.5,0,0,1-4,23.4A81.4,81.4,0,0,1,24.6,75.5l-.4.6,2,.7h0A83,83,0,0,0,38,53.8Zm68.4,24.7-.9-1.3-.3-.4a82,82,0,0,1-17.3,17,82,82,0,0,1-22.5,11.3h-.2l1.2,1.7A85.2,85.2,0,0,0,89.1,95.4,81.6,81.6,0,0,0,106.4,78.5ZM70.8,54.6l1.6,1.2c9.9-11.4,16.5-13.4,18.5-13.7a80.8,80.8,0,0,1-.9-12,97.8,97.8,0,0,1-11.9,2.8C78.4,35.1,78.4,42.1,70.8,54.6ZM126.3,152a28,28,0,0,0-3.9-7.7,26.3,26.3,0,0,0-11.9-9.5c-4.6-1.6-8.8-1.3-12,1s-5.5,8.3-4.3,14.4A82.6,82.6,0,0,1,126.3,152Z","M0,4L5,6.6L4,1.1L8.1,-2.9L2.5,-3.7L0,-8.8L-2.5,-3.7L-8.1,-2.9L-4,1.1L-5,6.6Z","M0,4L5,6.6L4,1.1L8.1,-2.9L2.5,-3.7L0,-8.8L-2.5,-3.7L-8.1,-2.9L-4,1.1L-5,6.6Z"],au=[f.red,f.blue,f.green,f.yellow,f.green,f.teal,f.orange,f.purple],C1=["-30 -35 60 60","-35 -42 70 70","-35 -60 70 70","-45 -45 90 90","-15 -30 30 60","-75 28 150 100","-30 -35 60 60","-30 -35 60 60"],hu=[.7,.6,.3,.6,.3,.6,.7,.7],gh=class extends j{constructor(t,e,s){super(ut(vs(Eo[+t])),e,s);this.type="garden";this.options=t;let i=+t;this.$path.setAttr("d",Eo[i]),this.$outline.setAttr("d",Eo[i]);let o=c("path",{d:ru[i],fill:"black",opacity:hu[i]});this.$path.insertAfter(o),this.symmetric=!0,this.setColour(au[i])}static makeThumbnail(t,e){let s=+t,o=c("svg",{width:s===4?40:s===5?120:80,height:80,viewBox:C1[s]},e),r=c("g",{transform:"scale(0.5)"},o);c("path",{d:Eo[s],fill:au[s],class:"polygon-tile"},r),c("path",{d:ru[s],fill:"black",opacity:hu[s]},r)}};var M1=["M34,0a16,16,0,0,1,6.3-12.7l-9-15.7A34.1,34.1,0,0,0,16,0,34.1,34.1,0,0,0,31.3,28.4l9-15.7A16,16,0,0,1,34,0Z","M-25,9.3a33.7,33.7,0,0,0-15.2,3.6l9,15.7A14.4,14.4,0,0,1-25,27.3a16.1,16.1,0,0,1,15.9,14h18A34,34,0,0,0-25,9.3Z","M-25-9.3a33.7,33.7,0,0,1-15.2-3.6l9-15.7A14.4,14.4,0,0,0-25-27.3a16.1,16.1,0,0,0,15.9-14h18A34,34,0,0,1-25-9.3Z","M-8.9,41.3h18A16.1,16.1,0,0,1,25,27.3a14.4,14.4,0,0,1,6.2,1.3l9-15.7A33.9,33.9,0,0,0-8.9,41.3Z","M-31.3-28.4l-9,15.6A65.9,65.9,0,0,1-9.1,41.3h18A83.7,83.7,0,0,0-31.3-28.4Z","M-8.9,41.3h18A65.9,65.9,0,0,1,40.3-12.8l-9-15.6A83.7,83.7,0,0,0-8.9,41.3Z","M-40.3 12.9L-31.3 28.4L40.3 -12.9L31.3 -28.4Z","M-40.2,12.9l9,15.6A65.7,65.7,0,0,1,0,20.6a65.7,65.7,0,0,1,31.2,7.9l9-15.6A82.6,82.6,0,0,0,0,2.6,82.6,82.6,0,0,0-40.2,12.9Z","M31.3,28.4l9-15.6A65.9,65.9,0,0,1,9.1-41.3h-18A83.7,83.7,0,0,0,31.3,28.4Z"],E1=[[6,3,2],[6,4,8],[7,2,5],[7,5,2],[2,6,3],[8,6,4],[5,7,2],[2,7,5],[3,2,6],[4,8,6],[2,5,7],[5,2,7],[0,1,2],[0,2,1]],sn="#242436",V1=[f.red,f.green,f.yellow];function lu(n,t){let e=E1[n].map((s,i)=>[s,i]).sort((s,i)=>i[0]-s[0]);for(let[s,i]of e)c("path",{d:M1[s],class:"tantrix","stroke-width":2.8,stroke:sn,fill:V1[i]},t)}var wh=class extends j{constructor(t,e,s){super("reg-hexagon",e,s);this.type="tantrix";this.options=t,this.colour=sn,this.$path.setAttr("fill",sn);for(let i of this.$el.$$(".tantrix"))i.setAttr("stroke",sn);lu(+t,this.$el)}setColour(){}static makeThumbnail(t,e){let s=c("svg",{width:60,height:60,viewBox:"-54 -54 108 108"},e);c("path",{class:"polygon-tile",path:yi("reg-hexagon"),fill:sn},s),lu(+t,s)}};var cu=[[[-15.7728,63.1105],[-65.2725,56.0545],[-61.7426,-21.037],[-34.7275,-63.1105],[65.2725,-63.1105]],[[60.6056,14.8729],[-53.4909,57.394],[-80.668,-12.5086],[-20.582,-57.394],[80.668,-57.394]],[[0,-73.612],[50,12.9905],[15,73.612],[-50,12.9905],[-30,-73.612]],[[67.056,-58.248],[67.056,1.752],[-10.5597,58.248],[-67.056,-19.3675],[7.056,-58.248]],[[-74.4415,-47.6314],[35.5585,-47.6314],[74.4415,-8.733],[60.1965,44.3902],[-19.4415,47.6314]],[[47.6215,-81.108],[43.731,-26.2458],[-24.012,81.108],[-47.6215,-43.6179],[-7.3786,-81.108]],[[94.9659,43.7299],[-5.0343,43.7299],[-94.9659,0],[-5.0343,-43.7299],[42.1151,-41.1631]],[[-13.1927,57.1955],[76.8074,57.1955],[76.8257,-32.8045],[-9.8062,-57.1955],[-76.8257,-6.4506]],[[-3.2764,58.8874],[86.2804,29.1016],[26.2804,-43.7514],[-26.2804,-58.8874],[-86.2804,13.9666]],[[51.5265,-55],[58.4735,-14.7198],[9.6458,43.251],[-58.4735,55],[-58.4735,-55]],[[-95.733,-40.991],[53.87,-40.991],[95.733,-15.7718],[1.5099,40.991],[-95.733,-10.4271]],[[-85.642,-51.4515],[12.4961,-51.4515],[85.642,-13.2965],[-38.4855,51.4515],[-85.642,18.5485]],[[-69.99,67.0025],[84.488,2.9975],[84.488,-67.0025],[14.488,-67.0025],[-84.488,32.0117]],[[-15.6401,96.696],[46.9202,6.219],[8.0799,-96.696],[-46.9202,-96.696],[-46.9202,51.458]],[[-46.6683,85],[-46.6683,22.7758],[15.5561,-85],[46.6683,-31.1122],[15.5561,85]],[[0,-46.65],[-43.301,-21.65],[-43.301,46.65],[43.301,46.65],[43.301,-21.65]],[[-25,46.65],[25,46.65],[59.15,-12.5],[0,-46.65],[-59.15,-12.5]],[[0,-64.951],[-50,21.65],[-25,64.951],[25,64.951],[50,21.65]]],du=[...G.rainbow(15).map(n=>n.hex),f.red,f.blue,f.yellow],vh=class extends j{constructor(t,e,s){super((cu[+t-1]||[]).map(i=>i.join(" ")).join(","),e,s);this.type="pentagon";this.options=t,this.setColour(du[+t-1])}static makeThumbnail(t,e){let s=c("svg",{width:80,height:80},e),i=new O(...cu[+t-1].map(r=>new d(r[0],r[1])));i=i.scale(41/i.radius).shift(40);let o=du[+t-1];c("path",{path:i,fill:o,class:"polygon-tile"},s)}};var Ot=25,pu={100:f.yellow,10:f.blue};function Vo(n,t,e,s){let i=s.shift(n*e,0),o=i.shift(0,Math.floor(t/n)*e),r=s.shift(0,Math.ceil(t/n)*e),a=r.shift(t%n*e,0),h=a.shift(0,t%n?-e:0);return new O(s,i,o,h,a,r)}function uu(n,t,e){return c("rect",{class:"number-tile",width:n,height:n,fill:e},t)}function fu(n,t,e,s,i,o){n.setAttr("x",i+t%e*s),n.setAttr("y",o+Math.floor(t/e)*s)}var Ao=class extends k{constructor(t,e,s){super(e,s);this.type="number-tile";this.options=t;let[i,o]=t.split(":").map(r=>+r);this.count=o,this.colour=pu[o]||f.red,this.$tiles=_(()=>uu(Ot,this.$el,this.colour),o),this.$outline=c("path",{class:"outline"},this.$el),o>1&&(this.$handle=this.makeHandle("h",r=>this.setWidth(Math.round(r.x/Ot)))),this.setWidth(i,!0)}setWidth(t,e=!1){var s;if(t=M(t,1,this.count),t!==this.width){this.value=this.count,this.width=t,this.options=`${t}:${this.count}`;for(let i=0;i<this.count;++i)fu(this.$tiles[i],i,t,Ot,-Ot/2,-Ot/2);this.path=Vo(t,this.count,Ot,new d(-Ot/2,-Ot/2)),this.$outline.draw(this.path),(s=this.$handle)==null||s.setTransform(new d((t-.5)*Ot,-Ot/2)),this.transform(),e||this.$parent.selection.update()}}setColour(t){this.colour=t;for(let e of this.$tiles)e.setAttr("fill",R(t))}static makeThumbnail(t,e){let[s,i]=t.split(":").map(l=>+l);s=Math.min(s,i);let o=c("svg",{width:i===1?40:80,height:80},e),r=(i===1?20:40)-s/2*7,a=40-Math.ceil(i/s)/2*7,h=pu[i]||f.red;for(let l=0;l<i;++l)fu(uu(7,o,h),l,s,7,r,a)}getSnapPoints(){let t=new d(-Ot/2,-Ot/2),e=[t];for(let i=1;i<=this.width;++i)e.push(t.shift(i*Ot,0));let s=Math.ceil(this.count/this.width);for(let i=1;i<=s;++i)e.push(t.shift(0,i*Ot));for(let i=0;i<this.count;++i)e.push(t.shift((i%this.width+1)*Ot,Math.floor(i/this.width+1)*Ot));return e}split(){if(this.count===1)return[];let t=_(e=>{let s=e%this.width*Ot,i=Math.floor(e/this.width)*Ot,o=this.posn.shift(s,i).rotate(this.rot*it,this.posn);return mu(1,1,this.$parent,o,this.rot,this.colour)},this.count);return this.$parent.selection.select(t),this.delete(),t}static action(t,e){if(t==="split"){let s=[];for(let i of e)s.push(...i.split());e[0].$parent.change({added:s,deleted:e})}else if(t==="merge"){let s=Array.from(e),i=H(s.map(u=>u.count)),o=I(cs(s,u=>u.count)),r=o.$parent,a=Math.min(...s.map(u=>u.posn.x)),h=Math.min(...s.map(u=>u.posn.y)),l=Math.max(...s.map(u=>Math.ceil((u.posn.x-a)/Ot)+u.width)),p=mu(i,l,r,new d(a,h),o.rot,o.colour);for(let u of e)u.delete();r.selection.add(p),e[0].$parent.change({added:[p],deleted:e})}}};function mu(n,t,e,s,i,o){let r=new Ao(`${t}:${n}`,e);return r.setColour(o),r.setTransform(s,i),r}var nn=[f.yellow,"#f15e19","#e1343b",f.red,"#8d2ca1","#4e53d0",f.blue,f.teal,f.green,f.lime],gu=["#e6e2c6","#cc1030",f.green,f.red,"#ffd615",f.teal,"#181824","#9a2e13",f.blue,f.yellow],wu=25,yh=class extends j{constructor(t,e,s){super(Co(+t*wu,wu),e,s);this.type="number-bar";this.options=t,this.value=+t,this.$text=c("text",{text:t,class:"polygon-label",y:6},this.$el),this.setColour((e.options.altColors?gu:nn)[+t-1])}customTransform(){this.$text.css("transform",`rotate(${-this.rot}deg)`)}static makeThumbnail(t,e,s){let i=+t,o=new S(new d(1,1),i*20,20),r=c("svg",{width:i*20+2,height:22},e),a=c("path",{class:"polygon-tile",path:o},r);c("text",{html:t,class:"polygon-label",x:i*10+1,y:16},r),s.options.watch(h=>a.setAttr("fill",(h.altColors?gu:nn)[i-1]))}};var vu=2*Math.PI;var Pi=50,ko={1:f.grey,2:f.yellow,3:f.green,5:f.blue,7:f.purple},A1="M0-xAx,x,0,0,0-x,0,x,x,0,0,0,0,x,x,x,0,0,0,x,0,x,x,0,0,0,0-xZM0,yAz,z,0,0,1-y,0,z,z,0,0,1,0-y,z,z,0,0,1,y,0,z,z,0,0,1,0,yZ";function yu(n,t,e=1){let s=n.y*t.x-n.x*t.y>0?e:1-e;return[n.x,n.y+"A"+n.length,n.length,0,s,e,t.x,t.y].join(",")}function bu(n,t,e=Pi){if(t===1)return A1.replace(/x/g,""+e).replace(/y/g,""+.4*e).replace(/z/g,""+(.4*e+.1));let s=vu/t,i=-Math.PI/2-s/2,o=d.fromPolar(i+s*n,e),r=d.fromPolar(i+s*(n+1),e);return`M${yu(o,r)}L${yu(r.scale(.4),o.scale(.4),0)}Z`}function $u(n){return n===1?[1]:je(n).reverse()}var on=class extends k{constructor(t,e,s){super(e,s);this.type="prime-disk";this.$segments=[];this.factors=[];this.path=new B(E,Pi),c("circle",{class:"prime-background",r:Pi},this.$el),this.$segmentWrap=c("g",{},this.$el),this.$label=c("text",{class:"prime-label",y:5},this.$el),this.$outline=c("path",{class:"outline",path:this.path},this.$el),this.setValue(+t)}setValue(t){t=this.value=M(Math.round(t),1,9999999),this.options=this.$label.text=""+t,this.factors=$u(t);let e=this.factors.length;for(let s=0;s<e;++s){let i=this.getSegment(s);i.setAttr("fill",ko[this.factors[s]]||f.red),i.setAttr("d",bu(s,e)),i.show()}for(let s=e;s<this.$segments.length;++s)this.$segments[s].hide()}multiply(t){this.setValue(+this.options*t)}getSegment(t){if(this.$segments[t])return this.$segments[t];let e=c("path",{class:"polygon-tile"},this.$segmentWrap);return this.$parent.events.listen(e,{down:()=>{this.$parent.selection.add(this,!this.$parent.events.shiftKey)},start:()=>{!this.isActive||(this.$parent.selection.add(this,!0),e.addClass("prime-move"),this.$container.append(e))},move:s=>{!this.isActive||(e.setTransform(this.posn.add(s.posn).subtract(s.startPosn)),this.setCollision(this.findNearby("prime-disk",Pi,s.posn)))},end:s=>{if(!this.isActive)return;e.removeClass("prime-move"),e.setTransform(),this.$segmentWrap.append(e);let i=s.lastPosn.subtract(s.startPosn);if(i.length>Pi){let o=[],r=[this];if(this.collision)this.collision.multiply(this.factors[t]),this.$parent.selection.add(this.collision,!0),r.push(this.collision),this.setCollision();else{let a=new on(`${this.factors[t]}`,this.$parent);a.setTransform(this.posn.add(i)),o.push(a),this.$parent.selection.add(a,!0)}this.setValue(+this.options/this.factors[t]),this.$parent.change({changed:r,added:o})}},checkIfActive:()=>this.factors.length>1}),this.$segments[t]=e,e}setColour(t){if(this.colour=t,t)for(let e of this.$segments)e.setAttr("fill",R(this.colour))}highlight(t=!0){this.$el.setClass("active",t)}move(t){super.move(t),!(this.$parent.selection.tiles.size>1)&&this.setCollision(this.findNearby("prime-disk",Pi))}collide(t){t.highlight(!1),t.multiply(+this.options),this.delete();let e=this.lastSavedData?[this]:void 0;this.$parent.change({changed:[t],deleted:e})}static makeThumbnail(t,e){let s=c("svg",{width:54,height:54},e),i=c("g",{transform:"translate(27 27)"},s),o=r=>{i.removeChildren();let a=$u(r);for(let h=0;h<a.length;++h){let l=ko[a[h]]||f.red,p=bu(h,a.length,25);c("path",{fill:l,d:p,class:"polygon-tile"},i),c("text",{text:r,y:4,fill:"white",style:"font-size: 11px; text-anchor: middle"},i)}};e.onAttr("data-options",r=>o(Math.round(+r)))}};var Vt=25,bh=class extends k{constructor(t,e,s){super(e,s);this.type="decimal-grid";this.$handles=[];this.$tiles=c("g",{},this.$el),this.$outline=c("path",{class:"outline"},this.$el),this.$handles[0]=this.makeHandle("h",a=>this.setDimensions(a.x/Vt,this.height,this.size)),this.$handles[1]=this.makeHandle("v",a=>this.setDimensions(this.width,a.y/Vt,this.size)),this.$handles[2]=this.makeHandle("c",a=>this.setDimensions(this.width,this.height,(a.x+a.y)/2/Vt)),this.$handles[1].css("cursor","ns-resize"),this.$handles[2].css("cursor","nwse-resize");let[i,o,r]=t.split(":");this.setDimensions(+i,+o,+r)}setDimensions(t,e,s){t=this.width=M(Math.round(t),1,100),e=this.height=M(Math.round(e),1,100),s=this.size=M(Math.round(s),2,Math.max(t,e));let i=[t,e,s].join(":");if(i===this.options)return;this.options=i,this.$tiles.removeChildren();let o=Math.floor(t/s)*s,r=Math.floor(e/s)*s,a=s*Vt;for(let h=0;h<o;h+=s)for(let l=0;l<r;l+=s)this.drawRect(h*Vt,l*Vt,a,a,f.yellow);for(let h=o;h<t;++h)for(let l=0;l<r;l+=s)this.drawRect(h*Vt,l*Vt,Vt,a,f.blue);for(let h=0;h<o;h+=s)for(let l=r;l<e;++l)this.drawRect(h*Vt,l*Vt,a,Vt,f.blue);for(let h=o;h<t;++h)for(let l=r;l<e;++l)this.drawRect(h*Vt,l*Vt,Vt,Vt,f.red);this.$handles[0].setTransform({x:t*Vt,y:0}),this.$handles[1].setTransform({x:0,y:e*Vt}),this.$handles[2].setTransform({x:a,y:a}),this.path=new S(E,t*Vt,e*Vt),this.$outline.draw(this.path),this.$parent.selection.update(),this.transform()}drawRect(t,e,s,i,o){c("rect",{x:t,y:e,width:s,height:i,fill:this.colour||o,class:"polygon-tile"},this.$tiles)}setColour(t){this.colour=t;for(let e of this.$tiles.children)e.setAttr("fill",R(t))}static makeThumbnail(t,e){let s=c("svg",{width:140,height:80},e),i=(o,r,a,h,l)=>c("rect",{x:5+o,y:5+r,width:a,height:h,fill:l,class:"polygon-tile"},s);for(let o=0;o<2;++o)i(50*o,0,50,50,f.yellow);for(let o=0;o<3;++o)i(100+10*o,0,10,50,f.blue);for(let o=0;o<2;++o)for(let r=0;r<2;++r)i(50*o,50+r*10,50,10,f.blue);for(let o=0;o<3;++o)for(let r=0;r<2;++r)i(100+o*10,50+r*10,10,10,f.red)}};var xu='<h3>Dot Machine</h3><label class="row"><div class="label">Base:</div><input class="input-field" type="number" :bind="base" min="2" max="25"></label><label class="row"><div class="label">Boxes:</div><input class="input-field" type="number" :bind="boxes" min="1" max="10"></label>';var $h=class extends k{constructor(t,e,s){super(e,s);this.type="dot-machine";this.canRotate=!1;this.canDragToSelect=!1;this.cells=[];this.isAnimating=!1;let[i,o]=t.split(":").map(a=>+a),r={base:i,boxes:o};this.model=e.bindSettingsPanel(this,xu,r),this.$outline=c("rect",{class:"outline",rx:12},this.$el),this.model.watch(()=>this.draw(this.model)),this.setColour(f.purple),this.setOrder("back"),this.onMove=()=>{let a=Array.from(e.selection.tiles).filter(h=>h.type==="dot");for(let h of this.cells)h.hover(a.some(l=>h.contains(l.posn)))},this.onMoveEnd=()=>{for(let a of this.cells)a.hover(!1)},e.on("move-selection",this.onMove),e.on("move-end",this.onMoveEnd),this.onChange=()=>this.rearrangeDots(),setTimeout(()=>{this.rearrangeDots(),e.on("change",this.onChange)})}delete(){this.$parent.off("move-selection",this.onMove),this.$parent.off("move-end",this.onMoveEnd),this.$parent.off("change",this.onChange),super.delete()}select(){super.select();for(let t of this.cells)t.hover()}deselect(){super.deselect();for(let t of this.cells)t.hover(!1)}draw(t){let e=Math.round(t.base),s=Math.round(t.boxes);if(this.options=`${e}:${s}`,this.cells.length>s){for(let o=s;o<this.cells.length;++o)this.cells[o].delete();this.cells=this.cells.slice(0,s)}else if(this.cells.length<s)for(let o=this.cells.length;o<s;++o){let r=new Pu(this,o);this.cells.push(r),r.setColour(this.colour)}for(let o of this.cells)o.setBase(e);let i=150*(s-1)+10;this.path=new S(new d(-i,-10),i+160,170),this.$outline.setRect(this.path),this.transform(),this.$parent.selection.update()}getSnapPoints(){return[]}setColour(t){super.setColour(t.slice(0,7));for(let e of this.cells)e.setColour(this.colour)}moveEnd(){super.moveEnd();for(let t of this.cells)for(let e of[...t.dots,...t.antiDots])e.cell=void 0}rearrangeDots(){if(!this.isAnimating){for(let t of this.cells)t.clear();for(let t of this.$parent.tiles.values())if(!(!t.is("dot")||t.deleted))for(let e of this.cells)(t.cell===e||!t.cell&&e.contains(t.posn))&&e.addDot(t);for(let t of this.cells)t.rearrange()}}static makeThumbnail(t,e){let s=c("svg",{width:160,height:60},e);for(let i of[105,55,5])c("rect",{x:i,y:5,width:50,height:50,class:"dot-cell",stroke:"#eee",style:"stroke-width: 6px"},s),c("circle",{cx:i+25,cy:5,r:2},s),c("circle",{cx:i+25,cy:55,r:2},s)}static action(t,e){return P(this,null,function*(){if(t==="explode")for(let s of e)s.isAnimating||s.cells[0].explode();else if(t==="annihilate")for(let s of e)s.isAnimating||s.cells[0].annihilate()})}},Pu=class{constructor(t,e=0){this.machine=t;this.index=e;this.dots=[];this.antiDots=[];let s=-150*e;this.$el=c("rect",{class:"dot-cell",width:150,height:150,x:s}),this.$label=c("text",{class:"dot-label",x:75+s,y:154,"font-size":"12px"},t.$el),this.$value=c("text",{class:"dot-label",x:75+s,y:6,text:0,"font-size":"18px"},t.$el),this.bounds=new S(new d(s,0),150,150),t.$el.prepend(this.$el)}setBase(t){this.$label.text=ot(Math.pow(t,this.index))}delete(){this.$el.remove(),this.$label.remove(),this.$value.remove()}setColour(t){this.$el.setAttr("stroke",t),this.machine.isActive&&this.$el.css("fill",t)}hover(t=!0){this.machine.isActive&&!t||this.$el.css("fill",t?this.machine.colour:"none")}contains(t){return this.bounds.translate(this.machine.posn).contains(t)}clear(){this.dots=[],this.antiDots=[]}addDot(t){(t.options==="1"?this.dots:this.antiDots).push(t),t.cell=this}rearrange(){this.$value.text=ot(this.dots.length-this.antiDots.length);let t=[...this.dots,...this.antiDots];if(!t.length)return;let e=Math.ceil(Math.sqrt(t.length)),s=Math.ceil(t.length/e),i=t.length<=16?30:t.length<=25?25:20,o=this.bounds.center.add(this.machine.posn).shift(-i*(e-1)/2,-i*(s-1)/2),r=_(a=>o.shift(a%e*i,Math.floor(a/e)*i),t.length);return this.animatePoints(t,r)}animatePoints(t,e){let s=t.map(i=>i.posn);for(let[i,o]of t.entries())o.setTransform(e[i]);return z(i=>{var o;for(let[r,a]of t.entries()){let h=d.interpolate(s[r],e[r],X("quad",i));a.$el.setTransform(h),a.transformed=(o=a.path)==null?void 0:o.translate(h)}this.machine.$parent.selection.update()},240).promise}getDotsToExplode(){let t=this.machine.model.base;if(this.dots.length>=t)return this.dots.splice(0,t);if(this.antiDots.length>=t)return this.antiDots.splice(0,t)}explode(){return P(this,null,function*(){let t=this.machine.cells[this.index+1];if(!t){this.machine.isAnimating=!1,this.machine.$parent.change({changed:this.dots});return}this.machine.isAnimating=!0;let e=this.getDotsToExplode();if(!e)return t.explode();t.addDot(e[0]);for(let s of e.slice(1))s.popOut();return t.rearrange(),yield Ve(400),this.rearrange(),yield Ve(400),this.explode()})}annihilate(){return P(this,null,function*(){this.machine.isAnimating=!0;let t=Math.min(this.dots.length,this.antiDots.length);if(t){let s=this.dots.splice(0,t),i=this.antiDots.splice(0,t);for(let o of[...s,...i])o.popOut();this.rearrange(),yield Ve(600)}let e=this.machine.cells[this.index+1];if(e)return e.annihilate();this.machine.isAnimating=!1,this.machine.$parent.change({changed:this.dots})})}};var Oo=25/2,rn=class extends k{constructor(t,e,s){super(e,s);this.type="dot";this.deleted=!1;this.options=t,this.$path=c("circle",{r:Oo,class:"polygon-tile"},this.$el),this.$outline=c("circle",{r:Oo,class:"outline"},this.$el),this.path=new B(E,Oo),this.setColour(f.blue)}setColour(t){this.colour=t,this.$path.setAttr("fill",this.options==="-1"?f.red:this.colour)}getSnapPoints(){return[]}getCell(){for(let t of this.$parent.tiles.values())if(!(t.type!=="dot-machine"||t.isActive)){for(let e of t.cells)if(e.contains(this.posn))return e}}moveEnd(){let t=this.cell,e=this.cell=this.getCell();if(!t||!e||t===e||t.machine!==e.machine)return;let s=Math.abs(t.index-e.index),i=t.machine.model.base**s;if(t.index<e.index){let o=this.options==="1"?t.dots:t.antiDots;if(o.length<i)return this.cell=t;for(let r of o.filter(a=>!a.isActive).slice(0,i-1))r.popOut()}else for(let o=0;o<i-1;++o){let r=new rn(this.options,this.$parent);r.posn=this.posn,r.cell=e}}static makeThumbnail(t,e){let s=t==="1"?f.blue:f.red,i=c("svg",{width:40,height:40},e);c("circle",{class:"polygon-tile",cx:20,cy:20,r:Oo,fill:s},i)}negate(){this.options=this.options==="-1"?"1":"-1",this.setColour(f.blue)}popOut(){return P(this,null,function*(){this.deleted=!0,yield this.$path.exit("pop").promise,this.delete()})}};function Su(n){return n===0?f.grey:n>0?f.blue:f.red}function Tu(n){return+n.replace("\u2013","-")}function Cu(n,t,e=40,s=50){t=M(Math.round(t),-9999,9999);let o=(n.text=ot(t)).length;return n.css("font-size",(o>=6?.625:o>=4?.75:1)*e+"px"),n.setAttr("y",(o>=6?.9:o>=4?.94:1)*s),t}var xh=class extends k{constructor(t,e,s){super(e,s);this.type="number-card";this.path=new S(E,75),this.$path=c("rect",{class:"polygon-tile",rx:10,width:75,height:75},this.$el),this.$label=c("text",{x:75/2,fill:"white",style:"text-anchor: middle"},this.$el),this.$outline=c("rect",{class:"outline",rx:10,width:75,height:75},this.$el),this.setValue(Tu(t))}setValue(t){this.value=Cu(this.$label,t),this.options=""+this.value,this.setColour()}setColour(t){super.setColour(t||Su(this.value)),this.$path.setAttr("fill",R(this.colour))}highlight(t=!0){this.$el.setClass("active",t)}move(t){if(super.move(t),!this.$parent.options.mergeTiles||this.$parent.selection.tiles.size>1)return;let e=this.findNearby("number-card",40);this.setCollision(e&&lt(e.value+this.value,-9999,9999)?e:void 0)}collide(t){t.highlight(!1),t.setValue(t.value+this.value),this.delete();let e=this.lastSavedData?[this]:void 0;this.$parent.change({changed:[t],deleted:e})}negate(){this.setValue(-this.value)}static makeThumbnail(t,e){let s=c("svg",{width:60,height:60},e),i=c("rect",{x:5,y:5,width:50,height:50,class:"polygon-tile",rx:5},s),o=c("text",{fill:"white",x:30,style:"text-anchor: middle"},s);e.onAttr("data-options",r=>{let a=Cu(o,Tu(r),30,39);i.setAttr("fill",Su(a))})}};var Tt=50,Ds=14,k1=`M-${Tt/2} -4.5h${Tt*Ds}v-33h9v75h-9v-33h-${Tt*Ds}v33h-9v-75h9Z`,Ph=class extends k{constructor(t,e,s){super(e,s);this.type="abacus";this.options=t,this.path=new S(new d(-Tt/2-9,-Tt/2-12.5),Ds*Tt+18,Tt+25),c("path",{path:this.path,fill:"transparent"},this.$el),c("path",{d:k1,class:"polygon-tile",fill:"#7e7c86"},this.$el),c("path",{path:this.path,class:"outline"},this.$el),this.positions=t.split(",").map(i=>+i),this.$beads=this.positions.map(i=>c("circle",{cx:i*Tt,r:Tt/2,class:"polygon-tile"},this.$el)),this.$gradients=this.positions.map(i=>c("circle",{cx:i*Tt,r:Tt/2,class:"bead-gradient"},this.$el)),this.count=this.$beads.length;for(let[i,o]of this.$beads.entries())this.setupBead(o,i);this.setColour(f.orange)}setupBead(t,e){let s=0;this.$parent.events.listen(t,{click:()=>{this.locked||this.$parent.selection.add(this,!this.$parent.events.shiftKey)},start:i=>{s=this.positions[e]-this.relativePosn(i.posn).x/Tt},move:i=>{let o=this.positions[e]=M(s+this.relativePosn(i.posn).x/Tt,e,Ds-(this.count-e)),r=o;for(let h=e+1;h<this.count;++h)this.positions[h]<r+1&&(this.positions[h]=r+1),r=this.positions[h];let a=o;for(let h=e-1;h>=0;--h)this.positions[h]>a-1&&(this.positions[h]=a-1),a=this.positions[h];for(let[h,l]of this.$beads.entries())l.setAttr("cx",this.positions[h]*Tt),this.$gradients[h].setAttr("cx",this.positions[h]*Tt)},end:()=>{let i=this.options;this.options=this.positions.join(","),i!==this.options&&this.$parent.change({changed:[this]})}})}setColour(t){super.setColour(t.slice(0,7));let e=this.$beads.length/2,s=G.mix("#fff",this.colour,.8);for(let[i,o]of this.$beads.entries())o.setAttr("fill",i<e?this.colour:s)}getSnapPoints(){return[new d(-Tt/2,-25),new d((Ds-.5)*Tt,-25),new d(-Tt/2,25),new d((Ds-.5)*Tt,25),new d(-Tt/2,50),new d((Ds-.5)*Tt,50)]}static makeThumbnail(t,e){let s=c("svg",{width:240,height:40},e);c("line",{x1:5,y1:18,x2:235,y2:20,stroke:"white","stroke-width":"3px"},s),c("line",{x1:4,y1:3,x2:4,y2:37,stroke:"white","stroke-width":"3px"},s),c("line",{x1:236,y1:3,x2:236,y2:37,stroke:"white","stroke-width":"3px"},s);for(let i=0;i<10;++i){let o=i<5?f.orange:G.mix("#fff",f.orange,.7),r={cx:16+20*i,cy:20,r:10,style:"stroke-width: 0.5px"};c("circle",me(me({},r),{class:"polygon-tile",fill:o}),s),c("circle",me(me({},r),{class:"bead-gradient"}),s)}}};var O1={1:f.yellow,x:f.green,x2:f.blue,y:f.teal,y2:"#8d2ca1",xy:"#4e53d0"},an=25,L1=an*5.4,R1=an*4.7,I1="#ddd";function Lo(n){return n.replace("-","\u2013").replace("2","\xB2")}function Sh(n){return n[0]==="-"?f.red:O1[n]}function Mu(n,t=an,e=L1,s=R1){return n.endsWith("x2")?[e,e]:n.endsWith("y2")?[s,s]:n.endsWith("xy")?[e,s]:n.endsWith("x")?[t,e]:n.endsWith("y")?[t,s]:[t,t]}var hn=class extends j{constructor(t,e,s){super(Co(...Mu(t.toLowerCase())),e,s);this.type="algebra-tile";this.options=t.toLowerCase(),this.$text=c("text",{text:Lo(this.options),class:"polygon-label",y:6},this.$el),this.setColour(Sh(this.options))}setColour(t=this.colour){super.setColour(t),this.$path.setAttr("fill",R(this.collision?I1:this.colour)),this.$text.text=this.collision?"0":Lo(this.options)}customTransform(){this.$text.css("transform",`rotate(${-this.rot}deg)`)}setCollision(t){this.collision=t,this.setColour()}move(t){if(super.move(t),this.collision){if(d.distance(this.posn,this.collision.posn)<.95*an)return;this.collision.setCollision(),this.setCollision()}let e=this.options[0]==="-"?this.options.slice(1):"-"+this.options;for(let s of this.$parent.tiles.values())if(!(!s.is("algebra-tile")||s.collision||s===this)&&s.options===e&&!(d.distance(this.posn,s.posn)>=.95*an)){this.setCollision(s),s.setCollision(this);return}}static makeThumbnail(t,e){let[s,i]=Mu(t,20,78,64),o=t[0]==="-"?t.slice(1):t,r=o==="y2"?112:["x2","xy"].includes(o)?28:2,a=o==="1"?2:["x","x2"].includes(o)?28:112;e.hasAttr("data-rot")&&([r,a,s,i]=[a,r,i,s]),e.setRect(new S(new d(r,a),s,i)),e.setAttr("fill",Sh(t)),e.insertAfter(c("text",{text:Lo(t),class:"polygon-label",x:r+s/2,y:a+i/2+5}))}negate(){this.options.startsWith("-")?this.options=this.options.slice(1):this.options="-"+this.options,this.setColour(Sh(this.options)),this.$text.text=Lo(this.options)}static action(t,e){if(t==="negate"){for(let s of e)s.negate();e[0].$parent.change({changed:e})}}};var Eu="M-125,0l35,252c0,11,40.3,20,90,20s90-9,90-20L125,0Z",Vu=_(n=>new d(n<5?-45:45,65+40*(n%5)),10),Th=class extends k{constructor(t,e,s){super(e,s);this.type="bucket";this.canRotate=!1;this.canDragToSelect=!1;this.isAnimating=!1;this.tiles=Nt(void 0,20);c("path",{class:"polygon-tile bucket",d:Eu,fill:"#ccc"},this.$el),c("ellipse",{class:"polygon-tile bucket",rx:125,ry:28,fill:"#888"},this.$el),this.$text=c("text",{text:0,class:"bucket-label",y:12},this.$el),this.setColour(f.grey),this.path=new O(new d(-125,0),new d(0,-28),new d(125,0),new d(90,252),new d(0,272),new d(-90,252)),this.setOrder("back"),this.onMoveEnd=()=>this.recompute(),e.on("change",this.onMoveEnd)}delete(){this.$parent.off("change",this.onMoveEnd),super.delete()}getSnapPoints(){return[]}recompute(){return P(this,null,function*(){var e;if(this.isAnimating)return;let t=[];for(let[s,i]of this.tiles.entries())i&&!Ue(this.$parent.tiles.values(),o=>o===i)&&(this.tiles[s]=void 0);for(let s of this.$parent.tiles.values()){if(!s.is("algebra-tile")||!s.options.endsWith("1"))continue;let i=s.options!=="1",o=(e=this.transformed)==null?void 0:e.contains(s.posn),r=this.tiles.indexOf(s);if(r>=0&&!o&&(this.tiles[r]=void 0),!o)continue;if((i?r>=0&&r<10:r>=10)&&(this.tiles[r]=void 0,r=-1),r<0&&(r=this.tiles.findIndex((h,l)=>!h&&(i?l>=10:l<10))),r<0)return;this.tiles[r]=s;let a=Vu[r%10].shift(i?15:-15,0).add(this.posn);a.equals(s.posn)||t.push({tile:s,from:s.posn,to:a})}if(this.$text.text=ot(H(this.tiles.map((s,i)=>s?i<10?1:-1:0))),t.length){this.isAnimating=!0,yield z(s=>{var o;let i=X("quad",s);for(let{tile:r,from:a,to:h}of t){let l=d.interpolate(a,h,i);r.posn=l,r.$el.setTransform(l,r.rot*it),r.transformed=(o=r.path)==null?void 0:o.translate(l)}this.$parent.selection.update()},240).promise;for(let s of t)s.tile.transform(),s.tile.move();this.isAnimating=!1}})}fill(){if(this.isAnimating)return[];let t=[];for(let[e,s]of this.tiles.entries()){if(s)continue;let i=new hn(e<10?"1":"-1",this.$parent);i.setTransform(Vu[e%10].shift(e<10?-15:15,0).add(this.posn)),this.tiles[e]=i,t.push(i)}return this.$text.text="0",t}static makeThumbnail(t,e){let s=c("svg",{width:120,height:140,viewBox:"-140 -40 280 320"},e);c("path",{class:"polygon-tile bucket",d:Eu,fill:"#ccc",style:"stroke-width: 2px"},s),c("ellipse",{class:"polygon-tile bucket",rx:125,ry:28,fill:"#888",style:"stroke-width: 2px"},s)}static action(t,e){return P(this,null,function*(){if(t==="fill"){let s=[];for(let i of e)s.push(...i.fill());s.length&&e[0].$parent.change({added:s})}})}};var re=50,Au=Jt((n,t,e,s,i)=>n==="number"?1+s+i*t:n==="addition"?!s&&!i?"+":!s||!i?s||i:s+i:!s&&!i?"\xD7":!s||!i?s||i:s*i),N1=Jt(n=>G.from(n).brightness<140),D1=Jt(n=>G.mix(n,"#000",.7).hex);function G1(n){return n?new Map(n.split(",").map(t=>t.split("-"))):new Map}function H1(n){return Array.from(n.entries()).map(t=>t.join("-")).join(",")}var Ch=class extends k{constructor(t,e,s){super(e,s);this.type="number-grid";this.cells=[];this.$handles=[];this.rows=3;this.cols=2;this.isFocussed=!1;this.selected=new Set;this.canRotate=!1;this.$cells=c("g",{},this.$el),this.$outline=c("path",{class:"outline"},this.$el),e.events.listen(this.$el,{down:h=>this.selectCell(h.posn),move:h=>this.selectCell(h.posn,!0),checkIfActive:()=>this.isFocussed}),this.$handles[0]=this.makeHandle("h",h=>this.resize(h.x/re,this.rows)),this.$handles[1]=this.makeHandle("v",h=>this.resize(this.cols,h.y/re)),this.$handles[1].css("cursor","ns-resize");let[i,o,r,a]=t.split(":");this.gridType=i,this.colour="#ccc",this.colorsStr=a||"",this.colors=G1(this.colorsStr),this.resize(+o,+r)}resize(t,e){this.cols=M(Math.round(t),2,20),this.rows=M(Math.round(e),2,20);let s=`${this.gridType}:${this.cols}:${this.rows}:${this.colorsStr}`;if(s===this.options)return;this.options=s;let i=this.cols*this.rows;for(let o=this.cells.length;o<i;++o)this.cells.push(this.makeCell());for(let o=i;o<this.cells.length;++o)this.cells[o][0].hide();this.updateCells(),this.path=new S(E,this.cols*re,this.rows*re),this.$outline.draw(this.path),this.$handles[0].setTransform({x:this.path.w,y:0}),this.$handles[1].setTransform({x:0,y:this.path.h}),this.transform(),this.$parent.selection.update()}makeCell(){let t=c("g",{class:"number-grid-cell"},this.$cells),e=c("circle",{r:23,cx:re/2,cy:re/2},t);return[t,e,c("text",{x:re/2,y:re/2+8},t)]}updateCells(){for(let t=0;t<this.cols;++t)for(let e=0;e<this.rows;++e){let[s,i,o]=this.cells[t+e*this.cols];s.show(),s.translate(t*re,this.flipped?(this.rows-1-e)*re:e*re),o.text=""+this.getCellValue(t,e)}this.updateColors()}updateColors(){let t=this.gridType==="number",e=R(this.colour),s=D1(e);for(let i=0;i<this.cols;++i)for(let o=0;o<this.rows;++o){let r=i+o*this.cols,a=!t&&(!i||!o),h=this.colors.get(t?`${r}`:`${o}/${i}`)||(a?s:e);this.cells[r][1].setAttr("fill",h),this.cells[r][2].setAttr("fill",N1(h)?"#fff":"#000")}}setColour(t,e){if(this.isFocussed&&e==="picker"){let s=this.gridType==="number",i=R(t);for(let o of this.selected)this.colors.set(s?`${o}`:`${Math.floor(o/this.cols)}/${o%this.cols}`,i);return this.colorsStr=H1(this.colors),this.options=`${this.gridType}:${this.cols}:${this.rows}:${this.colorsStr}`,this.$parent.change({changed:[this]}),this.updateColors()}e==="picker"&&(this.colors.clear(),this.colorsStr="",this.options=`${this.gridType}:${this.cols}:${this.rows}`),super.setColour(t),this.updateColors()}doubleClick(t){this.$parent.selection.clear(),this.isFocussed=!0,this.$parent.options.focussed=this,this.selectCell(t.posn)}selectCell(t,e=!1){if(t=this.relativePosn(t).scale(1/re).floor(),t.x<0||t.x>=this.cols||t.y<0||t.y>=this.rows)return;let s=t.x+(this.flipped?this.rows-1-t.y:t.y)*this.cols;if(e)this.selected.has(s)||this.addToSelection(s);else if(this.$parent.events.shiftKey)this.selected.has(s)?this.removeFromSelection(s):this.addToSelection(s);else{for(let i of this.selected)this.removeFromSelection(i);this.addToSelection(s)}}addToSelection(t){this.cells[t][0].addClass("active"),this.selected.add(t)}removeFromSelection(t){this.cells[t][0].removeClass("active"),this.selected.delete(t)}getCellValue(t,e){return Au(this.gridType,this.cols,this.rows,t,e)}blur(){for(let t of this.selected)this.removeFromSelection(t);this.isFocussed=!1,this.$parent.options.focussed=void 0}flip(){super.flip(),this.updateCells()}selectMultiples(){let t=Array.from(this.selected).map(s=>+this.getCellValue(s%this.cols,Math.floor(s/this.cols))),e=t.length>1?fs(...t):t[0];for(let s of this.selected)this.removeFromSelection(s);for(let s=0;s<this.cols;++s)for(let i=0;i<this.rows;++i)+this.getCellValue(s,i)%e==0&&this.addToSelection(s+i*this.cols)}static action(t,e){if(t==="reverse"){for(let s of e)s.flip();e[0].$parent.change({changed:e})}}static makeThumbnail(t,e){let s=t.split(":")[0],i=s==="number"?5:4,o=c("svg",{width:10+25*i,height:10+25*i,"text-anchor":"middle","font-size":"14"},e),r=(a,h,l,p)=>{c("circle",{cx:a+17.5,cy:h+17.5,r:12,fill:l},o),c("text",{x:a+17.5,y:h+22,text:p,fill:"white"},o)};for(let a=0;a<i;++a)for(let h=0;h<i;++h){let l=s==="number"||a&&h?"#ffffff44":"#ffffff88";r(25*a,25*h,l,Au(s,i,i,a,h))}}};var ku=25;function q1(n){let t=+n,e=Math.ceil(t/2);return ut(Vo(e,t,ku,E).points)}function Ou(n,t,e,s=0,i=0){let o=Math.ceil(n/2);for(let r=0;r<n;++r){let a=(r%o+.5)*t+s,h=(.5+(r<o?0:1))*t+i;c("circle",{fill:"white",cx:a,cy:h,r:t*.25},e)}}var Mh=class extends j{constructor(t,e,s){super(q1(t),e,s);this.type="number-frame";this.options=t,this.value=+t,this.setColour(nn[this.value-1]),Ou(this.value,ku,this.$el)}static makeThumbnail(t,e){let s=+t,i=Math.ceil(s/2),o=Vo(i,s,20,new d(5,5)),r=c("svg",{width:i*20+10,height:50},e);c("path",{path:o,fill:nn[s-1],class:"polygon-tile"},r),Ou(s,20,r,5,5)}};var Lu=4,Ru=6,Gs=6;function Iu(n){return n===1?[1]:je(n)}var _1=Jt((n,t)=>{if(n===2)return 2*t+1.5*Gs;let e=2*t+Gs,s=2*t+Gs;n===3&&(s/=Math.sqrt(3)),n===4&&(s/=Math.sqrt(2)),n>3&&n%2&&(n-=1);let o=Math.ceil((Math.sqrt(n*8/Ru+1)-1)/2);return s+(o-1)*e+t+Gs});function Eh(n){return n.reduceRight((t,e)=>_1(e,t),Lu)}function B1(n,t){if(n===1)return[];if(n===2)return[E.shift(-t-Gs/2,0),E.shift(t+Gs/2,0)];let e=[],s=2*t+Gs,i=s;n===3&&(i/=Math.sqrt(3)),n===4&&(i/=Math.sqrt(2)),n>3&&n%2&&(e.push(E),n-=1);let o=1;for(;n;){let r=Math.min(Ru*o,n);e.push(...O.regular(r,i).points),n-=r,i+=s,o+=1}return e}function Vh(n,t,e,s=E){if(n.length<1)return[];let i=c("g",{class:"tile","data-n":n.join("-")},e),o=ko[n[0]]||f.red;c("circle",{r:t,cx:s.x,cy:s.y,fill:o,class:"polygon-tile"},i);let r=n.slice(1),a=Eh(r),h=B1(n[0],a);if(r.length){let l=[i];for(let p of h)l.push(...Vh(r,a,i,s.add(p)));return l}else{for(let l of h){let p=s.add(l);c("circle",{r:Lu,cx:p.x,cy:p.y,fill:"white"},i)}return[i]}}var ln=class extends k{constructor(t,e){super(e);this.type="number-dot";this.factors=[];this.$body=c("g",{},this.$el),this.$outline=c("path",{class:"outline"},this.$el),t.startsWith(">")?(this.options=t,this.factors=t.slice(1).split("-").map(s=>+s),this.value=this.factors.reduce((s,i)=>s*i,1),this.count=this.factors.length,this.buildTile()):this.setValue(+t)}setValue(t){t=this.value=M(Math.round(t),1,999),this.factors=Iu(t),this.count=this.factors.length,this.options=">"+this.factors.join("-"),this.buildTile()}add(t){this.setValue(this.value+t)}buildTile(){this.$body.removeChildren(),this.radius=Eh(this.factors);let t=Vh(this.factors,this.radius,this.$body);if(this.factors.length>1)for(let e of t.slice(1))this.setupListeners(e);this.path=new B(E,this.radius),this.$outline.draw(this.path),this.transform()}setupListeners(t){let s=t.attr("data-n").split("-").reduce((r,a)=>r*+a,1),i=t.parent,o=t.children[0];this.$parent.events.listen(t,{down:()=>this.$parent.selection.add(this,!this.$parent.events.shiftKey),start:()=>{!this.isActive||(this.$parent.selection.add(this,!0),o.addClass("prime-move"),this.$container.append(t))},move:r=>{!this.isActive||(t.setTransform(this.posn.add(r.posn).subtract(r.startPosn)),this.setCollision(this.findCollision(r.posn)))},end:r=>{if(!!this.isActive)if(r.lastPosn.subtract(this.posn).length<=this.radius)t.setTransform(),o.removeClass("prime-move"),i.append(t);else if(this.collision)t.remove(),this.collision.add(s),this.add(-s),this.$parent.selection.add(this.collision,!0),this.$parent.change({changed:[this,this.collision]}),this.setCollision();else{t.remove();let a=new ln(`${s}`,this.$parent);a.setTransform(this.posn.add(r.lastPosn).subtract(r.startPosn)),this.add(-s),this.$parent.change({added:[a],changed:[this]})}}})}findCollision(t){for(let e of this.$parent.tiles.values())if(e!==this&&e.is("number-dot")&&d.distance(t,e.posn)<e.radius)return e}highlight(t=!0){this.$el.setClass("active",t)}move(t){super.move(t),!(this.$parent.selection.tiles.size>1)&&this.setCollision(this.findCollision(this.posn))}collide(t){t.highlight(!1),t.add(this.value);let e=this.lastSavedData?[this]:void 0;this.$parent.change({changed:[t],deleted:e}),this.delete()}reorder(){this.factors.push(this.factors.shift()),this.options=`>${this.factors.join("-")}`,this.buildTile()}shrink(){this.factors.length<=1||(this.factors.push(this.factors.pop()*this.factors.pop()),this.count=this.factors.length,this.options=`>${this.factors.join("-")}`,this.buildTile())}grow(){let t=this.factors.length-1-this.factors.slice(0).reverse().findIndex(i=>!Ei(i));if(t<0||!this.factors[t])return;let e=je(this.factors[t])[0],s=Math.round(this.factors[t]/e);this.factors.splice(t,1,e,s),this.count=this.factors.length,this.options=`>${this.factors.join("-")}`,this.buildTile()}static action(t,e){return P(this,null,function*(){if(t!=="grow"&&(e=e.filter(s=>s.factors.length>1)),!!e.length){if(t==="reorder")for(let s of e)s.reorder();else if(t==="shrink")for(let s of e)s.shrink();else if(t==="grow")for(let s of e)s.grow();e[0].$parent.change({changed:e})}})}static makeThumbnail(t,e){let s=c("svg",{width:54,height:54},e),i=o=>{s.removeChildren();let r=Iu(o);for(let a=0;a<r.length;++a){let h=Eh(r);Vh(r,h,s)[0].css("transform",`translate(27px, 27px) scale(${25/h})`)}};e.onAttr("data-options",o=>i(Math.round(+o)))}};var Rt=50,os=[f.yellow,"#f15e19","#e1343b",f.red,"#8d2ca1","#4e53d0",f.blue,"#0595bf","#0ba27b",f.green,"#7dc410","#ebc000"];function Hs(...n){if(!!v.isSafari){for(let t of n)t==null||t.css("transform-box","view-box");setTimeout(()=>{for(let t of n)t==null||t.css("transform-box","fill-box")})}}function z1(n,t){return n==="fraction"?`"1"/"${t}"`:n==="decimal"?`"${kt(1/t,2)}"`:`"${kt(1/t*100,1)}%"`}function Ro(n,t,e,s,i,o=1){let r=c("g",{class:"fraction"},i);if(n!=="fraction"&&t>12)return r;let a=t>20?12:t>16?14:18,h=c("g",{style:`font-size: ${a}px`,class:"equation"},r),l=new He(h,void 0,0,"",a,!0);l.setValue(z1(n,t));let p=l.root.width*o/2,u=l.root.height*o/2;return h.css("transform",`translate(${e-p}px, ${s-u}px)`+(o!==1?` scale(${o})`:"")),r}function Nu(n,t,e,s,i,o,r,a,h,l=1){let p=c("rect",{x:n,y:t,width:e,height:s,fill:r,class:"polygon-tile"},o);return a?[p,Ro(h,i,n+e/2,t+s/2,o,l)]:[p]}var Si=class extends k{constructor(t,e,s){super(e,s);this.type="fraction-bar";this.count=0;this.$parts=[];this.options=t;let[i,o,r]=t.split(":").map(a=>+a);this.denominator=i,this.tileWidth=10*Rt/i,this.$fraction=c("g",{},this.$el),this.$outline=c("path",{class:"outline"},this.$el),this.$handle=this.makeHandle("h",a=>this.setCount(Math.round((a.x+Rt/2)/this.tileWidth))),this.$dark=this.makeHandle("h",a=>this.setCount(this.count,Math.round((a.x+Rt/2)/this.tileWidth))),this.setCount(o,r!=null?r:o),this.setColour(os[(i-1)%os.length]),this.watch(a=>this.draw(!a.noLabels,a.labelType))}setCount(t,e){t=M(t,1,40),e=M(e!=null?e:this.dark===this.count?t:this.dark,0,t),!(t===this.count&&e===this.dark)&&(this.count=t,this.dark=e,this.value=e/this.denominator,this.options=`${this.denominator}:${t}:${e}`,this.draw(!this.$parent.options.noLabels,this.$parent.options.labelType),this.path=new S(new d(-Rt/2,-Rt/2),t*this.tileWidth,Rt),this.$outline.draw(this.path),this.$handle.setTransform(new d(t*this.tileWidth-Rt/2,-Rt/2)),this.$dark.setTransform(new d(this.dark*this.tileWidth-Rt/2,Rt/2)),this.$dark.setAttr("d",`M0 0V20L${this.dark?-20:20} 0Z`),this.transform(),this.$parent.selection.update())}select(){super.select(),Hs(...this.$parts.map(t=>t[1]))}deselect(){super.deselect(),Hs(...this.$parts.map(t=>t[1]))}setColour(t){super.setColour(t);let e=R(t),s=G.mix("#fff",e,.8).hex;for(let[i,o]of this.$parts.entries())o[0].setAttr("fill",i<this.dark?e:s);this.$fraction.css("color",G.from(e).brightness<220?"#fff":"#000")}draw(t,e){this.$fraction.removeChildren(),this.$parts=[];let s=G.mix("#fff",this.colour,.8).hex;for(let i=0;i<this.count;i+=1){let o=i<this.dark?this.colour:s;this.$parts.push(Nu(i*this.tileWidth-Rt/2,-Rt/2,this.tileWidth,Rt,this.denominator,this.$fraction,o,t,e))}this.customTransform(),Hs(...this.$parts.map(i=>i[1]))}customTransform(){var t;for(let e of this.$parts)(t=e[1])==null||t.css("transform",`rotate(${-this.rot}deg)`)}static makeThumbnail(t,e,s){let[i,o]=t.split(":").map(l=>+l),r=c("svg",{width:222,height:24},e),a=os[i-1],h=220/i;s.options.watch(l=>{r.removeChildren();let p=!l.noLabels,u=l.labelType,m=u!=="fraction"&&i>10?.44:.5;for(let g=0;g<o;++g)Nu(1+g*h,1,h,22,i,r,a,p,u,m)})}changeDenominator(t){for(let e=this.denominator+t;t>0?e<=24:e>=1;e+=t){let s=Math.round(this.count/this.denominator*e);if(!C(s,this.count/this.denominator*e))continue;let i=Math.round(this.dark/this.denominator*e);if(!!C(i,this.dark/this.denominator*e)){this.denominator=e,this.tileWidth=10*Rt/e,this.setCount(s,i),this.setColour(os[(e-1)%os.length]);return}}}getSnapPoints(){let t=[];for(let e=0;e<=this.count;e+=1)t.push(new d(e*this.tileWidth-Rt/2,-Rt/2)),t.push(new d(e*this.tileWidth-Rt/2,Rt/2));return t}split(){if(this.count===1)return[];let t=_(e=>{let s=this.posn.shift(e*this.tileWidth,0).rotate(this.rot*it,this.posn),i=new Si(`${this.denominator}:${1}`,this.$parent);return i.setTransform(s,this.rot),i.setColour(this.colour),i},this.count);return this.$parent.selection.select(t),this.delete(),t}static action(t,e){if(t==="split"){let s=[];for(let o of e)s.push(...o.split());let i=e.filter(o=>o.count>1);e[0].$parent.change({added:s,deleted:i})}else if(t==="expand"){for(let s of e)s.changeDenominator(1);e[0].$parent.change({changed:e})}else if(t==="reduce"){for(let s of e)s.changeDenominator(-1);e[0].$parent.change({changed:e})}else if(t==="merge"){let s=Array.from(e),i=Math.min(...s.map(l=>l.posn.x)),o=Math.min(...s.map(l=>l.posn.y)),r=s.map(l=>l.count),a=H(r),h=new Si(`${s[0].denominator}:${a}`,s[0].$parent);h.setColour(G.mixMany(s.map(l=>G.from(l.colour)),r).hex),h.setTransform(new d(i,o),s[0].rot);for(let l of e)l.delete();s[0].$parent.selection.add(h),e[0].$parent.change({added:[h],deleted:e})}}};var Ah=100,kh=class extends k{constructor(t,e,s){super(e,s);this.type="fraction-circle";this.rotateAroundOrigin=!0;this.options=t;let i={class:"polygon-tile",path:this.path,fill:this.colour};this.$path=c("path",i,this.$el),this.$outline=c("path",{class:"outline",path:this.path},this.$el);let o=this.denominator=+t;if(this.value=1/o,o>1){let r=new d(0,-Ah).rotate(-Math.PI/o),a=this.path=new ye(E,r,2*Math.PI/o);this.snapAngles=[0,ms(r)*Et,ms(a.end)*Et]}else this.path=new B(E,Ah);this.$path.draw(this.path),this.$outline.draw(this.path),this.watch(r=>this.draw(!r.noLabels,r.labelType)),o===1&&this.setOrder("back"),this.setColour(os[o-1]),this.$path.setAttr("fill",this.colour)}draw(t,e){var i;if((i=this.$label)==null||i.remove(),this.denominator===1||!t)return;let s=2-Ah/2-(this.denominator-2)*3;this.$label=Ro(e,this.denominator,0,s,this.$el),this.customTransform(),Hs(this.$label)}customTransform(){var t;(t=this.$label)==null||t.css("transform",`rotate(${-this.rot}deg)`)}select(){super.select(),Hs(this.$label)}deselect(){super.deselect(),Hs(this.$label)}setColour(t){super.setColour(t),this.$path.setAttr("fill",R(t)),this.$el.css("color",G.from(R(t)).brightness<220?"#fff":"#000")}static makeThumbnail(t,e,s){let i=+t,o=c("svg",{width:80,height:44},e),r=c("path",{class:"polygon-tile"},o),a=new d(40,2).rotate(-Math.PI/i,new d(40,42)),h=i>1?new ye(new d(40,42),a,2*Math.PI/i):new B(new d(40,22),20);if(r.draw(h),r.setAttr("fill",os[i-1]),i===1)return;let l;s.options.watch(p=>{l==null||l.remove();let u=!p.noLabels,m=p.labelType,g=26-(m==="fraction"?1.2:1.4)*i;u&&(l=Ro(m,i,40,g,o,.6-i/80))})}};var _e=25;function Oh(n,t,e,s,i){return new O(new d(-i,-i),new d(-i,n),new d(i,n),new d(i,-i),new d(t,-i),new d(t,i),new d(i,i),new d(i,e),new d(-i,e),new d(-i,i),new d(s,i),new d(s,-i))}var Lh=class extends k{constructor(t,e,s){super(e,s);this.type="grid";this.showSelectionOutline=!0;this.canDragToSelect=!1;this.options=t,this.dimensions=new d,this.$axes=_(()=>c("line",{class:"grid-axis",stroke:"#777"},this.$el),2),this.$fill=c("path",{fill:"transparent"},this.$el),this.$handles=[0,1].map(o=>this.makeHandle("c",r=>{let a=o?this.dimensions.x:Math.round(r.x/_e-1),h=o?Math.round(r.y/_e-1):this.dimensions.y;this.setDimensions(a,h)})),this.$handles[1].css("cursor","ns-resize");let i=t.split(":");this.setDimensions(+i[0],+i[1])}setDimensions(t,e){t=M(t,1,100),e=M(e,1,100),!(t===this.dimensions.x&&e===this.dimensions.y)&&(this.dimensions=new d(t,e),this.options=`${t}:${e}`,this.path=Oh(-1.5,t+1,e+1,-1.5,.5).scale(_e),this.$axes[0].setLine({x:-1.5*_e,y:0},{x:(t+1)*_e,y:0}),this.$axes[1].setLine({x:0,y:-1.5*_e},{x:0,y:(e+1)*_e}),this.$handles[0].setCenter({x:(t+1)*_e,y:0}),this.$handles[1].setCenter({x:0,y:(e+1)*_e}),this.$fill.draw(this.path),this.transform(),this.$parent.selection.update())}setColour(t){this.colour=t;for(let e of this.$axes)e.setAttr("stroke",R(t))}static makeThumbnail(t,e){let s=c("svg",{width:80,height:80},e);c("line",{x1:20,y1:0,x2:20,y2:80,stroke:"white","stroke-width":2},s),c("line",{x1:0,y1:20,x2:80,y2:20,stroke:"white","stroke-width":2},s)}};var rs=new Map,cn="";function Rh(n){var s,i,o;if(n.value!==void 0)return["",n.value,0,n.value,0];if(n.is("algebra-tile")){let r=n.options.startsWith("-")?-1:1,a=r<0?n.options.slice(1):n.options,h=(s=rs.get("x"))!=null?s:5,l=(i=rs.get("y"))!=null?i:4;switch(a){case"1":return["",r,0,r,0];case"x":return["x",r,0,r*h,h];case"x2":return["x",0,r,r*h*h,h];case"y":return["y",r,0,r*l,l];case"y2":return["y",0,r,r*l*l,l];case"xy":return["x",r*l,0,r*l*h,h]}}let t=btoa(n.type+n.options+n.colour).replace(/=/g,""),e=(o=rs.get(t))!=null?o:1;return[t,1,0,e,e]}function F1(n,t){let e={},s=0,i=(u,m=1)=>{let[g,b,w,y,$]=Rh(u);s+=m*y,!!g&&(e[g]||(e[g]=[0,0,0]),e[g][0]+=m*b,e[g][1]+=m*w,e[g][2]=$)};for(let u of n)i(u,1);for(let u of t)i(u,-1);if(C(s,0))return;let o=Object.keys(e).filter(u=>e[u][0]||e[u][1]),r=o.filter(u=>!rs.has(u))[0]||I(o);if(!r)return!0;let[a,h,l]=e[r],p=C(h,0)?l-s/a:Math.max(...rr(h,a,s-a*l-h*l*l));rs.set(r,p),cn=Array.from(rs.entries()).map(u=>u.join("=")).join(",")}function U1(n){if(n!==cn){cn=n,rs.clear();for(let t of n.split(",")){let[e,s]=t.split("=");e&&rs.set(e,+s||0)}}}var Io="M120,0C120,16,66.3,20,0,20S-120,16-120,0Z",Du="M0,26A18.1,18.1,0,0,0-18,44V72H18V44A18.1,18.1,0,0,0,0,26Z",Gu=["text","grid","number-line","spinner","decimal-grid","axes","custom-spinner","ruler","protractor","compass","geo","dot-machine","abacus","equation"],No=new S(new d(0,-180),240,180),qs=15;function Hu(n,t){var s;let e=n.posn.shift(0,t);n.$el.setTransform(e,n.rot*it),n.transformed=(s=n.path)==null?void 0:s.rotate(n.rot).translate(e)}var Ih=class extends k{constructor(t,e,s){super(e,s);this.type="balance";this.canRotate=!1;this.canDragToSelect=!1;this.level=0;this.left=[];this.right=[];this.isAnimating=!1;let[i,o]=t.split(":");this.level=+i||0,this.options=`${this.level}:${cn}`,t&&U1(o||""),this.$beam=c("path",{class:"balance-beam"},this.$el),this.$left=c("path",{d:Io,class:"balance"},this.$el),this.$right=c("path",{d:Io,class:"balance"},this.$el),this.$base=c("path",{d:Du,class:"balance"},this.$el),this.setColour("#bbb"),this.customTransform(),this.draw();let r=c("path",{path:No,class:"balance-target"},this.$el),a=c("path",{path:No,class:"balance-target"},this.$el);this.onMoveStart=()=>{if(!Ll(e.selection.tiles,h=>Gu.includes(h.type))){r.setTransform({x:-280,y:this.level*qs}),a.setTransform({x:40,y:-this.level*qs});for(let h of[r,a])h.show()}},this.onMoveEnd=()=>{for(let h of[r,a])h.hide()},this.onChange=h=>{h.action==="change"&&(this.checkTileOverlaps(),this.rebalance(400,h))},e.on("move-start",this.onMoveStart),e.on("move-end",this.onMoveEnd),setTimeout(()=>{this.checkTileOverlaps(),e.on("change",this.onChange)})}delete(){this.$parent.off("move-start",this.onMoveStart),this.$parent.off("move-end",this.onMoveEnd),this.$parent.off("change",this.onChange),super.delete()}checkTileOverlaps(){let t=No.translate(this.posn).shift(-280,this.level*qs),e=No.translate(this.posn).shift(40,-this.level*qs);this.left=[],this.right=[];for(let s of this.$parent.tiles.values())!s.transformed||s.type==="balance"||Gu.includes(s.type)||(Ki(t,s.transformed)?this.left.push(s):Ki(e,s.transformed)&&this.right.push(s))}draw(t=this.level){let e=new d(-160,t*15),s=new d(160,-t*15);this.$beam.draw(new be(e.shift(0,10),e.shift(0,44),s.shift(0,44),s.shift(0,10))),this.$left.setTransform(e),this.$right.setTransform(s)}rebalance(t=400,e){return P(this,null,function*(){let s=H(this.left.map(h=>Rh(h)[3])),i=H(this.right.map(h=>Rh(h)[3])),o=C(s,i)?0:s<i?-1:1;if(o===this.level||this.isAnimating)return;let r=this.level,a=(o-r)*qs;this.level=o;for(let h of this.left)h.setTransform(h.posn.shift(0,a));for(let h of this.right)h.setTransform(h.posn.shift(0,-a));if(e==null?void 0:e.data){let h=e.data.changed=e.data.changed||[],l=[...e.data.added||[],...e.data.deleted||[]];for(let p of[this,...this.left,...this.right])!h.includes(p)&&!l.includes(p)&&h.push(p)}this.options=`${o}:${cn}`,this.isAnimating=!0,yield z(h=>{this.draw(Ct(r,o,h));for(let l of this.left)Hu(l,(h-1)*a);for(let l of this.right)Hu(l,(1-h)*a);this.$parent.selection.update()},t).promise,this.isAnimating=!1,this.transform(),this.$parent.selection.update()})}customTransform(){let t=this.level*qs;this.path=new O(new d(-280,t),new d(-40,t),new d(-40,25),new d(40,25),new d(40,-t),new d(280,-t),new d(280,-t+48),new d(40,-t+48),new d(40,72),new d(-40,72),new d(-40,t+48),new d(-280,t+48))}getSnapPoints(){return[]}getSnapLines(){let t=this.level*qs;return[new Z(new d(-280,t),new d(-40,t)),new Z(new d(40,-t),new d(280,-t))]}setColour(t){this.colour=t,this.$beam.css("stroke",t);for(let e of[this.$base,this.$left,this.$right])e.css("fill",R(t))}static makeThumbnail(t,e){let s=c("svg",{width:250,height:50,viewBox:"-290 -10 580 82",class:"scale"},e);c("path",{d:"M-160 10v34h320v-34",fill:"transparent",stroke:"#bbb","stroke-width":10},s),c("path",{d:Io,transform:"translate(-160 0)",fill:"#bbb"},s),c("path",{d:Io,transform:"translate(160 0)",fill:"#bbb"},s),c("path",{d:Du,fill:"#bbb"},s)}static action(t,e){return P(this,null,function*(){let s=e[0];if(t!=="balance"||e.length!==1||!s.level)return;if(F1(s.left,s.right))return si("balance-error");let o=new Set;for(let r of s.$parent.tiles.values())if(!!r.is("balance")){r.rebalance();for(let a of[r,...r.left,...r.right])o.add(a)}e[0].$parent.change({changed:Array.from(o)})})}};var Nh={circle:"M -25 0a25,25 0 1 0 50 0a25 25 0 1 0 -50 0",square:"M0 -25L25 0L0 25L-25 0Z",cross:"M25 -9L9 -9L9 -25L-9 -25L-9 -9L-25 -9L-25 9L-9 9L-9 25L9 25L9 9L25 9L25 -9Z",weight:"M24.3,22.1,17.7-6.1A4,4,0,0,0,14-9H8a10.3,10.3,0,0,0,2-6A10,10,0,0,0,0-25,10,10,0,0,0-10-15,10.3,10.3,0,0,0-8-9h-6a4,4,0,0,0-3.7,2.9l-6.6,28.2A2.2,2.2,0,0,0-22,25H22A2.2,2.2,0,0,0,24.3,22.1ZM0-11a4,4,0,0,1-4-4,4,4,0,0,1,4-4,4,4,0,0,1,4,4A4,4,0,0,1,0-11Z",star:"M0 15.7L15.5 23.8L12.5 6.6L25 -5.6L7.7 -8.1L0 -23.8L-7.7 -8.1L-25 -5.6L-12.5 6.6L-15.5 23.8L0 15.7Z",heart:"M3.4,20.8a4.9,4.9,0,0,1-6.7-.1l-.3-.2C-16.7,8.6-25.3.8-25-8.9a13.7,13.7,0,0,1,5.9-10.7A14.4,14.4,0,0,1,0-16.8a14.4,14.4,0,0,1,19.1-2.8A13.7,13.7,0,0,1,25-8.9C25.3.8,16.7,8.6,3.6,20.5Z"},j1={weight:"M24.3,22.1,17.7-6.1A4,4,0,0,0,14-9H8a10.3,10.3,0,0,0,2-6A10,10,0,0,0,0-25,10,10,0,0,0-10-15,10.3,10.3,0,0,0-8-9h-6a4,4,0,0,0-3.7,2.9l-6.6,28.2A2.2,2.2,0,0,0-22,25H22A2.2,2.2,0,0,0,24.3,22.1Z"},qu={circle:f.orange,square:f.purple,cross:f.green,weight:f.blue,star:f.yellow,heart:f.red},Dh=class extends j{constructor(t,e,s){super("square",e,s);this.type="token";this.options=t,this.$path.setAttr("d",Nh[t]),this.$outline.setAttr("d",j1[t]||Nh[t]),this.setColour(qu[t])}static makeThumbnail(t,e){let s=c("svg",{width:36,height:36},e),i=c("path",{d:Nh[t],class:"polygon-tile"},s);i.setTransform({x:18,y:18},0,.6),i.setAttr("fill",qu[t])}};var Yt=19,dn=[[],[[0,0]],[[-.9,-.9],[.9,.9]],[[-1,-1],[0,0],[1,1]],[[-.9,-.9],[.9,-.9],[.9,.9],[-.9,.9]],[[-1,-1],[1,-1],[1,1],[-1,1],[0,0]],[[-.9,-1.1],[-.9,0],[-.9,1.1],[.9,-1.1],[.9,0],[.9,1.1]],[[0,-1.2],[0,0],[0,1.2],[1,-.6],[1,.6],[-1,-.6],[-1,.6]],[[0,-1.1],[0,1.1],[-1.1,-1.1],[-1.1,0],[-1.1,1.1],[1.1,-1.1],[1.1,0],[1.1,1.1]],[[0,-1.1],[0,0],[0,1.1],[-1.1,-1.1],[-1.1,0],[-1.1,1.1],[1.1,-1.1],[1.1,0],[1.1,1.1]]],Z1=new S(new d(-Yt,-Yt),2*Yt,2*Yt),Do=[[0,0],[0,Math.PI/2],[Math.PI/2,0],[-Math.PI/2,0],[0,-Math.PI/2],[Math.PI,0]],Gh=["#656073",f.teal,f.blue,f.purple,f.red,f.orange,f.yellow,f.lime,f.green,f.teal],de=class extends k{constructor(t,e,s){super(e,s);this.type="dice";this.isAnimating=!1;this.options=t;let[i,o]=t.split(":");this.faces=o||"1,2,3,4,5,6";let r=this.faces.split(",").map(a=>{let h=new Xt(Z1,{class:"dice-face",fill:Gh[+a],stroke:Gh[+a]}),l=dn[+a].map(p=>new Xt(new B(new d(p[0]*Yt/2,p[1]*Yt/2),4),{class:"dice-dot"}));for(let p of l)p.transform.translate(0,0,2);return new ne([h,...l])});r[0].transform.translate(0,0,Yt),r[1].transform.translate(-Yt,0,0).rotate(0,-Math.PI/2),r[2].transform.translate(0,Yt,0).rotate(-Math.PI/2,0),r[3].transform.translate(0,-Yt,0).rotate(Math.PI/2,0),r[4].transform.translate(Yt,0,0).rotate(0,Math.PI/2),r[5].transform.translate(0,0,-Yt).rotate(0,Math.PI),this.die=new ne(r,{},this.$el),this.die.sorting=!0,this.setValue(+i||ct.integer(1,6)),this.path=new S(new d(-25,-25),50,50),this.$outline=c("path",{class:"outline",path:this.path},this.$el)}setColour(t){this.colour=t==="#000"||t==="#000000"?"":t.slice(0,7);for(let e of this.die.children)e.children[0].color=R(this.colour);this.die.render()}setValue(t){this.value!==t&&(this.value=t,this.options=`${t}:${this.faces}`,this.die.transform.clear().rotate(...Do[t-1]),this.die.render())}roll(t=2e3){return P(this,null,function*(){if(this.isAnimating)return;this.isAnimating=!0;let e=ct.integer(1,6),s=Do[this.value-1],i=4*Math.PI+Do[e-1][0]-s[0],o=4*Math.PI+Do[e-1][1]-s[1];yield z(r=>{let a=X("sine",r);this.die.transform.clear().translate(0,0,4*a*(1-a)*Yt/2).rotate(s[0]+a*i,s[1]+a*o),this.die.render()},t).promise,this.setValue(e),this.isAnimating=!1})}static makeThumbnail(t,e){if(e.data.thumb==="net"){let s=c("svg",{width:58,height:76},e),i=t.split(":")[1].split(",").map(a=>+a),o=e.data.colour,r=[new d(20,2),new d(20,20),new d(20,38),new d(20,56),new d(2,20),new d(38,20)];for(let[a,h]of r.entries()){let l=o||Gh[+i[a]];c("path",{path:new S(h,18,18),class:"polygon-tile",fill:l},s);for(let p of dn[i[a]])c("circle",{cx:h.x+9+p[0]*4.5,cy:h.y+9+p[1]*4.5,r:1.8,class:"dice-dot"},s)}}else{let s=c("svg",{width:60,height:60},e);c("rect",{x:6,y:6,width:48,height:48,rx:3,class:"polygon-tile",fill:f.orange},s);for(let i of dn[5])c("circle",{cx:30+i[0]*12,cy:30+i[1]*12,r:5,class:"dice-dot"},s)}}doubleClick(){de.action("roll",[this])}static action(t,e){return P(this,null,function*(){t==="roll"&&(e[0].$parent.selection.clear(),yield Promise.all(e.map(s=>s.roll())),e[0].$parent.selection.tiles.size||e[0].$parent.selection.select(e),e[0].$parent.change({changed:e}))})}};var W1={1:"M-1.92 3.18V2.24H-0.5V-1.94H-1.67V-2.66C-1.15-2.74-0.65-2.92-0.2-3.18H0.66V2.24H1.91V3.18Z",2:"M-2.13 3.24V2.57C-1.04 1.37 0.53 0.37 0.75-1.23 0.78-2.65-0.89-2.56-1.53-1.62L-2.18-2.26C-1.23-3.5 1.07-3.69 1.72-2.09 2.36-0.32 0.62 1.1-0.44 2.33 0.43 2.26 1.3 2.24 2.18 2.26V3.24Z",3:"M-0.04 3.3C-0.86 3.34-1.65 3.01-2.2 2.4L-1.65 1.66C0.56 3.88 2.73 0.26-0.84 0.32V-0.52C2.13-0.44 0.64-3.74-1.4-1.79L-1.99-2.5C-1-3.49 1.1-3.71 1.83-2.34 2.03-1.92 2.04-1.45 1.85-1.03 1.67-0.61 1.31-0.29 0.87-0.16V-0.12C3.22 0.57 2.17 3.46-0.04 3.3Z",4:"M0.46 3.18V1.54H-2.34V0.76L0.18-3.18H1.55V0.65H2.35V1.54H1.55V3.18ZM-1.21 0.65H0.46C0.47-0.13 0.45-1.34 0.51-2.11H0.47C0.31-1.77 0.14-1.46-0.05-1.12Z",5:"M-0.03 3.24C-0.84 3.26-1.63 2.94-2.2 2.36L-1.67 1.62C-0.91 2.53 1.08 2.63 1.05 1.08 1.11-0.14-0.33-0.42-1.14 0.25L-1.69-0.1-1.5-3.24H1.9V-2.27H-0.5L-0.63-0.73C2.69-2.07 3.34 3.22-0.03 3.24Z",6:"M-0.78 3.3C-3.49 3.25-3.6-0.85-2.32-2.48-1.9-2.98-1.28-3.28-0.63-3.3 0.03-3.32 0.66-3.06 1.11-2.58L0.49-1.88C-0.96-3.24-2.1-1.59-2.02-0.01-1.71-0.43-1.23-0.7-0.72-0.75-0.2-0.8 0.32-0.63 0.71-0.28 1.85 0.94 1.02 3.38-0.78 3.3ZM-0.8 2.42C0.17 2.46 0.41 0.95-0.11 0.36-0.41 0.13-0.79 0.04-1.16 0.13-1.52 0.22-1.83 0.47-1.99 0.81-1.88 1.7-1.63 2.37-0.8 2.42ZM2.38 3.3C1.97 3.27 1.64 2.93 1.64 2.52 1.64 2.1 1.97 1.76 2.38 1.74 3.35 1.7 3.35 3.33 2.38 3.3Z",7:"M-0.89 3.18C-0.9 1.24-0.28-0.65 0.87-2.21H-2.13V-3.18H2.13V-2.48C0.84-0.89 0.17 1.13 0.28 3.18Z",8:"M0.01 3.3C-2.15 3.38-3.04 0.92-1.01-0.08V-0.12C-1.71-0.52-2.04-1.36-1.79-2.14-1.54-2.91-0.77-3.4 0.03-3.3 0.83-3.37 1.57-2.88 1.82-2.12 2.06-1.36 1.75-0.53 1.05-0.12V-0.08C3.03 0.9 2.12 3.43 0.01 3.3ZM0.03 2.48C0.38 2.52 0.72 2.36 0.91 2.06 1.11 1.77 1.13 1.39 0.96 1.08 0.57 0.68 0.08 0.38-0.46 0.24-1.49 0.87-1.34 2.51 0.02 2.48ZM0.43-0.41C1.17-1 1.18-2.49 0.02-2.48-0.3-2.49-0.59-2.33-0.75-2.06-0.9-1.79-0.91-1.46-0.75-1.19-0.46-0.81-0.04-0.54 0.42-0.41Z",9:"M-1.33 3.3C-1.97 3.31-2.59 3.05-3.03 2.58L-2.41 1.88C-0.96 3.23 0.2 1.59 0.11 0.01-0.27 0.53-0.9 0.81-1.55 0.74-2.19 0.66-2.74 0.25-2.99-0.35-3.27-0.99-3.21-1.72-2.84-2.31-2.46-2.9-1.83-3.27-1.13-3.3 2.17-3.26 1.88 3.36-1.33 3.3ZM-1.06-0.08C-0.58-0.12-0.15-0.39 0.08-0.82 0.07-1.94-0.89-2.96-1.79-2.11-2.32-1.48-2.12 0.01-1.06-0.08ZM2.41 3.3C2 3.28 1.67 2.94 1.67 2.52 1.67 2.11 2 1.76 2.41 1.74 3.38 1.71 3.38 3.33 2.41 3.3Z",10:"M-4.48 3.18V2.24H-3.06V-1.94H-4.23V-2.66C-3.71-2.74-3.21-2.92-2.76-3.18H-1.9V2.24H-0.65V3.18ZM2.27 3.3C-0.66 3.38-0.69-3.4 2.27-3.3 5.23-3.39 5.2 3.38 2.27 3.3ZM2.27 2.4C3.71 2.54 3.74-2.56 2.27-2.4 0.8-2.56 0.83 2.53 2.27 2.4Z",11:"M-4.38 3.18V2.24H-2.96V-1.94H-4.13V-2.66C-3.61-2.74-3.11-2.92-2.66-3.18H-1.8V2.24H-0.55V3.18ZM0.55 3.18V2.24H1.97V-1.94H0.8V-2.66C1.32-2.74 1.82-2.92 2.27-3.18H3.13V2.24H4.38V3.18Z",12:"M-4.43 3.24V2.3H-3.01V-1.88H-4.18V-2.6C-3.67-2.68-3.17-2.86-2.71-3.12H-1.85V2.3H-0.6V3.24ZM0.13 3.24V2.57C1.22 1.37 2.79 0.37 3.01-1.23 3.04-2.65 1.37-2.56 0.73-1.62L0.09-2.26C1.03-3.5 3.33-3.69 3.98-2.09 4.62-0.32 2.88 1.1 1.82 2.33 2.69 2.26 3.56 2.24 4.43 2.26V3.24Z",13:"M-4.41 3.18V2.24H-2.99V-1.94H-4.16V-2.66C-3.65-2.74-3.15-2.92-2.69-3.18H-1.83V2.24H-0.58V3.18ZM2.18 3.3C1.36 3.34 0.57 3.01 0.02 2.4L0.57 1.66C2.78 3.88 4.94 0.26 1.38 0.32V-0.52C4.34-0.44 2.86-3.74 0.82-1.79L0.23-2.5C1.21-3.49 3.31-3.71 4.04-2.34 4.24-1.92 4.25-1.45 4.07-1.03 3.88-0.61 3.53-0.29 3.09-0.16V-0.12C5.43 0.57 4.38 3.46 2.18 3.3Z",14:"M-4.53 3.18V2.24H-3.11V-1.94H-4.28V-2.66C-3.76-2.74-3.26-2.92-2.81-3.18H-1.95V2.24H-0.7V3.18ZM2.65 3.18V1.54H-0.16V0.76L2.36-3.18H3.73V0.65H4.53V1.54H3.73V3.18ZM0.98 0.65H2.65C2.65-0.13 2.64-1.34 2.7-2.11H2.66C2.5-1.77 2.32-1.46 2.14-1.12Z",15:"M-4.41 3.12V2.18H-2.99V-2H-4.16V-2.72C-3.65-2.8-3.15-2.98-2.69-3.24H-1.83V2.18H-0.58V3.12ZM2.19 3.24C1.37 3.26 0.59 2.94 0.02 2.36L0.55 1.62C1.3 2.53 3.29 2.63 3.27 1.08 3.33-0.14 1.88-0.42 1.07 0.25L0.52-0.1 0.71-3.24H4.11V-2.27H1.72L1.59-0.73C4.9-2.06 5.56 3.22 2.18 3.24Z",16:"M-4.47 3.18V2.24H-3.05V-1.94H-4.22V-2.66C-3.71-2.74-3.21-2.92-2.75-3.18H-1.89V2.24H-0.64V3.18ZM2.46 3.3C-0.24 3.25-0.35-0.85 0.92-2.48 1.34-2.98 1.96-3.28 2.61-3.3 3.27-3.32 3.9-3.06 4.35-2.58L3.73-1.88C2.29-3.24 1.14-1.59 1.22-0.01 1.54-0.43 2.01-0.7 2.53-0.75 3.05-0.8 3.56-0.63 3.95-0.28 5.09 0.94 4.26 3.39 2.46 3.3ZM2.44 2.42C3.41 2.46 3.65 0.95 3.13 0.36 2.84 0.13 2.45 0.04 2.09 0.13 1.72 0.22 1.41 0.47 1.25 0.81 1.36 1.7 1.61 2.37 2.45 2.42Z",17:"M-4.45 3.18V2.24H-3.03V-1.94H-4.2V-2.66C-3.68-2.74-3.18-2.92-2.73-3.18H-1.87V2.24H-0.62V3.18ZM1.42 3.18C1.42 1.24 2.04-0.65 3.19-2.21H0.18V-3.18H4.45V-2.48C3.15-0.89 2.49 1.13 2.59 3.18Z",18:"M-4.45 3.18V2.24H-3.03V-1.94H-4.2V-2.66C-3.68-2.74-3.18-2.92-2.73-3.18H-1.87V2.24H-0.62V3.18ZM2.31 3.3C0.16 3.38-0.74 0.92 1.3-0.08V-0.12C0.59-0.52 0.26-1.36 0.51-2.14 0.77-2.91 1.53-3.4 2.34-3.3 3.14-3.37 3.88-2.88 4.12-2.12 4.37-1.36 4.05-0.53 3.36-0.12V-0.08C5.33 0.9 4.42 3.43 2.31 3.3ZM2.33 2.48C2.68 2.52 3.02 2.36 3.22 2.06 3.41 1.77 3.43 1.39 3.26 1.08 2.88 0.68 2.39 0.38 1.85 0.24 0.82 0.87 0.96 2.51 2.33 2.48ZM2.73-0.41C3.47-1 3.48-2.49 2.32-2.48 2.01-2.49 1.72-2.33 1.56-2.06 1.4-1.79 1.39-1.46 1.55-1.19 1.85-0.81 2.26-0.54 2.73-0.41Z",19:"M-4.45 3.18V2.24H-3.03V-1.94H-4.2V-2.66C-3.68-2.74-3.18-2.92-2.73-3.18H-1.87V2.24H-0.62V3.18ZM1.91 3.3C1.27 3.31 0.65 3.05 0.21 2.58L0.83 1.88C2.28 3.23 3.44 1.59 3.35 0.01 2.97 0.53 2.33 0.81 1.69 0.74 1.05 0.66 0.5 0.25 0.24-0.35-0.03-0.99 0.03-1.73 0.4-2.31 0.77-2.9 1.41-3.27 2.11-3.3 5.4-3.26 5.12 3.36 1.91 3.3ZM2.18-0.08C2.66-0.12 3.09-0.39 3.32-0.82 3.3-1.94 2.35-2.96 1.45-2.11 0.91-1.48 1.12 0.01 2.18-0.08Z",20:"M-4.63 3.18V2.51C-3.54 1.31-1.98 0.31-1.75-1.29-1.73-2.71-3.4-2.62-4.04-1.68L-4.68-2.32C-3.74-3.56-1.44-3.75-0.79-2.15-0.15-0.38-1.88 1.04-2.95 2.27-2.08 2.2-1.21 2.18-0.33 2.2V3.18ZM2.48 3.3C-0.45 3.38-0.48-3.4 2.48-3.3 5.43-3.39 5.4 3.38 2.48 3.3ZM2.48 2.4C3.92 2.54 3.95-2.56 2.48-2.4 1.01-2.56 1.03 2.53 2.48 2.4Z"},Hh=40,qh={4:{net:$o,meshScale:.9,numberScale:.08,colour:f.red,thumbnailY:8,renderOptions:{fov:180,hideBackface:!0}},6:{net:xo,meshScale:.744,numberScale:.1,colour:f.yellow,renderOptions:{fov:120,hideBackface:!0}},8:{net:Po,meshScale:.85,numberScale:.07,colour:f.green,thumbnailY:3,renderOptions:{fov:180,hideBackface:!0}},12:{net:So,meshScale:.6,numberScale:.1,colour:f.blue,renderOptions:{fov:!1,hideBackface:!0}},20:{net:To,meshScale:.6,numberScale:.06,colour:f.purple,renderOptions:{fov:!1,hideBackface:!0}}};function _u(n,t){let e=qh[n],s=[],i=Yi(e.net,r=>{let a=new Xt(r.shape,{class:"polygon-tile",style:"stroke-width: 0.5"});a.color=R(e.colour),s.push(a);let h=new Xt(W1[s.length],{class:"dice-dot"});return h.transform.scale(U.all(e.numberScale)),new ne([a,h])}).group,o=i.children[0].children.map(r=>{let a=r.getTransformed(U.zero).fixFloat(),h=0;(a.x!=0||a.z!=0)&&(h=Math.atan2(a.z,a.x)-Math.PI/2);let l=a.transform(J.rotateY(h)),p=0;(l.y!=0||l.z!=0)&&(p=Math.atan2(l.y,l.z));let u=xt.product(J.rotateX(p),J.rotateY(h)),m=r.getTransformed(new U(1,0,0)).transform(u).fixFloat().xy,g=Math.atan2(-m.y,m.x);return new U(p,h,g)});return t.append(i.$el),{die:i,faces:s,rotationOptions:o}}var _h=class extends k{constructor(t,e,s){super(e,s);this.type="polyhedral-dice";this.isAnimating=!1;this.options=t;let[i,o]=t.split(":").map(h=>+h);i=i||0,i>=o&&(i=0),this.faceCount=o,this.definition=qh[o];let r=_u(o,this.$el);this.faces=r.faces,this.die=r.die,this.rotationOptions=r.rotationOptions,this.setValue(+i||ct.integer(1,o));let a=this.die.getProjectedVertices(this.definition.renderOptions);this.path=O.convexHull(...a),this.$outline=c("path",{class:"outline",path:this.path},this.$el)}setColour(t){super.setColour(t);for(let e of this.faces)e.color=R(this.colour);this.die.render(this.definition.renderOptions)}setValue(t){if(this.value===t)return;this.value=t,this.options=`${t}:${this.faceCount}`;let e=this.rotationOptions[this.value-1];this.die.transform.matrix=xt.product(J.rotateZ(e.z),J.rotateX(e.x),J.rotateY(e.y),J.scaleAll(this.definition.meshScale*Hh)),this.die.render(this.definition.renderOptions)}roll(t=2e3){return P(this,null,function*(){if(this.isAnimating)return;this.isAnimating=!0;let e=Math.floor(Math.random()*this.faceCount),s=this.rotationOptions[this.value-1],i=this.rotationOptions[e];yield z(o=>{o=X("sine",o),this.die.transform.matrix=xt.product(J.translate(new U(0,0,4*o*(1-o)*Hh/2)),J.rotateZ(s.z+(i.z-s.z)*o),J.rotateX(s.x+(i.x-s.x+4*Math.PI)*o),J.rotateY(s.y+(i.y-s.y+4*Math.PI)*o),J.scaleAll(this.definition.meshScale*Hh)),this.die.render(this.definition.renderOptions)},t).promise,this.setValue(e+1),this.isAnimating=!1})}doubleClick(){de.action("roll",[this])}static makeThumbnail(t,e){let s=+t.split(":")[1],i=qh[s],o=c("svg",{width:70,height:70},e),r=c("g",{transform:`translate(35, ${35+(i.thumbnailY||0)})`},o),a=_u(s,r),h=a.rotationOptions[a.rotationOptions.length-1];a.die.transform.matrix=xt.product(J.rotateZ(h.z),J.rotateX(h.x),J.rotateY(h.y),J.scaleAll(i.meshScale*32)),a.die.render()}};var K1="M0 7.4L8.6 12L7 2.4L13.9 -4.4L4.3 -5.8L0 -14.5L-4.3 -5.8L-13.9 -4.4L-7 2.4L-8.6 12L0 7.4",Bu="M12.9,9.7C13.9,3,4,5.3,4,1.2H4C9.4-3.7,7.6-14,.1-14.3S-9.3-3.9-4,1.3c-.1,3.8-9.8,1.9-8.9,8.4h0C-5.5,13.2,5.2,13.2,12.9,9.7Z",zu=23,X1=[f.red,f.blue],Y1=[K1,Bu],Bh=class extends k{constructor(t,e,s){super(e,s);this.type="coin";this.isAnimating=!1;let i=new B(E,zu),o=X1.map((r,a)=>{let h=new Xt(i,{class:"dice-face",fill:r,stroke:r}),l=new Xt(Y1[a],{class:"dice-dot"});return l.transform.translate(0,0,1),new ne([h,l])});o[0].transform.translate(0,0,.5),o[1].transform.rotate(Math.PI,0,0).translate(0,0,-.5),this.coin=new ne(o,{},this.$el),this.coin.sorting=!0,this.setValue(t?+t:ct.integer(0,1)),this.path=new B(E,25),this.$outline=c("path",{class:"outline",path:this.path},this.$el)}setValue(t){this.value!==t&&(this.value=t,this.options=""+t,this.coin.transform.clear().rotate(t?Math.PI:0,0,0),this.coin.render())}setColour(t){this.colour=t.slice(0,7)}roll(t=2e3){return P(this,null,function*(){if(this.isAnimating)return;this.isAnimating=!0;let e=ct.integer(0,1),s=this.value?Math.PI:0,i=6*Math.PI+(e?Math.PI:0)-s;yield z(o=>{let r=X("sine",o);this.coin.transform.clear().translate(0,0,4*r*(1-r)*zu).rotate(s+r*i,.4*Math.sin(r*8*Math.PI),0),this.coin.render()},t).promise,this.setValue(e),this.isAnimating=!1})}doubleClick(){de.action("roll",[this])}static makeThumbnail(t,e){let s=c("svg",{width:60,height:60},e);c("circle",{cx:30,cy:30,r:28,class:"polygon-tile",fill:f.blue},s),c("path",{d:Bu,class:"dice-dot"},s).setTransform({x:30,y:30},0,1.2)}};var zh=75,pn=2*Math.PI,un=Math.PI/2,Go="M9.8-39.1,0-63-9.8-39.1-3-43V60a2.9,2.9,0,0,0,3,3,2.9,2.9,0,0,0,3-3V-43Z";function fn(n,t,e,s=zh,i=E){let o=e?G.shades(e,t.length):G.rainbow(t.length);n.removeChildren();for(let[r,a]of t.entries()){let h=t[r+1]?t[r+1]-a:pn-a+t[0],l=new ye(i,d.fromPolar(a-un,s).add(i),h),p=o[r];c("path",{path:l,class:"polygon-tile",fill:p},n)}}var mn=class extends k{constructor(t,e,s){super(e,s);this.type="spinner";this.angle=0;this.isAnimating=!1;this.path=new B(E,zh),this.$sectors=c("g",{},this.$el),this.$arrow=c("path",{d:Go,class:"spinner"},this.$el),this.$outline=c("path",{class:"outline",path:this.path},this.$el),this.setupHandles(),c("circle",{r:4,class:"spinner"},this.$el),e.events.listen(this.$arrow,{move:({posn:r})=>{let a=this.relativePosn(r).angle()+un;this.$arrow.setTransform(void 0,a)},end:({lastPosn:r})=>{let a=this.relativePosn(r).angle()+un;this.setValue(a*Et)},click:()=>this.roll()}),this.$arrow.css("cursor","pointer");let[i,o]=t.split(":");this.drawSectors(+o),this.setValue(+i||0)}setupHandles(){this.$handle=this.makeHandle("c",t=>{let e=(t.angle()+un)%pn;this.drawSectors(pn/e)}),this.$handle.css("cursor","move")}drawSectors(t){let e=M(Math.round(t),2,16);if(e===this.sectors)return;this.sectors=e,this.options=`${this.angle}:${e}`;let s=pn/e;fn(this.$sectors,_(i=>s*i,e),this.colour),this.$handle.setCenter(d.fromPolar(s-un,zh))}setColour(t){this.colour=t;let e=this.$sectors.children,s=G.shades(t,e.length);for(let[i,o]of e.entries())o.setAttr("fill",s[i])}setValue(t){t=$t(Math.round(t),360),this.angle!==t&&(this.angle=t,this.options=`${t}:${this.sectors}`,this.$arrow.setTransform(void 0,this.angle*it))}roll(t=2e3){return P(this,null,function*(){if(this.isAnimating)return;this.isAnimating=!0;let e=this.angle,s=(4+Math.random())*360;yield z(i=>{let o=Ct(e,s,X("sine",i));this.$arrow.setTransform(void 0,o*it)},t).promise,this.setValue(s),this.isAnimating=!1})}doubleClick(){de.action("roll",[this])}static makeThumbnail(t,e){let s=c("svg",{width:80,height:80},e),i=new d(40,40);fn(s,_(r=>pn/5*r,5),"",36,i),c("path",{d:Go,class:"spinner"},s).setTransform(i,-.8,.5)}};var J1=2*Math.PI,Fh=Math.PI/2,Uh=75,jh=class extends mn{constructor(t,e,s){super(`${t.split(":")[0]}:1`,e,s);this.type="custom-spinner";this.$handles=[];for(let i of t.split(":")[1].split(","))this.makeVertex(d.fromPolar(+i*it-Fh,Uh))}setupHandles(){let t;this.$parent.events.listen(this.$outline,{down:({posn:e})=>t=this.makeVertex(this.relativePosn(e)),move:({posn:e})=>this.moveVertex(this.relativePosn(e),t),end:()=>this.$parent.change({changed:[this]})}),this.$outline.css("cursor","crosshair")}drawSectors(){if(!this.$handles||this.$handles.length<2)return;let t=this.$handles.map(s=>(s.center.angle()+Fh)%J1).sort();this.sectors=t.map(s=>Math.round(s*Et)).join(",");let e=`${this.angle}:${this.sectors}`;e!==this.options&&(this.options=e,fn(this.$sectors,t,this.colour))}makeVertex(t){if(this.$handles.length>=24)return;let e=this.makeHandle("c",s=>{!e||(s.length>2*Uh?(this.deleteVertex(e),e=void 0):this.moveVertex(s,e))},()=>{e&&this.deleteVertex(e)});return e.setAttr("r",8),e.css("cursor","move"),this.$handles.push(e),this.moveVertex(t,e),e}deleteVertex(t){this.$handles.length<=2||(t.remove(),this.$handles.splice(this.$handles.indexOf(t),1),this.drawSectors())}moveVertex(t,e){if(!e)return;let s=st(t.angle()*Et,10)*it;e.setCenter(d.fromPolar(s,Uh)),this.drawSectors()}static makeThumbnail(t,e){let s=c("svg",{width:80,height:80},e),i=new d(40,40),o=t.split(":")[1].split(",").map(a=>+a*it);fn(s,o,"",36,i),c("path",{d:Go,class:"spinner"},s).setTransform(i,.4,.5);for(let a of o){let h=d.fromPolar(a-Fh,36).add(i);c("circle",{cx:h.x,cy:h.y,r:3,fill:"white"},s)}}};var pe=50;function Ho(n,t,e,s=0,i=0){for(let o of dn[t]){let r=o[0]*.23*e+e/2+s,a=o[1]*.23*e+e/2+i;c("circle",{cx:r,cy:a,r:e/10,class:"dice-dot"},n)}}var Zh=class extends k{constructor(t,e,s){super(e,s);this.type="domino";this.options=t,this.path=new S(E,pe,pe*2),this.$mainShape=c("rect",{class:"polygon-tile",rx:5},this.$el),c("line",{x1:0,y1:pe,x2:pe,y2:pe,class:"polygon-tile"},this.$el);let[i,o]=t.split(":").map(r=>+r);Ho(this.$el,i,pe,0,0),Ho(this.$el,o,pe,0,pe),this.value=i+o,this.$outline=c("rect",{class:"outline",rx:5},this.$el),this.$mainShape.setRect(this.path),this.$outline.setRect(this.path),this.transform(),this.setColour(f.teal)}getSnapPoints(){return[...super.getSnapPoints(),new d(0,pe),new d(pe,pe)]}setColour(t){super.setColour(t),this.$mainShape.setAttr("fill",R(t))}static makeThumbnail(t,e){let s=30,i=c("svg",{width:s+4,height:s*2+4},e);c("rect",{x:2,y:2,width:s,height:s*2,rx:2,class:"polygon-tile",fill:f.teal},i),c("line",{x1:2,y1:s+2,x2:s+2,y2:s+2,class:"polygon-tile"},i);let[o,r]=t.split(":").map(a=>+a);Ho(i,o,s,2,2),Ho(i,r,s,2,2+s)}};var Fu=[f.red,f.blue,f.green,f.yellow,f.purple,f.orange,f.lime],_s=class extends k{constructor(t,e,s){super(e,s);this.focussedSeries=-1;this.default=!0;this.chartOptions=Dt({}),t&&Object.assign(this.chartOptions,JSON.parse(t)),this.chartColors=this.chartOptions.colours||[],this.chartOptions.watchAll(()=>this.options=JSON.stringify(this.chartOptions)),this.$series=c("g",{},this.$el),this.$outline=c("path",{class:"outline"},this.$el),e.events.listen(this.$el,{click:i=>this.focusOnSeries(i),checkIfActive:()=>this.focussedSeries>=0})}setColour(t,e){let s=this.focussedSeries;if(s>=0&&e==="picker"){if(this.chartColors[s]===t)return;this.chartColors[s]=t,this.colorSeries(R(t),s),this.chartOptions.colours=this.chartColors.slice(0),this.$parent.change({changed:[this]})}else e==="theme"||super.setColour(t)}getSeriesColor(t){if(this.default)return f.grey;let e=this.chartColors[t]||Fu[t%Fu.length];return R(e)}doubleClick(t){this.focussedSeries>=0||(this.focusOnSeries(t),!(this.focussedSeries<0)&&(this.$parent.options.focussed=this,this.$el.addClass("chart-focussed"),this.$parent.selection.clear()))}focusOnSeries(t){let e=t.event.target.getAttribute("series-idx")||this.findClosestElement(t);!e||(this.focussedSeries=+e,this.focusSeries(+e))}findClosestElement(t){return""}blur(){this.focussedSeries<0||(this.focussedSeries=-1,this.$el.removeClass("chart-focussed"),this.$parent.options.focussed=void 0)}};function gn(n){n=n.filter((e,s)=>!s||e.some(i=>i));let t=n[0].map((e,s)=>n.some((i,o)=>o>0&&i[s]));return n.map(e=>e.filter((s,i)=>t[i]))}function Uu(n){if(n=gn(n),!n.length||!n[0].length)return[[],[]];n[0].length===1&&(n=n.map((i,o)=>[`${o}`,i[0]]));let t=n.slice(1),e=t.map(i=>i[0]),s=n[0].slice(1).map((i,o)=>({label:i,data:t.map(r=>+r[o+1]||0)}));return[e,s]}function ju(n,t,e=!0){let s=n[0].data.length,i=[];for(let o=0;o<s;++o){let r=[];if(t==="grouped")for(let a of n)r.push([0,a.data[o]]);else if(e){let a=0,h=0,l=n.map(u=>u.data[o]),p=t==="percentage"?99.99/H(l):1;for(let u of l)u<0?(r.push([a,a+u*p]),a+=u*p):(r.push([h,h+u*p]),h+=u*p)}else{let a=0,h=n.map(p=>p.data[o]),l=t==="percentage"?99.99/H(h):1;for(let p of h)r.push([a,a+p*l]),a+=p*l}i.push(r)}return i}var Me=class{constructor(t){this.makeNew=t;this.stack=[]}get(t){return this.stack[t]||(this.stack[t]=this.makeNew()),this.stack[t]}};var Q1=["A","B","C"],tw=[[10,20,30],[30,10,40],[20,25,10]].map(n=>({label:"",data:n})),Wh=class extends _s{constructor(t,e,s){super(t,e,s);this.type="chart";this.colour=f.darkGrey;this.tables=[];this.categories=[];this.series=[];this.$rects=new Me(()=>c("rect",{class:"polygon-tile"}));this.$areas=new Me(()=>c("polygon",{opacity:.5}));this.$lines=new Me(()=>c("polyline",{class:"chart-line"}));this.$points=new Me(()=>c("circle",{r:5}));this.$background=c("path",{fill:"transparent"},this.$el),this.$el.prepend(this.$background),this.$axes=c("path",{class:"grid-axis",stroke:f.darkGrey},this.$el),this.$labels=c("g",{class:"axis-labels"},this.$el),this.$foreground=c("g",{},this.$el),this.$handle=this.makeHandle("c",i=>{this.chartOptions.height=Math.max(st(-i.y,25),100),this.chartOptions.width=Math.max(st(i.x,25),100)}),this.$handle.css("cursor","nesw-resize"),this.chartOptions.watch(({type:i,layout:o,width:r,height:a})=>{this.updateOutline(r,a),this.drawChart(i,o)})}reconcileSeries(){var t,e;this.categories=((t=this.tables[0])==null?void 0:t.categories.slice(0))||[],this.series=((e=this.tables[0])==null?void 0:e.series.map(s=>({label:s.label,data:s.data.slice(0)})))||[];for(let s of this.tables.slice(1)){let i=this.categories.length,o=this.series.length;for(let r of s.series)this.series.push({label:r.label,data:Nt(0,i)});for(let[r,a]of s.categories.entries()){let h=this.categories.indexOf(a);if(h<0){this.categories.push(a);for(let l of this.series)l.data.push(0);h=this.categories.length-1}for(let[l,p]of s.series.entries())this.series[o+l].data[h]=p.data[r]}}}link(t){if(super.link(t),!t.source.is("table"))return;let[e,s]=Uu(t.source.visibleData),i=this.tables.find(o=>o.table===t.source);i?Object.assign(i,{categories:e,series:s}):this.tables.push({table:t.source,categories:e,series:s}),this.reconcileSeries(),this.drawChart(this.chartOptions.type,this.chartOptions.layout)}unlink(t){super.unlink(t),this.tables=this.tables.filter(e=>e.table!==t.source),this.reconcileSeries(),this.drawChart(this.chartOptions.type,this.chartOptions.layout)}updateOutline(t=400,e=250){this.path=new S(E.shift(0,-e),t,e),this.$background.draw(this.path),this.$outline.draw(this.path),this.$handle.setCenter({x:t,y:-e}),this.transform(),this.$parent.selection.update()}getX(t){return(t-this.bounds.xMin)/this.bounds.dx*this.path.w}getY(t){return(t-this.bounds.yMin)/this.bounds.dy*this.path.h}drawChart(t="column",e="grouped"){this.$series.removeChildren(),this.$foreground.removeChildren();let s=["line","area"].includes(t);this.default=!this.series.length;let i=this.default?tw:this.series,o=this.default?Q1:this.categories,r=ju(i,e,!s),a=Math.min(0,...r.map(b=>Math.min(...b.map(w=>w[1])))),h=Math.max(0,...r.map(b=>Math.max(...b.map(w=>w[1])))),l=t==="row"?this.path.w:this.path.h,p=es("",l,[a,h],0),u=[0,o.length-1,1],m=s&&!o.some(b=>isNaN(+b)),g=m?o.map(b=>+b):void 0;if(m){let b=Math.min(...g),w=Math.max(...g);u=es("",this.path.w,[b,w],0)}t==="row"&&([p,u]=[u,p]),this.bounds=new pt(u[0],u[1],p[0],p[1]),t==="column"?this.drawColumnChart(r,e):t==="row"?this.drawRowChart(r,e):(t==="area"&&this.drawAreas(r,g),this.drawLines(r,g),t==="line"&&this.drawPoints(r,g)),this.drawAxes(t,this.path.w,this.path.h,u[2],p[2],m?void 0:o)}drawAxes(t,e,s,i,o,r){var h;this.$labels.removeChildren();let a=`M0 0v${-s}M0 0h${e}`;if(lt(0,this.bounds.yMin,this.bounds.yMax)&&(a+=`M0 ${-this.getY(0)}h${e}`),lt(0,this.bounds.xMin,this.bounds.xMax)&&(a+=`M${this.getX(0)} 0 v${-s}`),t==="column"&&r){let l=r.length?e/r.length:0;for(let p=0;p<=r.length;++p){let u=p*l;a+=`M${u} 0L${u} 5`,c("text",{text:r[p],x:u+l/2,y:21,"text-anchor":"middle"},this.$labels)}}else for(let l=this.bounds.xMin;l<=this.bounds.xMax;l+=i){let p=this.getX(l);a+=`M${p},0v5`;let u=t==="row"?ot(l,4):(h=r==null?void 0:r[l])!=null?h:ot(l,4);c("text",{text:u,x:p,y:21,"text-anchor":"middle"},this.$labels)}if(t==="row"&&r){let l=r.length?s/r.length:0;for(let p=0;p<=r.length;++p){let u=-p*l;a+=`M0 ${u}h-5`,c("text",{text:r[p],x:-12,y:u-l/2+5,"text-anchor":"end"},this.$labels)}}else for(let l=this.bounds.yMin;l<=this.bounds.yMax;l+=o){let p=this.getY(l);a+=`M0 ${-p}h-5`;let u=ot(l,4);c("text",{text:u,x:-10,y:-p+5,"text-anchor":"end"},this.$labels)}this.$axes.setAttr("d",a)}drawColumnChart(t,e){let s=t.length,i=t[0].length,o=this.path.w/s,r=o/4,a=o-r,h=e==="grouped";h&&(a/=i);for(let l=0;l<i;++l)for(let p=0;p<s;++p){let u=t[p][l],m=p*o+r/2+(h?l*a:0),g=[-this.getY(u[0]),-this.getY(u[1])],b=Math.abs(g[1]-g[0]);this.drawRect(l*s+p,l,m,Math.min(...g),a,b)}}drawRowChart(t,e){let s=t.length,i=t[0].length,o=this.path.h/s,r=o/4,a=o-r,h=e==="grouped";h&&(a/=i);for(let l=0;l<i;++l)for(let p=0;p<s;++p){let u=t[p][l],m=p*o+r/2+(h?l*a:0),g=[this.getX(u[0]),this.getX(u[1])],b=Math.abs(g[1]-g[0]);this.drawRect(l*s+p,l,Math.min(...g),-(m+a),b,a)}}drawRect(t,e,s,i,o,r){let a=this.$rects.get(t);this.$series.append(a),a.setAttr("fill",this.getSeriesColor(e)),a.setAttr("x",s),a.setAttr("y",i),a.setAttr("width",o),a.setAttr("height",r),a.setAttr("series-idx",e)}drawLines(t,e){let s=t[0].length;for(let i=0;i<s;++i){let o=t.map((a,h)=>{var l;return`${this.getX((l=e==null?void 0:e[h])!=null?l:h)} ${-this.getY(a[i][1])}`}).join(" "),r=this.$lines.get(i);r.setAttr("stroke",this.getSeriesColor(i)),r.setAttr("points",o),r.setAttr("series-idx",i),this.$series.append(r)}}drawPoints(t,e){var o;let s=t[0].length,i=t.length;for(let r=0;r<s;++r)for(let a=0;a<i;++a){let h=this.$points.get(r*i+a);h.setCenter({x:this.getX((o=e==null?void 0:e[a])!=null?o:a),y:-this.getY(t[a][r][1])}),h.setAttr("fill",this.getSeriesColor(r)),h.setAttr("series-idx",r),this.$foreground.append(h)}}drawAreas(t,e){let s=t[0].length;for(let i=0;i<s;++i){let o=t.map((h,l)=>{var p;return`${this.getX((p=e==null?void 0:e[l])!=null?p:l)} ${-this.getY(h[i][1])}`}).join(" "),r=t.map((h,l)=>{var p;return`${this.getX((p=e==null?void 0:e[l])!=null?p:l)} ${-this.getY(h[i][0])}`}).reverse().join(" "),a=this.$areas.get(i);a.setAttr("fill",this.getSeriesColor(i)),a.setAttr("points",o+" "+r),a.setAttr("series-idx",i),this.$series.append(a)}}setColour(t,e){super.setColour(t,e),this.focussedSeries<0&&(this.$labels.setAttr("fill",R(t)),this.$axes.setAttr("stroke",R(t)))}colorSeries(t,e){var s,i,o,r;if(!!this.series.length){(s=this.$lines.stack[e])==null||s.setAttr("stroke",t),(i=this.$areas.stack[e])==null||i.setAttr("stroke",t),(o=this.$areas.stack[e])==null||o.setAttr("fill",t),e===this.focussedSeries&&((r=this.$focussedLine)==null||r.setAttr("stroke",t));for(let a of this.$series.$$(`rect[series-idx="${e}"]`))a.setAttr("fill",t);for(let a of this.$foreground.$$(`circle[series-idx="${e}"]`))a.setAttr("fill",t)}}focusSeries(t){if(this.chartOptions.type==="line"){this.$focussedLine||(this.$focussedLine=c("polyline",{class:"chart-shadow"}),this.$background.insertAfter(this.$focussedLine)),this.$focussedLine.setAttr("points",this.$lines.get(t).attr("points")),this.$focussedLine.setAttr("stroke",this.getSeriesColor(t)),this.$focussedLine.show();return}if(this.$focussedOutline||(this.$focussedOutline=c("path",{class:"chart-outline"},this.$el)),this.chartOptions.type==="area"){let e=js(this.$areas.get(t).attr("points").split(" "),2),s="M"+e.map(i=>i.join(" ")).join("L")+"Z";this.$focussedOutline.setAttr("d",s)}else{let e=this.$rects.stack.filter(i=>+i.attr("series-idx")===t&&i.css("display")),s="";for(let i of e){let o=+i.attr("height");if(C(0,o))continue;let r=i.attr("width");s+=`M${i.attr("x")} ${i.attr("y")}h${r}v${o}h${-r}Z`}this.$focussedOutline.setAttr("d",s)}this.$focussedOutline.show()}blur(){var t,e;super.blur(),(t=this.$focussedOutline)==null||t.hide(),(e=this.$focussedLine)==null||e.hide()}findClosestElement(t){var i;if(this.chartOptions.type!=="line"&&this.chartOptions.type!=="area")return"";let e=this.relativePosn(t.posn),s=this.$lines.stack.slice(0,this.series.length);return((i=ps(s,o=>{let r=js(o.attr("points").split(" "),2).map(([h,l])=>new d(+h,+l)),a=new be(...r);return d.distance(e,a.project(e))}))==null?void 0:i.attr("series-idx"))||""}static action(t,e){return P(this,null,function*(){if(["line","area","column","row"].includes(t)){let s=e.filter(i=>i.chartOptions.type!==t);for(let i of s)i.chartOptions.type=t;s.length&&s[0].$parent.change({changed:s})}else if(["grouped","stacked","percentage"].includes(t)){let s=e.filter(i=>i.chartOptions.layout!==t);for(let i of s)i.chartOptions.layout=t;s.length&&s[0].$parent.change({changed:s})}})}};var ew=[2,4,5],Kh=class extends _s{constructor(t,e,s){super(t,e,s);this.type="pie-chart";this.series=[];this.$sectors=new Me(()=>c("path",{class:"polygon-tile"}));this.$focussedOutline=c("path",{class:"chart-outline"},this.$el),this.$handle=this.makeHandle("c",i=>{this.chartOptions.width=M(st(i.length,25),50,300)}),this.$handle.css("cursor","ew-resize"),this.chartOptions.watch(({type:i,width:o})=>{this.updateOutline(o),this.drawChart(i||"pie",o)})}link(t){var i;if(super.link(t),!t.source.is("table"))return;this.currentLink!==t&&((i=this.currentLink)==null||i.delete());let e=gn(t.source.visibleData).slice(1),s=e[0].length>1?1:0;this.series=e.map(o=>Math.abs(+o[s]||0)),this.drawChart(this.chartOptions.type,this.chartOptions.width)}unlink(t){super.unlink(t),this.series=[],this.drawChart(this.chartOptions.type,this.chartOptions.width)}updateOutline(t=100){this.path=new B(E,t),this.$outline.draw(this.path),this.$handle.setTransform({x:t,y:0}),this.transform(),this.$parent.selection.update()}drawChart(t,e=100){var a,h;this.default=!this.series.length;let s=this.default?ew:this.series,i=H(s),o=s.map(l=>l/i*2*Math.PI);this.$series.removeChildren();let r=-Math.PI/2;for(let[l,p]of o.entries()){let u=this.$sectors.get(l);this.$series.append(u),u.setAttr("fill",this.getSeriesColor(l)),u.setAttr("series-idx",l),u.draw(new ye(E,d.fromPolar(r,e),p)),r+=p}t==="donut"&&!this.$donutHole&&(this.$donutHole=c("circle",{fill:"white",class:"donut-hole"},this.$el)),(a=this.$donutHole)==null||a.setAttr("r",e/2),(h=this.$donutHole)==null||h.toggle(t==="donut")}colorSeries(t,e){!this.series.length||this.$sectors.get(e).setAttr("fill",t)}focusSeries(t){this.$focussedOutline.setAttr("d",this.$sectors.get(t).attr("d")),this.$focussedOutline.show()}blur(){super.blur(),this.$focussedOutline.hide()}static action(t,e){return P(this,null,function*(){if(["pie","donut"].includes(t)){let s=e.filter(i=>i.chartOptions.type!==t);for(let i of s)i.chartOptions.type=t;s.length&&s[0].$parent.change({changed:s})}})}};var sw=[[1,2,3,4,5]].map(n=>({label:"",data:n}));function iw(n,t=!1){let e=Xs(n,.25),s=Xs(n,.75),i=1.5*(s-e),o=t?n.filter(l=>lt(l,e-i,s+i)):n,r=Math.min(...o);e=Xs(o,.25);let a=Xs(o,.5);s=Xs(o,.75);let h=Math.max(...o);return[r,e,a,s,h]}var Xh=class extends _s{constructor(t,e,s){super(t,e,s);this.type="box-whisker";this.colour=f.darkGrey;this.$boxPlots=new Me(()=>c("path",{class:"chart-line"}));this.range=[0,5];this.series=[];this.tables=[];this.$background=c("path",{fill:"transparent"}),this.$el.prepend(this.$background),this.$axis=c("path",{class:"grid-axis",stroke:f.darkGrey},this.$el),this.$labels=c("g",{class:"axis-labels"},this.$el),this.$focussedOutline=c("path",{class:"chart-shadow"},this.$el),this.$handle=this.makeHandle("h",i=>{this.chartOptions.width=Math.max(st(i.x,25),100)}),this.chartOptions.watch(({width:i})=>{this.updateOutline(i),this.drawChart()})}drawChart(){this.default=!this.series.length;let t=this.default?sw:this.series;this.$series.removeChildren(),this.range[0]=Math.min(...t.map(e=>Math.min(...e.data))),this.range[1]=Math.max(...t.map(e=>Math.max(...e.data))),t.forEach((e,s)=>this.drawBoxWhiskerPlot(e.data,s,-25-50*s)),this.drawAxes(t)}drawBoxWhiskerPlot(t,e,s){let i=this.$boxPlots.get(e),o=this.chartOptions.layout==="outliers",[r,a,h,l,p]=iw(t,o).map(b=>this.getX(b)),u=16,m=10,g=`M${r} ${s+m}V${s-m}M${r} ${s}H${a}V${s+u}H${l}V${s-u}H${a}V${s}M${h} ${s+u}V${s-u}M${l} ${s}H${p}M${p} ${s+m}V${s-m}`;if(o){let b=t.map(w=>this.getX(w)).filter(w=>w<r||w>p);for(let w of b)g+=$e(new B(new d(w,s),4))}i.setAttr("d",g),i.setAttr("series-idx",e),i.setAttr("stroke",this.getSeriesColor(e)),this.$series.append(i)}drawAxes(t){this.$labels.removeChildren();let e=es("",this.path.w,this.range,0),s=`M 0 0 h ${this.path.w}`;for(let i=this.range[0];i<=this.range[1]+.001;i+=e[2]){let o=this.getX(i);s+=`M${o},0v5`,c("text",{text:ot(i,4),x:o,y:21,"text-anchor":"middle"},this.$labels)}this.$axis.setAttr("d",s),t.forEach((i,o)=>{let r=-25-50*o,a=i.label;c("text",{text:a,x:-14,y:r,"text-anchor":"end"},this.$labels)})}updateOutline(t=this.chartOptions.width||300){let e=(this.series.length||1)*50;this.path=new S(E.shift(0,-e),t,e),this.$outline.draw(this.path),this.$background.draw(this.path),this.$handle.translate(t,-e),this.transform(),this.$parent.selection.update()}colorSeries(t,e){this.$boxPlots.get(e).setAttr("stroke",t),this.$focussedOutline.setAttr("stroke",t)}getX(t){return(t-this.range[0])/(this.range[1]-this.range[0])*this.path.w}setColour(t,e){super.setColour(t,e),this.focussedSeries<0&&(this.$labels.setAttr("fill",R(t)),this.$axis.setAttr("stroke",R(t)))}link(t){super.link(t),!!t.source.is("table")&&(this.tables.includes(t.source)||this.tables.push(t.source),this.buildSeries(),this.drawChart(),this.updateOutline())}unlink(t){super.unlink(t),!!t.source.is("table")&&(this.tables=this.tables.filter(e=>e!==t.source),this.buildSeries(),this.drawChart(),this.updateOutline())}buildSeries(){this.series=[];for(let t of this.tables){let e=gn(t.visibleData).slice(1);if(!!e.length)for(let s=0;s<e[0].length;s++){let i=e.map(o=>parseInt(o[s])).filter(o=>!Number.isNaN(o));this.series.push({label:t.visibleData[0][s],data:i})}}}focusSeries(t){this.$focussedOutline.setAttr("d",this.$boxPlots.get(t).attr("d")),this.$focussedOutline.setAttr("stroke",this.getSeriesColor(t)),this.$focussedOutline.show()}blur(){super.blur(),this.$focussedOutline.hide()}findClosestElement(t){let e=Math.round((this.relativePosn(t.posn).y+25)/50);return""+M(-e,0,this.series.length-1)}static action(t,e){return P(this,null,function*(){if(t==="outliers")for(let s of e)s.chartOptions.layout=s.chartOptions.layout===t?void 0:t})}static makeThumbnail(t,e){let[s,i]=[180,45],[o,r,a,h,l]=[0,1,2,3,4].map(y=>5+y/4*170),[p,u,m]=[i/2,14,8],g=c("svg",{width:s,height:i},e),b=c("path",{class:"chart-line",stroke:"white",style:"stroke-width: 2px"},g),w=`M${o} ${p-m} V ${p+m}M${o} ${p} H ${r}V${p-u}H${h} V ${p+u}H${r} V ${p}M${a} ${p-u} V ${p+u}M${h} ${p}H${l}M${l} ${p-m}V${p+m}`;b.setAttr("d",w)}};var Zu=`<h3>Coordinate System</h3><div class="row"><div class="label">X Axis:</div><button class="increment" @click="step('xStep', -1)">\u2013</button><input class="input-field" type="number" :bind="xStep" min="0" style="width: 45px"><button class="increment" @click="step('xStep', 1)">+</button></div><div class="row"><div class="label">Y Axis:</div><button class="increment" @click="step('yStep', -1)">\u2013</button><input class="input-field" type="number" :bind="yStep" min="0" style="width: 45px"><button class="increment" @click="step('yStep', 1)">+</button></div>`;var At=50,Wu=class{constructor(t){this.promises=new Map;this.worker=new Worker(t),this.worker.onmessage=e=>{var s;return(s=this.promises.get(e.data[0]))==null?void 0:s(e.data[1])}}draw(t,{xMin:e,xMax:s,yMin:i,yMax:o,xStep:r,yStep:a}){let h=Fe();return this.worker.postMessage(["plot",t,h,e,s,r,i,o,a,At]),new Promise(l=>this.promises.set(h,l))}},Yh,Jh=class extends k{constructor(t,e,s){super(e,s);this.type="axes";this.canRotate=!1;this.canDragToSelect=!1;this.functions=new Map;this.$fill=c("path",{fill:"transparent"},this.$el),this.$grid=c("path",{class:"axis-gridlines"},this.$el),this.$content=c("g",{},this.$el),this.$axes=c("path",{class:"grid-axis"},this.$el),this.$labels=c("g",{class:"axis-labels"},this.$el),this.$outline=c("rect",{class:"outline active",hidden:!0},this.$el),this.setColour(f.darkGrey),this.watch(g=>this.$grid.toggle(g.grid==="none"));let[i,o,r,a,h,l]=t.split(":").map(g=>+g),u={xMin:i,xMax:r,xStep:o,yMin:a,yMax:l,yStep:h,step:(g,b)=>this.step(g,b)},m=this.model=e.bindSettingsPanel(this,Zu,u);this.$handles=[this.makeHandle("c",g=>m.xMin=M(Math.round(g.x/At),-20,0)),this.makeHandle("c",g=>m.xMax=M(Math.round(g.x/At),0,20)),this.makeHandle("c",g=>m.yMin=M(Math.round(-g.y/At),-20,0)),this.makeHandle("c",g=>m.yMax=M(Math.round(-g.y/At),0,20))];for(let g of[2,3])this.$handles[g].css("cursor","ns-resize");m.watch((g,b)=>this.setSizes(m,b))}highlight(t=!0){var e;(e=this.$outline)==null||e.toggle(t)}setSizes({xMin:t,xMax:e,yMin:s,yMax:i,xStep:o,yStep:r},a=!1){var m;let h=`${t}:${o}:${e}:${s}:${r}:${i}`;if(h===this.options)return;this.options=h;let l=At;this.$handles[0].setCenter({x:t*l,y:0}),this.$handles[1].setCenter({x:e*l,y:0}),this.$handles[2].setCenter({x:0,y:-s*l}),this.$handles[3].setCenter({x:0,y:-i*l}),this.$labels.removeChildren();let p="",u=`M${t*l} 0L${e*l} 0M0 ${-s*l}L0 ${-i*l}`;u+=`M0 ${-i*l-3}l5 8h-10ZM${e*l+3} 0l-8 5v-10Z`;for(let g=t+1;g<e;++g)!g||(u+=`M${g*l} 0L${g*l} 5`,p+=`M${g*l} ${-s*l}L${g*l} ${-i*l}`,c("text",{text:ot(g*o,4),x:g*l,y:21,"text-anchor":"middle"},this.$labels));for(let g=s+1;g<i;++g)!g||(u+=`M0 ${-g*l}L-5 ${-g*l}`,p+=`M${t*l} ${-g*l}L${e*l} ${-g*l}`,c("text",{text:ot(g*r,4),x:-10,y:-g*l+5,"text-anchor":"end"},this.$labels));this.$axes.setAttr("d",u),this.$grid.setAttr("d",p),this.$fill.draw(Oh(-i*At,e*At,-s*At,t*At,15)),this.path=new S(new d(t*At,-i*At),(e-t)*At,(i-s)*At),(m=this.$outline)==null||m.setRect(this.path);for(let[g,b]of this.functions.entries())this.draw(g.options,b);this.transform(),this.$parent.selection.update(),a||this.$parent.change({changed:[this]})}step(t,e){let s=this.model[t],i=Math.pow(10,Math.floor(Math.log10(s))),o=[.5*i,i,2*i,5*i,10*i],r=o.find((a,h)=>e>0?a>s:o[h+1]>=s);this.model[t]=M(r,1e-6,1e12)}link(t){if(super.link(t),!t.source.is("equation"))return;this.functions.has(t.source)||this.functions.set(t.source,c("path",{class:"geo-path"},this.$content));let e=this.functions.get(t.source);e.css("color",t.source.colour),this.draw(t.source.options,e)}unlink(t){var e;super.unlink(t),(e=this.functions.get(t.source))==null||e.remove(),this.functions.delete(t.source)}draw(t,e){return P(this,null,function*(){Yh||(Yh=new Wu(this.$parent.attr("worker")));let s=yield Yh.draw(t,this.model);s.startsWith("[Error]")?e.setAttr("d",""):e.setAttr("d",s)})}getSnapPoints(){let{xMin:t,xMax:e,yMin:s,yMax:i}=this.model,o=[];for(let r=t;r<=e;++r)for(let a=s;a<=i;++a)o.push(new d(r*At,-a*At));return o}getSnapLines(){let{xMin:t,xMax:e,yMin:s,yMax:i}=this.model;return[new Z(new d(t*At,0),new d(e*At,0)),new Z(new d(0,-s*At),new d(0,-i*At))]}setColour(t){super.setColour(t.slice(0,7));for(let e of[this.$axes,this.$labels])e.setAttr("fill",R(this.colour));for(let e of[this.$axes,this.$grid])e.setAttr("stroke",R(this.colour))}static makeThumbnail(t,e){let s=c("svg",{width:180,height:180},e);c("path",{d:"M30 10v160M60 10v160M120 10v160M150 10v160M10 30h160M10 60h160M10 120h160M10 150h160",class:"axis-gridlines",stroke:"white"},s),c("path",{d:"M10 90h160M90 10v160M90 8l4 6h-8ZM172 90l-6 4v-8Z",class:"grid-axis",fill:"white"},s)}};var nw=Math.PI/2,It=Math.PI*2,Ku=["hours","minutes","seconds"],ow={hours:"M-3,0-4-29l4-5,4,5L3,0Z",minutes:"M-2,0-3-47l3-5,3,5L2,0",seconds:"M-1,-52L1,-52L1,0L-1,0Z"};function Xu(n,t=75){let e=t-5,s="";for(let a=0;a<60;++a){let h=d.fromPolar(a/30*Math.PI),l=e-(a%5?3:8);s+=`M${h.x*l} ${h.y*l}L${h.x*e} ${h.y*e}`}let i=c("circle",{r:t,class:"polygon-tile"},n);c("circle",{r:e,class:"clock-face"},n);let o=c("path",{d:s,class:"clock-ticks"},n);for(let a=1;a<=12;++a){let h=d.fromPolar((a-3)/6*Math.PI).scale(53).shift(0,5);c("text",{text:a,x:h.x,y:h.y,class:"clock-label"},n)}let r=Ku.map(a=>c("path",{class:"clock-handle",d:ow[a],opacity:a==="hours"?.8:void 0},n));return c("circle",{r:4,class:"spinner"},n),[i,o,...r]}var Qh=class extends k{constructor(t,e,s){super(e,s);this.type="clock";this.showSeconds=!0;this.prevAngle=0;this.currentAngle=0;this.seconds=0;this.time=[0,0,0];this.options=t;let i=75;this.path=new B(E,i),[this.$border,this.$ticks,...this.$hands]=Xu(this.$el,i),this.$outline=c("circle",{class:"outline",r:i},this.$el);let o=this.options;for(let[l,p]of this.$hands.entries())e.events.listen(p,{start:({posn:u})=>{o=this.options,this.prevAngle=this.getPointerAngle(u)%It},move:({posn:u})=>this.handleMoveHand(Ku[l],u),end:()=>{this.updateOptions(),this.options!==o&&e.change({changed:[this]})}});let[r,a,...h]=this.options.split(":");if(+a||this.$hands[2].hide(),r==="l"){this.clockType="live";let l=new Date().getTimezoneOffset()*60,p=-1;this.animation=z(()=>{let u=Math.round(Date.now()/1e3-l);u!==p&&(p=u,this.setTime(u))});for(let u of this.$hands)u.css("pointer-events","none")}else r==="g"?(this.clockType="geared",this.setTime(+h[0]||0)):(this.clockType="free",this.setHands(+h[0]||0,+h[1]||0,+h[2]||0))}setTime(t){this.seconds=t;let e=t%60,s=t/60%60,i=t/3600%12;this.setHands(i,s,e)}setHands(t,e,s){this.time=[t%12,e%60,s%60],this.$hands[2].setTransform(void 0,Math.round(s)/60*It),this.$hands[1].setTransform(void 0,e/60*It),this.$hands[0].setTransform(void 0,t/12*It),this.value=$t(t,12)+$t(e,60)/60+$t(s,60)/3600}updateOptions(){let t=this.showSeconds?"1":"0";this.clockType==="live"?this.options=`l:${t}`:this.clockType==="geared"?this.options=`g:${t}:${this.seconds}`:this.options=`f:${t}:${this.time[0]}:${this.time[1]}:${this.time[2]}`}delete(){var t;(t=this.animation)==null||t.cancel,super.delete()}getPointerAngle(t){return this.relativePosn(t).angle()+nw}handleMoveHand(t,e){this.currentAngle=this.getPointerAngle(e)%It,this.prevAngle/It>.75?this.currentAngle/It<.25&&(this.currentAngle+=It):this.prevAngle/It<.25&&this.currentAngle/It>.75&&(this.currentAngle-=It);let s=(this.currentAngle-this.prevAngle)/It;if(this.clockType==="geared"){let i=s*(t==="hours"?43200:t==="minutes"?3600:60);this.setTime(this.seconds+i)}else if(this.clockType==="free"){let[i,o,r]=this.time;t==="hours"?i+=s*12:t==="minutes"?o+=s*60:r+=s*60,this.setHands(i,o,r)}this.currentAngle>=It?this.currentAngle-=It:this.currentAngle<0&&(this.currentAngle+=It),this.prevAngle=this.currentAngle}setColour(t){super.setColour(t),this.$border.setAttr("fill",R(t)),this.$ticks.setAttr("stroke",R(t)),this.$hands[2].css("fill",R(t))}toggleSecondsVisible(){this.$hands[2].toggle(!this.showSeconds),this.showSeconds=!this.showSeconds,this.updateOptions()}static action(t,e){if(t==="toggleSeconds"){for(let s of e)s.toggleSecondsVisible();e[0].$parent.change({changed:e})}}static makeThumbnail(t,e){let s=c("svg",{width:80,height:80,viewBox:"-80 -80 160 160"},e),i=e.data.colour,[o,r,...a]=Xu(s,75);o.removeClass("polygon-tile"),o.setAttr("fill",i),r.setAttr("stroke",i),a[2].css("fill",i),a[2].setTransform(void 0,57/60*It),a[1].setTransform(void 0,37/60*It),a[0].setTransform(void 0,2.62/12*It)}};var Yu='<h3>Number Line</h3><label class="row"><div class="label">Start:</div><input class="input-field" type="number" :bind="start"></label><label class="row"><div class="label">Step Size:</div><input class="input-field" type="number" :bind="step" min="0"></label><label class="row"><div class="label">Width:</div><input class="input-field" type="number" :bind="size" min="1" max="25"></label><label class="row"><div class="label">Divisions:</div><input class="input-field" type="number" :bind="minor" min="1" max="25"></label>';var wn=25,tl=class extends k{constructor(t,e,s){super(e,s);this.type="number-line";this.$el.addClass("number-line"),this.$fill=c("path",{fill:"transparent"},this.$el),this.$lines=c("path",{class:"number-line-ticks"},this.$el),this.$labels=c("g",{},this.$el),this.setColour(f.darkGrey);let[i,o,r,a,h]=t.split(":").map(u=>+u),l={start:i,step:o,width:r,size:a,minor:h},p=e.bindSettingsPanel(this,Yu,l);this.$start=this.makeHandle("h",u=>{let m=M(Math.round(u.x/wn/p.size),p.width-100,p.width-1);!m||(this.setTransform(this.posn.rotate(-ar(this.rot)).shift(m*wn*p.size,0).rotate(ar(this.rot))),p.width-=m,p.start=kt(p.start+m*p.step,5))}),this.$start.setTransform({x:-wn,y:-2.5},Math.PI),this.$end=this.makeHandle("h",u=>{let m=u.x/wn/p.size;p.width=M(Math.round(m),1,100)}),p.watch((u,m)=>{p.start=kt(p.start,4),p.step=kt(p.step,4),p.size=Math.round(p.size),p.minor=Math.round(p.minor),this.setDimensions(p,m)})}setDimensions({start:t,step:e,width:s,size:i,minor:o},r=!1){let a=`${t}:${e}:${s}:${i}:${o}`;if(a===this.options)return;this.options=a,this.$labels.removeChildren(),i*=wn;let h=`M0 10L${s*i} 10`;for(let l=0;l<=s*o;l+=1){let p=l*i/o,u=!(l%o),m=ot(t+l*e/o,4);h+=`M${p} ${u?0:5}L${p} ${u?20:15}`,u&&c("text",{text:m,x:p,y:40},this.$labels)}this.$lines.setAttr("d",h),this.$end.setTransform({x:s*i,y:-2.5}),this.linePoints=_(l=>new d(l*i/o,10),s*o+1),this.line=new Z(new d(0,10),new d(s*i,10)),this.path=new S(new d(0,-2.5),s*i,25),this.$fill.draw(this.path),this.transform(),this.$parent.selection.update(),r||this.$parent.change({changed:[this]})}getSnapPoints(){return this.linePoints}getSnapLines(){return[this.line]}customTransform(){for(let t of this.$labels.children)t.css("transform",`rotate(${-this.rot}deg)`)}setColour(t){super.setColour(t.slice(0,7)),this.$lines.setAttr("stroke",R(this.colour)),this.$labels.setAttr("fill",R(this.colour))}static makeThumbnail(t,e){let s=c("svg",{width:240,height:40,class:"number-line"},e),i="M20 10L220 10";for(let o=0;o<=10;o+=1){let r=20+o*20;i+=`M${r} 5L${r} 15`,c("text",{text:o,x:r,y:30},s)}c("path",{d:i,class:"number-line-ticks"},s)}};var as=50,qo=class extends k{constructor(t,e,s){super(e,s);this.canRotate=!1;this.canDragToSelect=!1;this.$el.addClass("utensil"),this.width=+t,this.absoluteEnd=new d(this.width,0),this.setup(),this.$handles=[0,1].map(i=>this.makeHandle("c",(o,r)=>{var l;let a=i?this.posn:this.absoluteEnd,h=(l=this.$parent.snap([r]))==null?void 0:l.shift;r=h?r.add(h):r.snap(a,10),d.distance(r,a)<75&&(r=new B(a,75).project(r)),i?this.absoluteEnd=r:this.posn=r,this.rot=this.absoluteEnd.angle(this.posn)*Et,this.width=this.absoluteEnd.subtract(this.posn).length,this.update(),this.transform()})),this.update(),this.setOrder("front")}flip(){super.flip(),this.update(),this.transform()}moveEnd(){this.absoluteEnd=new d(this.width,0).rotate(this.rot/Et).add(this.posn)}update(){this.options=""+this.width,this.$handles[1].setCenter({x:this.width,y:0})}},rw=["ruler","protractor"];function Ju(n){return rw.includes(n.type)}var el=class extends qo{constructor(){super(...arguments);this.type="ruler"}setup(){this.$glass=c("rect",{x:-20,height:60,class:"glass",rx:5},this.$el),this.$ticks=c("path",{class:"ticks"},this.$el),this.$labels=_(t=>c("text",{text:t,y:31},this.$el),31)}update(){this.path=new Z(E,new d(this.width,0)),this.flipped&&(this.path=new Z(this.path.p2,E));let t=this.path.length+.1;this.$glass.setAttr("width",t+40);let e="";for(let s=0;s<=t;s+=as/10){let i=s%as?s%(as/2)?0:1:2;e+=`M${this.flipped?this.width-s:s} 0V${[10,15,20][i]}`}this.$ticks.setAttr("d",e);for(let[s,i]of this.$labels.entries())i.toggle(s<=t/as),i.setAttr("x",this.flipped?this.width-as*s:as*s);super.update()}getSnapPoints(){let t=this.path.length;return _(e=>this.path.at(e*as/t),t/as)}getSnapLines(){return[this.path]}static action(t,e){if(t==="flip")for(let s of e)s.flip();e[0].$parent.change({changed:e})}};function aw(n){return`M0-${n}A${n},${n},0,0,0-${n},0V3a5,5,0,0,0,5,5H${n-5}a5,5,0,0,0,5-5V0A${n},${n},0,0,0,0-${n}Z`}var sl=class extends qo{constructor(){super(...arguments);this.type="protractor"}setup(){this.$glass=c("path",{d:"",class:"glass"},this.$el),this.$ticks=c("path",{class:"ticks"},this.$el),this.$labels=_(t=>c("text",{text:t*10},this.$el),19)}update(){let t=this.width;this.path=new ve(E,new d(-this.width,0),Math.PI),this.$glass.setAttr("d",aw(t));let e="",s=this.width<100?5:1;for(let i=0;i<=180;i+=s){let o=!(i%10),r=d.fromPolar(-i*it),a=t-(o?30:20);e+=`M${r.x*t} ${r.y*t}L${r.x*a} ${r.y*a}`,o&&(e+=`M${r.x*8} ${r.y*8}L${r.x*(t-50)} ${r.y*(t-50)}`)}this.$ticks.setAttr("d",e);for(let[i,o]of this.$labels.entries()){let r=t>160||!(i%3);o.toggle(r),!!r&&(o.setAttr("y",44-t),o.setAttr("transform",`rotate(${(this.flipped?-1:1)*(90-10*i)})`))}super.update()}getSnapPoints(){return[E,this.path.start,this.path.at(.5),this.path.end]}getSnapLines(){return[]}},il=class extends qo{constructor(){super(...arguments);this.type="compass"}setup(){}update(){}getSnapPoints(){return[]}getSnapLines(){return[]}};var Be=50,nl=class extends k{constructor(t,e,s){super(e,s);this.type="table";this.size=0;this.$handles=[];this.$cells=[];this.focussed=!1;this.timeout=0;this.rows=3;this.cols=2;this.data=[["x","y"],["",""],[""],[""]];this.columnWidths=[];this.selection={startRow:0,startCol:0,endRow:0,endCol:0};this.visibleData=[[]];this.linkTypes=["chart","pie-chart","box-whisker"];this.options=t,t&&this.initializeData(),this.$foreignObject=c("foreignObject",{x:this.posn.x,y:this.posn.y,width:1,height:1,overflow:"visible"},this.$el),this.$table=c("div",{xmlns:"http://www.w3.org/1999/xhtml",class:"table-tile"},this.$foreignObject),this.$outline=c("path",{class:"outline"},this.$el),this.$selectionOutline=c("rect",{class:"table-selection",hidden:!0,rx:2},this.$el),e.events.listen(this.$el,{down:i=>{this.findSelection(this.relativePosn(i.posn)),this.$hidden.focus()},move:i=>{let o=this.relativePosn(i.startPosn),r=this.relativePosn(i.posn);this.findSelection(o,r)},click:i=>this.focusCell(this.findCellAt(this.relativePosn(i.posn))),blurInput:!1,checkIfActive:()=>this.focussed}),this.$hidden=c("textarea",{class:"table-hidden"},this.$parent),this.$hidden.on("blur",i=>{var o;((o=N(i.relatedTarget))==null?void 0:o.hasClass("table-cell"))||this.blur()}),this.$hidden.on("paste",i=>{var o;i.preventDefault(),this.paste(((o=i.clipboardData)==null?void 0:o.getData("text").trim())||"")}),this.$hidden.on("cut copy",i=>{var r;let o=this.getSelectionContents();o&&((r=window.navigator.clipboard)==null||r.writeText(o)),i.type==="cut"&&this.removeSelectionContents()}),this.$hidden.onKeyDown("escape",i=>{i.stopPropagation(),this.$hidden.blur(),this.$parent.selection.add(this)}),this.$hidden.onKeyDown("enter",i=>{i.preventDefault(),this.moveDown(!0)}),this.$hidden.onKeyDown("tab",i=>{i.preventDefault(),this.moveRight()}),this.$hidden.onKeyDown("backspace",i=>{i.stopPropagation(),this.removeSelectionContents()}),this.$handles[0]=this.makeHandle("h",i=>this.updateCols(i.x)),this.$handles[1]=this.makeHandle("v",i=>this.updateRows(i.y)),this.$handles[1].css("cursor","ns-resize"),this.setColour("#bbb"),this.buildTable()}select(){var t;super.select(),!((t=this.links)==null?void 0:t.size)&&Ue(this.$parent.tiles.values(),e=>this.linkTypes.some(s=>e.is(s)))&&this.makeLink()}setColour(t){this.colour=t,this.$table.css("border-color",t);for(let s of this.$cells)s.css("border-color",t);let e=G.mix(t,"#fff",.6);this.$table.css("background",e.rgb),this.$table.setClass("contrast",e.brightness<128)}updateOutline(){let t=I(this.columnWidths),e=this.rows*Be;this.$foreignObject.setAttr("width",t||1),this.$foreignObject.setAttr("height",e||1);let s=new S(E,t,e);this.$outline.draw(s),this.path=s.shift(.5),this.$handles[0].setTransform({x:t,y:0}),this.$handles[1].setTransform({x:0,y:e})}initializeData(){this.data=JSON.parse(this.options),this.rows=this.data.length,this.cols=this.data[0].length}updateCols(t){let e=I(this.columnWidths),s=this.columnWidths[this.columnWidths.length-2]||0;t>e+Be?(this.cols+=1,this.buildTable()):this.cols>1&&t<s+Be&&(this.cols-=1,this.buildTable())}updateRows(t){let e=M(Math.round(t/Be),1,100);e!==this.rows&&(this.rows=e,this.buildTable())}resizeColumns(){this.columnWidths=Tn(_(t=>this.$cells[t].width,this.cols)),this.drawSelection()}makeCell(){let t=this.$cells.length,e=c("div",{class:"table-cell",contenteditable:!0,"cell-index":t},this.$table);e.css("border-color",this.colour),this.$cells.push(e);let s=!1;e.on("focus",()=>s=!0),e.on("pointerdown",o=>{s&&o.stopPropagation()}),e.on("blur",o=>{s=!1,this.data[this.cellPosn(e)[0]][this.cellPosn(e)[1]]=e.text,this.updateData();let r=N(o.relatedTarget);!(r==null?void 0:r.hasClass("table-cell"))&&!(r==null?void 0:r.hasClass("table-hidden"))&&this.blur()});let i=e.width;e.on("change keyup input",()=>{let o=i;i=e.width,o!==i&&this.resizeColumns()}),e.on("paste",o=>{var a;let r=((a=o.clipboardData)==null?void 0:a.getData("text").trim())||"";(r.includes(`
`)||r.includes("	"))&&(o.preventDefault(),this.paste(r))}),e.onKeyDown("escape",o=>{o.stopPropagation(),e.blur(),this.$parent.selection.add(this)}),e.onKeyDown("enter",o=>{o.preventDefault(),this.$parent.events.shiftKey?this.moveUp():this.moveDown(!0)}),e.onKeyDown("tab",o=>{o.preventDefault(),this.$parent.events.shiftKey?this.moveLeft():this.moveRight()})}cellPosn(t){let e=parseInt(t.attr("cell-index"));return[Math.floor(e/this.cols),e%this.cols]}buildTable(){this.$table.css("grid-template-columns",`repeat(${this.cols}, max-content)`);let t=this.cols*this.rows;for(let e=this.$cells.length;e<t;++e)this.makeCell();for(let e=t;e<this.$cells.length;++e)this.$cells[e].hide();for(let e=0;e<this.rows;++e)for(let s=0;s<this.cols;++s){this.data[e]||(this.data[e]=[]),this.data[e][s]||(this.data[e][s]="");let i=this.$cells[e*this.cols+s];i.show(),i.html=this.data[e][s],i.setClass("header",!e)}this.resizeColumns(),this.updateOutline(),this.updateData(),this.transform(),this.$parent.selection.update()}paste(t){let[e,s]=[this.selection.startRow,this.selection.startCol],i=t.trim().split(`
`).map(o=>o.split("	"));this.rows=Math.max(this.rows,e+i.length),this.cols=Math.max(this.cols,s+Math.max(...i.map(o=>o.length)));for(let o=0;o<i.length;++o)for(let r=0;r<i[o].length;++r)this.data[e+o]||(this.data[e+o]=[]),this.data[e+o][s+r]=i[o][r];this.updateSelection(s,e,s+i[0].length-1,e+i.length-1),this.buildTable()}moveLeft(){let[t,e]=[this.selection.startRow,this.selection.startCol];this.focusCell(this.$cells[t*this.cols+e-1]||this.$cells[this.$cells.length-1])}moveRight(){let[t,e]=[this.selection.startRow,this.selection.startCol];this.focusCell(this.$cells[t*this.cols+e+1]||this.$cells[0])}moveUp(){let[t,e]=[this.selection.startRow,this.selection.startCol],s=t===0?this.rows:t;this.focusCell(this.$cells[(s-1)*this.cols+e])}moveDown(t=!0){let[e,s]=[this.selection.startRow,this.selection.startCol];t&&this.rows<=e+1&&(this.data[e][s]=this.$cells[e*this.cols+s].text,this.rows+=1,this.buildTable()),this.focusCell(this.$cells[(e+1)*this.cols+s])}click(t){let e=Date.now();e-this.timeout<500&&(this.focus(),this.focusCell(this.findCellAt(this.relativePosn(t.posn)))),this.timeout=e}focus(){this.focussed||(this.focussed=!0,this.initialOptions=this.options,this.$parent.options.focussed=this,this.$table.addClass("active"),this.$parent.selection.clear(),this.$selectionOutline.show())}findCellAt(t){let e=this.columnWidths.findIndex(i=>i>t.x),s=Math.floor(t.y/Be);return this.$cells[this.cols*s+e]}focusCell(t){var o,r;let[e,s]=this.cellPosn(t);this.updateSelection(s,e),t.focus();let i=document.createRange();i.selectNodeContents(t._el),(o=document.getSelection())==null||o.removeAllRanges(),(r=document.getSelection())==null||r.addRange(i)}blur(){!this.focussed||(this.focussed=!1,this.$parent.options.focussed=void 0,this.$table.removeClass("active"),this.$selectionOutline.hide(),this.updateData(),this.updateOutline(),this.transform(),this.$parent.selection.add(this),this.initialOptions!==this.options&&this.$parent.change({changed:[this]}))}updateData(){let t=this.data.slice(0,this.rows).map(e=>e.slice(0,this.cols));if(this.options=JSON.stringify(t),this.visibleData=t,this.initialOptions!==this.options)for(let e of this.links||[])e.change()}findSelection(t,e=t){let s=Math.floor(Math.min(t.y,e.y)/Be),i=Math.ceil(Math.max(t.y,e.y)/Be)-1,o=this.columnWidths.findIndex(a=>a>Math.min(t.x,e.x)),r=this.columnWidths.findIndex(a=>a>Math.max(t.x,e.x));r<0&&(r=this.cols),this.updateSelection(o,s,r,i)}updateSelection(t,e,s=t,i=e){var o,r,a,h;t=M(t,0,this.cols-1),s=M(s,t,this.cols-1),e=M(e,0,this.rows-1),i=M(i,e,this.rows-1),!(((o=this.selection)==null?void 0:o.startRow)===e&&((r=this.selection)==null?void 0:r.endRow)===i&&((a=this.selection)==null?void 0:a.startCol)===t&&((h=this.selection)==null?void 0:h.endCol)===s)&&(this.selection={startCol:t,startRow:e,endCol:s,endRow:i},this.drawSelection())}drawSelection(){if(!this.selection)return;let t=this.columnWidths[this.selection.startCol-1]||0,e=new d(t,this.selection.startRow*Be),s=this.columnWidths[this.selection.endCol]-t||0,i=(this.selection.endRow+1-this.selection.startRow)*Be;this.$selectionOutline.setRect(new S(e,s+1,i+1))}getSelectionContents(){let t="",e=this.selection;if(!e)return t;for(let s=e.startRow;s<=e.endRow;++s){for(let i=e.startCol;i<=e.endCol;++i)i>e.startCol&&(t+="	"),t+=this.data[s][i];t+=`
`}return t}removeSelectionContents(){let t=this.selection;if(!!t)for(let e=t.startRow;e<=t.endRow;++e)for(let s=t.startCol;s<=t.endCol;++s)this.data[e][s]="",this.$cells[e*this.cols+s].text=""}static makeThumbnail(t,e){let s=c("svg",{width:110,height:85},e),i=(o,r,a,h,l,p="")=>{c("rect",{x:5+o,y:5+r,width:a,height:h,fill:l,class:"polygon-tile"},s),p&&c("text",{x:25+5/2+o,y:25-5/2+r,text:p,fill:"white"},s)};for(let o=0;o<2;++o)for(let r=0;r<3;++r)i(50*o,25*r,50,25,r?"#ffffff33":"#ffffff66",r?"":o?"y":"x")}};var hw=ds(["#cd0e66","#0f82f2","#22ab24","#fd8c00"]),Qu=class{constructor(t){this.index=t;this.color=hw();this.tilt=Math.floor(Math.random()*10)-10;this.tiltAngleIncrement=Math.random()*.07+.05;this.tiltAngle=0;this.x=Math.random()*v.width;this.y=(Math.random()-1)*v.height;this.r=ct.uniform(10,30)}draw(t){t.beginPath(),t.lineWidth=this.r/2,t.strokeStyle=this.color,t.moveTo(this.x+this.tilt+this.r/4,this.y),t.lineTo(this.x+this.tilt,this.y+this.tilt+this.r/4),t.stroke()}update(t,e){this.tiltAngle+=this.tiltAngleIncrement,this.y+=(Math.cos(t)+3+this.r/2)/2,this.x+=Math.sin(t),this.tilt=Math.sin(this.tiltAngle-this.index/3)*15,this.x<-20?(this.x=-20,this.y=Math.random()*v.height,this.tilt=Math.floor(Math.random()*10)-20):this.x>v.width+20?(this.x=v.width+20,this.y=Math.random()*v.height,this.tilt=Math.floor(Math.random()*10)-20):e&&this.y>v.height&&(this.x=Math.random()*v.width,this.y=-10,this.tilt=Math.floor(Math.random()*10)-20)}},lw="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999",Bs;function zs(n=2e3,t=150){Bs||(Bs=c("canvas",{style:lw},q)),Bs.setAttr("width",v.width),Bs.setAttr("height",v.height),Bs.show();let e=Bs.ctx,s=_(o=>new Qu(o),t),i=z(o=>{e.clearRect(0,0,v.width,v.height);let r=o<n,a=0;for(let h of s)h.draw(e),h.update(o,r),h.y<v.height&&(a+=1);a||(i.cancel(),Bs.hide())})}var cw="M7,4,2.3-.3,6.6-5a1.2,1.2,0,0,0,0-1.5l-.4-.3a1,1,0,0,0-1.4,0L0-2.5-4.8-6.8a1,1,0,0,0-1.4,0l-.4.3A1.2,1.2,0,0,0-6.6-5L-2.3-.3-7,4a1.1,1.1,0,0,0-.1,1.4l1.5,1.4a.9.9,0,0,0,1.3,0L0,2.1,4.3,6.8a.9.9,0,0,0,1.3,0L7.1,5.4A1.1,1.1,0,0,0,7,4Z",tf="M7.7-5.7l-.2-.4-.3-.2c-.1-.1-.3,0-.4,0A36.6,36.6,0,0,0-3,2.1,36.1,36.1,0,0,0-7.8-.8h-.5l-1,.9a.4.4,0,0,0-.1.3c0,.2,0,.3.1.4a72.1,72.1,0,0,1,6.6,7h.4l.4-.2C1.9,1,3.8-1.8,7.5-5.2,7.7-5.3,7.7-5.5,7.7-5.7Z",ef={fill:"none",style:"touch-action: none",stroke:f.green},sf=class{constructor(t){this.$el=c("g",{});this.$ring=c("circle",me({opacity:.6},ef),this.$el);this.$burst=c("path",ef,this.$el);this.$mark=c("g",{class:"problem-marker"},this.$el);this.$circle=c("circle",{r:13},this.$mark);this.$cross=c("path",{d:cw,fill:"white"},this.$mark);this.$check=c("path",{d:tf,fill:"white"},this.$mark);this.isAnimating=!1;t.append(this.$el)}show(t=!1,e=!0){this.$cross.toggle(!t),this.$check.toggle(t),this.$circle.setAttr("fill",t?f.green:f.red),this.$mark.addClass("show"),e&&t&&this.burst()}hide(){this.$mark.removeClass("show")}burst(t=1e3,e=60,s=20){return P(this,null,function*(){this.isAnimating||(this.isAnimating=!0,yield z(i=>{let o=X("sine-out",i);this.$ring.setAttr("r",.6*o*e),this.$ring.setAttr("stroke-width",.25*(1-o)*e);let r=X("exp-out",i),a=(.4+.6*r)*e,h=(.1+.9*r)*e,l="";for(let p=0;p<s;++p){let u=Math.cos(Math.PI*2*p/s),m=Math.sin(Math.PI*2*p/s);l+=`M${u*h} ${m*h}L${u*a} ${m*a}`}this.$burst.setAttr("d",l)},t).promise,this.isAnimating=!1)})}},vn=class extends k{constructor(t,e,s){super(e,s);this.type="question-blank";this.size=100;this.canRotate=!1;this.solution="";this.submitted="";this.attempts=0;this.correct=!1;this.focussed=!1;this.options=t||"Pw::0";let[i,o,r]=this.options.split(":");this.solution=atob(i),this.submitted=o,this.attempts=+r||0,this.$box=c("rect",{class:"problem-box",rx:6},this.$el),this.$text=c("text",{class:"problem-text",text:this.text,y:36},this.$el),this.mark=new sf(this.$el),this.$input=c("input",{class:"problem-text"},e.$html),this.$input.onKeyDown("enter",()=>this.$input.blur()),this.$input.on("blur",()=>this.blur()),this.$parent.options.canEditQuestions?(this.$handle=this.makeHandle("c",a=>this.setSize(a.x)),this.$handle.css("cursor","ew-resize")):(this.$input.setInputPattern(this.solution),this.checkAnswer(!1),this.canMove=!1),this.setSize(100),this.setOrder("front")}setSize(t){var e;super.setSize(st(M(t,50,400),25)),this.path=new S(E,this.size,50),this.$input.css({width:this.size+"px",height:"50px"}),this.$box.setRect(this.path),this.$text.setAttr("x",this.size/2),this.mark.$el.setTransform({x:this.size,y:0}),(e=this.$handle)==null||e.setCenter({x:this.size,y:50}),this.transform()}delete(){super.delete(),this.$input.remove()}get text(){return(this.$parent.options.canEditQuestions?this.solution:this.submitted)||"?"}click(){this.focussed||this.$parent.events.shiftKey||this.correct&&!this.$parent.options.canEditQuestions||(this.focussed=!0,this.$parent.selection.add(this,!0),setTimeout(()=>{this.$el.removeClass("correct incorrect"),this.mark.hide()}),this.$input.css({top:this.posn.y+"px",left:this.posn.x+"px"}),this.$input.value=this.text,this.$text.hide(),this.$input.show(),this.$input.focus(),document.execCommand("selectAll",!1))}blur(){if(!this.focussed)return;this.focussed=!1,this.$input.hide(),this.$text.show();let t=this.text,e=this.$input.value.trim();this.$parent.options.canEditQuestions?(this.solution=e,this.options=`${btoa(e)}::0`):(e&&e!==this.submitted&&(this.attempts+=1),this.submitted=e==="?"?"":e,this.options=`${btoa(this.solution)}:${e}:${this.attempts}`,setTimeout(()=>{this.checkAnswer(),vn.gradeWorksheet(this.$parent)})),this.$text.text=this.text,this.text!==t&&this.$parent.change({changed:[this]})}isCorrect(){if(!this.submitted||!this.solution)return!1;if(this.submitted.toLowerCase()===this.solution.toLowerCase())return!0;let t=Mi(this.solution),e=Mi(this.submitted);return C(e,t)||Ws(t)===this.submitted||this.solution===Ws(e)}checkAnswer(t=!0){this.correct=this.isCorrect(),this.submitted&&this.mark.show(this.correct,t),this.$el.setClass("correct",this.correct),this.$el.setClass("incorrect",!!this.submitted&&!this.correct)}static gradeWorksheet(t){let e=[0,0,0,0];for(let s of t.tiles.values())!s.is("question-blank")||(e[0]+=1,!!s.submitted&&(e[s.correct?s.attempts<=1?1:2:3]+=1));e[0]===e[1]+e[2]&&zs()}static makeThumbnail(t,e){let s=c("svg",{width:130,height:70},e);c("rect",{x:15,y:15,width:100,height:50,class:"problem-box",rx:6},s),c("text",{x:65,y:50,text:"?",class:"problem-text"},s),c("circle",{cx:115,cy:15,r:13,fill:f.blue},s),c("path",{d:tf,fill:"white",transform:"translate(115 15)"},s)}};var nf=Jt(In),ol=class extends k{constructor(t,e,s){super(e,s);this.type="image";this.path=new S(E,0,0);this.aspectRatio=1;this.options=t,this.$image=c("image",{href:t,crossorigin:"anonymous"},this.$el),this.$outline=c("path",{class:"outline"},this.$el),nf(t).then(i=>{this.aspectRatio=i.height/i.width,this.setSize(this.size||i.width)}),this.$handle=this.makeHandle("c",i=>this.setSize(i.x)),this.$handle.css("cursor","nwse-resize")}setHref(t){this.options=t,this.$image.setAttr("href",t),nf(t)}setSize(t){let e=Math.max(50,50*this.aspectRatio),s=Math.min(1e3,1e3/this.aspectRatio);this.size=M(t,e,s),this.$image.setAttr("width",this.size),this.$image.setAttr("height",this.aspectRatio*this.size),this.path=new S(E,this.size,this.aspectRatio*this.size),this.$outline.draw(this.path),this.$handle.setCenter({x:this.size,y:this.aspectRatio*this.size}),this.transform(),this.$parent.selection.update()}};var dw={bold:"font-weight",italic:"font-style",underline:"text-decoration",colour:"color"};function of(n,t){return n.style.getPropertyValue(t)||""}function rf(n,t,e){n.style.setProperty(t,e)}function pw(n,t){t==="font-weight"||t==="font-style"?n.style.setProperty(t,"normal"):t==="text-decoration"?n.style.setProperty(t,"none"):n.style.removeProperty(t)}var rl=class extends k{constructor(t,e,s){super(e,s);this.type="text";this.size=0;this.focussed=!1;this.creating=!1;this.$box=c("rect",{fill:"transparent"},this.$el),this.$foreignObject=c("foreignObject",{x:this.posn.x,y:this.posn.y,width:1,height:1,overflow:"visible"},this.$el),this.$text=c("div",{class:"text-edit",style:"pointer-events: none",xmlns:"http://www.w3.org/1999/xhtml"},this.$foreignObject),this.$outline=c("path",{class:"outline"},this.$el),this.options=this.$text.html=t||"Text",this.setColour(e.penColour),this.setOrder("front"),this.updateOutline(),this.$text.on("pointerdown",i=>i.handled=!0),this.$text.onKeyDown("escape",i=>this.blur()),this.$text.on("blur",()=>this.blur())}setSize(t){super.setSize(M(t,-5,10)),this.$text.css("font-size",20*1.2**this.size+"px"),this.updateOutline()}setColour(t){if(this.focussed)return this.formatFont("color",t);this.colour=t,this.$text.css("color",R(this.colour))}getSnapPoints(){return[]}updateOutline(){let t=this.$text.width,e=this.$text.height;this.$foreignObject.setAttr("width",t||1),this.$foreignObject.setAttr("height",e||1),this.path=new S(E,t,e),this.$box.setRect(this.path),this.$outline.draw(this.path),this.transform()}selectAll(){let t=this.selection,e=document.createRange();e.selectNodeContents(this.$text._el),t==null||t.removeAllRanges(),t==null||t.addRange(e)}static action(t,e){return P(this,null,function*(){for(let s of Array.from(e))t==="smaller"||t==="larger"?s.setSize(t==="larger"?s.size+1:s.size-1):s.format(t);e[0].$parent.change({changed:Array.from(e)})})}format(t){this.formatFont(dw[t]||"",t),this.cleanupElements(this.$text._el.children),this.updateOutline(),this.options=this.$text.html}get selection(){var e,s;return(((s=(e=this.$el._el).getRootNode)==null?void 0:s.call(e))||document).getSelection()}formatFont(t,e){if(!this.focussed){let o=new Range,r=this.$text._el.childNodes;return o.setStartBefore(r[0]),o.setEndAfter(r[r.length-1]),this.formatRange(o,t,e)}let s=this.selection;if(!s)return;let i=[];for(let o=0;o<s.rangeCount;++o){let r=s.getRangeAt(o);this.formatRange(r,t,e),i.push(s.getRangeAt(o))}s.removeAllRanges();for(let o=0;o<i.length;++o)s.addRange(i[o])}formatRange(t,e,s){let i=t==null?void 0:t.extractContents().childNodes;if(!i)return;let o=t.commonAncestorContainer;(o==null?void 0:o.nodeName)==="#text"&&o.parentNode&&(o=o.parentNode),this.removeEmptyTextNodes(i),this.wrapChildrenInSpans(o,i,e),this.updateRangeChildren(i,e,s);for(let r=i.length-1;r>=0;--r)t.insertNode(i[r])}removeEmptyTextNodes(t){for(let e=0;e<t.length;e++){let s=t[e];s.nodeName==="#text"&&!s.nodeValue&&s.remove()}}wrapChildrenInSpans(t,e,s){for(let i=0;i<e.length;++i){let o=e[i];if(o.nodeName==="#text"){let r=document.createElement("span");t.nodeName==="SPAN"&&rf(r,s,of(t,s)),r.appendChild(document.createTextNode(o.nodeValue||"")),o.replaceWith(r)}}}updateRangeChildren(t,e,s){if(s==="smaller"||s==="larger"){let i=t[0],o=parseFloat(i.style.fontSize)||100,r=(s==="smaller"?1/1.2:1.2)*o;this.setChildrenStyles(t,"font-size",r+"%")}else this.allChildrenHaveStyle(t,e,s)?this.unsetChildrenStyles(t,e):this.setChildrenStyles(t,e,s)}allChildrenHaveStyle(t,e,s){for(let i=0;i<t.length;++i){let o=t[i];if(of(o,e)!==s||!this.allChildrenHaveStyle(o.children,e,s))return!1}return!0}unsetChildrenStyles(t,e){for(let s=0;s<t.length;++s){let i=t[s];pw(i,e),this.unsetChildrenStyles(i.children,e)}}setChildrenStyles(t,e,s){for(let i=0;i<t.length;++i){let o=t[i];rf(o,e,s),this.clearChildrenStyles(o.children,e)}}clearChildrenStyles(t,e){for(let s=0;s<t.length;++s){let i=t[s];i.style.removeProperty(e),this.clearChildrenStyles(i.children,e)}}cleanupElements(t){for(let e=0;e<t.length;++e)this.cleanupElements(t[e].children);for(let e=0;e<t.length;++e)t[e].textContent||t[e].remove();for(let e=0;e<t.length;++e)t[e].getAttribute("style")||t[e].replaceWith(...Array.from(t[e].childNodes))}doubleClick(){this.focus()}focus(t=!1){this.focussed||(this.creating=t,this.focussed=!0,this.$parent.options.focussed=this,this.$parent.selection.clear(),this.$text.css("pointer-events","all"),this.$text.setAttr("contenteditable",!0),this.$text.focus(),this.selectAll())}blur(){var s;if(!this.focussed)return;this.focussed=!1,this.$parent.options.focussed=void 0,this.$text.css("pointer-events","none"),this.$text.removeAttr("contenteditable");let t=this.$text.html,e=this.options!==t;if(t){this.$text.show(),this.options=t,this.updateOutline();let i=this.creating?"added":"changed";(this.creating||e)&&this.$parent.change({[i]:[this]})}else this.delete(),this.creating||this.$parent.change({deleted:[this]});(s=this.selection)==null||s.removeAllRanges()}};function _t(n){return!!n.setValue}function af(n,t){let e=n;for(let s of n.parents()){if(s.type in t&&s.children.indexOf(e)===t[s.type])return s;e=s}}function uw(n,t){for(let e of n.parents(!0))for(let s of t.parents(!0))if(e===s)return s}function hf(n,t,e=!1){let s=e?n.children.slice(0).reverse():n.children,i=t.parent;return s.findIndex((o,r)=>i.hasParent(a=>a===o)||_t(i)&&i===o||n===i&&(e?s.length-r:r)===t.offset)}var al=class{constructor(t){this.equation=t;this.offset=0;this.$el=c("line",{class:"cursor",hidden:!0},t.$row),this.$range=c("rect",{class:"range",hidden:!0}),t.$row.prepend(this.$range),this.parent=t.root}redraw(){let t=this.getRangeRect();if(this.$el.toggle(!t),this.$range.toggle(!!t),t)this.$range.setRect(t);else{this.selected=void 0;let e=this.getCursorLine();e&&this.$el.setLine(...e),this.$el.restartAnimation()}}hide(){this.$el.hide(),this.$range.hide(),this.clearRange()}startRange(){this.start={parent:this.parent,offset:this.offset}}clearRange(){this.selected=void 0,this.start=void 0}moveToPoint(t){let e=this.equation.root.hitTest(t)||this.equation.root,s=e.worldTransform,i=(t.x-s.x)/(e.width*s.scale);_t(e)?this.moveInto(e,Math.round(i*e.value.length)):i<.5?this.moveBefore(e):this.moveAfter(e)}getRangeRect(){if(!this.start||this.start.parent===this.parent&&this.start.offset===this.offset)return;let t=uw(this.parent,this.start.parent),e=[t];if(t.children.length){let s=hf(t,this.start),i=hf(t,this);i<s&&([s,i]=[i,s]),(s>0||i<t.children.length-1)&&(e=t.children.slice(s,i+1)),e.length||(e=[t]),(s<0||i<0)&&t.type==="mrow"&&t.parent&&(e=[t.parent]),e.length===1&&e[0].type==="mrow"&&(e=e[0].children.slice(0))}return this.selected=e,S.aroundPoints(Rl(e,s=>{let i=s.worldTransform;return[i,{x:i.x+s.width*i.scale,y:i.y+s.height*i.scale}]}))}getCursorLine(){let t=_t(this.parent)?this.parent:this.prev||this.next;if(!t)return;let e=t.worldTransform,s=t.height*e.scale,i=-1;return _t(this.parent)?i=t.width*e.scale*this.offset/t.value.length:this.prev&&(i=this.prev.width*e.scale+1),[{x:e.x+i,y:e.y+2},{x:e.x+i,y:e.y+s-2}]}moveAfter(t){if(t.type==="mrow")return this.moveAfter(I(t.children));if(!t.parent)throw new Error("Move cursor to unattached node");this.parent=t.parent,this.offset=this.parent.children.indexOf(t)+1}moveBefore(t){if(t.type==="mrow")return this.moveBefore(t.children[0]);if(!t.parent)throw new Error("Move cursor to unattached node");this.parent=t.parent,this.offset=this.parent.children.indexOf(t)}moveInto(t,e){if(_t(t)){if(e<=0)return this.moveBefore(t);if(e>=t.value.length)return this.moveAfter(t)}this.parent=t,this.offset=e}get prev(){return this.parent.children[this.offset-1]}get next(){return this.parent.children[this.offset]}handleShift(t,e=!1){if(t&&!this.selected)this.startRange();else if(!t&&this.selected)return e?this.moveBefore(this.selected[0]):this.moveAfter(I(this.selected)),this.clearRange(),!0;this.selected&&this.parent!==this.selected[0].parent&&this.moveAfter(I(this.selected))}left(t){if(this.handleShift(t,!0))return;if(this.selected)return this.offset-=1;if(_t(this.parent))return this.moveInto(this.parent,this.offset-1);let e=this.prev;if(e)return _t(e)?this.moveInto(e,e.value.length-1):e.children.length?this.moveAfter(I(e.children)):this.moveBefore(e);let s=this.parent,i=(s==null?void 0:s.type)==="mrow";if(i&&(s==null?void 0:s.prev))return this.moveAfter(s.prev);let o=i?s.parent:s;o&&this.moveBefore(o)}right(t){if(this.handleShift(t))return;if(this.selected)return this.offset+=1;if(_t(this.parent))return this.moveInto(this.parent,this.offset+1);let e=this.next;if(e)return _t(e)?this.moveInto(e,1):e.children.length?this.moveBefore(e.children[0]):this.moveAfter(e);let s=this.parent,i=(s==null?void 0:s.type)==="mrow";if(i&&(s==null?void 0:s.next))return this.moveBefore(s.next);let o=i?s.parent:s;o&&this.moveAfter(o)}up(t){this.selected&&this.clearRange();let e=af(this.parent,{mfrac:1,msub:1,msup:0});(e==null?void 0:e.type)==="mfrac"&&this.moveAfter(I(e.children[0].children)),(e==null?void 0:e.type)==="msub"&&this.moveAfter(I(e.children[0].children)),(e==null?void 0:e.type)==="msup"&&this.moveBefore(e.children[1].children[0])}down(t){this.selected&&this.clearRange();let e=af(this.parent,{mfrac:0,msub:0,msup:1});(e==null?void 0:e.type)==="mfrac"&&this.moveBefore(e.children[1].children[0]),(e==null?void 0:e.type)==="msub"&&this.moveBefore(e.children[1].children[0]),(e==null?void 0:e.type)==="msup"&&this.moveAfter(I(e.children[0].children))}backspace(){var o;if(this.selected){this.moveBefore(this.selected[0]);for(let r of this.selected)r.deleteFromDom();this.clearRange(),this.parent.children.length||this.parent.addChildren([this.placeholder]);return}if(_t(this.parent)){let r=this.parent.value;return this.setText(r.slice(0,this.offset-1)+r.slice(this.offset)),this.moveInto(this.parent,this.offset-1)}let t=this.prev;if(t)return _t(t)&&t.value.length>1?t.setValue(t.value.slice(0,t.value.length-1)):t.type==="placeholder"||t.children.length?this.left():(t.deleteFromDom(),this.parent.children.length||this.parent.addChildren([this.placeholder]),this.moveInto(this.parent,this.offset-1));let e=this.parent,s=e.children,i=0;e.type==="mrow"&&parent.parent&&(i=((o=e.prev)==null?void 0:o.children.filter(r=>r.type!=="placeholder").length)||0,e=e.parent,s=Ut((e==null?void 0:e.children.map(r=>r.children))||[])),!!(e==null?void 0:e.parent)&&(this.moveInto(e.parent,e.index+i),e.insertAfter(s.filter(r=>r.type!=="placeholder")),e.deleteFromDom(),this.parent.children.length||this.parent.addChildren([this.placeholder]))}get placeholder(){return new co(this.equation)}setText(t,e){if(!e&&_t(this.parent)&&(e=this.parent),!!e){if(t in pi&&(t=pi[t]),t==="sqrt"){let s=this.createNode("msqrt");return e.insertAfter([s]),e.deleteFromDom(),this.moveBefore(s.children[0].children[0])}e.setValue(t)}}createNode(t,e){let s=Ce(this.equation,e||[this.placeholder]);if(t==="mfenced")return new Fi([s],this.equation);if(t==="msqrt")return new fi(t,[s],this.equation);let i=Ce(this.equation,[this.placeholder]);if(t==="mfrac")return new po([s,i],this.equation);if(t==="mroot")return new fi(t,[s,i],this.equation);if(t==="msub"||t==="msup")return new ui(t,[s,i],this.equation)}splitTextNode(){let t=this.parent,e=t.value.slice(this.offset);t.setValue(t.value.slice(0,this.offset)),t.insertAfter([new Cs(t.type,e,this.equation)]),this.moveAfter(t)}insert(t,e){var i,o,r,a,h;let s=((i=this.prev)==null?void 0:i.type)==="placeholder";if(_t(this.parent)&&!this.start&&!this.selected){let l=this.parent.value;((o=this.parent)==null?void 0:o.type)===t?(this.setText(l.slice(0,this.offset)+e+l.slice(this.offset)),this.moveInto(this.parent,this.offset+1)):(this.splitTextNode(),this.insert(t,e))}else if(t==="mi"||t==="mn"||t==="mtext")this.selected&&this.backspace(),((r=this.prev)==null?void 0:r.type)===t?this.setText(this.prev.value+e,this.prev):((a=this.next)==null?void 0:a.type)===t?(this.setText(e+this.next.value,this.next),this.moveInto(this.next,1)):(this.parent.addChildren([new Cs(t,e,this.equation)],this.offset),s||(this.offset+=1));else if(t==="mo"||t==="mspace"){this.selected&&this.backspace();let l=t==="mo"?new Cs("mo",e,this.equation):new lo(this.equation);this.parent.addChildren([l],this.offset),s||(this.offset+=1)}else{let l=t==="msub"||t==="msup"||t==="mfrac"&&((h=this.prev)==null?void 0:h.type)!=="mo",p=this.selected||(l&&this.prev?[this.prev]:void 0);p&&this.moveBefore(p[0]),this.selected&&this.clearRange();let u=this.createNode(t,p);this.parent.addChildren([u],this.offset),this.moveBefore(u.children[p&&u.children.length>1?1:0].children[0])}}toSubSup(t){let e=this.placeholder,s=t.type==="msub"?2:1;t.addChildren([Ce(this.equation,[e])],s),t.type="msubsup",this.moveBefore(e)}type(t){var e,s,i,o,r,a;if(t=t.replace("*","\xD7").replace("-","\u2212"),t.match(/^[A-Za-zÏ€]$/))this.insert("mi",t);else if("0123456789.".includes(t))this.insert("mn",t);else if("+\u2212\xB1\xD7\xF7<>\u2264\u2265=%!".includes(t))this.insert("mo",t);else if(t===" "){let h=(e=this.prev)==null?void 0:e.type,l=(s=this.next)==null?void 0:s.type;if(h==="placeholder"||h==="mspace"||l==="placeholder"||l==="mspace"||!_t(this.parent)&&h!=="mi"&&l!=="mi")return;this.insert("mspace")}else if(t==="frac"||t==="/")this.insert("mfrac",t);else if(t==="sqrt")this.insert("msqrt",t);else if(t==="^"||t==="sup"){if(((i=this.prev)==null?void 0:i.type)==="msub")return this.toSubSup(this.prev);this.insert("msup",t)}else if(t==="_"||t==="sub"){if(((o=this.prev)==null?void 0:o.type)==="msup")return this.toSubSup(this.prev);this.insert("msub",t)}else if(t==="brackets"||"([{|".includes(t))this.insert("mfenced",t);else if(")]}".includes(t))if(((a=(r=this.parent)==null?void 0:r.parent)==null?void 0:a.type)==="mfenced")this.moveAfter(this.parent.parent);else{let h=this.prev;this.parent.addChildren([this.createNode("mfenced",h?[h]:void 0)],this.offset),h||(this.offset+=1)}}copy(){return this.selected?this.selected.map(t=>t.expr).join(""):""}paste(t){try{let e=this.equation.parse(t);if(this.selected&&this.backspace(),e.length===1&&_t(e[0]))return this.insert(e[0].type,e[0].value),e[0].deleteFromDom();_t(this.parent)&&this.splitTextNode(),this.parent.addChildren(e,this.offset),this.moveAfter(I(e))}catch(e){}}};var hl=class extends k{constructor(t,e,s){super(e,s);this.type="equation";this.focussed=!1;this.size=0;this.linkTypes=["axes"];this.creating=!1;this.options=t||"placeholder",this.$box=c("rect",{fill:"transparent"},this.$el),this.$outline=c("rect",{class:"outline"},this.$el),this.$equation=c("g",{class:"equation","font-size":"20px"},this.$el),this.equation=new He(this.$equation,void 0,0,"",20),this.cursor=new al(this.equation),this.setOrder("front");try{this.equation.setValue(this.options)}catch(i){console.warn("Parsing error",t,i.message)}this.transform(),this.setColour(e.penColour),this.$textarea=c("textarea",{class:"hidden-input",tabindex:-1},e),this.$textarea.on("key",i=>this.handleKey(i)),this.$textarea.on("blur",()=>this.blur()),this.$textarea.on("cut copy",i=>{var o;(o=window.navigator.clipboard)==null||o.writeText(this.cursor.copy()),i.type==="cut"&&(this.cursor.backspace(),this.redraw())}),this.$textarea.on("paste",()=>P(this,null,function*(){var o;let i=yield(o=window.navigator.clipboard)==null?void 0:o.readText();!i||(this.cursor.paste(i),this.redraw())})),e.events.listen(this.$el,{down:i=>{i.event.preventDefault(),this.cursor.clearRange(),this.moveCursor(i)},start:()=>this.cursor.startRange(),move:i=>this.moveCursor(i),blurInput:!1,checkIfActive:()=>this.focussed})}setSize(t){super.setSize(M(t,-5,10)),this.$equation.css("transform",this.size?`scale(${this.scale})`:""),this.transform()}get scale(){return 1.2**this.size}select(){var t;super.select(),!((t=this.links)==null?void 0:t.size)&&Ue(this.$parent.tiles.values(),e=>e.type==="axes")&&this.makeLink()}doubleClick(t){this.focus(!1,t)}customTransform(){let t=this.equation.root.width*this.scale+16,e=this.equation.root.height*this.scale+12;this.path=new S(E.shift(-8,-6),t,e);for(let s of[this.$box,this.$outline])s.setRect(this.path)}setColour(t){super.setColour(t),this.$equation.css("color",R(this.colour))}delete(){super.delete(),this.$textarea.remove()}getSnapPoints(){return[]}focus(t=!1,e){this.focussed||(this.focussed=!0,this.$parent.options.focussed=this,this.creating=t,this.$el.css("cursor","text"),this.$textarea.show(),this.$textarea.focus(),this.$parent.selection.clear(),this.moveCursor(e))}blur(){if(!this.focussed)return;this.focussed=!1,this.$parent.options.focussed=void 0,this.cursor.hide(),this.$el.css("cursor","grab"),this.$textarea.hide();let t=this.options;if(this.options=this.equation.root.expr,this.equation.updateDescription(),this.creating||t!==this.options){let e=this.creating?"added":"changed";this.$parent.change({[e]:[this]});for(let s of this.links||[])s.change()}}redraw(){this.equation.resize(),this.transform(),this.cursor.redraw()}moveCursor(t){this.cursor.moveToPoint(t?this.relativePosn(t.posn).scale(1/this.scale):E),this.cursor.redraw()}handleKey(t){if(t.code===Bt.enter||t.code===Bt.escape)return this.$textarea.blur(),this.$parent.selection.add(this,!0);if(t.code===Bt.left)this.cursor.left(t.shift);else if(t.code===Bt.right)this.cursor.right(t.shift);else if(t.code===Bt.up)this.cursor.up(t.shift);else if(t.code===Bt.down)this.cursor.down(t.shift);else return t.code===Bt.backspace||t.code===Bt.delete?(this.cursor.backspace(),this.redraw()):(this.cursor.type(t.char),this.redraw());this.cursor.redraw()}format(t){this.handleKey({char:t})}};var lf={"number-bar":yh,"number-tile":Ao,polygon:j,pentomino:lh,tangram:ch,"fraction-bar":Si,"fraction-circle":kh,text:rl,"algebra-tile":hn,grid:Lh,"custom-polygon":ah,image:ol,dice:de,"polyhedral-dice":_h,coin:Bh,"number-line":tl,penrose:dh,kolam:ph,"prime-disk":on,balance:Ih,"decimal-grid":bh,spinner:mn,"custom-spinner":jh,token:Dh,egg:uh,geo:bt,fractal:mh,ruler:el,protractor:sl,compass:il,"dot-machine":$h,dot:rn,garden:gh,tantrix:wh,axes:Jh,"question-blank":vn,equation:hl,"number-card":xh,card:wi,abacus:Ph,bucket:Th,table:nl,pentagon:vh,domino:Zh,"number-grid":Ch,"number-frame":Mh,"number-dot":ln,polyhedron:Ns,chart:Wh,"pie-chart":Kh,clock:Qh,"box-whisker":Xh};function yn(n){if(!(n in lf))throw new Error(`Unknown tile type: ${n}`);return lf[n]}var bn=Math.PI/180,cf,df,_o=new Set,ll=new Set;function fw(n,t,e){let s=$t(n-t,e);return s>e/2?s-e:s}function mw(n,t){for(let e of n)if(t(e))return!0;return!1}var cl=class{constructor(t){this.$parent=t;this.angle=0;this.startAngle=0;this.hasChanged=!1;this.showTools=!1;this.isMoving=!1;this.tiles=new Set;this.implicitChanges=new Set;this.$tools=t.$(".transform-tools"),this.$shadow=t.$(".group-shadow"),this.$rect=this.$tools.$(".group-outline"),this.$rotateBar=this.$tools.$(".rotate-bar"),this.$rotateCircle=this.$tools.$(".rotate-circle"),t.events.listen(this.$rotateCircle,{start:()=>{this.startAngle=this.angle,this.rotateStart()},move:({startPosn:e,posn:s})=>{this.rotate(this.startAngle-new Pt(s,this.center,e).deg)},end:()=>this.rotateEnd()}),v.onKey("up down left right r R",(e,s)=>{if(!this.tiles.size)return;if(s==="r"||s==="R"){if(Array.from(this.tiles).some(l=>l.fixed||!l.canRotate))return;this.rotateStart(),this.rotate(this.angle+(s==="R"?-15:15)),this.rotateEnd();return}let i=E,o=this.$parent.events.shiftKey?5:25,r=s==="left"?-o:s==="right"?o:0,a=s==="up"?-o:s==="down"?o:0,h=i.shift(r,a);this.moveStart(),this.move({posn:h,startPosn:i}),this.moveEnd()}),v.onKey("escape",()=>this.clear())}get size(){return this.tiles.size}add(t,e=!1,s=!1){e&&this.clear(),!t.isActive&&this.$parent.tiles.has(t.id)&&this.select([t],s)}select(t,e=!1){for(let s of t)s.isActive||!this.$parent.tiles.has(s.id)||(this.tiles.add(s),s.select(),this.hasChanged=!0);e||this.update(!0)}remove(t,e=!1){!t.isActive||(t.deselect(),this.hasChanged=!0,this.tiles.delete(t),e||this.update(!0))}clear(){if(!this.isMoving){for(let t of this.tiles)t.deselect();this.tiles.size&&(this.hasChanged=!0),this.tiles.clear(),this.update(!0)}}getTileProperty(t){if(!this.size)return;let e=Array.from(this.tiles),s=t(e[0]);return e.slice(1).some(o=>t(o)!==s)?void 0:s}update(t=!1){if(t&&!this.hasChanged)return;if(this.hasChanged=!1,this.implicitChanges.clear(),!this.size){for(let h of[this.$shadow,this.$tools])h.hide();this.$parent.trigger("change-selection",{tiles:[],color:void 0});return}let e=Array.from(this.tiles);this.angle=this.getTileProperty(h=>h.rot)||0;let s=Ls(...e.map(h=>h.transformed.rotate(-this.angle*bn))),i=s.p.shift(s.w/2,s.h/2).rotate(this.angle*bn).shift(-s.w/2,-s.h/2);this.rect=new S(i,s.w,s.h),this.center=this.rect.center;let o=!!this.$parent.options.canRotate&&e.every(h=>h.canRotate&&!h.fixed);if(e.length===1&&et(e[0].transformed)&&(o=!1),o&&this.getTileProperty(h=>h.rotateAroundOrigin)){let h=e[0].posn;e.slice(1).every(l=>l.posn.equals(h))&&(this.center=h,this.angle&&e.length===1&&(this.rect=Ls(e[0].transformed.rotate(-this.angle*bn,h))))}this.$rotateBar.toggle(o),this.$rotateCircle.toggle(o);let r=this.size>1||e[0].showSelectionOutline;this.$rect.toggle(r),this.showTools=!this.getTileProperty(h=>h.hideSelectionOutline),this.$tools.toggle(this.showTools),this.$shadow.toggle(r&&this.showTools),(this.size===1?e[0].$container:this.$parent.$svg).append(this.$tools),this.positionTools();let a=this.getTileProperty(h=>h.colour);this.$parent.trigger("change-selection",{tiles:e,color:a})}positionTools(){if(!this.showTools)return;let t=this.rect.rotate(this.angle*bn,this.center);for(let i of[this.$shadow,this.$rect])i.draw(t);let e=new d(this.center.x,this.rect.p.y),s=new Z(e,e.shift(0,-28)).rotate(this.angle*bn,this.center);this.$rotateBar.setLine(s.p1,s.p2),this.$rotateCircle.setCenter(s.p2)}moveStart(){for(let t of this.tiles)if(t.fixed||!t.canMove)return;this.isMoving=!0;for(let t of this.tiles)t.moveStart();this.startSnapPoints=[];for(let t of this.tiles)for(let e of t.snapPoints)this.startSnapPoints.some(s=>e.equals(s))||this.startSnapPoints.push(e);df=this.rect,cf=this.center,this.$parent.newTileShift=0,this.$parent.trigger("move-start")}move({posn:t,startPosn:e}){if(!this.isMoving)return;let s=t.subtract(e),i=this.startSnapPoints.map(a=>a.add(s)),o=this.$parent.snap(i);o&&(s=s.add(o.shift));let r=this.tiles.size===1?o==null?void 0:o.target:void 0;for(let a of this.tiles)a.move(s,r);this.rect=df.translate(s),this.center=cf.add(s),this.positionTools(),this.$parent.trigger("move-selection")}moveEnd(t=!1){if(!this.isMoving)return;for(let s of this.tiles)s.transform(),s.moveEnd();if(bt.computeIntersections(this.$parent),this.$parent.trigger("move-end"),this.isMoving=!1,!this.tiles.size)return;let e=[...Array.from(this.tiles),...Array.from(this.implicitChanges)];this.$parent.change({[t?"added":"changed"]:e}),this.implicitChanges.clear()}rotateStart(){ll.clear();for(let t of this.tiles)for(let e of t.snapAngles)ll.add($t(e+t.rot,180));_o.clear(),_o.add(0);for(let t of this.$parent.tiles.values())if(!t.isActive&&!!mw(this.tiles,e=>d.distance(e.posn,t.posn)<140))for(let e of t.snapAngles)_o.add($t(e+t.rot,180));this.$parent.newTileShift=0}rotate(t){if(t=st(t,3),t===this.angle)return;let e=Infinity;for(let i of ll)for(let o of _o){let r=fw(o,i+t-this.startAngle,180);Math.abs(r)<Math.abs(e)&&(e=r)}if(Math.abs(e)<8&&(t+=e),t===this.angle)return;let s=t-this.angle;this.angle=t;for(let i of this.tiles)i.posn=i.posn.rotate(s*Math.PI/180,this.center),i.rot=$t(i.rot+s,360),i.transform(!0);this.positionTools(),this.$parent.trigger("rotate-selection")}rotateEnd(){for(let t of this.tiles)t.transform();this.$parent.change({changed:Array.from(this.tiles)})}copy(t=!1,e=25){if(this.isMoving||!this.$parent.options.canCopy||!this.tiles.size)return;let s={},i=Array.from(this.tiles).map(o=>o.copy(s,e));this.clear();for(let o of i)this.add(o);t||this.$parent.change({added:i})}delete(){if(this.isMoving||!this.$parent.options.canDelete)return;let t=Array.from(this.tiles).filter(s=>!s.fixed);if(!t.length)return;let e=new Set;for(let s of t){for(let i of s.linkSources||[])e.add(i.source);s.delete()}bt.computeIntersections(this.$parent),this.$parent.change({deleted:t,changed:Array.from(e).filter(s=>!t.includes(s))}),this.$parent.newTileShift=0}action(t,e){if(e==="copy")return this.copy();if(e==="delete")return this.delete();yn(t.split(" ")[0]).action(e,Array.from(this.tiles),this.center),this.update()}setOrder(t){for(let e of this.tiles)e.setOrder(t);this.$parent.change({changed:Array.from(this.tiles)})}lock(){let t=Array.from(this.tiles);for(let e of this.tiles)e.lock();this.$parent.change({changed:t})}setFixed(t=!0){let e=Array.from(this.tiles).filter(s=>!s.fixed!=!t);for(let s of e)s.fixed=t;e.length&&this.$parent.change({changed:e})}hide(){let t=Array.from(this.tiles);for(let e of t)e.hide();this.$parent.change({changed:t})}};var gw=5,Fs=class{constructor(t){this.$parent=t}getTileAt(t,e=!0){var r;let s=this.$parent.snap([t.posn],e,!0,!0,"geo"),i=(r=s==null?void 0:s.target)==null?void 0:r.tile;if(!(i==null?void 0:i.locked)&&!(i==null?void 0:i.hidden)&&(i==null?void 0:i.type)==="geo")return i;let o=t.event.target;for(;o;){let a=vo.get(o);if(a&&!a.locked&&!a.hidden&&a.type!=="geo")return a;if(o=o.parentNode||void 0,o===this.$parent._el)return}}hoverGeoTile(t){var e;this.hoveringTile!==t&&((e=this.hoveringTile)==null||e.hover(!1)),t==null||t.hover(),this.hoveringTile=t}down(t){}start(t){}move(t){}end(t){}click(t){}hover(t){}cancel(){}},dl=class extends Fs{constructor(){super(...arguments);this.clickTimeout=0;this.name="move"}down(t){var s;let e=this.activeTile=this.getTileAt(t,!1);this.previousSelection=void 0,(s=this.$parent.options.focussed)==null||s.blur(),e?(e.isActive&&this.$parent.events.shiftKey?this.$parent.selection.remove(e):(this.$parent.events.shiftKey||!e.isActive)&&this.$parent.selection.add(e,!this.$parent.events.shiftKey),Mt.addClass("grabbing")):this.$parent.events.shiftKey?this.previousSelection=new Set(this.$parent.selection.tiles):this.$parent.selection.clear()}start(){this.activeTile?(this.$parent.events.altKey&&this.$parent.selection.copy(!0,0),this.$parent.selection.moveStart()):this.$parent.$selection.show()}move(t){var s;if(this.activeTile){this.$parent.selection.move(t);return}let e=S.aroundPoints([t.startPosn,t.posn]);this.$parent.$selection.setRect(e);for(let i of this.$parent.tiles.values()){if(i.locked||i.hidden||!i.canDragToSelect||!i.transformed)continue;let o=Ki(e,i.transformed,i.type);(this.$parent.events.shiftKey&&((s=this.previousSelection)==null?void 0:s.has(i))?!o:o)?this.$parent.selection.add(i,!1,!0):this.$parent.selection.remove(i,!0)}this.$parent.selection.update(!0)}end(){this.activeTile?this.$parent.selection.moveEnd():this.$parent.$selection.hide(),Mt.removeClass("grabbing")}click(t){if(this.activeTile){this.activeTile.click(t);let e=Date.now();e-this.clickTimeout<500&&this.activeTile.doubleClick(t),this.clickTimeout=e}}hover(t){let e=this.getTileAt(t,!1);this.hoverGeoTile((e==null?void 0:e.type)==="geo"?e:void 0),this.$parent.$svg.css("cursor",e?"grab":"")}},pl=class extends Fs{constructor(){super(...arguments);this.erased=[];this.name="eraser"}down({posn:t}){this.erase(t)}move({posn:t,lastPosn:e}){let s=d.distance(t,e)/4;for(let i=0;i<s;++i)this.erase(d.interpolate(t,e,i/s))}shouldErase(t,e,s){return vt(e)?d.distance(e,t)<10:wt(e)?e.distanceSquared(t)<100:Ln(e)?e.edges.some(i=>i.distanceSquared(t)<100):et(e)&&s==="geo"?Math.abs(d.distance(t,e.c)-e.r)<10:e.contains(t)}erase(t){for(let e of this.$parent.tiles.values())if(!(!e.transformed||!e.canDragToSelect||e.locked||e.hidden)&&this.shouldErase(t,e.transformed,e.type)){e.delete(),this.erased.push(e);return}for(let e of this.$parent.strokes.values())if(e.hitTest(t,10)){e.delete(),this.erased.push(e);return}}end(){this.erased.length&&this.$parent.change({deleted:this.erased}),this.erased=[]}click(){this.end()}},ul=class extends Fs{constructor(){super(...arguments);this.name="text";this.options="text"}down({posn:t}){let e=this.$parent.newTile(this.options,"");e.setTransform(t.shift(-10,-15)),this.$parent.trigger("add-tile",{tile:e}),e.focus(!0)}},fl=class extends Fs{constructor(){super(...arguments);this.name="pan"}enable(){this.previousTool=this.$parent.activeTool.name,this.$parent.setActiveTool("pan")}down(t){this.initialOrigin=this.$parent.origin,this.startPosn=jt(t.event)}move(t){let e=jt(t.event).subtract(this.startPosn),s=this.initialOrigin.subtract(e.scale(1/this.$parent.zoom));this.$parent.setViewport(s,this.$parent.zoom)}end(){this.$parent.setActiveTool(this.previousTool)}click(){this.end()}},Bo=class extends Fs{constructor(){super(...arguments);this.name="pen";this.options="pen"}getUtensil(t){for(let e of this.$parent.tiles.values()){if(!e.transformed||!Ju(e))continue;let s=e.transformed.project(t);if(d.distance(t,s)<30)return e.transformed}}getPoint(t){if(this.options==="ruler"){let e=this.$parent.snap([t]);return e?t.add(e.shift):this.startPoint?t.snap(this.startPoint,gw):t}else return this.utensil?this.utensil.project(t):t}down({posn:t}){this.utensil=this.getUtensil(t),this.startPoint=this.getPoint(t),this.stroke=new ns(this.$parent,[this.startPoint],this.$parent.penColour,this.options)}move({posn:t}){var s,i;let e=this.getPoint(t);this.options==="ruler"?(s=this.stroke)==null||s.setLine(new Z(this.startPoint,e)):(i=this.stroke)==null||i.addPoint(this.getPoint(e))}click(){this.$parent.change({added:[this.stroke]}),this.stroke=this.startPoint=this.utensil=void 0}end(t){var e,s;this.options==="ruler"?(e=this.stroke)==null||e.makeSnapPoints():(s=this.stroke)==null||s.simplify(),this.click()}},zo=class extends Fs{constructor(){super(...arguments);this.name="geo";this.options="line"}expr(t,e){switch(this.options){case"line":return`segment(${t},${e})`;case"circle":return`circle(${t},distance(${t},${e}))`;case"rect":return`rectangle(${t},${e}.x-${t}.x,${e}.y-${t}.y)`}}snapPoint(t){var o,r,a,h;let e=this.$parent.snap([t]);e&&(t=t.add(e.shift));let s="",i=((r=(o=e==null?void 0:e.target)==null?void 0:o.tile)==null?void 0:r.type)==="geo"?(a=e==null?void 0:e.target)==null?void 0:a.tile:void 0;return(i==null?void 0:i.path)&&vt(i.path)&&(s=i.key),((h=e==null?void 0:e.target)==null?void 0:h.intersection)&&(s=e.target.intersection.expr),{point:t,tile:i,expr:s||`point(${t.x},${t.y})`}}getOrMakePointTile(t){var s,i;if(((s=t==null?void 0:t.tile)==null?void 0:s.path)&&vt(t.tile.path))return t.tile;if((i=t==null?void 0:t.tile)==null?void 0:i.path){let o=As(t.tile.path,t.point),r=new bt(`${t.tile.key}.at(${o})`,this.$parent);return this.$parent.trigger("add-tile",{tile:r}),r}let e=new bt(t.expr,this.$parent);return this.$parent.trigger("add-tile",{tile:e}),e}drawPendingPoint(t){var i,o;let e=((o=(i=t.tile)==null?void 0:i.path)==null?void 0:o.type)==="point",s=t.expr.startsWith("intersection");this.$parent.$pendingPoint.toggle(!e),e||(this.$parent.$pendingPoint.setCenter(t.point),this.$parent.$pendingPoint.setClass("intersection",s),this.$parent.$pendingPoint.setAttr("r",s?3.5:6))}down({posn:t}){let e=this.snapPoint(t);this.startPoint=this.getOrMakePointTile(e),this.createdNewStart=!e.tile}start(){var t;this.path=new bt("",this.$parent),this.startPoint.pending=this.path.pending=!0,(t=this.$parent.$pendingPoint)==null||t.show(),this.hoverGeoTile(void 0)}move({posn:t}){var e;this.endSnap=this.snapPoint(t),this.path.setExpr(this.expr(this.startPoint.key,this.endSnap.expr),!0),this.drawPendingPoint(this.endSnap),this.hoverGeoTile((e=this.endSnap)==null?void 0:e.tile)}end(){var s;let t=d.distance(this.startPoint.path,this.endSnap.point)<8,e;if(t?this.path.delete():(e=this.getOrMakePointTile(this.endSnap),this.path.setExpr(this.expr(this.startPoint.key,e.key)),this.path.setPending(!1),this.$parent.trigger("add-tile",{tile:this.path})),this.startPoint.setPending(!1),(s=this.$parent.$pendingPoint)==null||s.hide(),this.hoverGeoTile(void 0),bt.computeIntersections(this.$parent),this.createdNewStart||!t){let i=[];this.createdNewStart&&i.push(this.startPoint),this.path&&i.push(this.path),e&&i.push(e),this.$parent.change({added:i})}this.startPoint=this.path=this.endSnap=void 0}click(){this.createdNewStart&&this.$parent.change({added:[this.startPoint]})}hover(t){var s;let e=this.snapPoint(t.posn);this.drawPendingPoint(e),this.hoverGeoTile(((s=e==null?void 0:e.tile)==null?void 0:s.type)==="geo"?e.tile:void 0)}cancel(){this.$parent.$pendingPoint.hide(),this.path&&this.path.delete(),this.startPoint=this.path=this.endSnap=void 0}},ml=class extends zo{constructor(){super(...arguments);this.name="geoPending";this.startId="";this.expression=""}enable(t){var e;this.expression=t,this.$parent.selection.clear(),this.$parent.setActiveTool("geoPending"),((e=window.event)==null?void 0:e.clientX)&&this.hover({posn:ie(window.event,this.$parent.$svg)})}makePath(){return this.path=new bt("",this.$parent),this.path.$el.css("opacity",.5),this.path.pending=!0,this.path}down(t){if(!this.expression)return;super.down(t);let e=this.path||this.makePath();e.$el.css("opacity",1),e.setExpr(this.expression.replace(/\$1/g,this.startPoint.key)),e.pending=!1,this.path=void 0,this.$parent.selection.add(e,!0);let s=this.createdNewStart?[this.startPoint]:[];this.$parent.change({added:[...s,e]}),bt.computeIntersections(this.$parent),this.$parent.trigger("add-tile",{tile:e}),this.$parent.setActiveTool("move")}hover({posn:t}){var s;if(!this.expression)return;let e=this.snapPoint(t);this.drawPendingPoint(e),this.hoverGeoTile(((s=e==null?void 0:e.tile)==null?void 0:s.type)==="geo"?e.tile:void 0),this.path||this.makePath(),this.path.setExpr(this.expression.replace(/\$1/g,e.expr))}cancel(){super.cancel(),this.expression=""}},gl=class extends Bo{constructor(){super(...arguments);this.name="cutPolygon";this.options="ruler"}enable(){if(this.tiles=Array.from(this.$parent.selection.tiles).filter(t=>!t.fixed),!this.tiles.length)return this.cancel();this.$parent.selection.clear(),this.$parent.setActiveTool("cutPolygon");for(let t of this.tiles)t.$el.addClass("active")}down(){}start({posn:t}){!this.tiles||(this.utensil=this.getUtensil(t),this.startPoint=this.getPoint(t),this.$stroke=c("line",{class:"stroke cut"},this.$parent.$strokes))}move({posn:t}){var e;this.lastPoint=this.getPoint(t),(e=this.$stroke)==null||e.setLine(this.startPoint,this.lastPoint)}end(t){var r;if(t.cancelled)return this.cancel();let e=new dt(this.startPoint,this.lastPoint),s=!1,i=[],o=[];for(let a of this.tiles||[]){let l=a.transformed.cut(e);if(l.length>1){for(let p of l){let u=new j(ut(p.points),this.$parent);u.setColour(a.colour),u.transform(),i.push(u)}a.delete(),o.push(a),s=!0}else a.$el.removeClass("active")}s&&this.$parent.change({added:i,deleted:o}),(r=this.$stroke)==null||r.remove(),this.$stroke=this.tiles=this.startPoint=this.lastPoint=void 0,this.$parent.setActiveTool("move")}click(){this.cancel()}cancel(){var t;for(let e of this.tiles||[])e.$el.removeClass("active");(t=this.$stroke)==null||t.remove(),this.$stroke=this.tiles=this.startPoint=this.lastPoint=void 0,setTimeout(()=>this.$parent.setActiveTool("move"))}};var pf='<svg class="canvas" tabindex="0"><defs><pattern class="grid-pattern" id="square2-grid" x="0" y="0" width="50" height="50" patternUnits="userSpaceOnUse"><rect x="0" y="0" width="50" height="50" opacity="0.2"></rect></pattern><pattern class="grid-pattern" id="square-dots" x="-4" y="-4" width="25" height="25" patternUnits="userSpaceOnUse"><circle cx="4" cy="4" r="2" opacity="0.3"></circle></pattern><pattern class="grid-pattern" id="square-grid" x="0" y="0" width="125" height="125" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="25" y1="0" x2="25" y2="125"></line><line x1="0" y1="25" x2="125" y2="25"></line><line x1="50" y1="0" x2="50" y2="125"></line><line x1="0" y1="50" x2="125" y2="50"></line><line x1="75" y1="0" x2="75" y2="125"></line><line x1="0" y1="75" x2="125" y2="75"></line><line x1="100" y1="0" x2="100" y2="125"></line><line x1="0" y1="100" x2="125" y2="100"></line></g><rect x="0" y="0" width="125" height="125" opacity="0.5"></rect></pattern><pattern class="grid-pattern" id="tri-dots" x="0" y="-4" width="25" height="43.30127018922193" patternUnits="userSpaceOnUse"><circle cx="0" cy="4" r="2" opacity="0.3"></circle><circle cx="25" cy="4" r="2" opacity="0.3"></circle><circle cx="12.5" cy="25.650635094610966" r="2" opacity="0.3"></circle></pattern><pattern class="grid-pattern" id="tri-grid" x="0" y="0" width="25" height="43.30127018922193" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="0" y1="0" x2="25" y2="0"></line><line x1="0" y1="21.650635094610966" x2="25" y2="21.650635094610966"></line><line x1="0" y1="43.30127018922193" x2="25" y2="43.30127018922193"></line><line x1="0" y1="0" x2="25" y2="43.30127018922193"></line><line x1="25" y1="0" x2="0" y2="43.30127018922193"></line></g></pattern><pattern class="grid-pattern" id="tri2-dots" x="-4" y="0" width="43.30127018922193" height="25" patternUnits="userSpaceOnUse"><circle cx="4" cy="0" r="2" opacity="0.3"></circle><circle cx="4" cy="25" r="2" opacity="0.3"></circle><circle cx="25.650635094610966" cy="12.5" r="2" opacity="0.3"></circle></pattern><pattern class="grid-pattern" id="tri2-grid" x="0" y="0" width="43.30127018922193" height="25" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="0" y1="0" x2="0" y2="25"></line><line x1="21.650635094610966" y1="0" x2="21.650635094610966" y2="25"></line><line x1="43.30127018922193" y1="0" x2="43.30127018922193" y2="25"></line><line x1="0" y1="0" x2="43.30127018922193" y2="25"></line><line x1="0" y1="25" x2="43.30127018922193" y2="0"></line></g></pattern><pattern class="grid-pattern" id="square-checked" x="0" y="0" width="50" height="50" patternUnits="userSpaceOnUse"><rect class="filled" x="0" y="0" width="25" height="25" opacity="0.2"></rect><rect class="filled" x="25" y="25" width="25" height="25" opacity="0.2"></rect></pattern><pattern class="grid-pattern" id="rainbow-grid" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="10" y1="-10" x2="-110" y2="110" style="stroke:#cd0e66" stroke-width="17.677669529663685"></line><line x1="35" y1="-10" x2="-85" y2="110" style="stroke:#fd8c00" stroke-width="17.677669529663685"></line><line x1="60" y1="-10" x2="-60" y2="110" style="stroke:#22ab24" stroke-width="17.677669529663685"></line><line x1="85" y1="-10" x2="-35" y2="110" style="stroke:#0f82f2" stroke-width="17.677669529663685"></line><line x1="110" y1="-10" x2="-10" y2="110" style="stroke:#cd0e66" stroke-width="17.677669529663685"></line><line x1="135" y1="-10" x2="15" y2="110" style="stroke:#fd8c00" stroke-width="17.677669529663685"></line><line x1="160" y1="-10" x2="40" y2="110" style="stroke:#22ab24" stroke-width="17.677669529663685"></line><line x1="185" y1="-10" x2="65" y2="110" style="stroke:#0f82f2" stroke-width="17.677669529663685"></line><line x1="210" y1="-10" x2="90" y2="110" style="stroke:#cd0e66" stroke-width="17.677669529663685"></line></g></pattern><marker id="axis-arrow" refX="3" refY="3" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 6 3 L 0 6 z"></path></marker><radialGradient id="sphere-gradient" cx="65%" cy="35%" r="65%"><stop offset="0" stop-color="white" stop-opacity="0.3"></stop><stop offset="0.32" stop-color="white" stop-opacity="0"></stop><stop offset="0.33" stop-opacity="0"></stop><stop offset="1" stop-opacity="0.2"></stop></radialGradient><linearGradient id="card-gradient"><stop offset="0" stop-color="#999"></stop><stop offset="0.08" stop-color="#bbb"></stop><stop offset="0.92" stop-color="#bbb"></stop><stop offset="1" stop-color="#999"></stop></linearGradient><filter id="handdrawn" x="-20%" y="-20%" width="140%" height="140%"><feTurbulence type="fractalNoise" basefrequency="0.004 0.004" numoctaves="26" stitchtiles="stitch" result="turbulence"></feTurbulence><feDisplacementMap in="SourceGraphic" in2="turbulence" scale="20" xchannelselector="R" ychannelselector="G" result="displacementMap"></feDisplacementMap></filter><filter id="pencil" x="-10%" y="-10%" width="110%" height="110%" filterUnits="objectBoundingBox"><feTurbulence type="fractalNoise" baseFrequency="1.2" numOctaves="3" result="noise"></feTurbulence><feDisplacementMap xChannelSelector="R" yChannelSelector="G" scale="2" in="SourceGraphic" result="newSource"></feDisplacementMap></filter><symbol id="suit-c" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m0-10c2.3.1 4.2 1.9 4.3 4.2 0 1.6-.9 3-2.3 3.8.8-.3 1.6-.5 2.5-.5 2.4-.1 4.4 1.7 4.5 4.1v.2c0 2.3-1.9 4.2-4.2 4.2-.1 0-.2 0-.3 0-1.2-.1-2.4-.4-3.5-1 0 0-.3 2 2 5h-6c2.3-3 2-5 2-5-1.1.6-2.3.9-3.5 1-2.3.2-4.3-1.6-4.5-3.9 0-.1 0-.2 0-.3 0-2.4 1.9-4.3 4.3-4.3h.2c.9 0 1.7.2 2.5.5-1.4-.8-2.3-2.2-2.3-3.8.1-2.3 2-4.1 4.3-4.2z"></path></symbol><symbol id="suit-s" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m0-10c-3 5-8 7-8 12 .1 2.1 1.9 3.9 4 4 1.1.1 2.2-.2 3-1 0 0 .3 2-2 5h6c-2-3-2-5-2-5 .8.8 1.9 1.1 3 1 2.1-.1 3.9-1.9 4-4 0-5-5-7-8-12z"></path></symbol><symbol id="suit-h" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m0 8.5-1.3-1.3c-4.6-4.1-7.7-6.9-7.7-10.3-.1-2.7 2.1-4.9 4.8-5h.2c1.5 0 3.1.7 4 1.9 1-1.2 2.5-1.9 4-1.9 2.8-.1 4.9 2.1 5 4.8v.2c0 3.4-3.1 6.2-7.7 10.3z"></path></symbol><symbol id="suit-d" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m7 0-7 10-7-10 7-10"></path></symbol><pattern id="card-bg" width="6" height="8" patternUnits="userSpaceOnUse"><rect width="6" height="8" fill="#0f82f2"></rect><line x2="6" y2="8" stroke="#eee" stroke-width="1"></line><line x1="6" y2="8" stroke="#eee" stroke-width="1"></line></pattern></defs><rect class="grid"></rect><path class="group-shadow"></path><g class="tiles"></g><g class="tiles"></g><g class="tiles"></g><g class="tiles"></g><g class="strokes"></g><g class="geo-shadows"></g><g class="geo-paths"></g><g class="geo-points"></g><g class="tiles"></g><g class="tiles"></g><rect class="selection"></rect><g class="transform-tools" hidden><path class="group-outline"></path><line class="rotate-bar"></line><circle class="rotate-circle" r="10"></circle></g></svg><div class="html-overlay"></div><div class="panels"></div><slot></slot>';var wl=3,ww=new pt(-2e3,4e3,-2e3,4e3),ze=25,vl=ze*Math.sqrt(3)/2,Fo=n=>`${n.xMin} ${n.yMin} ${n.dx} ${n.dy}`,uf=n=>!!n.name,yl=class extends L{constructor(){super(...arguments);this.tiles=new Map;this.strokes=new Map;this.penColour="#242436";this.initial={};this.intersections=new Set;this.margins=[20,20,20,20];this.tools={move:new dl(this),pen:new Bo(this),geo:new zo(this),geoPending:new ml(this),eraser:new pl(this),text:new ul(this),pan:new fl(this),cutPolygon:new gl(this)};this.activeTool=this.tools.move;this.origin=E;this.zoom=1;this.newTileShift=0;this.options=Dt({grid:"none",changeCount:0,labelType:"fraction"});this.canPinchPan=!1;this.setup=!1;this.undoStack=[];this.redoStack=[]}ready(){this.$svg=this.$("svg.canvas"),this.$tiles=this.$svg.$$(".tiles"),this.$selection=this.$svg.$(".selection"),this.$strokes=this.$svg.$(".strokes"),this.$grid=this.$svg.$(".grid"),this.$html=this.$(".html-overlay"),this.$panels=this.$(".panels"),this.$geoShadows=this.$svg.$(".geo-shadows"),this.$geoPaths=this.$svg.$(".geo-paths"),this.$geoPoints=this.$svg.$(".geo-points"),this.$pendingPoint=c("circle",{class:"geo-point pending",hidden:!0},this.$geoPoints),this.setAttr("data-tool","move"),this.events=new Zi(this.$svg,{down:s=>this.activeTool.down(s),start:s=>this.activeTool.start(s),move:s=>this.activeTool.move(s),end:s=>this.activeTool.end(s),click:s=>this.activeTool.click(s),hover:s=>this.activeTool.hover(s),cursor:!1});let t=this.options;this.$svg.copy=function(s=!0,i=!0,o){let r=Li.prototype.copy.call(this,s,i,o);if(t.canEditQuestions)for(let a of r.$$(".problem-text"))a.text="?";return r},this.selection=new cl(this),this.isTeacher=this.attr("user-type")==="teacher",this.options.canEditQuestions=this.isTeacher,this.options.canRotate=Ft(this,"rotate",!0),this.options.canDelete=Ft(this,"delete",!0),this.options.canCopy=Ft(this,"copy",!0),this.options.grid=this.attr("grid")||"none",this.setViewport(E,1),this.options.watch(s=>{this.$grid.setAttr("fill",s.grid!=="none"?`url(#${s.grid})`:"none"),this.$grid.setRect(this.canvasBounds.rect)}),Ft(this,"pan",!1)&&this.enablePinchPan(),this.$svg.on("contextmenu",s=>{this.options.focussed||s.preventDefault()});let e=!1;this.$svg.on("focusin",()=>{if(!e)return;let s=Array.from(this.tiles.values());this.focusTile(this.events.shiftKey?I(s):s[0])}),this.$svg.on("focusout",()=>this.focussed=void 0),q.on("keydown",s=>{if(e=!0,s.keyCode!==9||!this.focussed)return;let i=Array.from(this.tiles.values());this.focusTile(i[i.indexOf(this.focussed)+(s.shiftKey?-1:1)]),this.focussed&&s.preventDefault()}),q.on("pointerdown",()=>e=!1),v.onThemeChange(()=>{for(let s of this.tiles.values())s.colour&&s.setColour(s.colour,"theme");for(let s of this.strokes.values())s.setColor(s.color)})}focusTile(t){this.options.focussed||(this.focussed=t,this.$svg.setAttr("aria-description",t?t.ariaDescription:"Empty Canvas"),t&&this.selection.add(t,!0))}*snapPoints(t,e,s){if(!s){for(let i of bt.tiles)if(!(t&&i.isActive||e&&i.locked||i.pending))for(let o of i.snapPoints)yield[o,{tile:i}]}for(let i of this.tiles.values())if(!(t&&i.isActive||e&&i.locked||i.pending||s&&i.type!==s))for(let o of i.snapPoints)yield[o,{tile:i}];for(let i of this.strokes.values())if(!!i.snapPoints)for(let o of i.snapPoints)yield[o,{stroke:i}];for(let i of this.intersections)yield[i.value,{intersection:i}]}*gridPoints(t){if(this.options.grid==="none")return;let e=this.options.grid.split("-")[0],s=S.aroundPoints(t),i=new pt(s.p.x-ze,s.p.x+s.w+2*ze,s.p.y-ze,s.p.y+s.h+2*ze);if(e.startsWith("square")){let o=(e==="square2"?2:1)*ze,r=st(i.xMin,o);for(let a=st(i.yMin,o);a<i.yMax;a+=o)for(let h=r;h<i.xMax;h+=o)yield[new d(h,a),{}]}else if(e.startsWith("tri")){let o=e==="tri2";o&&(i=i.flip);let r=st(i.xMin,ze);for(let a=Math.floor(i.yMin/vl);a*vl<i.yMax;++a)for(let h=r+(a%2?ze/2:0);h<i.xMax;h+=ze){let l=new d(h,a*vl);yield[o?l.flip:l,{}]}}}*snapLines(t,e,s){for(let i of this.tiles.values())if(!(t&&i.isActive||e&&i.locked||i.pending||s&&i.type!==s))for(let o of i.snapLines)yield[o,{tile:i}];for(let i of this.strokes.values())if(!!i.snapLines)for(let o of i.snapLines)yield[o,{stroke:i}]}snap(t,e=!0,s=!1,i=!1,o){return go(8,t,this.snapPoints(e,i,o))||!s&&go(18,t,this.gridPoints(t))||go(6,t,this.snapLines(e,i,o),(r,a)=>r.project(a))}getTileAt(t,e){for(let s of this.tiles.values())if(e.includes(s.type)&&s.transformed&&(ee(s.transformed)||et(s.transformed))&&s.transformed.contains(t))return s}enablePinchPan(){this.canPinchPan=!0,this.on("wheel",s=>{if(s.preventDefault(),s.ctrlKey){let i=this.zoom*(1-s.deltaY/100);this.setViewport(this.origin,i,ie(s,this.$svg))}else{let i=this.origin.shift(s.deltaX/this.zoom,s.deltaY/this.zoom);this.setViewport(i,this.zoom)}});let t=0,e=this.origin;this.on("gesturestart",s=>{s.preventDefault(),e=new d(s.pageX,s.pageY).subtract(this.origin),t=this.zoom,this.events.cancel()}),this.on("gesturechange",s=>{s.preventDefault();let i=t*s.scale,o=new d(s.pageX,s.pageY).subtract(e);this.setViewport(o,i,ie(s,this.$svg))}),this.on("gestureend",s=>s.preventDefault())}enableImageDrop(t,e){let s=c("div",{class:"image-drop"},this);this.imageUploadCallback=t,this.on("dragenter dragover dragleave drop",o=>o.preventDefault()),this.on("dragenter dragover",()=>s.show()),this.on("dragleave drop",()=>s.hide());let i=(o,r)=>P(this,null,function*(){let h=Array.from((o==null?void 0:o.files)||[]).slice(0,10).map((p,u)=>this.newImage(p,r.shift(u*25),t)),l=yield Promise.all(h);this.change({added:l}),this.trigger("paste")});this.on("drop",o=>i(o.dataTransfer,ie(o,this.$svg))),e==null||e.on("change",()=>P(this,null,function*(){yield i(e._el,this.canvasBounds.center),e.value=""}))}bindSettingsPanel(t,e,s){let i=c("div",{class:"polypad-settings",html:e},this.$panels);this.on("change-selection",({tiles:r})=>{i.toggle(r.length===1&&r[0]===t)});let o=Dt(s);return i.bindModel(o),o}enableHotkeys(){v.onKey("backspace",()=>this.selection.delete()),v.onKey("z",t=>{(t.ctrlKey||t.metaKey)&&(t.preventDefault(),t.shiftKey?this.redo():this.undo())}),v.onKey("y",t=>{(t.ctrlKey||t.metaKey)&&(t.preventDefault(),this.redo())}),v.onKey("c",t=>{var e;t.ctrlKey||t.metaKey||((e=v.getActiveInput())==null?void 0:e.is("input, textarea, [contenteditable]"))||this.selection.copy()}),q.on("cut copy",t=>{var s,i;if(!this.selection.tiles.size||((s=v.getActiveInput())==null?void 0:s.is("input, textarea, [contenteditable]")))return;let e=Array.from(this.selection.tiles).map(o=>o.serialize());for(let o of e)o.links=void 0;(i=window.navigator.clipboard)==null||i.writeText(JSON.stringify(e)),t.type==="cut"&&this.selection.delete()}),q.on("paste",t=>P(this,null,function*(){var i,o;if((i=v.getActiveInput())==null?void 0:i.is("input, textarea, [contenteditable]"))return;let e=Tp(t.clipboardData);if(e&&this.imageUploadCallback){let r=yield this.newImage(e,this.center.shift(-50),this.imageUploadCallback);return this.trigger("paste"),this.change({added:[r]})}let s=yield(o=window.navigator.clipboard)==null?void 0:o.readText();if(!!s){try{let r=JSON.parse(s);if(!r.length)return;let a=r.map(p=>k.unSerialize(p,this,!0)).filter(p=>p);this.selection.clear();let h=Ls(...a.map(p=>p.transformed)).center,l=this.center.subtract(h).shift(this.newTileShift*25);for(let p of a)p.setTransform(p.posn.add(l)),this.selection.add(p);this.change({added:a}),this.newTileShift+=1}catch(a){let r=this.newTile("text",s);r.setTransform(this.canvasBounds.center.subtract(r.center)),this.selection.add(r,!0),this.change({added:[r]})}this.trigger("paste")}}))}newImage(t,e,s){return P(this,null,function*(){let i=new FileReader;i.readAsDataURL(t),yield new Promise(r=>i.onloadend=r);let o=this.newTile("image",(i.result||"").toString());return o.setTransform(e),this.selection.add(o,!0),yield s==null?void 0:s(t,o),o})}newTile(t,e,s){return new(yn(t))(e,this,s)}setViewport(t,e=1,s){if(e=M(e,1/wl,wl),s){let a=this.zoom/e;t=s.subtract(s.subtract(this.origin).scale(a))}let i=this.width/e,o=this.height/e;this.zoom=e,this.origin=t.clamp(ww.resize(-i,-o)),this.canvasBounds=new pt(this.origin.x,this.origin.x+i,this.origin.y,this.origin.y+o),this.$svg.setAttr("viewBox",this.attr("viewBox")||Fo(this.canvasBounds)),this.$html.setTransform(this.origin.inverse.scale(this.zoom),0,this.zoom);let r=this.canvasBounds.rect;this.options.grid!=="none"&&this.$grid.setRect(r),bt.redrawLines(r),this.newTileShift=0}resetViewport(){if(!this.tiles.size&&!this.strokes.size)return this.setViewport(E,1);let t=wo(this.tiles,this.strokes,0),[e,s,i,o]=this.margins,r=(this.width-o-s)/t.dx,a=(this.height-e-i)/t.dy,h=M(Math.min(r,a),1/wl,1),l=new d(this.width+o-s,this.height+e-i),p=t.center.subtract(l.scale(1/2/h));this.setViewport(p,h)}bindSource(t,e,s,i,o){yn(e).makeThumbnail(s,t,this,o);let r,a=i==null?void 0:i.$(".tiles"),h=+t.attr("data-rot")||0;this.events.listen(t,{down:()=>this.trigger("add-tile-start"),start:({posn:l})=>{r=this.newTile(e,t.data.options||s),o&&r.setColour(o),r.setTransform(l,h),this.selection.add(r,!0),this.selection.moveStart(),i&&i.setAttr("viewBox",Fo(this.canvasBounds)),(a||r.$container).append(r.$el),this.trigger("add-tile",{tile:r})},move:l=>this.selection.move(l),end:()=>{r.$container.append(r.$el),this.selection.moveEnd(!0)},click:()=>{let l=this.newTile(e,t.data.options||s);l.setTransform(this.center.subtract(l.center).shift(this.newTileShift*25)),o&&l.setColour(o),this.selection.add(l,!0),l.moveEnd(),this.trigger("add-tile",{tile:l}),this.change({added:[l]}),this.newTileShift+=1}})}get center(){let[t,e,s,i]=this.margins;return this.canvasBounds.center.shift((i-e)/this.zoom/2,(t-s)/this.zoom/2)}setActiveTool(t,e){this.activeTool.cancel(),this.activeTool=this.tools[t],e&&(this.activeTool.options=e),this.setAttr("data-tool",t),this.selection.clear()}clear(t=!0){this.selection.clear();let e=[...Array.from(this.tiles.values()),...Array.from(this.strokes.values())];for(let s of e)s.delete();t&&this.setViewport(E,1),this.change({deleted:e})}thumbnail(t,e){let s=wo(this.tiles,this.strokes,50);return this.$svg.pngImage(t,e,Fo(s))}downloadImage(t){var i;this.selection.clear();let e=t||((i=this.options.title)==null?void 0:i.replace(/\s/g,"-").replace(/[^\w-]/g,"").toLowerCase())||"polypad",s=wo(this.tiles,this.strokes,50);this.$svg.downloadImage(`${e}.png`,s.dx,s.dy,Fo(s))}unlockAll(){let t=[];for(let e of this.tiles.values())!e.locked&&!e.hidden||(e.lock(!1),e.hide(!1),t.push(e));this.change({changed:t})}check(t){let e=!1;return new Promise(s=>{this.on("change",()=>{!e&&t(Array.from(this.tiles.values()))&&(e=!0,s())})})}change(t){var e,s,i;this.setup||(this.trigger("change",{action:"change",data:t}),this.undoStack.push({added:(e=t.added)==null?void 0:e.map(o=>o.serialize()),changed:(s=t.changed)==null?void 0:s.map(o=>[o.lastSavedData,o.serialize()]),deleted:(i=t.deleted)==null?void 0:i.map(o=>o.lastSavedData)}),this.undoStack.length>50&&this.undoStack.shift(),this.redoStack=[],this.options.canUndo=!0,this.options.canRedo=!1,this.options.changeCount+=1)}undo(){!this.undoStack.length||(this.applyChange(I(this.undoStack),!0),this.redoStack.push(this.undoStack.pop()),this.options.canUndo=!!this.undoStack.length,this.options.canRedo=!0,this.options.changeCount-=1,this.selection.update(),this.trigger("change",{action:"undo"}))}redo(){!this.redoStack.length||(this.applyChange(I(this.redoStack)),this.undoStack.push(this.redoStack.pop()),this.options.canUndo=!0,this.options.canRedo=!!this.redoStack.length,this.options.changeCount+=1,this.selection.update(),this.trigger("change",{action:"redo"}))}applyChange(t,e=!1){var s,i;for(let o of(e?t.deleted:t.added)||[])(uf(o)?k:ns).unSerialize(o,this);for(let o of(e?t.added:t.deleted)||[])(s=(uf(o)?this.tiles:this.strokes).get(o.id))==null||s.delete();for(let[o,r]of t.changed||[])(i=this.tiles.get(o.id))==null||i.applyChange(e?o:r)}serialize(t=2e3,e=1e3,s=16e3){var i;return{title:(i=this.options.title)==null?void 0:i.slice(0,30),grid:this.options.grid||"none",noLabels:this.options.noLabels,altColors:this.options.altColors,mergeTiles:this.options.mergeTiles,labelType:this.options.labelType,tiles:Array.from(this.tiles.values()).slice(0,t).map(o=>o.serialize()),strokes:Array.from(this.strokes.values()).slice(0,e).map(o=>o.serialize(s))}}unSerialize(t){if(!!t){this.setup=!0,this.clear(!1),bt.clearModel();for(let e of t.tiles||[])k.unSerialize(e,this);for(let e of t.strokes||[])ns.unSerialize(e,this);bt.computeIntersections(this);for(let e of this.tiles.values())e.move();this.setup=!1}}load(t){var e,s,i,o;this.initial=t,this.options.canEditQuestions=this.isTeacher&&((e=t.canEdit)!=null?e:!0),this.unSerialize(t),this.undoStack=this.redoStack=[],this.options.assign({title:t.title,grid:t.grid||"none",canUndo:!1,changeCount:0,noLabels:(s=t.noLabels)!=null?s:this.options.noLabels,altColors:(i=t.altColors)!=null?i:this.options.altColors,mergeTiles:(o=t.mergeTiles)!=null?o:this.options.mergeTiles,labelType:t.labelType||this.options.labelType}),this.resetViewport()}};yl=V([A("x-polypad",{template:pf})],yl);var ff=`<div class="factris-panel-left"><div class="keys-play"><button @click="app.reset()" title="Restart Game"><x-icon name="restart" size="36"></x-icon></button><button @click="app.toggle()" :title="playing ? 'Pause' : 'Play'"><span :show="playing"><x-icon name="pause" size="36"></x-icon></span><span :show="!playing"><x-icon name="play" size="36"></x-icon></span></button><button class="highscore-btn" @click="app.showHighscore()" title="Highscore"><x-icon name="trophy" size="36"></x-icon></button></div><div class="panel-item"><div class="text-large" :class="points &gt; 999999 ? 'narrow' : ''">\${numberFormat(points)}</div><div class="text-small">Points</div></div><div class="panel-item"><div class="text-large margin"><span :show="min(time)" data-display="inline">\${min(time)}m</span> \${time % 60}s</div><div class="text-small">Time</div></div><hr :show="highscore.length"><div class="highscore-panel" :show="highscore.length"><div class="highscore-title">Highscore</div><table><tr><td>\${highscore[0].name.slice(0, 4)}</td><td>\${numberFormat(highscore[0].score)}</td></tr><tr><td>\${highscore[1].name.slice(0, 4)}</td><td>\${numberFormat(highscore[1].score)}</td></tr><tr><td>\${highscore[2].name.slice(0, 4)}</td><td>\${numberFormat(highscore[2].score)}</td></tr><tr><td>\${highscore[3].name.slice(0, 4)}</td><td>\${numberFormat(highscore[3].score)}</td></tr><tr><td colspan="2"><a @click="app.showHighscore()">View more\u2026</a></td></tr></table></div><div class="corner"><svg width="13" height="17"><path class="dark" d="M0,0V5A12,12,0,0,1,12,17h1V0Z"></path><path d="M0,0V1A12,12,0,0,1,12,13v4h1V0Z"></path></svg></div></div><div class="factris-panel-right"><div class="panel-item"><div class="text-small">Next blocks:</div><div class="text-large">\${next[0]}</div><div class="text-large">\${next[1]}</div><div class="text-large">\${next[2]}</div><div class="text-large">\${next[3]}</div><div class="text-large">\${next[4]}</div></div><hr><div class="text-small discharge-label">Discharge:</div><button class="discharge" :show="!discardCounter" data-display="inline-block" @click="app.discharge()" title="Discard Tile"><x-icon name="delete" size="36"></x-icon></button><svg class="discharge-count" :show="discardCounter" data-display="inline-block" width="74" height="74" viewBox="0 0 74 74"><circle cx="37" cy="37" r="32" style="strokeDashoffset:\${201*discardCounter/5}px"></circle><text class="large" x="37" y="38">\${discardCounter}</text><text class="small" x="37" y="51">needed</text></svg><div class="corner"><svg width="13" height="17"><path class="dark" d="M0,0V17H1A12,12,0,0,1,13,5V0Z"></path><path d="M0,0V17H1V13A12,12,0,0,1,13,1V0Z"></path></svg></div></div><div class="factris-body"><svg class="factris-board" :show="(playing || lost) &amp;&amp; !showHighscore &amp;&amp; !initial" data-display="visibility"><defs><linearGradient id="shadow" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color: white; stop-opacity: 0.2"></stop><stop offset="100%" style="stop-color: white; stop-opacity: 0.05"></stop></linearGradient></defs><rect class="shadow" fill="url(#shadow)"></rect><g class="tiles"></g><g class="grid"><g class="faint-grid"></g></g><g class="scores"></g></svg><div class="logo" :class="initial &amp;&amp; !showHighscore ? 'show' : ''"><svg viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg"><g fill="#ffffff"><path d="m1.5039 59.1143v-57.9034h24.7227v7.8077h-16.4278v17.5659h14.313v7.8071h-14.313v24.7227z"/><path d="m23.7871 59.1143 12.9307-57.9034h6.9122l12.931 57.9034h-8.2954l-2.4394-12.4429h-11.3042l-2.44 12.4429zm20.4937-20.25-4.066-20.9815h-.1626l-4.0664 20.9815z"/><path d="m86.9766 42.6055v3.5781a12.9 12.9 0 0 1 -1.0166 5.083 14.0881 14.0881 0 0 1 -2.8057 4.27 13.5323 13.5323 0 0 1 -4.1885 2.9683 12.2636 12.2636 0 0 1 -5.164 1.0977 18.5964 18.5964 0 0 1 -4.7984-.65 11.3307 11.3307 0 0 1 -4.3911-2.2774 12.5723 12.5723 0 0 1 -3.2123-4.1889 14.814 14.814 0 0 1 -1.2608-6.5463v-31.8795a14.0993 14.0993 0 0 1 .976-5.2861 12.4357 12.4357 0 0 1 2.7648-4.229 12.863 12.863 0 0 1 4.27-2.8054 14.35 14.35 0 0 1 5.4892-1.0169 12.5807 12.5807 0 0 1 9.5151 3.8223 13.6266 13.6266 0 0 1 2.8057 4.4321 14.9842 14.9842 0 0 1 1.0166 5.5708v3.253h-8.2954v-2.7652a6.7153 6.7153 0 0 0 -1.3824-4.2285 4.4819 4.4819 0 0 0 -3.7412-1.789q-3.0915 0-4.1064 1.9111a10.23 10.23 0 0 0 -1.0166 4.8384v29.6025a7.6635 7.6635 0 0 0 1.0976 4.2285q1.098 1.7081 3.9444 1.708a6.0109 6.0109 0 0 0 1.7485-.2846 5.2115 5.2115 0 0 0 1.7485-.9351 4.953 4.953 0 0 0 1.22-1.79 7.2474 7.2474 0 0 0 .4878-2.8462v-2.8457z"/><path d="m99.1748 59.1143v-50.0957h-9.5967v-7.8077h27.4878v7.8077h-9.5959v50.0957z"/><path d="m120.7246 59.1143v-57.9034h13.3369q14.6385 0 14.6385 16.9971a21.4218 21.4218 0 0 1 -1.5859 8.7017 12.2983 12.2983 0 0 1 -5.5708 5.7739l8.9458 26.4307h-8.7832l-7.7256-24.7227h-4.9603v24.7227zm8.2954-50.0957v18.0537h4.7168a8.348 8.348 0 0 0 3.4971-.61 4.7555 4.7555 0 0 0 2.0332-1.7485 7.9534 7.9534 0 0 0 .8945-2.8057 26.9748 26.9748 0 0 0 .2437-3.8628 26.99 26.99 0 0 0 -.2437-3.8628 7.7387 7.7387 0 0 0 -.976-2.8872q-1.5467-2.2753-5.8556-2.2767z"/><path d="m155.6123 59.1143v-57.9034h8.2954v57.9034z"/><path d="m198.7954 17.8828h-8.2949v-1.8706a8.8535 8.8535 0 0 0 -1.3423-4.92 4.962 4.962 0 0 0 -4.5132-2.0737 5.2227 5.2227 0 0 0 -2.7651.65 5.4612 5.4612 0 0 0 -1.708 1.6265 6.8624 6.8624 0 0 0 -.8946 2.3989 15.6706 15.6706 0 0 0 -.2436 2.8057 27.5758 27.5758 0 0 0 .1216 2.8467 5.3954 5.3954 0 0 0 .61 2.0332 4.5014 4.5014 0 0 0 1.4229 1.5449 12.9606 12.9606 0 0 0 2.562 1.3013l6.3433 2.521a15.7628 15.7628 0 0 1 4.4726 2.48 10.7272 10.7272 0 0 1 2.6839 3.2943 15.4228 15.4228 0 0 1 1.22 4.4321 44.0689 44.0689 0 0 1 .3252 5.6524 29.8066 29.8066 0 0 1 -.7319 6.7905 14.3039 14.3039 0 0 1 -2.3584 5.3267 11.699 11.699 0 0 1 -4.4727 3.5781 15.7942 15.7942 0 0 1 -6.75 1.3013 14.7745 14.7745 0 0 1 -5.6113-1.0572 13.31 13.31 0 0 1 -4.4732-2.9277 14.2235 14.2235 0 0 1 -2.9682-4.3506 13.2116 13.2116 0 0 1 -1.0982-5.4082v-3.09h8.2955v2.6025a6.7761 6.7761 0 0 0 1.3418 4.1069q1.3418 1.83 4.5136 1.83a7.2794 7.2794 0 0 0 3.2935-.61 4.3859 4.3859 0 0 0 1.83-1.7486 6.4244 6.4244 0 0 0 .7729-2.7246q.1216-1.5856.1221-3.5376a35.0565 35.0565 0 0 0 -.1631-3.7407 6.4528 6.4528 0 0 0 -.65-2.3584 4.59 4.59 0 0 0 -1.5044-1.4639 19.57 19.57 0 0 0 -2.4805-1.22l-5.9365-2.44q-5.3679-2.1958-7.1972-5.8145a19.9948 19.9948 0 0 1 -1.83-9.0679 21.0112 21.0112 0 0 1 .8945-6.1806 14.0506 14.0506 0 0 1 2.6841-5.042 12.3042 12.3042 0 0 1 4.3506-3.375 14.5257 14.5257 0 0 1 6.3018-1.2609 13.7661 13.7661 0 0 1 5.6519 1.1387 14.5927 14.5927 0 0 1 4.4326 3.0088 12.5712 12.5712 0 0 1 3.7407 8.9458z"/></g></svg></div><x-icon class="play" :class="initial &amp;&amp; !showHighscore ? 'show' : ''" @click="app.play()" name="play" size="80"></x-icon><div class="overlay lost" :class="lost &amp;&amp; !showHighscore ? 'show' : ''">Game over!</div><div class="overlay paused" :class="playing || lost || initial || showHighscore ? '' : 'show'">Paused</div><div class="highscore" :show="showHighscore"><div class="text-large"><x-icon name="trophy" size="36"></x-icon> Highscore</div><table><tr><td>\${highscore[0].name}</td><td>\${numberFormat(highscore[0].score)}</td></tr><tr><td>\${highscore[1].name}</td><td>\${numberFormat(highscore[1].score)}</td></tr><tr><td>\${highscore[2].name}</td><td>\${numberFormat(highscore[2].score)}</td></tr><tr><td>\${highscore[3].name}</td><td>\${numberFormat(highscore[3].score)}</td></tr><tr><td>\${highscore[4].name}</td><td>\${numberFormat(highscore[4].score)}</td></tr><tr><td>\${highscore[5].name}</td><td>\${numberFormat(highscore[5].score)}</td></tr><tr><td>\${highscore[6].name}</td><td>\${numberFormat(highscore[6].score)}</td></tr><tr><td>\${highscore[7].name}</td><td>\${numberFormat(highscore[7].score)}</td></tr><tr><td>\${highscore[8].name}</td><td>\${numberFormat(highscore[8].score)}</td></tr><tr><td>\${highscore[9].name}</td><td>\${numberFormat(highscore[9].score)}</td></tr><tr><td>\${highscore[10].name}</td><td>\${numberFormat(highscore[10].score)}</td></tr></table></div></div><div class="factris-keys"><button class="key-left" :class="key === 'left' ? 'active' : ''" title="Left" @pointerdown="app.keyPress('left')"><x-icon name="left" size="36"></x-icon></button><div class="keys-center"><button class="key-up" :class="key === 'up' ? 'active' : ''" title="Resize" @pointerdown="app.keyPress('up')"><svg class="icon" width="54" height="36" viewBox="0 0 54 36" xmlns="http://www.w3.org/2000/svg"><path d="m41.1973 11 1.5975-1.635a.75.75 0 0 1 1.2751.5325v.495a6 6 0 0 1 5.2501 5.8575.75.75 0 0 1 -1.5 0 4.5 4.5 0 0 0 -3.75-4.3426v1.1475a.75.75 0 0 1 -1.2751.5326l-1.5975-1.56a.7676.7676 0 0 1 -.0001-1.0275z"/><path d="m12.8027 11-1.5975-1.635a.75.75 0 0 0 -1.2752.5324v.495a6 6 0 0 0 -5.25 5.8576.75.75 0 0 0 1.5 0 4.5 4.5 0 0 1 3.75-4.3426v1.1475a.75.75 0 0 0 1.2751.5326l1.5975-1.56a.7676.7676 0 0 0 .0001-1.0275z"/><rect height="11" rx="2" width="11" x="15" y="6"/><rect height="11" rx="2" width="11" x="28" y="6"/><rect height="11" rx="2" width="11" x="15" y="19"/><rect height="11" rx="2" width="11" x="28" y="19"/><path d="m50 21v7h-7v-7zm0-2h-7a2 2 0 0 0 -2 2v7a2 2 0 0 0 2 2h7a2 2 0 0 0 2-2v-7a2 2 0 0 0 -2-2z"/><path d="m11 21v7h-7v-7zm0-2h-7a2 2 0 0 0 -2 2v7a2 2 0 0 0 2 2h7a2 2 0 0 0 2-2v-7a2 2 0 0 0 -2-2z"/></svg>
</button><button class="key-down" :class="key === 'down' ? 'active' : ''" title="Down" @pointerdown="app.keyPress('down')"><x-icon name="down" size="36"></x-icon></button></div><button class="key-right" :class="key === 'right' ? 'active' : ''" title="Right" @pointerdown="app.keyPress('right')"><x-icon name="right" size="36"></x-icon></button></div><div class="factris-panel-top" :class="showHighscore ? 'hide' : ''"><div class="text-small">Block size:</div><div class="text-large">\${active[0] || '?' } = \${active[2]|| '?'} \xD7 \${active[1]|| '?'}</div><div class="corner left"><svg width="13" height="13"><path d="M12,0A12,12,0,0,1,0,12v1H13V0Z"></path></svg></div><div class="corner right"><svg width="13" height="13"><path d="M1,0A12,12,0,0,0,13,12v1H0V0Z"></path></svg></div></div>`;var vw=1e3,Q=M(+cc(location.search).size||16,8,24),yw=5,Ti=Math.ceil(Q/2),Uo=Q+Ti,jo=[];for(let n=2;n<=Q*1.5;n+=1){let t=Ei(n);t&&n>.75*Q||n>Q&&_l(n)[0]>Q/2||(t&&n>Q/2||n>1.25*Q?jo.push(n):jo.push(n,n))}var $n=()=>jo[ct.integer(jo.length)],bw=Us(1,Q),$w=Q*10,mf=_(n=>$w*2**n,Q),gf=class{constructor(t,e,s){this.$el=c("rect",{width:20,height:20},s),this.setPosition(t,e)}setPosition(t,e){this.x=t,this.y=e,this.$el.setTransform({x:10+20*this.x,y:10+20*this.y})}go(t,e,s){this.setPosition(this.x+s-e,this.y+t)}canSet(t,e,s){return!s.find(i=>i.x===t&&i.y===e)}canGo(t,e,s,i){let o=this.x+s-e,r=this.y+t;return r>=Uo||o<0||o>=Q?!1:this.canSet(o,r,i)}canGoDown(t){return this.canGo(1,0,0,t)}goDown(t=1){if(t!==0)return this.go(t,0,0)}},bl=class extends L{constructor(){super(...arguments);this.interval=void 0;this.tiles=[];this.activeTiles=[];this.activeSize=[0,0,0];this.activeFactors=[];this.isDown=!1;this.keyLock=!1;this.requestQueue=Promise.resolve("");this.highscore=!0}ready(){this.$svg=this.$(".factris-board"),this.$tiles=this.$svg.$(".tiles"),this.$shadow=this.$svg.$(".shadow"),this.attr("highscore")==="no"&&(this.highscore=!1);let t=this.$svg.$(".scores");this.$scores=mf.map((e,s)=>{let i=c("g",{},t);return c("text",{text:"+"+e,class:`s${s+1}`},i),i}),this.bindModel(Dt({time:0,points:0,playing:!1,lost:!1,initial:!0,key:void 0,discardCounter:0,next:[],active:[],highscore:[],showHighscore:!1,min:e=>Math.floor(e/60),numberFormat:ot,app:this}));for(let e of this.$$("button, .play"))e.on("contextmenu",s=>s.preventDefault());v.onKey("left up right down",(e,s)=>{!this.model.playing||(e.preventDefault(),this.isDown=!0,this.model.key=s,this.keyPress(s))}),v.onKey("left up right down",()=>{!this.model.playing||(this.isDown=this.keyLock=!1,this.model.key=void 0)},!0),this.setupSVG(),this.updateHighscore()}setupSVG(){this.$svg.setAttr("viewBox",`0 0 ${(Q+1)*20} ${(Uo+1)*20}`);let t=this.$svg.$(".grid"),e=t.$(".faint-grid");for(let s=0;s<=Q;s+=1){let i=10+s*20,o=10+(Ti+s)*20,r=!(s%4)||s===Q?t:e,a=!(s%2)||s===Q?"thick":"";c("line",{x1:10,y1:o,x2:10+Q*20,y2:o,class:a},r),c("line",{x1:i,y1:10+Ti*20,x2:i,y2:Uo*20+10,class:a},r)}}drawShadow(){!this.activeTiles.length||(this.$shadow.setAttr("x",10+20*this.activeSize[0]),this.$shadow.setAttr("y",10+20*this.activeSize[1]),this.$shadow.setAttr("width",20*this.activeSize[2]),this.$shadow.setAttr("height",20*(Uo-this.activeSize[1])))}newRect(){let t=this.getNewTileSize();this.activeFactors=bw.filter(i=>t%i==0);let e=this.activeFactors.pop(),s=Math.floor((Q-e)/2);this.activeTiles=_(i=>new gf(s+i%e,Math.floor(i/e),this.$tiles),t),this.model.active=[t,e,t/e],this.activeSize=[s,t/e,e],this.drawShadow(),this.isDown&&(this.keyLock=!0)}reset(){this.pause(),this.model.time=0,this.model.points=0,this.model.discardCounter=0,this.model.showHighscore=!1,this.model.lost=!1,this.model.next=[$n(),$n(),$n(),$n()];for(let t of this.tiles)t.$el.remove();for(let t of this.activeTiles)t.$el.remove();this.tiles=[],this.newRect(),this.play(),this.requestQueue=Promise.resolve("")}toggle(){this.model.lost?this.reset():this.model.playing?this.pause():this.play()}pause(){this.model.playing=!1,clearInterval(this.interval)}play(){if(this.model.showHighscore=!1,window==null||window.ga("send","event","Factris","play"),this.model.initial||this.model.lost)return this.model.initial=!1,this.reset();this.model.playing=!0,this.interval=window.setInterval(()=>this.tick(),vw)}getNewTileSize(){let t=Q*Q-this.tiles.length;if(this.model.next[0]>t)return t>Q?t-Q:Q;this.model.discardCounter>0&&(this.model.discardCounter-=1);let e=this.model.next[0];return this.model.next=[...this.model.next.slice(1),$n()],e}tick(){if(this.model.time+=1,this.activeTiles.every(o=>o.canGoDown(this.tiles))){for(let o of this.activeTiles)o.goDown();this.activeSize[1]+=1,this.drawShadow();return}this.tiles.push(...this.activeTiles);for(let o of this.activeTiles)o.$el.addClass("fixed");if(this.tiles.some(o=>o.y<Ti))return this.gameOver();this.activeTiles=[];let e=this.getFullRows();if(!e.length)return this.newRect();this.model.points+=H(mf.slice(0,e.length)),e.length>=6&&zs(10,150*e.length/Q),this.removeRows(e);let s=this.model.points,i=(s+Q)%13+(s-Q)%87;this.requestQueue=this.requestQueue.then(o=>ke("/factris-verify",{token:o,size:Q,score:s,check:i})),this.trigger("score",{points:s})}getFullRows(){return _(t=>this.tiles.filter(e=>e.y===t+Ti),Q).filter(t=>t.length===Q)}removeRows(t){let e=Ut(t);this.tiles=this.tiles.filter(o=>!e.includes(o)),this.$tiles.addClass("animated"),v.redraw();for(let o of e)o.$el.addClass("removing");let s=t.map(o=>o[0].y);for(let o of this.tiles)o.goDown(s.filter(r=>r>o.y).length);let i=400/t.length;for(let[o,r]of s.reverse().entries())this.$scores[o].setTransform({x:10+Ti*20,y:27+r*20}),ge(()=>this.$scores[o].addClass("visible"),o*i);return setTimeout(()=>{for(let o of this.$scores)o.removeClass("visible")},600),setTimeout(()=>{for(let o of e)o.$el.remove();this.$tiles.removeClass("animated"),this.newRect()},1e3),!1}gameOver(){this.model.lost=!0;for(let t of this.activeTiles)t.$el.addClass("error");this.pause(),this.requestQueue.then(t=>{t&&this.trigger("game-over",{token:t,points:this.model.points})})}discharge(){if(!!this.model.playing){for(let t of this.activeTiles)t.$el.remove();this.newRect(),this.model.discardCounter=yw}}keyPress(t,e=!0){if(!!this.model.playing&&!this.keyLock){if(t==="up"){if(!this.activeFactors.length)return;let s=this.activeFactors.pop(),i=this.activeSize[0]+Math.floor((this.activeSize[2]-s)/2),o=this.activeSize[1];if(this.activeTiles.some((h,l)=>!h.canSet(i+l%s,o-1-Math.floor(l/s),this.tiles)))return;for(let[h,l]of this.activeTiles.entries())l.setPosition(i+h%s,o-1-Math.floor(h/s));let a=this.model.active[0];this.model.active=[a,s,a/s],this.activeSize=[i,o,s]}else{let s=t==="down"?1:0,i=t==="left"?1:0,o=t==="right"?1:0;if(this.activeTiles.every(r=>r.canGo(s,i,o,this.tiles))){for(let r of this.activeTiles)r.go(s,i,o);this.activeSize[0]+=o-i,this.activeSize[1]+=s}e&&t==="down"&&setTimeout(()=>this.keyPress("down",!1),100)}this.drawShadow()}}showHighscore(){!this.highscore||(this.pause(),this.model.showHighscore=!0)}updateHighscore(){return P(this,null,function*(){if(!this.highscore)return;let t=yield fetch(`/factris-highscore?size=${Q}`);this.model.highscore=yield t.json()})}};bl=V([A("x-factris",{template:ff})],bl);var $l=class extends L{ready(){let t=Array.from(this._el.children);this.removeChildren();let e=c("svg",{class:"equation"},this),s=c("g",{transform:"translate(2 0)"},e),i=c("div",{class:"overlay"},this),o=parseFloat(this.css("font-size")),r=this.parents(".text-center").length||this.hasClass("display"),a=new He(s,i,0,"",o,!!r);a.setValue(this.attr("expr")||t),this.css({width:a.root.width+4+"px",height:a.root.height+"px","vertical-align":`-${a.root.height-a.root.baseline}px`})}};$l=V([A("x-math")],$l);window.$=N;window.$$=Pe;window.Browser=v;var Zo=N("x-modal#privacy");Zo&&Zo.$("form").on("submit",n=>{n.preventDefault();let t=Zo.$('input[name="newsletter"]');ke("/settings/privacy",{policies:"on",newsletter:t.checked?"on":"off"}),Zo.close()});var wf="";function xl(){return fetch("/joke").then(n=>n.text()).then(n=>wf=n),wf}var Pl=N(".error-box");Pl&&Pl.on("click",()=>Pl.html=xl());xl();window.tellMeAJoke=function(){return xl().replace(/<p>/g,"").replace(/<\/p>/g,`
`).trim()};console.log(`%cWelcome to Mathigon!
%cYou can see our source code at https://github.com/mathigon
%cIf you want to contribute, visit https://mathigon.io
%cJust here for fun? Run tellMeAJoke()`,"color: #cd0e66; font-weight: bold; font-size: 18px;","color: #0f82f2; font-weight: bold;","color: #22ab24; font-weight: bold;","color: #fd8c00; font-weight: bold;");var vf=[38,38,40,40,37,39,37,39,66,65],xn=0;document.addEventListener("keydown",n=>{n.keyCode===vf[xn]?(xn+=1,xn===vf.length&&(zs(),xn=0)):xn=0});})();